<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>spring基础知识-事务</title>
    <link href="/spring%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86-%E4%BA%8B%E5%8A%A1/2ff047cb81fb/"/>
    <url>/spring%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86-%E4%BA%8B%E5%8A%A1/2ff047cb81fb/</url>
    
    <content type="html"><![CDATA[<h1 id="1-事务"><a href="#1-事务" class="headerlink" title="1 事务"></a>1 事务</h1><ol><li><p>事务是数据库操作最基本单位，要么都成功，要么都失败。</p></li><li><p>事务四个特性ACID：原子性，一致性，隔离性，持久性。</p></li><li><p>Spring事务管理有两种方式：编程式事务管理 和 声明式事务管理，一般使用声明式事务管理，底层使用AOP原理。</p></li><li><p>声明式事务管理有两种方式：基于xml配置方式 和 基于注解方式，一般使用注解方式。</p></li><li><p>Spring事务管理提供了一个接口，叫做事务管理器，这个接口针对不同的框架提供不同的实现类。</p></li><li><p>在service类上面或者service类的方法上面添加事务注解<code>@Transactional</code></p></li><li><p>如果把<code>@Transactional</code>添加在类上面，这个类里面所有方法都添加事务。</p></li><li><p>如果只是添加在方法上面，则只为这个方法添加事务。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@Transactional</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> &#123;<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h2 id="声明式事务"><a href="#声明式事务" class="headerlink" title="声明式事务"></a>声明式事务</h2><ol><li><p>propagation：事务传播行为，总共有7种。</p></li><li><p>isolation：事务隔离级别</p><blockquote><p>有三个读问题：脏读，不可重复读，虚读（幻读）。</p><p>设置隔离级别，解决读问题：</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Spring/image-20240414125344168.png" alt="image-20240414125344168"></p></blockquote></li><li><p>timeout：超时时间</p><ul><li>事务需要在一定时间内进行提交，超过时间后回滚。</li><li>默认值是-1，设置时间以秒为单位。</li></ul></li><li><p>readOnly：是否只读</p><ul><li>默认值为false，表示可以查询，也可以增删改。</li><li>设置为true，只能查询。</li></ul></li><li><p>rollbackFor：回滚，设置出现哪些异常进行事务回滚。</p></li><li><p>noRollbackFor：不回滚，设置出现哪些异常不进行事务回滚。</p></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@Transactional(propagation = Propagation.REQUIRED,isolation = Isolation.READ_COMMITTED)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AccountService</span> &#123;<br></code></pre></td></tr></table></figure><h2 id="完全注解实现声明式事务管理"><a href="#完全注解实现声明式事务管理" class="headerlink" title="完全注解实现声明式事务管理"></a>完全注解实现声明式事务管理</h2><p>配置类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span>  <span class="hljs-comment">//配置类</span><br><span class="hljs-meta">@ComponentScan(basePackages = &quot;com.oymn.spring5&quot;)</span>  <span class="hljs-comment">//开启组件扫描</span><br><span class="hljs-meta">@EnableTransactionManagement</span>  <span class="hljs-comment">//开启事务</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Config</span> &#123;<br><br>    <span class="hljs-comment">//创建数据库连接池</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> DruidDataSource <span class="hljs-title function_">getDruidDataSource</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">DruidDataSource</span> <span class="hljs-variable">druidDataSource</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DruidDataSource</span>();<br>        druidDataSource.setDriverClassName(<span class="hljs-string">&quot;com.mysql.jdbc.Driver&quot;</span>);<br>        druidDataSource.setUrl(<span class="hljs-string">&quot;jdbc:mysql://localhost:3306/book&quot;</span>);<br>        druidDataSource.setUsername(<span class="hljs-string">&quot;root&quot;</span>);<br>        druidDataSource.setPassword(<span class="hljs-string">&quot;000000&quot;</span>);<br>        <span class="hljs-keyword">return</span> druidDataSource;<br>    &#125;<br>    <span class="hljs-comment">//创建JdbcTemplate对象</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> JdbcTemplate <span class="hljs-title function_">getJdbcTemplate</span><span class="hljs-params">(DataSource dataSource)</span>&#123;<br>        <span class="hljs-type">JdbcTemplate</span> <span class="hljs-variable">jdbcTemplate</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JdbcTemplate</span>();<br>        jdbcTemplate.setDataSource(dataSource);<br>        <span class="hljs-keyword">return</span> jdbcTemplate;<br>    &#125;<br>    <span class="hljs-comment">//创建事务管理器</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> DataSourceTransactionManager <span class="hljs-title function_">getDataSourceTransactionManager</span><span class="hljs-params">(DataSource dataSource)</span>&#123;<br>        <span class="hljs-type">DataSourceTransactionManager</span> <span class="hljs-variable">transactionManager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataSourceTransactionManager</span>();<br>        transactionManager.setDataSource(dataSource);<br>        <span class="hljs-keyword">return</span> transactionManager;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>service类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AccountService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> AccountDao accountDao;<br><br>    <span class="hljs-meta">@Transactional</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">accountMoney</span><span class="hljs-params">()</span>&#123;<br>        accountDao.add();<br>        <span class="hljs-comment">//int i=1/0;   //用来模拟转账失败</span><br>        accountDao.reduce();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="事务传播行为"><a href="#事务传播行为" class="headerlink" title="事务传播行为"></a>事务传播行为</h2><p>在spring中一共有7中传播行为，REQUIRED、NESTED、REQUIRES_NEW常用</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">REQUIRED：如果当前没有事务，就新建一个事务。如果当前存在事务，则加入这个事务。 <br><span class="hljs-code"> </span><br>NESTED：如果当前没有事务，就新建一个事务。如果当前事务存在，则执行一个嵌套事务。<br><span class="hljs-code"> </span><br>REQUIRES<span class="hljs-emphasis">_NEW：如果当前没有事务，就新建一个事务。如果当前存在事务，把当前事务挂起，并且自己创建一个新的事务给自己使用。 </span><br><span class="hljs-emphasis"> </span><br><span class="hljs-emphasis">SUPPORTS：如果当前没有事务，就以非事务方式执行。 如果当前有事务，则使用事务。</span><br><span class="hljs-emphasis"> </span><br><span class="hljs-emphasis">NOT_</span>SUPPORTED：以非事务方式执行操作，如果当前存在事务，就把当前事务挂起。<br><span class="hljs-code"> </span><br>MANDATORY：以事务方式执行，如果当前没有事务，就抛出异常。 <br><span class="hljs-code"> </span><br>NEVER：以非事务方式执行，如果当前存在事务，则抛出异常。 <br></code></pre></td></tr></table></figure><h3 id="场景示例"><a href="#场景示例" class="headerlink" title="场景示例"></a>场景示例</h3><p>有个注册业务，注册时需要记录登录账号、密码、身份证号、姓名、手机号这5个信息，涉及三张表，分别是<strong>t_user_account、t_user_idcard、t_user_phone</strong>，刚开始的业务要求这些都不能为空，如果其中一个发生异常，那么其余已经插入的全部回滚（这些异常是我用作数据校验时抛出的，正常生产上会先进行数据校验，校验成功了再更改数据库，我这里为了演示@Transactional的回滚效果，先更改数据，如果校验不通过，便会通过spring的事务进行回滚）。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserVO</span> &#123;<br>    <span class="hljs-keyword">private</span> Long id;<br>    <span class="hljs-keyword">private</span> String userAccount;<br>    <span class="hljs-keyword">private</span> String userPwd;<br>    <span class="hljs-keyword">private</span> String phoneNum;<br>    <span class="hljs-keyword">private</span> String userName;<br>    <span class="hljs-keyword">private</span> String IDCard;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> &#123;<br> <br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserService userService;<br> <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 注册用户</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> userVO</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">register</span><span class="hljs-params">(UserVO userVO)</span> &#123;<br>        userService.insertId(userVO);<br>        <span class="hljs-keyword">try</span> &#123;<br>            userService.register(userVO);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserService</span> &#123;<br>    <span class="hljs-comment">//插入新用户的id</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertId</span><span class="hljs-params">(UserVO userVO)</span>;<br>    <span class="hljs-comment">//插入用户账号、密码、手机号、姓名、身份证号</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">register</span><span class="hljs-params">(UserVO userVO)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserService</span> &#123;<br> <br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> JdbcTemplate jdbcTemplate;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserDao userDao;<br> <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertId</span><span class="hljs-params">(UserVO userVO)</span> &#123;<br> <br>        <span class="hljs-type">String</span> <span class="hljs-variable">sql1</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;insert into t_user_account (user_id) values (?)&quot;</span>;<br>        jdbcTemplate.update(sql1,userVO.getId());<br>        <span class="hljs-type">String</span> <span class="hljs-variable">sql2</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;insert into t_user_idcard (user_id) values (?)&quot;</span>;<br>        jdbcTemplate.update(sql2,userVO.getId());<br>        <span class="hljs-type">String</span> <span class="hljs-variable">sql3</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;insert into t_user_phone (user_id) values (?)&quot;</span>;<br>        jdbcTemplate.update(sql3,userVO.getId());<br>    &#125;<br> <br>    <span class="hljs-meta">@Transactional(propagation = Propagation.REQUIRED)</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">register</span><span class="hljs-params">(UserVO userVO)</span> &#123;<br>        <span class="hljs-comment">//插入账号密码</span><br>        userDao.insertAccountAndPwd(userVO);<br>        <span class="hljs-comment">//再插入手机号</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">sql1</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;update t_user_phone set phone_num = ? where user_id = ?&quot;</span>;<br>        jdbcTemplate.update(sql1,userVO.getPhoneNum(),userVO.getId());<br>        <span class="hljs-keyword">if</span> (userVO.getPhoneNum() == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;手机号码不能为空&quot;</span>);<br>        &#125;<br>        <span class="hljs-comment">//插入身份证号和姓名</span><br>        userDao.insertIDcardAndName(userVO);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>注：这里选择抛出的是RuntimeException，该异常是运行时异常，如果不做异常回滚的配置，默认非运行时异常（比如我刚开始抛出的是Exception），则不会发生回滚。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserDao</span> &#123;<br>    <span class="hljs-comment">//插入账户和密码</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertAccountAndPwd</span><span class="hljs-params">(UserVO userVO)</span>;<br> <br>    <span class="hljs-comment">//插入身份证号和姓名</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertIDcardAndName</span><span class="hljs-params">(UserVO userVO)</span>;<br> <br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Repository</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDaoImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserDao</span> &#123;<br> <br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> JdbcTemplate jdbcTemplate;<br> <br>    <span class="hljs-meta">@Transactional(propagation = Propagation.REQUIRED)</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertAccountAndPwd</span><span class="hljs-params">(UserVO userVO)</span> &#123;<br> <br>        <span class="hljs-type">String</span> <span class="hljs-variable">sql1</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;update t_user_account set user_account = ?, user_pwd = ? where user_id = ?&quot;</span>;<br>        jdbcTemplate.update(sql1,userVO.getUserAccount(),userVO.getUserPwd(),userVO.getId());<br>        <span class="hljs-keyword">if</span> (userVO.getUserAccount() == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;账号不能为空&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (userVO.getUserPwd() == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;密码不能为空&quot;</span>);<br>        &#125;<br>    &#125;<br> <br>    <span class="hljs-meta">@Transactional(propagation = Propagation.REQUIRED)</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertIDcardAndName</span><span class="hljs-params">(UserVO userVO)</span> &#123;<br>        <span class="hljs-comment">//先将新用户的身份证号和姓名插入</span><br> <br>        <span class="hljs-type">String</span> <span class="hljs-variable">sql1</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;update t_user_idcard set ID_card = ?, user_name = ? where user_id = ?&quot;</span>;<br>        jdbcTemplate.update(sql1,userVO.getIDCard(),userVO.getUserName(),userVO.getId());<br>        <span class="hljs-keyword">if</span> (userVO.getIDCard() == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;身份证号不能为空&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (userVO.getUserName() == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;姓名不能为空&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>测试</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringJUnitConfig(locations = &quot;classpath:txSpreadBean.xml&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestTxSpread</span> &#123;<br> <br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserController userController;<br> <br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test2</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">UserVO</span> <span class="hljs-variable">userVO1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserVO</span>(<span class="hljs-number">1L</span>,<span class="hljs-string">&quot;花花&quot;</span>,<span class="hljs-string">&quot;123456&quot;</span>,<span class="hljs-literal">null</span>,<span class="hljs-string">&quot;花木兰&quot;</span>,<span class="hljs-string">&quot;511387197807180001&quot;</span>);<br>        userController.register(userVO1);<br> <br>        <span class="hljs-type">UserVO</span> <span class="hljs-variable">userVO2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserVO</span>(<span class="hljs-number">2L</span>,<span class="hljs-string">&quot;花花&quot;</span>,<span class="hljs-string">&quot;123456&quot;</span>,<span class="hljs-string">&quot;13612312345&quot;</span>,<span class="hljs-string">&quot;花木兰&quot;</span>,<span class="hljs-literal">null</span>);<br>        userController.register(userVO2);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>在该示例中涉及事务传播行为要点的是UserServiceImpl的register方法。</p><p>register方法：是外围方法，除了调用了insertAccountAndPwd方法和insertIDcardAndName方法外，直接调用jdbcTemplate进行手机号的插入。</p><p>insertAccountAndPwd方法：是内围方法，进行账号密码的插入。</p><p>insertIDcardAndName方法：是内围方法，进行身份证号、姓名的插入。</p></blockquote><h4 id="场景1"><a href="#场景1" class="headerlink" title="场景1"></a>场景1</h4><p>我们要实现登录账号、密码、手机号、身份证号、姓名，这些都不能为空，<strong>如果其中一个发生异常，那么其余已经插入的全部回滚。</strong></p><p>根据这个业务及我们当前代码结构，我们需要在这一个外围方法和两个内围方法中都添加@Transactional注解，因为要求有异常，只要有数据库改动的代码全部回滚。</p><p><strong>传播行为选择</strong></p><blockquote><p>将<code>@Transactional</code>的事务传播属性propagation值设为<code>Propagation.REQUIRED</code></p><p>这个值是默认的，它的含义是：如果当前没有事务，就新建一个事务，如果已经存在一个事务中，加入到这个事务中。</p><p>这正好符合我们业务需求：外围方法已经是一个事务后，被调用的两个内围方法也加入到这个事务中，就实现了只要有任意一个异常，只会插入一个id，其余需要插入的登录账号、密码、手机号、身份证号、姓名都回滚。</p></blockquote><p>测试：</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Spring/521ab1ee8e694e4d9fd1a41ce37dc036.png" alt="img"></p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Spring/599b446f0ad0440a9ed20ebaa3d90260.png" alt="img"></p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Spring/db7df0bd3fb8405d8d6fe9d6c856976a.png" alt="img"></p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Spring/7b8e1b5dd2b0404284df697e248c4afe.png" alt="img"></p><blockquote><p>可以看见：只要一个方法内有异常，这三个方法都会回滚，数据库里没有一个表中有新记录。</p></blockquote><h4 id="场景2"><a href="#场景2" class="headerlink" title="场景2"></a>场景2</h4><p>业务逻辑改为注册时可以不提交身份证号与姓名（但是身份证号和姓名必须同时添加或不添加），后续确定后再提交即可，账号密码和手机号仍然不可缺少，少一个则全部回滚。</p><p>那么这里我们仍保持内围方法insertIDcardAndName方法为事务，外围方法register和内围方法insertAccountAndPwd也为事务，但是要保证insertIDcardAndName方法出现异常时不能导致外围方法回滚。</p><p>导致外围回滚有两种途径，一个是内围方法出现异常后会抛出给外围方法，然后外围方法的@Transactional感知到异常回滚，另一个是外围方法与内围方法本事是一个事务，那么内围方法回滚的时候自然会使外围方法也会滚。</p><p><strong>传播行为选择</strong></p><p>首先要在外围方法中将内围方法insertIDcardAndName的异常捕获，<strong>不能再使用REQUIRED为事务传播属性了</strong>，因为内围方法事务传播属性为REQUIRED代表加入到外围方法的事务中，会同时回滚。将@Transactional的事务传播属性propagation值设为<strong>Propagation.NESTED</strong>，它的含义是：如果当前存在事务，则在嵌套事务内执行。如果当前没有事务，就新建一个事务。这正好符合我们业务需求：外围方法是一个事务的情况下，我们的内围方法有异常只需要回滚自己就行，外围方法有异常才回滚全部。</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Spring/4feb68dcda764293b540821b3881ed02.png" alt="img"></p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Spring/a62d73850cb34503b124652f27eb4159.png" alt="img"></p><p>测试：</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Spring/9fdf991c5a914488b6f10896be7e30d9.png" alt="img"></p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Spring/1f3ef4a7139a490282092cb1d9db249d.png" alt="img"></p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Spring/5b07b1ad0c8f41dbbd44faf9eb5c3334.png" alt="img"></p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Spring/17b715b890344d5aa54d58533549be57.png" alt="img"></p><blockquote><p>上边我们通过引起这三个方法（一个外围、两个内围）内的异常，发现当insertIDcardAndName方法有异常，并不会导致外围方法register和内围方法insertAccountAndPwd回滚。</p></blockquote><h4 id="场景3"><a href="#场景3" class="headerlink" title="场景3"></a>场景3</h4><p>注册时可以不提交身份证号与姓名（但是身份证号和姓名必须同时添加或不添加），也可以不提交手机号，后续确定后再提交即可，账号密码和手机号仍然不可缺少，少一个则全部回滚。</p><p><strong>传播行为选择</strong></p><p>上次业务修改我们只要保证内围方法insertIDcardAndName回滚不带上外围方法回滚，这次我们还要保证外围方法register回滚时不要带上内围方法insertAccountAndPwd回滚。</p><p>所以这次我们可以将@Transactional的事务传播属性propagation值设为<strong>Propagation.REQUIRES_NEW</strong>，它的含义是：如果当前没有事务，就新建一个事务。如果当前存在事务，把当前事务挂起，并且自己创建一个新的事务给自己使用。</p><p>这正好符合我们业务需求：外围方法是一个事务的情况下，我们的内围方法开始它自己的业务，外围方法回滚不带上内围方法。</p><p>测试</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Spring/45b994b6edce413d87afbb416230793a.png" alt="img"></p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Spring/652913bdfebb49eebc6e913678d8b731.png" alt="img"></p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Spring/700a2667522d40bf8a4f45af8e5e42cc.png" alt="img"></p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Spring/a7ca59a0dc4e489dadb1b1dce1e52296.png" alt="img"></p><blockquote><p>上边我们通过引起这三个方法（一个外围、两个内围）内的异常，发现当外围方法register方法有异常，并不会导致内围方法insertAccountAndPwd回滚。</p></blockquote><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>当我们不想让内围回滚带上外围也回滚，内围方法事务就不要使用REQUIRED，可以使用NESTED或REQUIRES_NEW。</p><p>当我们不想让外围回滚带上内围也回滚，内围方法事务就不要使用REQUIRED和NESTED，可以使用REQUIRES_NEW。</p>]]></content>
    
    
    <categories>
      
      <category>spring</category>
      
    </categories>
    
    
    <tags>
      
      <tag>spring</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>spring基础知识-AOP</title>
    <link href="/spring%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86-AOP/a8d960500940/"/>
    <url>/spring%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86-AOP/a8d960500940/</url>
    
    <content type="html"><![CDATA[<h1 id="1-原理"><a href="#1-原理" class="headerlink" title="1 原理"></a>1 原理</h1><ul><li><p><strong>面向切面编程</strong>，利用 AOP 可以对业务逻辑的各个部分进行隔离，从而使得<strong>业务逻辑各部分之间的耦合度降低</strong>，提高程序的可重用性，同时提高了开发的效率。通俗来说就是<strong>在不修改代码的情况下添加新的功能。</strong></p></li><li><p>底层通过动态代理来实现：</p><ul><li>第一种：<strong>有接口的情况</strong>，使用JDK动态代理：<strong>创建接口实现类的代理对象</strong>。</li><li>第二种：<strong>无接口的情况</strong>，使用CGLIB动态代理：<strong>创建当前类子类的代理对象</strong>。</li></ul></li></ul><h2 id="JDK动态代理"><a href="#JDK动态代理" class="headerlink" title="JDK动态代理"></a>JDK动态代理</h2><ol><li>通过 java.lang.reflect.Proxy类 的 newProxyInstance方法 创建代理类。<ol><li>newProxyInstance方法：</li></ol></li></ol><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Spring/95dd9d0804e03a9505f51dea7f3f49d2.png" alt="image-20210801004308007"></p><pre><code class="hljs">1. 参数一：类加载器1. 参数二：所增强方法所在的类，这个类实现的接口，支持多个接口1. 参数三：实现InvocationHandle接口，重写invoke方法来添加新的功能</code></pre><p>接口：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserDao</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">multi</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>实现类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDaoImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserDao</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> &#123;<br>        <span class="hljs-keyword">return</span> a+b;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">multi</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> &#123;<br>        <span class="hljs-keyword">return</span> a*b;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>增强类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDaoProxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InvocationHandler</span> &#123;<br>      Object obj;<br>  <span class="hljs-comment">//通过有参构造函数将所需代理的类传过来</span><br>      <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserDaoProxy</span><span class="hljs-params">(Object obj)</span>&#123;<br>          <span class="hljs-built_in">this</span>.obj = obj;<br>      &#125;<br><br>      <span class="hljs-meta">@Override</span><br>      <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br><br>          System.out.println(<span class="hljs-string">&quot;进入&quot;</span> + method.getName() + <span class="hljs-string">&quot;方法，这是新增的代码，参数有&quot;</span> + Arrays.toString(args));<br><br>    <span class="hljs-comment">//执行原有的代码</span><br>          <span class="hljs-type">Object</span> <span class="hljs-variable">invoke</span> <span class="hljs-operator">=</span> method.invoke(obj, args);<br><br>          System.out.println(<span class="hljs-string">&quot;方法原先的内容执行完了&quot;</span>);<br><br>          <span class="hljs-keyword">return</span> invoke;<br>      &#125;<br>  &#125;<br></code></pre></td></tr></table></figure><p>测试：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test1</span><span class="hljs-params">()</span>&#123;<br><br>        <span class="hljs-comment">//所需代理的类实现的接口，支持多个接口</span><br>        Class[] interfaces = &#123;UserDao.class&#125;;<br><br>        <span class="hljs-type">UserDao</span> <span class="hljs-variable">userDao</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserDaoImpl</span>();<br>        <br><span class="hljs-comment">//调用newProxyInstance方法来创建代理类</span><br>        <span class="hljs-type">UserDao</span> <span class="hljs-variable">userDaoProxy</span> <span class="hljs-operator">=</span> (UserDao) Proxy.newProxyInstance(Main.class.getClassLoader(), interfaces, <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserDaoProxy</span>(userDao));<br><br>        <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> userDaoProxy.add(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>);<br>        System.out.println(result);<br>    &#125;<br>    <br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Spring/20210801005210.png" alt="image-20210801005210363"></p><h2 id="CGLIB动态代理"><a href="#CGLIB动态代理" class="headerlink" title="CGLIB动态代理"></a>CGLIB动态代理</h2><p>目标类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TargetClass</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doSomething</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;目标方法&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>实现MethodInterceptor接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> net.sf.cglib.proxy.MethodInterceptor;<br><span class="hljs-keyword">import</span> net.sf.cglib.proxy.MethodProxy;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomMethodInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MethodInterceptor</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">intercept</span><span class="hljs-params">(Object obj, Method method, Object[] args, MethodProxy proxy)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>        System.out.println(<span class="hljs-string">&quot;执行目标方法之前&quot;</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> proxy.invokeSuper(obj, args);<br>        System.out.println(<span class="hljs-string">&quot;执行目标方法之后&quot;</span>);<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>测试</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> net.sf.cglib.proxy.Enhancer;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CglibDynamicProxyDemo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Enhancer</span> <span class="hljs-variable">enhancer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Enhancer</span>();<br>        enhancer.setSuperclass(TargetClass.class);   <span class="hljs-comment">//将代理类作为父类</span><br>        enhancer.setCallback(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomMethodInterceptor</span>());<br><br>        <span class="hljs-type">TargetClass</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> (TargetClass) enhancer.create();<br>        proxy.doSomething();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>结果</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs">执行目标方法之前<br>目标方法<br>执行目标方法之后<br></code></pre></td></tr></table></figure><h1 id="2-基于AspectJ实现AOP操作"><a href="#2-基于AspectJ实现AOP操作" class="headerlink" title="2 基于AspectJ实现AOP操作"></a>2 基于AspectJ实现AOP操作</h1><h2 id="AOP相关术语"><a href="#AOP相关术语" class="headerlink" title="AOP相关术语"></a>AOP相关术语</h2><ol><li>连接点：类中可以被增强的方法，称为连接点。</li><li>切入点：实际被增强的方法，称为切入点。</li><li>通知：增强的那一部分逻辑代码。通知有多种类型：<ol><li>前置通知：增强部分代码在原代码前面。</li><li>后置通知：增强部分代码在原代码后面。</li><li>环绕通知：增强部分代码既有在原代码前面，也有在原代码后面。</li><li>异常通知：原代码发生异常后才会执行。</li><li>最终通知：类似与finally那一部分</li></ol></li><li>切面：指把通知应用到切入点这一个动作。</li></ol><h2 id="切入点表达式"><a href="#切入点表达式" class="headerlink" title="切入点表达式"></a>切入点表达式</h2><p><strong>语法：execution（[权限修饰符] [返回类型] [类全路径] [方法名称] [参数列表]）</strong></p><ol><li><p>对 com.atguigu.dao.BookDao 类里面的 add 进行增强</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">execution(* com.auguigu.dao.BookDao.add(..))<br></code></pre></td></tr></table></figure></li><li><p>对 com.atguigu.dao.BookDao 类里面的所有的方法进行增强</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">execution(* com.atguigu.dao.BookDao.*(..))<br></code></pre></td></tr></table></figure></li><li><p>对 com.atguigu.dao 包里面所有类，类里面所有方法进行增强</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">execution(* com.atguigu.dao.*.* (..))<br></code></pre></td></tr></table></figure></li></ol><h2 id="基于注解实现AOP"><a href="#基于注解实现AOP" class="headerlink" title="基于注解实现AOP"></a>基于注解实现AOP</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">()</span>&#123;    <br>        System.out.println(<span class="hljs-string">&quot;User.add()&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Aspect</span>   <span class="hljs-comment">//使用Aspect注解</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserProxy</span> &#123;<br>    <span class="hljs-comment">//前置通知</span><br>    <span class="hljs-meta">@Before(value=&quot;execution(* com.oymn.spring5.User.add(..))&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">before</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;UserProxy.before()&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-comment">//后置通知</span><br>    <span class="hljs-meta">@AfterReturning(value=&quot;execution(* com.oymn.spring5.User.add(..))&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterReturning</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;UserProxy.afterReturning()&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-comment">//最终通知</span><br>    <span class="hljs-meta">@After(value=&quot;execution(* com.oymn.spring5.User.add(..))&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">After</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;UserProxy.After()&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//异常通知</span><br>    <span class="hljs-meta">@AfterThrowing(value=&quot;execution(* com.oymn.spring5.User.add(..))&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">AfterThrowing</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;UserProxy.AfterThrowing()&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//环绕通知</span><br>    <span class="hljs-meta">@Around(value=&quot;execution(* com.oymn.spring5.User.add(..))&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Around</span><span class="hljs-params">(ProceedingJoinPoint proceedingJoinPoint)</span> <span class="hljs-keyword">throws</span> Throwable&#123;<br><br>        System.out.println(<span class="hljs-string">&quot;UserProxy.Around()   _1&quot;</span>);<br><br>        <span class="hljs-comment">//调用proceed方法执行原先部分的代码</span><br>        proceedingJoinPoint.proceed();<br><br>        System.out.println(<span class="hljs-string">&quot;UserProxy.Around()   _2&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>配置类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@ComponentScan(basePackages = &quot;com.oymn.spring5&quot;)</span><br><span class="hljs-meta">@EnableAspectJAutoProxy(proxyTargetClass = true)</span>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Config</span> &#123;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>测试</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test2</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">ClassPathXmlApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathXmlApplicationContext</span>(<span class="hljs-string">&quot;bean1.xml&quot;</span>);<br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> context.getBean(<span class="hljs-string">&quot;user&quot;</span>, User.class);<br>    user.add();<br>&#125;<br></code></pre></td></tr></table></figure><p>输出<br><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Spring/20210801210024.png" alt="image-20210801210024676"></p><p>异常</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>/<span class="hljs-number">0</span>;<br>    System.out.println(<span class="hljs-string">&quot;User.add()&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Spring/20210801210304.png" alt="image-20210801210304774"></p><p>对于上面的例子，有很多通知的切入点都是相同的方法，因此，可以将<strong>该切入点进行抽取：通过@Pointcut注解</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Pointcut(value=&quot;execution(* com.oymn.spring5.User.add(..))&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">pointDemo</span><span class="hljs-params">()</span>&#123;<br>    <br>&#125;<br><br><span class="hljs-comment">//前置通知</span><br><span class="hljs-meta">@Before(value=&quot;pointDemo()&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">before</span><span class="hljs-params">()</span>&#123;<br>    System.out.println(<span class="hljs-string">&quot;UserProxy.before()&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="优先级"><a href="#优先级" class="headerlink" title="优先级"></a>优先级</h3><p>当有多个增强类对同一方法进行增强时，可以通过**@Order（数字值）来设置增强类的优先级，数字越小优先级越高。**</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Aspect</span><br><span class="hljs-meta">@Order(1)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PersonProxy</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>spring</category>
      
    </categories>
    
    
    <tags>
      
      <tag>spring</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>spring基础知识-IOC</title>
    <link href="/spring%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86-IOC/245be0057711/"/>
    <url>/spring%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86-IOC/245be0057711/</url>
    
    <content type="html"><![CDATA[<h1 id="1-Spring概述"><a href="#1-Spring概述" class="headerlink" title="1 Spring概述"></a>1 Spring概述</h1><ol><li><p>Spring 是轻量级的开源的 JavaEE 框架</p></li><li><p>Spring 有两个核心部分：IOC 和 AOP。</p><ol><li>IOC：控制反转，把创建对象过程交给 Spring 进行管理</li><li>AOP：面向切面，不修改源代码进行功能增强</li></ol></li><li><p>Spring 特点 ：</p><ol><li>方便解耦，简化开发</li><li>Aop 编程支持</li><li>方便程序测试</li><li>方便和其他框架进行整合</li><li>方便进行事务操作</li><li>降低 API 开发难度</li></ol></li></ol><h1 id="2-IOC"><a href="#2-IOC" class="headerlink" title="2 IOC"></a>2 IOC</h1><p>概念：控制反转，把对象创建和对象的调用过程交给spring进行管理。</p><p>目标：<strong>降低耦合度。</strong></p><p>底层原理：<strong>xml，反射，工厂模式</strong></p><h2 id="2-1-两大接口"><a href="#2-1-两大接口" class="headerlink" title="2.1 两大接口"></a>2.1 两大接口</h2><p>Spring提供IOC容器两种实现方式（两个接口）</p><ol><li><p>BeanFactory：Spring内部使用的接口，不提倡开发人员使用。特点：加载配置文件时不会创建对象，获取对象时才会创建对象。</p></li><li><p><strong>ApplicationContext：</strong>BeanFactory的子接口，提供了更多更强大的功能，一般由开发人员使用。特点：加载配置文件时会把配置文件里的对象进行创建。</p><ol><li>FileSystemXmlApplicationContext：绝对路径，从盘符开始算起</li><li>ClassPathXmlApplicationContext：相对路径，从src开始算起</li></ol></li><li><p>Bean管理是指两个操作：Spring创建对象 和 Spring注入属性。</p><ol><li>Bean管理有两种操作方式：基于xml配置文件方式实现 和 基于注解方式实现</li></ol></li></ol><h2 id="2-2-基于XML操作Bean"><a href="#2-2-基于XML操作Bean" class="headerlink" title="2.2 基于XML操作Bean"></a>2.2 基于XML操作Bean</h2><p>在基于xml创建对象的时候需要做到：</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/SpringCloud/20210719101725.png" alt="image-20210719101725911"></p><ol><li>在Spring配置文件中使用bean标签来创建对象</li><li>bean标签有很多属性，常用属性：<ul><li>id：唯一标识</li><li>class：类路径</li></ul></li><li><strong>创建对象时，默认执行无参构造函数</strong></li></ol><h3 id="方法一："><a href="#方法一：" class="headerlink" title="方法一："></a>方法一：</h3><blockquote><ol><li><p>为对应类提供set方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> &#123;<br><br>    <span class="hljs-keyword">private</span> String userName;<br>    <span class="hljs-keyword">private</span> String userAge;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUserName</span><span class="hljs-params">(String userName)</span> &#123;<br>        <span class="hljs-built_in">this</span>.userName = userName;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUserAge</span><span class="hljs-params">(String userAge)</span> &#123;<br>        <span class="hljs-built_in">this</span>.userAge = userAge;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getUserName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> userName;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getUserAge</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> userAge;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure></li><li><p>在xml配置文件中通过property标签进行属性注入</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--配置User对象--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;user&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.oymn.spring5.User&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;userName&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;haha&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;userAge&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;18&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>创建对象</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathXmlApplicationContext</span>(<span class="hljs-string">&quot;bean1.xml&quot;</span>);<br><span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> applicationContext.getBean(<span class="hljs-string">&quot;user&quot;</span>, User.class);<br>System.out.println(user.getUserName() + <span class="hljs-string">&quot;     &quot;</span> + user.getUserAge());<br></code></pre></td></tr></table></figure></li></ol></blockquote><h4 id="注入值"><a href="#注入值" class="headerlink" title="注入值"></a>注入值</h4><h5 id="空值"><a href="#空值" class="headerlink" title="空值"></a>空值</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--配置User对象--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;user&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.oymn.spring5.User&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;userName&quot;</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">null</span>/&gt;</span> <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br></code></pre></td></tr></table></figure><h5 id="属性值含有特殊符号"><a href="#属性值含有特殊符号" class="headerlink" title="属性值含有特殊符号"></a>属性值含有特殊符号</h5><p>假设现在userName属性需要赋值为 &lt; haha &gt;</p><p>如果像上面那样直接在value中声明的话会报错，因为包含特殊符号 &lt;&gt;</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/SpringCloud/image-20240414102602634.png" alt="image-20240414102602634"></p><h5 id="注入外部Bean"><a href="#注入外部Bean" class="headerlink" title="注入外部Bean"></a>注入外部Bean</h5><p>有两个类：UserService和UserDaoImpl，其中UserDaoImpl实现UserDao接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> &#123;<br><br>    <span class="hljs-keyword">private</span> UserDao userDao;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUserDao</span><span class="hljs-params">(UserDao userDao)</span>&#123;<br>        <span class="hljs-built_in">this</span>.userDao = userDao;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;add&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>使用ref来指定外部bean</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;userDaoImpl&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.oymn.spring5.UserDaoImpl&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;userService&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.oymn.spring5.UserService&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;userDao&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;userDaoImpl&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br></code></pre></td></tr></table></figure><h5 id="注入内部bean"><a href="#注入内部bean" class="headerlink" title="注入内部bean"></a>注入内部bean</h5><p>嵌套bean标签实现</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--内部 bean--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;emp&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.atguigu.spring5.bean.Emp&quot;</span>&gt;</span><br>     <span class="hljs-comment">&lt;!--设置两个普通属性--&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;ename&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;lucy&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;gender&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;女&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>     <span class="hljs-comment">&lt;!--设置对象类型属性--&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;dept&quot;</span>&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;dept&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.atguigu.spring5.bean.Dept&quot;</span>&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;dname&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;安保部&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>         <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br>     <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="方法二："><a href="#方法二：" class="headerlink" title="方法二："></a>方法二：</h3><blockquote><ol><li><p>提供有参构造</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> &#123;<br><br>    <span class="hljs-keyword">private</span> String userName;<br>    <span class="hljs-keyword">private</span> String userAge;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">User</span><span class="hljs-params">(String userName, String userAge)</span>&#123;<br>        <span class="hljs-built_in">this</span>.userName = userName;<br>        <span class="hljs-built_in">this</span>.userAge = userAge;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure></li><li><p>xml中通过constructor-arg标签进行属性注入</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--配置User对象--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;user&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.oymn.spring5.User&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;userName&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;haha&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">constructor-arg</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;userAge&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;18&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">constructor-arg</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br></code></pre></td></tr></table></figure></li></ol></blockquote><h4 id=""><a href="#" class="headerlink" title=""></a></h4><h4 id="注入值-1"><a href="#注入值-1" class="headerlink" title="注入值"></a>注入值</h4><h5 id="级联赋值"><a href="#级联赋值" class="headerlink" title="级联赋值"></a>级联赋值</h5><p>emp类中有ename和dept两个属性，其中dept有dname属性，写法二需要emp提供dept属性的get方法。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--级联赋值--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;emp&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.atguigu.spring5.bean.Emp&quot;</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--设置两个普通属性--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;ename&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;lucy&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;gender&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;女&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--写法一--&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;dept&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;dept&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--写法二--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;dept.dname&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;技术部&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;dept&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.atguigu.spring5.bean.Dept&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;dname&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;财务部&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br></code></pre></td></tr></table></figure><h5 id="注入属性集合-数组-List-Map-Set"><a href="#注入属性集合-数组-List-Map-Set" class="headerlink" title="注入属性集合-数组&#x2F;List&#x2F;Map&#x2F;Set"></a>注入属性集合-数组&#x2F;List&#x2F;Map&#x2F;Set</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Stu</span> &#123;<br><br>    <span class="hljs-keyword">private</span> String[] courses;<br>    <span class="hljs-keyword">private</span> List&lt;String&gt; list;<br>    <span class="hljs-keyword">private</span> Map&lt;String,String&gt; map;<br>    <span class="hljs-keyword">private</span> Set&lt;String&gt; set;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setCourses</span><span class="hljs-params">(String[] courses)</span> &#123;<br>        <span class="hljs-built_in">this</span>.courses = courses;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setList</span><span class="hljs-params">(List&lt;String&gt; list)</span> &#123;<br>        <span class="hljs-built_in">this</span>.list = list;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setMap</span><span class="hljs-params">(Map&lt;String, String&gt; map)</span> &#123;<br>        <span class="hljs-built_in">this</span>.map = map;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setSet</span><span class="hljs-params">(Set&lt;String&gt; set)</span> &#123;<br>        <span class="hljs-built_in">this</span>.set = set;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;stu&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.oymn.spring5.Stu&quot;</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--数组类型属性注入--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;courses&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">array</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>java课程<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>数据库课程<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">array</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--List类型属性注入--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;list&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">list</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>张三<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>李四<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">list</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--Map类型属性注入--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;map&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">map</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">entry</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;JAVA&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;java&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">entry</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">entry</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;PHP&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;php&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">entry</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">map</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--Set类型属性注入--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;set&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">set</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>Mysql<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>Redis<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">set</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br></code></pre></td></tr></table></figure><blockquote><p>如果是对象的话，写法：集合+外部bean</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--创建多个 course 对象--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;course1&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.atguigu.spring5.collectiontype.Course&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;cname&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;Spring5 框架&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;course2&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.atguigu.spring5.collectiontype.Course&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;cname&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;MyBatis 框架&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br><span class="hljs-comment">&lt;!--注入 list 集合类型，值是对象--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;courseList&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">list</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">ref</span> <span class="hljs-attr">bean</span>=<span class="hljs-string">&quot;course1&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">ref</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">ref</span> <span class="hljs-attr">bean</span>=<span class="hljs-string">&quot;course2&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">ref</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">list</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br></code></pre></td></tr></table></figure></blockquote><blockquote><p>把集合注入部分提取出来</p><p>使用 util 标签，这样不同的bean都可以使用相同的集合注入部分了。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--将集合注入部分提取出来--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">util:list</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;booklist&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>易筋经<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>九阳神功<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">util:list</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;book&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.oymn.spring5.Book&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;list&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;booklist&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br></code></pre></td></tr></table></figure></blockquote><h3 id="Bean的作用域"><a href="#Bean的作用域" class="headerlink" title="Bean的作用域"></a>Bean的作用域</h3><p>在Spring中，<strong>默认Bean是单实例对象</strong>。但是可以通过修改Bean标签中的scope属性，让单例对象变为多实例对象。</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Spring/20210719113500.png" alt="image-20210719113500730"></p><h3 id="Bean的生命周期"><a href="#Bean的生命周期" class="headerlink" title="Bean的生命周期"></a>Bean的生命周期</h3><ol><li>通过构造器创建 bean 实例（无参数构造）</li><li>为 bean 的属性设置值和对其他 bean 引用（调用 set 方法）</li><li>把 bean 实例传递 bean 后置处理器的方法 postProcessBeforeInitialization</li><li>调用 bean 的初始化的方法（需要进行配置初始化的方法）</li><li>把 bean 实例传递 bean 后置处理器的方法 postProcessAfterInitialization</li><li>bean 可以使用了（对象获取到了）</li><li>当容器关闭时候，调用 bean 的销毁的方法（需要进行配置销毁的方法）</li></ol><h4 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Orders</span> &#123;<br>    <span class="hljs-keyword">private</span> String orderName;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Orders</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;第一步：执行无参构造方法创建bean实例&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setOrderName</span><span class="hljs-params">(String orderName)</span> &#123;<br>        <span class="hljs-built_in">this</span>.orderName = orderName;<br>        System.out.println(<span class="hljs-string">&quot;第二步：调用set方法设置属性值&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//初始化方法</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initMethod</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;第四步：执行初始化方法&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//销毁方法</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroyMethod</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;第七步：执行销毁方法&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>后置处理器</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//实现后置处理器，需要实现BeanPostProcessor接口</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyBeanPost</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BeanPostProcessor</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">postProcessBeforeInitialization</span><span class="hljs-params">(Object bean, String beanName)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>        System.out.println(<span class="hljs-string">&quot;第三步：将bean实例传递给bean后置处理器的postProcessBeforeInitialization方法&quot;</span>);<br>        <span class="hljs-keyword">return</span> bean;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">postProcessAfterInitialization</span><span class="hljs-params">(Object bean, String beanName)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>        System.out.println(<span class="hljs-string">&quot;第五步：将bean实例传递给bean后置处理器的postProcessAfterInitialization方法&quot;</span>);<br>        <span class="hljs-keyword">return</span> bean;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>xml创建对象</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;orders&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.oymn.spring5.Orders&quot;</span> <span class="hljs-attr">init-method</span>=<span class="hljs-string">&quot;initMethod&quot;</span> <span class="hljs-attr">destroy-method</span>=<span class="hljs-string">&quot;destroyMethod&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;orderName&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;hahah&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br><span class="hljs-comment">&lt;!--配置bean后置处理器，这样配置后整个xml里面的bean用的都是这个后置处理器--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;myBeanPost&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.oymn.spring5.MyBeanPost&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br></code></pre></td></tr></table></figure><p>测试</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testOrders</span><span class="hljs-params">()</span>&#123;<br><br>    <span class="hljs-type">ClassPathXmlApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathXmlApplicationContext</span>(<span class="hljs-string">&quot;bean1.xml&quot;</span>);<br><br>    <span class="hljs-type">Orders</span> <span class="hljs-variable">orders</span> <span class="hljs-operator">=</span> context.getBean(<span class="hljs-string">&quot;orders&quot;</span>, Orders.class);<br><br>    System.out.println(<span class="hljs-string">&quot;第六步：获取bean实例对象&quot;</span>);<br>    System.out.println(orders);<br><br>    <span class="hljs-comment">//手动让bean实例销毁</span><br>    context.close();<br>&#125;<br></code></pre></td></tr></table></figure><p>执行结果</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Spring/20210720122628.png" alt="image-20210720122628081"></p><h3 id="XML自动装配"><a href="#XML自动装配" class="headerlink" title="XML自动装配"></a>XML自动装配</h3><ul><li>根据指定的装配规则（属性名称或者属性类型），Spring自动将匹配的属性值进行注入。</li><li>根据属性名称自动装配：要求 emp中属性的名称dept 和 bean标签的id值dept 一样，才能识别。</li><li>根据属性类型自动装配：要求同一个xml文件中不能有两个相同类型的bean，否则无法识别是哪一个</li></ul><h3 id="通过外部文件操作Bean"><a href="#通过外部文件操作Bean" class="headerlink" title="通过外部文件操作Bean"></a>通过外部文件操作Bean</h3><ol><li>导入德鲁伊连接池jar包</li><li>创建外部属性文件，properties格式文件，写数据库信息</li></ol><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Spring/20210731004522.png" alt="image-20210731004522456"></p><ol start="3"><li>引入context名称空间，并通过context标签引入外部属性文件，使用“${}”来获取文件中对应的值</li></ol><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Spring/a6aa7ccefe1d0a49cc0729a056c8086b.png" alt="image-20210731010320233"></p><h2 id="2-3-基于注解操作Bean"><a href="#2-3-基于注解操作Bean" class="headerlink" title="2.3 基于注解操作Bean"></a>2.3 基于注解操作Bean</h2><ul><li>格式：@注解名称（属性名&#x3D;属性值，属性名&#x3D;属性值，……）</li><li>注解可以作用在类，属性，方法。</li><li>使用注解的目的：简化xml配置</li></ul><h3 id="创建对象"><a href="#创建对象" class="headerlink" title="创建对象"></a>创建对象</h3><ul><li>@Component：将该类标记为一个组件，Spring会自动扫描该类，并将其实例化为一个Bean。</li><li>@Service：一般用于Service层</li><li>@Controller：一般用于web层</li><li>@ Repository：一般用于Dao层</li></ul><h3 id="基于注解进行属性注入"><a href="#基于注解进行属性注入" class="headerlink" title="基于注解进行属性注入"></a>基于注解进行属性注入</h3><p><strong>@Autowired</strong>：根据属性类型自动装配</p><blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">StuDao</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">()</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Repository</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StuDaoImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">StuDao</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;StuDaoImpl&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component(value=&quot;stuService&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StuService</span> &#123;<br>    <br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">public</span> StuDao stuDao;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;addService&quot;</span>);<br>        stuDao.add();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></blockquote><p><strong>@Qualifier</strong>：根据属性名称自动装配</p><blockquote><p>当遇到一个接口有很多实现类时，只通过@Autowire是无法完成自动装配的，所以需要再使用@Qualifier通过名称来锁定某个类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component(value=&quot;stuService&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StuService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-meta">@Qualifier(value=&quot;stuDaoImpl&quot;)</span>  <span class="hljs-comment">//这样就能显式指定stuDaoImpl这个实现类</span><br>    <span class="hljs-keyword">public</span> StuDao stuDao;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;addService&quot;</span>);<br>        stuDao.add();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></blockquote><p><strong>@Resource</strong>：可以根据类型注入，也可以根据名称注入</p><blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component(value=&quot;stuService&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StuService</span> &#123;<br>    <br>    <span class="hljs-comment">//@Resource   //根据类型进行注入</span><br>    <span class="hljs-meta">@Resource(name=&quot;stuDaoImpl&quot;)</span>  <span class="hljs-comment">//根据名称进行注入</span><br>    <span class="hljs-keyword">public</span> StuDao stuDao;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;addService&quot;</span>);<br>        stuDao.add();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></blockquote><p><strong>@Value</strong>：注入普通类型属性</p><blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Value(value = &quot;abc&quot;)</span><br><span class="hljs-keyword">private</span> String name;<br></code></pre></td></tr></table></figure></blockquote><h3 id="完全基于注解开发"><a href="#完全基于注解开发" class="headerlink" title="完全基于注解开发"></a>完全基于注解开发</h3><p>创建配置类替代XML文件</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span>    <span class="hljs-comment">//表明为一个配置类</span><br><span class="hljs-meta">@ComponentScan(basePackages = &quot;com.oymn&quot;)</span>   <span class="hljs-comment">//开启组件扫描</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringConfig</span> &#123;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>spring</category>
      
    </categories>
    
    
    <tags>
      
      <tag>spring</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>springcloud微服务技术栈-04</title>
    <link href="/springclou%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%A0%88-04/016cd1d7bfed/"/>
    <url>/springclou%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%A0%88-04/016cd1d7bfed/</url>
    
    <content type="html"><![CDATA[]]></content>
    
    
    <categories>
      
      <category>springcloud</category>
      
    </categories>
    
    
    <tags>
      
      <tag>springcloud</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>springcloud微服务技术栈-03</title>
    <link href="/springclou%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%A0%88-03/a8ff326633d6/"/>
    <url>/springclou%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%A0%88-03/a8ff326633d6/</url>
    
    <content type="html"><![CDATA[]]></content>
    
    
    <categories>
      
      <category>springcloud</category>
      
    </categories>
    
    
    <tags>
      
      <tag>springcloud</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>springcloud微服务技术栈-02</title>
    <link href="/springclou%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%A0%88-02/2a83262f3ef9/"/>
    <url>/springclou%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%A0%88-02/2a83262f3ef9/</url>
    
    <content type="html"><![CDATA[]]></content>
    
    
    <categories>
      
      <category>springcloud</category>
      
    </categories>
    
    
    <tags>
      
      <tag>springcloud</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>springclou微服务技术栈-01</title>
    <link href="/springclou%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%A0%88-01/f0aa2e2b38d0/"/>
    <url>/springclou%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%A0%88-01/f0aa2e2b38d0/</url>
    
    <content type="html"><![CDATA[<h1 id="1-微服务认识"><a href="#1-微服务认识" class="headerlink" title="1 微服务认识"></a>1 微服务认识</h1><blockquote><p>SpringCloud ！&#x3D; 微服务</p></blockquote><h2 id="1-1-如何学"><a href="#1-1-如何学" class="headerlink" title="1.1 如何学"></a>1.1 如何学</h2><ol><li>核心思想是拆分，把大的业务模块划分成多个小的模块，每个模块叫服务。多个服务形成了服务集群。</li><li>服务集群多了之后，各个服务之间的调用关系会很复杂，需要靠注册中心管理。</li><li>同理，随着服务集群的增多，配置文件也不断增长需要配置中心来管理(实现配置的热更新)。</li><li>用户访问组件需要经过网关，其作用主要是：身份验证、路由规则、负载均衡。</li><li>把数据库数据放入内存中，为了应对高并发，不能是单体缓存而是集群，称为分布式缓存。</li><li>进行搜索的时候用上分布式搜索。</li><li>最后还需要异步通信的消息队列，为了减少服务通知的链路，缩短响应时间，增加吞吐量。</li><li>最后这么多组件，一旦出了问题，不好定位，引入分布式日志服务。</li><li>实时监控系统中各个服务的状态和内存占用，可以定位到某个方法栈信息，便于找到异常所在称为系统监控链路追踪。</li></ol><h2 id="1-2-学习规划"><a href="#1-2-学习规划" class="headerlink" title="1.2 学习规划"></a>1.2 学习规划</h2><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/SpringCloud/a7079e42e02b43989a56284cfa7cf261.png" alt="在这里插入图片描述"></p><h2 id="1-3-单体架构和分布式架构"><a href="#1-3-单体架构和分布式架构" class="headerlink" title="1.3 单体架构和分布式架构"></a>1.3 单体架构和分布式架构</h2><h3 id="1-3-1-单体架构"><a href="#1-3-1-单体架构" class="headerlink" title="1.3.1 单体架构"></a>1.3.1 单体架构</h3><p><strong>单体架构</strong>：将业务的所有功能集中在一个项目中开发，打成一个包部署。</p><p><strong>优点：</strong></p><ul><li>架构简单</li><li>部署成本低</li></ul><p><strong>缺点：</strong></p><ul><li>耦合度高（维护困难、升级困难）</li></ul><h3 id="1-3-2-分布式架构"><a href="#1-3-2-分布式架构" class="headerlink" title="1.3.2 分布式架构"></a>1.3.2 分布式架构</h3><p><strong>分布式架构</strong>：根据业务功能对系统做拆分，每个业务功能模块作为独立项目开发，称为一个服务。</p><p><strong>优点：</strong></p><ul><li>降低服务耦合</li><li>有利于服务升级和拓展</li></ul><p><strong>缺点：</strong></p><ul><li>服务调用关系错综复杂</li></ul><blockquote><p>分布式架构虽然降低了服务耦合，但是服务拆分时也有很多问题需要思考：</p><ul><li>服务拆分的粒度如何界定？</li><li>服务之间如何调用？</li><li>服务的调用关系如何管理？</li></ul></blockquote><h2 id="1-4-微服务"><a href="#1-4-微服务" class="headerlink" title="1.4 微服务"></a>1.4 微服务</h2><p>微服务的架构特征：</p><ul><li>单一职责：微服务拆分粒度更小，每一个服务都对应唯一的业务能力，做到单一职责</li><li>自治：团队独立、技术独立、数据独立，独立部署和交付</li><li>面向服务：服务提供统一标准的接口，与语言和技术无关</li><li>隔离性强：服务调用做好隔离、容错、降级，避免出现级联问题</li></ul><h3 id="1-4-1-微服务技术对比"><a href="#1-4-1-微服务技术对比" class="headerlink" title="1.4.1 微服务技术对比"></a>1.4.1 微服务技术对比</h3><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/SpringCloud/578f90a2be084cb5b733dff0470bc9e5.png" alt="在这里插入图片描述"></p><h3 id="1-4-2-SpringCloud"><a href="#1-4-2-SpringCloud" class="headerlink" title="1.4.2 SpringCloud"></a>1.4.2 SpringCloud</h3><p>SpringCloud是目前国内使用最广泛的微服务框架。集成了各种微服务功能组件，并基于SpringBoot实现了这些组件的自动装配，从而提供了良好的开箱即用体验。</p><p>常用组件：</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/SpringCloud/d926594e22d446efb0d2f1b16c74577e.png" alt="在这里插入图片描述"></p><p>版本关系：</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/SpringCloud/b3ab831aeb02466c9181cc6f5a0edb07.png" alt="在这里插入图片描述"></p><h1 id="2-服务拆分和远程调用"><a href="#2-服务拆分和远程调用" class="headerlink" title="2 服务拆分和远程调用"></a>2 服务拆分和远程调用</h1><h2 id="2-1-服务拆分原则"><a href="#2-1-服务拆分原则" class="headerlink" title="2.1 服务拆分原则"></a>2.1 服务拆分原则</h2><ul><li>不同微服务，不要重复开发相同业务</li><li>微服务数据独立，不要访问其它微服务的数据库</li><li>微服务可以将自己的业务暴露为接口，供其它微服务调用</li></ul><h2 id="2-2-demo"><a href="#2-2-demo" class="headerlink" title="2.2 demo"></a>2.2 demo</h2><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/SpringCloud/5148009735d54e0d865aec5fbfa28387.png" alt="在这里插入图片描述"></p><p>cloud-demo：父工程，管理依赖</p><ul><li>order-service：订单微服务，负责订单相关业务</li><li>user-service：用户微服务，负责用户相关业务</li></ul><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/SpringCloud/c0127a23415d4acb9a12a58189011190.png" alt="在这里插入图片描述"></p><h2 id="2-3-远程调用"><a href="#2-3-远程调用" class="headerlink" title="2.3 远程调用"></a>2.3 远程调用</h2><p>在order-service服务中，有一个根据id查询订单的接口：</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/SpringCloud/e264831bbce745a8a848a070ca9b70a9.png" alt="在这里插入图片描述"></p><blockquote><p><a href="http://localhost:8080/order/101">http://localhost:8080/order/101</a> 进行查询</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/SpringCloud/2036990b89474356b2e1b52edbaf9454.png" alt="在这里插入图片描述"></p></blockquote><p>在user-service中有一个根据id查询用户的接口：</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/SpringCloud/e9a8bcb3d987428dbc4ae49d46a866ca.png" alt="在这里插入图片描述"></p><blockquote><p><a href="http://localhost:8081/user/1">http://localhost:8081/user/1</a> 进行查询<br><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/SpringCloud/ef76d983db85404599e1b087cf00471d.png" alt="在这里插入图片描述"></p></blockquote><p>那么此时如何可以在查询订单的时候将用户信息返回呢？</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/SpringCloud/a65b799a4bb844609be3eff482b28a25.png" alt="在这里插入图片描述"></p><h2 id="2-4-实现"><a href="#2-4-实现" class="headerlink" title="2.4 实现"></a>2.4 实现</h2><h3 id="2-4-1-注册RestTemplate"><a href="#2-4-1-注册RestTemplate" class="headerlink" title="2.4.1 注册RestTemplate"></a>2.4.1 注册RestTemplate</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.order;<br><br><span class="hljs-keyword">import</span> org.mybatis.spring.annotation.MapperScan;<br><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.web.client.RestTemplate;<br><br><span class="hljs-meta">@MapperScan(&quot;cn.itcast.order.mapper&quot;)</span><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderApplication</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(OrderApplication.class, args);<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> RestTemplate <span class="hljs-title function_">restTemplate</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RestTemplate</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-4-2-实现远程调用"><a href="#2-4-2-实现远程调用" class="headerlink" title="2.4.2 实现远程调用"></a>2.4.2 实现远程调用</h3><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/SpringCloud/bc23f328b85642b59261a347a836f54d.png" alt="在这里插入图片描述"></p><blockquote><p>这样再次访问<a href="http://localhost:8080/order/101">http://localhost:8080/order/101</a> 就能在查询订单信息的时候查询出用户相关信息</p></blockquote><h2 id="2-5-提供者和消费者"><a href="#2-5-提供者和消费者" class="headerlink" title="2.5 提供者和消费者"></a>2.5 提供者和消费者</h2><p>在服务调用关系中，会有两个不同的角色：</p><p><strong>服务提供者</strong>：一次业务中，被其它微服务调用的服务。（提供接口给其它微服务）<br><strong>服务消费者</strong>：一次业务中，调用其它微服务的服务。（调用其它微服务提供的接口）</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/SpringCloud/a0118f83b9714fb2bf8395391f7bc75c.png" alt="在这里插入图片描述"></p><blockquote><p>但是提供者和消费者只是相对而言，没有绝对的定义，需要依据提供的服务以及使用的服务进行决定的。</p></blockquote><h1 id="3-Eureka注册中心"><a href="#3-Eureka注册中心" class="headerlink" title="3 Eureka注册中心"></a>3 Eureka注册中心</h1><h2 id="3-1-Eureka的作用"><a href="#3-1-Eureka的作用" class="headerlink" title="3.1 Eureka的作用"></a>3.1 Eureka的作用</h2><p>当user-service部署多个的时候，存在一下几个问题：</p><ol><li>order-service在发起远程调用的时候，该如何得知user-service实例的ip地址和端口？</li><li>有多个user-service实例地址，order-service调用时该如何选择？</li><li>order-service如何得知某个user-service实例是否依然健康，是不是已经宕机？</li></ol><p>因此针对上面的问题，利用SpringCloud的注册中心就可以解决，其中最广为人知的注册中心就是Eureka。</p><h2 id="3-2-Eureka结构"><a href="#3-2-Eureka结构" class="headerlink" title="3.2 Eureka结构"></a>3.2 Eureka结构</h2><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/SpringCloud/8741664e455749d497bcdb3980c86fd9.png" alt="在这里插入图片描述"></p><blockquote><p>问题1：order-service如何得知user-service实例地址？</p></blockquote><p>获取地址信息的流程如下：</p><ol><li>user-service服务实例启动后，将自己的信息注册到eureka-server（Eureka服务端）。这个叫服务注册</li><li>eureka-server保存服务名称到服务实例地址列表的映射关系。</li><li>order-service根据服务名称，拉取实例地址列表。这个叫服务发现或服务拉取。</li></ol><p></p><blockquote><p>问题2：order-service如何从多个user-service实例中选择具体的实例？</p></blockquote><ol><li>order-service从实例列表中利用负载均衡算法选中一个实例地址向该实例地址发起远程调用。</li></ol><blockquote><p>问题3：order-service如何得知某个user-service实例是否依然健康，是不是已经宕机？</p></blockquote><ol><li>user-service会每隔一段时间（默认30秒）向eureka-server发起请求，报告自己状态，称为心跳当超过一定时间没有发送心跳时，eureka-server会认为微服务实例故障，将该实例从服务列表中剔除order-service拉取服务时，就能将故障实例排除了。</li></ol><blockquote><p>一个微服务，既可以是服务提供者，又可以是服务消费者，因此eureka将服务注册、服务发现等功能统一封装到了eureka-client端</p></blockquote><h2 id="3-3-动手搭建"><a href="#3-3-动手搭建" class="headerlink" title="3.3 动手搭建"></a>3.3 动手搭建</h2><p>首先搭建注册中心服务端：eureka-server，这必须是一个独立的微服务</p><h3 id="3-3-1-创建eureka-server"><a href="#3-3-1-创建eureka-server" class="headerlink" title="3.3.1 创建eureka-server"></a>3.3.1 创建eureka-server</h3><ol><li>新建模块：在cloud-demo父工程下，创建一个子模块：</li></ol><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/SpringCloud/dceb951554ea45ff8f24622683b598c6.png" alt="在这里插入图片描述"></p><ol start="2"><li><p>引入依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>编写启动类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.eureka;<br><br><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br><span class="hljs-keyword">import</span> org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;<br><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableEurekaServer</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EurekaApplication</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(EurekaApplication.class, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>使用@EnableEurekaServer注解，这样就开启eureka的注册中心功能</p></blockquote></li><li><p>编写配置文件</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">10086</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">eureka-server</span><br><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">service-url:</span> <br>      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://127.0.0.1:10086/eureka</span><br></code></pre></td></tr></table></figure></li></ol><p>启动该服务，发现无任何异常</p><h3 id="3-3-2-服务注册"><a href="#3-3-2-服务注册" class="headerlink" title="3.3.2 服务注册"></a>3.3.2 服务注册</h3><blockquote><p>即：哪个服务需要对外提供服务能力，哪个服务进行注册</p></blockquote><ol><li><p>引入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>修改配置文件</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">userservice</span><br><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">service-url:</span><br>      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://127.0.0.1:10086/eureka</span><br></code></pre></td></tr></table></figure></li><li><p>启动多user-service实例</p><p>复制原user-service启动配置</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/SpringCloud/f0477881f8f7468eb48324345044edab.png" alt="在这里插入图片描述"></p><p>修改配置信息：<code>-Dserver.port=8082</code></p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/SpringCloud/6184869fa3664d76b2e9251fee9fc0ca.png" alt="在这里插入图片描述"></p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/SpringCloud/c961dce6e36f465895f9108d7ee8b752.png" alt="在这里插入图片描述"></p></li></ol><h3 id="3-3-3-服务发现"><a href="#3-3-3-服务发现" class="headerlink" title="3.3.3 服务发现"></a>3.3.3 服务发现</h3><ol><li><p>引入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>配置文件</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">orderservice</span><br><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">service-url:</span><br>      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://127.0.0.1:10086/eureka</span><br></code></pre></td></tr></table></figure></li><li><p>服务拉取和负载均衡</p><ol><li><p>在order-service中的Application中添加一个<code>@LoadBalanced</code></p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/SpringCloud/f88b90b50646464d99f33d67cd62311e.png" alt="在这里插入图片描述"></p></li><li><p>修改之前的url，使用服务名代替ip和端口：</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/SpringCloud/2bfb7abae1424039a2e4e56f30471f1f.png" alt="在这里插入图片描述"></p></li><li><p>重启后访问：<code>http://localhost:8080/order/102</code>和<code>http://localhost:8080/order/101</code>发现两个服务都有日志输出。</p></li></ol></li></ol><h1 id="4-Ribbon负载均衡"><a href="#4-Ribbon负载均衡" class="headerlink" title="4 Ribbon负载均衡"></a>4 Ribbon负载均衡</h1><h2 id="4-1-负载均衡原理"><a href="#4-1-负载均衡原理" class="headerlink" title="4.1 负载均衡原理"></a>4.1 负载均衡原理</h2><p>在SpringCloud的底层其实使用了一个名为Ribbon的组件，实现了负载均衡。</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/SpringCloud/427b8ac5ff424fe2b9e0c18163259664.png" alt="在这里插入图片描述"></p><h2 id="4-2-源码跟踪"><a href="#4-2-源码跟踪" class="headerlink" title="4.2 源码跟踪"></a>4.2 源码跟踪</h2><p>在源码跟踪前，思考一下为什么我们使用服务名替换了原来的ip和端口就可以访问了，并且请求明明是<a href="http://userservice/user/1%EF%BC%8C%E4%B8%BA%E4%BB%80%E4%B9%88%E6%9C%80%E5%90%8E%E5%8F%98%E6%88%90%E4%BA%86http://localhost:8081">http://userservice/user/1，为什么最后变成了http://localhost:8081</a></p><h3 id="4-2-1-LoadBalacerInterceptor"><a href="#4-2-1-LoadBalacerInterceptor" class="headerlink" title="4.2.1 LoadBalacerInterceptor"></a>4.2.1 LoadBalacerInterceptor</h3><p>这个类会在对RestTemplate的请求进行拦截，然后从Eureka根据服务id获取服务列表，随后利用负载均衡算法得到真实的服务地址信息，替换服务id。</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/SpringCloud/65f941536921415ebb9d8f4ad03db934.png" alt="在这里插入图片描述"></p><p>可以看到这里的intercept方法，拦截了用户的HttpRequest请求，然后做了几件事：</p><ul><li>request.getURI()：获取请求uri，本例中就是 <a href="http://user-service/user/8">http://user-service/user/8</a></li><li>originalUri.getHost()：获取uri路径的主机名，其实就是服务id，user-service</li><li>this.loadBalancer.execute()：处理服务id，和用户请求。</li></ul><p>这里的this.loadBalancer是LoadBalancerClient类型，我们继续跟入。</p><h3 id="4-2-2-LoadBalancerClient"><a href="#4-2-2-LoadBalancerClient" class="headerlink" title="4.2.2 LoadBalancerClient"></a>4.2.2 LoadBalancerClient</h3><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/SpringCloud/4892fef950334acdbe8a9af7418e78d3.png" alt="在这里插入图片描述"></p><ul><li><p>getLoadBalancer(serviceId)：根据服务id获取ILoadBalancer，而ILoadBalancer会拿着服务id去eureka中获取服务列表并保存起来。</p></li><li><p>getServer(loadBalancer)：利用内置的负载均衡算法，从服务列表中选择一个。本例中，可以看到获取了8082端口的服务</p></li></ul><p>放行后，再次访问并跟踪，发现获取的是8081：</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/SpringCloud/8becd127c28342ba8cab27fb2c30b55b.png" alt="在这里插入图片描述"><br>果然实现了负载均衡。</p><h3 id="4-2-3-负载均衡策略IRule"><a href="#4-2-3-负载均衡策略IRule" class="headerlink" title="4.2.3 负载均衡策略IRule"></a>4.2.3 负载均衡策略IRule</h3><p>在刚才的代码中，可以看到获取服务使通过一个<code>getServer</code>方法来做负载均衡，内部跟进</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/SpringCloud/76f1b0fa3d5140de96e04b631fa81858.png" alt="在这里插入图片描述"></p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/SpringCloud/7e985520a5ca4bc983eed85213c3a50c.png" alt="在这里插入图片描述"></p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/SpringCloud/c017c1a23cb042838967b61311d6427f.png" alt="在这里插入图片描述"></p><p>那么这个<code>RoundRobinRule</code>就是轮询策略</p><h3 id="4-2-4-总结"><a href="#4-2-4-总结" class="headerlink" title="4.2.4 总结"></a>4.2.4 总结</h3><p>pringCloudRibbon的底层采用了一个拦截器，拦截了RestTemplate发出的请求，对地址做了修改。</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/SpringCloud/9cf9b4759d2542c0a1b512f1a15edf17.png" alt="在这里插入图片描述"></p><p>基本流程如下：</p><ol><li>拦截我们的RestTemplate请求<a href="http://userservice/user/1">http://userservice/user/1</a></li><li>RibbonLoadBalancerClient会从请求url中获取服务名称，也就是user-service</li><li>DynamicServerListLoadBalancer根据user-service到eureka拉取服务列表</li><li>eureka返回列表，localhost:8081、localhost:8082</li><li>IRule利用内置负载均衡规则，从列表中选择一个，例如localhost:8081</li><li>RibbonLoadBalancerClient修改请求地址，用localhost:8081替代userservice，得到<a href="http://localhost:8081/user/1%EF%BC%8C%E5%8F%91%E8%B5%B7%E7%9C%9F%E5%AE%9E%E8%AF%B7%E6%B1%82%E3%80%82">http://localhost:8081/user/1，发起真实请求。</a></li></ol><h2 id="4-3-负载均衡策略"><a href="#4-3-负载均衡策略" class="headerlink" title="4.3 负载均衡策略"></a>4.3 负载均衡策略</h2><h3 id="4-3-1-类图"><a href="#4-3-1-类图" class="headerlink" title="4.3.1 类图"></a>4.3.1 类图</h3><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/SpringCloud/7cd2c1f4ec164e44a859bb348e364edd.png" alt="在这里插入图片描述"></p><table><thead><tr><th align="center"><strong>内置负载均衡规则类</strong></th><th align="center"><strong>规则描述</strong></th></tr></thead><tbody><tr><td align="center">RoundRobinRule</td><td align="center">简单轮询服务列表来选择服务器。它是Ribbon默认的负载均衡规则。</td></tr><tr><td align="center">AvailabilityFilteringRule</td><td align="center">对以下两种服务器进行忽略： （1）在默认情况下，这台服务器如果3次连接失败，这台服务器就会被设置为“短路”状态。短路状态将持续30秒，如果再次连接失败，短路的持续时间就会几何级地增加。 （2）并发数过高的服务器。如果一个服务器的并发连接数过高，配置了AvailabilityFilteringRule规则的客户端也会将其忽略。并发连接数的上限，可以由客户端的&lt; clientName &gt;.&lt; clientConfigNameSpace &gt;.ActiveConnectionsLimit属性进行配置。</td></tr><tr><td align="center">WeightedResponseTimeRule</td><td align="center">为每一个服务器赋予一个权重值。服务器响应时间越长，这个服务器的权重就越小。这个规则会随机选择服务器，这个权重值会影响服务器的选择。</td></tr><tr><td align="center">ZoneAvoidanceRule</td><td align="center">以区域可用的服务器为基础进行服务器的选择。使用Zone对服务器进行分类，这个Zone可以理解为一个机房、一个机架等。而后再对Zone内的多个服务做轮询。</td></tr><tr><td align="center">BestAvailableRule</td><td align="center">忽略那些短路的服务器，并选择并发数较低的服务器。</td></tr><tr><td align="center">RandomRule</td><td align="center">随机选择一个可用的服务器。</td></tr><tr><td align="center">RetryRule</td><td align="center">重试机制的选择逻辑</td></tr></tbody></table><blockquote><p>默认实现：ZoneAvoidanceRule</p></blockquote><h3 id="4-3-2-自定义负载均衡策略"><a href="#4-3-2-自定义负载均衡策略" class="headerlink" title="4.3.2 自定义负载均衡策略"></a>4.3.2 自定义负载均衡策略</h3><ul><li><p>方式1：代码方式：在order-service中的OrderApplication类中，定义一个新的IRule：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> IRule <span class="hljs-title function_">randomRule</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RandomRule</span>();<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>方式2：配置文件：在order-service的application.yml文件中，添加新的配置也可以修改规则：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">userservice:</span> <span class="hljs-comment"># 给某个微服务配置负载均衡规则，这里是userservice服务</span><br>  <span class="hljs-attr">ribbon:</span><br>    <span class="hljs-attr">NFLoadBalancerRuleClassName:</span> <span class="hljs-string">com.netflix.loadbalancer.RandomRule</span> <span class="hljs-comment"># 负载均衡规则 </span><br></code></pre></td></tr></table></figure></li></ul><h2 id="4-4-饥饿加载"><a href="#4-4-饥饿加载" class="headerlink" title="4.4 饥饿加载"></a>4.4 饥饿加载</h2><p>当重启重启order-service，访问<code>http://localhost:8080/order/101</code></p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/SpringCloud/7c63c6a080c94711bdae4a780534a92a.png" alt="在这里插入图片描述"></p><p>发现耗时很高，重新刷新后<br><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/SpringCloud/00904d8277e84aa7982d27efb0810a2b.png" alt="在这里插入图片描述"></p><p>为何差别如此大？</p><p>Ribbon默认是采用懒加载，即第一次访问时才会去创建LoadBalanceClient，请求时间会很长。</p><p>如何降低第一次访问耗时？</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/SpringCloud/3ca809a32bab4ccab6c813741cb076c2.png" alt="在这里插入图片描述"></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">ribbon:</span><br>  <span class="hljs-attr">eager-load:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">clients:</span> <span class="hljs-string">userservice</span><br>      <span class="hljs-comment"># 多个需要用-分割、换行</span><br>      <span class="hljs-comment"># -userservice1</span><br>      <span class="hljs-comment"># -userservice2</span><br></code></pre></td></tr></table></figure><h1 id="5-Nacos注册中心"><a href="#5-Nacos注册中心" class="headerlink" title="5 Nacos注册中心"></a>5 Nacos注册中心</h1><h2 id="5-1-介绍"><a href="#5-1-介绍" class="headerlink" title="5.1 介绍"></a>5.1 介绍</h2><p>国内公司一般都推崇阿里巴巴的技术，比如注册中心，SpringCloudAlibaba也推出了一个名为Nacos的注册中心。</p><h2 id="5-2-依赖"><a href="#5-2-依赖" class="headerlink" title="5.2 依赖"></a>5.2 依赖</h2><p>项目根目录下的pom.xml引入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2.5.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>nacos客户端依赖包</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- nacos客户端依赖包 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="5-3-服务注册"><a href="#5-3-服务注册" class="headerlink" title="5.3 服务注册"></a>5.3 服务注册</h2><ol><li><p>引入依赖</p><p>在cloud-demo父工程的pom文件中的<code>&lt;dependencyManagement&gt;</code>中引入SpringCloudAlibaba的依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2.6.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>在user-service和order-service中的pom文件中引入nacos-discovery依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>配置nacos地址</p><p>在user-service和order-service的配置文件添加nacos地址</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">server-addr:</span> <span class="hljs-string">localhost:8848</span><br><br></code></pre></td></tr></table></figure></li><li><p>重启服务</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/SpringCloud/73e620b393084d2c90a27cc4ca4d71fa.png" alt="在这里插入图片描述"></p></li></ol><h2 id="5-4-服务分级存储模型"><a href="#5-4-服务分级存储模型" class="headerlink" title="5.4 服务分级存储模型"></a>5.4 服务分级存储模型</h2><p>一个服务可以有多个实例，例如我们的user-service，可以有:</p><p>127.0.0.1:8081<br>127.0.0.1:8082<br>127.0.0.1:8083<br>假如这些实例分布于全国各地的不同机房，例如：</p><p>127.0.0.1:8081，在上海机房<br>127.0.0.1:8082，在上海机房<br>127.0.0.1:8083，在杭州机房<br>Nacos就将同一机房内的实例 划分为一个集群。</p><p>即：user-service是服务，一个服务可以包含多个集群，如杭州、上海，每个集群下可以有多个实例，形成分级模型，如图：</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/SpringCloud/5e6274232dfc4164b3e80166ff5655c4.png" alt="在这里插入图片描述"></p><p>微服务互相访问时，应该尽可能访问同集群实例，因为本地访问速度更快。当本集群内不可用时，才访问其它集群。</p><h3 id="5-4-1-user-service配置集群"><a href="#5-4-1-user-service配置集群" class="headerlink" title="5.4.1 user-service配置集群"></a>5.4.1 user-service配置集群</h3><p>修改user-service的application.yml文件，添加集群相关配置</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">server-addr:</span> <span class="hljs-string">localhost:8848</span><br>      <span class="hljs-attr">discovery:</span><br>        <span class="hljs-attr">cluster-name:</span> <span class="hljs-string">HZ</span> <span class="hljs-comment"># 集群名称</span><br></code></pre></td></tr></table></figure><p>重启两个user-service实例：</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/SpringCloud/5db68262da6e4debae8b32f6ad4bff05.png" alt="在这里插入图片描述"></p><p>同时再复制一个user-service启动配置，添加相关属性<code>-Dserver.port=8083 -Dspring.cloud.nacos.discovery.cluster-name=SH</code></p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/SpringCloud/90575cea053140a1bc9a5bbe67d04f99.png" alt="在这里插入图片描述"></p><p>启动UserApplication3后再次查看nacos控制台</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/SpringCloud/3c050141842d4b4987ea1e335ff6c672.png" alt="在这里插入图片描述"></p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/SpringCloud/3c050141842d4b4987ea1e335ff6c672-20240316203202823.png" alt="在这里插入图片描述"></p><h3 id="5-4-2-同集群优先的负载均衡"><a href="#5-4-2-同集群优先的负载均衡" class="headerlink" title="5.4.2 同集群优先的负载均衡"></a>5.4.2 同集群优先的负载均衡</h3><p>默认的<code>ZoneAvoidanceRule</code>并不能实现根据同集群优先来实现负载均衡。<br>因此Nacos中提供了一个<code>NacosRule</code>的实现，可以优先从同集群中挑选实例。</p><ol><li><p>修改order-service的application.yaml文件，添加集群相关配置</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">server-addr:</span> <span class="hljs-string">localhost:8848</span><br>      <span class="hljs-attr">discovery:</span><br>        <span class="hljs-attr">cluster-name:</span> <span class="hljs-string">HZ</span> <span class="hljs-comment"># 集群名称</span><br></code></pre></td></tr></table></figure><blockquote><p>但是多次访问后还是轮询调用，我们现在只想访问HZ集群下的，不想让SH集群的实例被访问</p></blockquote></li><li><p>修改order-service的application.yml文件，修改负载均衡规则：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">userservice:</span><br>  <span class="hljs-attr">ribbon:</span><br>    <span class="hljs-attr">NFLoadBalancerRuleClassName:</span> <span class="hljs-string">com.alibaba.cloud.nacos.ribbon.NacosRule</span> <span class="hljs-comment"># 负载均衡规则 </span><br></code></pre></td></tr></table></figure><blockquote><p>随后再访问发现SH集群下载user-service3没有任何日志输出</p></blockquote></li><li><p>当HZ集群都停掉，此时会调用SH集群下的服务</p></li></ol><h2 id="5-5-权重配置"><a href="#5-5-权重配置" class="headerlink" title="5.5 权重配置"></a>5.5 权重配置</h2><p>实际部署中会出现这样的场景：<br>• 服务器设备性能有差异，部分实例所在机器性能较好，另一些较差，我们希望性能好的机器承担更多的用户请求。</p><p>但默认情况下NacosRule是同集群内随机挑选，不会考虑机器的性能问题。</p><p>因此，Nacos提供了权重配置来控制访问频率，权重越大则访问频率越高。</p><p>在nacos控制台，找到user-service的实例列表，点击编辑，即可修改权重：</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/SpringCloud/6cd6cf71d26c4b42b459a1b35a0a12fe.png" alt="在这里插入图片描述"></p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/SpringCloud/452379c893e8478ea9ba036f1d6ba472.png" alt="在这里插入图片描述"></p><blockquote><p>如果权重修改为0，则该实例永远不会被访问<br>权重为0通常用于系统升级。<br>先将某个服务器的权重设置为0，然后做升级，升级完后，把权重调小，放一部分用户进来，无问题，再把权重扩大。(平滑升级)</p></blockquote><h2 id="5-6-环境隔离"><a href="#5-6-环境隔离" class="headerlink" title="5.6 环境隔离"></a>5.6 环境隔离</h2><p>Nacos提供了namespace来实现环境隔离功能。</p><ul><li>nacos中可以有多个namespace</li><li>namespace下可以有group、service等</li><li>不同namespace之间相互隔离，例如不同namespace的服务互相不可见</li></ul><blockquote><p>其实namespace针对开发人员解决开发环境、测试环境、生产环境切换等。</p></blockquote><h3 id="5-6-1-创建namespace"><a href="#5-6-1-创建namespace" class="headerlink" title="5.6.1 创建namespace"></a>5.6.1 创建namespace</h3><p>默认情况下，所有service、data、group都在同一个namespace，名为public：</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/SpringCloud/9ccfa49c759947a4926479031b9f8c65.png" alt="在这里插入图片描述"></p><p>我们可以点击页面新增按钮，添加一个namespace：</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/SpringCloud/89e4e7075c9c40ccacc59a1b3798233a.png" alt="在这里插入图片描述"></p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/SpringCloud/467548a3855b45a4969ed3b5bd66a8d1.png" alt="在这里插入图片描述"></p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/SpringCloud/d7ea78da1471401daa9d2485149e6535.png" alt="在这里插入图片描述"></p><h3 id="5-6-2-服务配置namespace"><a href="#5-6-2-服务配置namespace" class="headerlink" title="5.6.2 服务配置namespace"></a>5.6.2 服务配置namespace</h3><p>给微服务配置namespace只能通过修改配置来实现。</p><p>例如，修改order-service的application.yml文件：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">server-addr:</span> <span class="hljs-string">localhost:8848</span><br>      <span class="hljs-attr">discovery:</span><br>        <span class="hljs-attr">cluster-name:</span> <span class="hljs-string">HZ</span><br>        <span class="hljs-attr">namespace:</span> <span class="hljs-string">492a7d5d-237b-46a1-a99a-fa8e98e4b0f9</span> <span class="hljs-comment"># 命名空间，填ID</span><br></code></pre></td></tr></table></figure><h2 id="5-7-Nacos和Eureka区别"><a href="#5-7-Nacos和Eureka区别" class="headerlink" title="5.7 Nacos和Eureka区别"></a>5.7 Nacos和Eureka区别</h2><p>Nacos的服务实例分为两种l类型：</p><ul><li>临时实例：每隔30秒会向Nacos发送心跳，靠Nacos进行监控，一旦发现超时未发送心跳，就会被Nacos从服务列表中移除。</li><li>非临时实例：不会发送心跳，是Nacos主动向provider进行询问。如果询问超时也不会剔除服务列表，而是仅仅标记为不健康，等待其恢复健康即可。</li></ul><p>默认情况下，所有实例都是临时实例</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/SpringCloud/a64d9c2786504f7ba4b50a061989bb53.png" alt="在这里插入图片描述"></p><h3 id="5-7-1-修改为永久实例"><a href="#5-7-1-修改为永久实例" class="headerlink" title="5.7.1 修改为永久实例"></a>5.7.1 修改为永久实例</h3><p>Order-service:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">discovery:</span><br>        <span class="hljs-attr">ephemeral:</span> <span class="hljs-literal">false</span> <span class="hljs-comment"># 设置为非临时实例</span><br></code></pre></td></tr></table></figure><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/SpringCloud/5606af21ad904041b9c03beeb68bc9c4.png" alt="在这里插入图片描述"></p><p>当关闭的时候，nacos控制台只是把它标记为不健康</p><h3 id="5-7-2-区别"><a href="#5-7-2-区别" class="headerlink" title="5.7.2 区别"></a>5.7.2 区别</h3><p>相同点：</p><ul><li>都支持服务注册和服务拉取</li><li>都支持服务提供者心跳方式做健康检测</li></ul><p>不同点：</p><ul><li>Nacos支持服务端主动检测提供者状态：临时实例采用心跳模式，非临时实例采用主动检测模式临时实例心跳不正常会被剔除，非临时实例则不会被剔除</li><li>Nacos支持服务列表变更的消息推送模式，服务列表更新更及时</li><li>Nacos集群默认采用AP方式(强调服务可用性)，当集群中存在非临时实例时，采用CP模式(可靠性和一致性)；Eureka采用AP方式。</li></ul>]]></content>
    
    
    <categories>
      
      <category>springcloud</category>
      
    </categories>
    
    
    <tags>
      
      <tag>springcloud</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>redis-附近&amp;签到&amp;UV</title>
    <link href="/redis-%E9%99%84%E8%BF%91-%E7%AD%BE%E5%88%B0-UV/91f9a5d4aa12/"/>
    <url>/redis-%E9%99%84%E8%BF%91-%E7%AD%BE%E5%88%B0-UV/91f9a5d4aa12/</url>
    
    <content type="html"><![CDATA[<h1 id="1-附近的店铺"><a href="#1-附近的店铺" class="headerlink" title="1 附近的店铺"></a>1 附近的店铺</h1><h2 id="1-1-GEO数据结构的基本用法"><a href="#1-1-GEO数据结构的基本用法" class="headerlink" title="1.1 GEO数据结构的基本用法"></a>1.1 GEO数据结构的基本用法</h2><p>GEO就是Geolocation的简写形式，代表地理坐标。Redis在3.2版本中加入了对GEO的支持，允许存储地理坐标信息，帮助我们根据经纬度来检索数据。常见的命令有：</p><ul><li>GEOADD：添加一个地理空间信息，包含：经度（longitude）、纬度（latitude）、值（member）</li><li>GEODIST：计算指定的两个点之间的距离并返回</li><li>GEOHASH：将指定member的坐标转为hash字符串形式并返回</li><li>GEOPOS：返回指定member的坐标</li><li>GEORADIUS：指定圆心、半径，找到该圆内包含的所有member，并按照与圆心之间的距离排序后返回。6.以后已废弃</li><li>GEOSEARCH：在指定范围内搜索member，并按照与指定点之间的距离排序后返回。范围可以是圆形或矩形。6.2.新功能</li><li>GEOSEARCHSTORE：与GEOSEARCH功能一致，不过可以把结果存储到一个指定的key。 6.2.新功能。</li></ul><h2 id="1-2-附近的店铺导入GEO"><a href="#1-2-附近的店铺导入GEO" class="headerlink" title="1.2 附近的店铺导入GEO"></a>1.2 附近的店铺导入GEO</h2><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/b618a38193b04d26bb0dea88c35d4d32.png" alt="在这里插入图片描述"></p><p>分析shop对应的数据库表，发现有一个typeId字段，表明是什么类型的，那么此时可以根据这个字段将店铺进行分组</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/a55fc0a0189144c39835a8e5dd7f0a89.png" alt="在这里插入图片描述"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">loadShopData</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 1.查询店铺信息</span><br>    List&lt;Shop&gt; list = shopService.list();<br>    <span class="hljs-comment">// 2.把店铺按照typeId分组，typeId一样的分一组</span><br>    Map&lt;Long, List&lt;Shop&gt;&gt; map = list.stream().collect(Collectors.groupingBy(Shop::getTypeId));<br><br>    <span class="hljs-comment">// 3.分批完成写入Redis</span><br>    Set&lt;Map.Entry&lt;Long, List&lt;Shop&gt;&gt;&gt; entries = map.entrySet();<br>    <span class="hljs-keyword">for</span> (Map.Entry&lt;Long, List&lt;Shop&gt;&gt; entry : entries) &#123;<br>        <span class="hljs-comment">// 3.1获取typeId</span><br>        <span class="hljs-type">Long</span> <span class="hljs-variable">typeId</span> <span class="hljs-operator">=</span> entry.getKey();<br><br>        <span class="hljs-comment">// 3.2获取同类型的店铺的集合</span><br>        List&lt;Shop&gt; value = entry.getValue();<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> RedisConstants.SHOP_GEO_KEY + typeId;<br>        <span class="hljs-comment">// 3.3 写入Redis</span><br><br>        <span class="hljs-comment">// 方法一：打开shop实体类集合，一条店铺一条店铺添加(比较慢)</span><br>        <span class="hljs-comment">/*for (Shop shop : value) &#123;</span><br><span class="hljs-comment">            stringRedisTemplate.opsForGeo().add(key, new Point(shop.getX(), shop.getY()), shop.getId().toString());</span><br><span class="hljs-comment">        &#125;*/</span><br><br>        <span class="hljs-comment">// 方法二：locations</span><br>        List&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt; locations = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(value.size());<br>        <span class="hljs-keyword">for</span> (Shop shop : value) &#123;<br>            locations.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisGeoCommands</span>.GeoLocation&lt;&gt;(shop.getId().toString(),<br>                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Point</span>(shop.getX(), shop.getY())));<br>        &#125;<br>        stringRedisTemplate.opsForGeo().add(key, locations);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="1-3-获取附近的店铺"><a href="#1-3-获取附近的店铺" class="headerlink" title="1.3 获取附近的店铺"></a>1.3 获取附近的店铺</h2><p>SpringDataRedis的2.3.9版本并不支持Redis 6.2提供的GEOSEARCH命令，因此我们需要提示其版本，修改自己的POM</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.data<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.6.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.lettuce<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lettuce-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>6.1.6.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/of/type&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">queryShopByType</span><span class="hljs-params">(</span><br><span class="hljs-params">        <span class="hljs-meta">@RequestParam(&quot;typeId&quot;)</span> Integer typeId,</span><br><span class="hljs-params">        <span class="hljs-meta">@RequestParam(value = &quot;current&quot;, defaultValue = &quot;1&quot;)</span> Integer current,</span><br><span class="hljs-params">        <span class="hljs-meta">@RequestParam(value = &quot;x&quot;, required = false)</span> Double x,</span><br><span class="hljs-params">        <span class="hljs-meta">@RequestParam(value = &quot;y&quot;, required = false)</span> Double y</span><br><span class="hljs-params">)</span> &#123;<br>   <span class="hljs-keyword">return</span> shopService.queryShopByType(typeId, current, x, y);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> void</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> //根据商铺类型分页查询商铺信息(加入坐标)</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">queryShopByType</span><span class="hljs-params">(Integer typeId, Integer current, Double x, Double y)</span> &#123;<br>    <span class="hljs-comment">// 1.判断是否需要根据坐标查询，如果需要再按照坐标</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == x || <span class="hljs-literal">null</span> == y) &#123;<br>        <span class="hljs-comment">// 根据类型分页查询</span><br>        Page&lt;Shop&gt; page = query()<br>                .eq(<span class="hljs-string">&quot;type_id&quot;</span>, typeId)<br>                .page(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>&lt;&gt;(current, SystemConstants.DEFAULT_PAGE_SIZE));<br>        <span class="hljs-comment">// 返回数据</span><br>        <span class="hljs-keyword">return</span> Result.ok(page.getRecords());<br>    &#125;<br><br>    <span class="hljs-comment">// 2.分页参数的计算</span><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 当前页的起始数据是第几条</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">from</span> <span class="hljs-operator">=</span> (current - <span class="hljs-number">1</span>) * SystemConstants.DEFAULT_PAGE_SIZE;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 当前页的结束数据是第几条</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> current * SystemConstants.DEFAULT_PAGE_SIZE;<br><br>    <span class="hljs-comment">// 3.查询redis，按照距离排序和分页 结果 shopId ,distance</span><br>    <span class="hljs-comment">// GEOSEARCH g1 FROMLONLAT 116.397904 39.909005 BYRADIUS 10 km WITHDIST</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> RedisConstants.SHOP_GEO_KEY + typeId;<br>    GeoResults&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt; results = stringRedisTemplate.opsForGeo()<br>            .search(key,<br>                    GeoReference.fromCoordinate(x, y),<br>                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Distance</span>(RedisConstants.GEO_DISTANT),<br>                    RedisGeoCommands.GeoRadiusCommandArgs.newGeoRadiusArgs().includeDistance().limit(end)<br>            );<br><br>    <span class="hljs-comment">// 4.解析shopId</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == results) &#123;<br>        <span class="hljs-keyword">return</span> Result.ok(Collections.emptyList());<br>    &#125;<br>    List&lt;GeoResult&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt;&gt; list = results.getContent();<br>    ArrayList&lt;Long&gt; shopIds = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(list.size());<br>    Map&lt;String, Distance&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(list.size());<br>    <span class="hljs-comment">// 4.1 截取从from 到 end</span><br>    list.stream().skip(from).forEach(result -&gt; &#123;<br>        <span class="hljs-comment">// 4.2获取店铺id</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">shopIdStr</span> <span class="hljs-operator">=</span> result.getContent().getName();<br>        shopIds.add(Long.valueOf(shopIdStr));<br><br>        <span class="hljs-comment">// 4.3获取距离</span><br>        <span class="hljs-type">Distance</span> <span class="hljs-variable">distance</span> <span class="hljs-operator">=</span> result.getDistance();<br><br>        map.put(shopIdStr, distance);<br>    &#125;);<br><br>    <span class="hljs-comment">// 5.根据id查询shop</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">joinStr</span> <span class="hljs-operator">=</span> StrUtil.join(<span class="hljs-string">&quot;,&quot;</span>, shopIds);<br>    List&lt;Shop&gt; shops = query().in(<span class="hljs-string">&quot;id&quot;</span>, shopIds).last(<span class="hljs-string">&quot;order by field(id,&quot;</span> + joinStr + <span class="hljs-string">&quot;)&quot;</span>).list();<br>    <span class="hljs-keyword">for</span> (Shop shop : shops) &#123;<br>        shop.setDistance(map.get(shop.getId().toString()).getValue());<br>    &#125;<br><br>    <span class="hljs-comment">// 6.返回</span><br>    <span class="hljs-keyword">return</span> Result.ok(shops);<br>&#125;<br></code></pre></td></tr></table></figure><p>但是此时测试的时候，到最后的时候向下拉却报错了</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/6856c73dfc814521b58138fc3dfa70a7.png" alt="在这里插入图片描述"></p><p>原因分析：</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/5abe1713f1ef422780ff4cae726be1e2.png" alt="在这里插入图片描述"></p><p>最后在截取的时候，跳过之后就没有任何值了</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> void</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> //根据商铺类型分页查询商铺信息(加入坐标)</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">queryShopByType</span><span class="hljs-params">(Integer typeId, Integer current, Double x, Double y)</span> &#123;<br>    <span class="hljs-comment">// 1.判断是否需要根据坐标查询，如果需要再按照坐标</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == x || <span class="hljs-literal">null</span> == y) &#123;<br>        <span class="hljs-comment">// 根据类型分页查询</span><br>        Page&lt;Shop&gt; page = query()<br>                .eq(<span class="hljs-string">&quot;type_id&quot;</span>, typeId)<br>                .page(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>&lt;&gt;(current, SystemConstants.DEFAULT_PAGE_SIZE));<br>        <span class="hljs-comment">// 返回数据</span><br>        <span class="hljs-keyword">return</span> Result.ok(page.getRecords());<br>    &#125;<br><br>    <span class="hljs-comment">// 2.分页参数的计算</span><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 当前页的起始数据是第几条</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">from</span> <span class="hljs-operator">=</span> (current - <span class="hljs-number">1</span>) * SystemConstants.DEFAULT_PAGE_SIZE;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 当前页的结束数据是第几条</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> current * SystemConstants.DEFAULT_PAGE_SIZE;<br><br>    <span class="hljs-comment">// 3.查询redis，按照距离排序和分页 结果 shopId ,distance</span><br>    <span class="hljs-comment">// GEOSEARCH g1 FROMLONLAT 116.397904 39.909005 BYRADIUS 10 km WITHDIST</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> RedisConstants.SHOP_GEO_KEY + typeId;<br>    GeoResults&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt; results = stringRedisTemplate.opsForGeo()<br>            .search(key,<br>                    GeoReference.fromCoordinate(x, y),<br>                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Distance</span>(RedisConstants.GEO_DISTANT),<br>                    RedisGeoCommands.GeoRadiusCommandArgs.newGeoRadiusArgs().includeDistance().limit(end)<br>            );<br><br>    <span class="hljs-comment">// 4.解析shopId</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == results) &#123;<br>        <span class="hljs-keyword">return</span> Result.ok(Collections.emptyList());<br>    &#125;<br>    List&lt;GeoResult&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt;&gt; list = results.getContent();<br>    ArrayList&lt;Long&gt; shopIds = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(list.size());<br>    <span class="hljs-keyword">if</span>(list.size () &lt;= from) &#123;<br>      <span class="hljs-comment">// 已经没有下一页了</span><br>      <span class="hljs-keyword">return</span> Result.ok(Collections.emptyList());<br>    &#125;<br>    Map&lt;String, Distance&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(list.size());<br>    <span class="hljs-comment">// 4.1 截取从from 到 end</span><br>    list.stream().skip(from).forEach(result -&gt; &#123;<br>        <span class="hljs-comment">// 4.2获取店铺id</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">shopIdStr</span> <span class="hljs-operator">=</span> result.getContent().getName();<br>        shopIds.add(Long.valueOf(shopIdStr));<br><br>        <span class="hljs-comment">// 4.3获取距离</span><br>        <span class="hljs-type">Distance</span> <span class="hljs-variable">distance</span> <span class="hljs-operator">=</span> result.getDistance();<br><br>        map.put(shopIdStr, distance);<br>    &#125;);<br><br>    <span class="hljs-comment">// 5.根据id查询shop</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">joinStr</span> <span class="hljs-operator">=</span> StrUtil.join(<span class="hljs-string">&quot;,&quot;</span>, shopIds);<br>    List&lt;Shop&gt; shops = query().in(<span class="hljs-string">&quot;id&quot;</span>, shopIds).last(<span class="hljs-string">&quot;order by field(id,&quot;</span> + joinStr + <span class="hljs-string">&quot;)&quot;</span>).list();<br>    <span class="hljs-keyword">for</span> (Shop shop : shops) &#123;<br>        shop.setDistance(map.get(shop.getId().toString()).getValue());<br>    &#125;<br><br>    <span class="hljs-comment">// 6.返回</span><br>    <span class="hljs-keyword">return</span> Result.ok(shops);<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="2-签到"><a href="#2-签到" class="headerlink" title="2 签到"></a>2 签到</h1><h2 id="2-1-MySQL实现签到"><a href="#2-1-MySQL实现签到" class="headerlink" title="2.1 MySQL实现签到"></a>2.1 MySQL实现签到</h2><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/8e553025f3df4520a2cc7d1339f1d409.png" alt="在这里插入图片描述"></p><p>缺点：</p><p>用户一次签到，就是一条记录，假如有1000万用户，平均每人每年签到次数为10次，则这张表一年的数据量为 1亿条</p><p>每签到一次需要使用（8 + 8 + 1 + 1 + 3 + 1）共22 字节的内存，一个月则最多需要600多字节</p><h2 id="2-2-优化"><a href="#2-2-优化" class="headerlink" title="2.2 优化"></a>2.2 优化</h2><p>我们按月来统计用户签到信息，签到记录为1，未签到则记录为0.</p><p>把每一个bit位对应当月的每一天，形成了映射关系。用0和1标示业务状态，这种思路就称为位图（BitMap）。这样我们就用极小的空间，来实现了大量数据的表示。</p><p>Redis中是利用string类型数据结构实现BitMap，因此最大上限是512M，转换为bit则是 232个bit位。</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/e35598cef7e547e8ab05eae512c65f0d.png" alt="在这里插入图片描述"></p><p>BitMap的操作命令有：</p><ul><li>SETBIT：向指定位置（offset）存入一个0或1,从0开始</li><li>GETBIT ：获取指定位置（offset）的bit值</li><li>BITCOUNT ：统计BitMap中值为1的bit位的数量</li><li>BITFIELD ：操作（查询、修改、自增）BitMap中bit数组中的指定位置（offset）的值</li><li>BITFIELD_RO ：获取BitMap中bit数组，并以十进制形式返回</li><li>BITOP ：将多个BitMap的结果做位运算（与 、或、异或）</li><li>BITPOS ：查找bit数组中指定范围内第一个0或1出现的位置</li></ul><p>那么，如何完成用户签到？</p><p>思路：我们可以把年和月作为bitMap的key，然后保存到一个bitMap中，每次签到就到对应的位上把数字从0变成1，只要对应是1，就表明说明这一天已经签到了，反之则没有签到。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@PostMapping(&quot;/sign&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">sign</span><span class="hljs-params">()</span>&#123;<br>  <span class="hljs-keyword">return</span> userService.sign();<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> com.hmdp.dto.Result</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> //签到</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">sign</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 1.获取当前登录用户</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br>    <span class="hljs-comment">// 2.获取日期</span><br>    <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> LocalDateTime.now();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">keySuffix</span> <span class="hljs-operator">=</span> now.format(DateTimeFormatter.ofPattern(<span class="hljs-string">&quot;:yyyyMM&quot;</span>));<br><br>    <span class="hljs-comment">// 3.拼接key</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> RedisConstants.USER_SIGN_KEY + userId + keySuffix;<br><br>    <span class="hljs-comment">// 4.获取今天是本月的第几天</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">dayOfMonth</span> <span class="hljs-operator">=</span> now.getDayOfMonth();<br><br>    <span class="hljs-comment">// 5.写入Redis SETBIT key offset 1</span><br>    stringRedisTemplate.opsForValue().setBit(key, dayOfMonth - <span class="hljs-number">1</span>, <span class="hljs-literal">true</span>);<br><br>    <span class="hljs-keyword">return</span> Result.ok();<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-3-统计连续签到"><a href="#2-3-统计连续签到" class="headerlink" title="2.3 统计连续签到"></a>2.3 统计连续签到</h2><p><strong>问题1：</strong>什么叫做连续签到天数？<br>从最后一次签到开始向前统计，直到遇到第一次未签到为止，计算总的签到次数，就是连续签到天数。</p><p>Java逻辑代码：获得当前这个月的最后一次签到数据，定义一个计数器，然后不停的向前统计，直到获得第一个非0的数字即可，每得到一个非0的数字计数器+1，直到遍历完所有的数据，就可以获得当前月的签到总天数了</p><p><strong>问题2：</strong>如何得到本月到今天为止的所有签到数据？</p><p>BITFIELD key GET u[dayOfMonth] 0</p><p>假设今天是10号，那么我们就可以从当前月的第一天开始，获得到当前这一天的位数，是10号，那么就是10位，去拿这段时间的数据，就能拿到所有的数据了，那么这10天里边签到了多少次呢？统计有多少个1即可。</p><p><strong>问题3：</strong>如何从后向前遍历每个bit位？</p><p>注意：bitMap返回的数据是10进制，哪假如说返回一个数字8，那么我哪儿知道到底哪些是0，哪些是1呢？我们只需要让得到的10进制数字和1做与运算就可以了，因为1只有遇见1 才是1，其他数字都是0 ，我们把签到结果和1进行与操作，每与一次，就把签到结果向右移动一位，依次内推，我们就能完成逐个遍历的效果了。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/sign/count&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">signCount</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-keyword">return</span> userService.signCount();<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> com.hmdp.dto.Result</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> //合计签到总数</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">signCount</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 1.获取当前登录用户</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br>    <span class="hljs-comment">// 2.获取日期</span><br>    <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> LocalDateTime.now();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">keySuffix</span> <span class="hljs-operator">=</span> now.format(DateTimeFormatter.ofPattern(<span class="hljs-string">&quot;:yyyyMM&quot;</span>));<br><br>    <span class="hljs-comment">// 3.拼接key</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> RedisConstants.USER_SIGN_KEY + userId + keySuffix;<br><br>    <span class="hljs-comment">// 4.获取今天是本月的第几天</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">dayOfMonth</span> <span class="hljs-operator">=</span> now.getDayOfMonth();<br><br>    <span class="hljs-comment">// 5.获取本月截至今天为止所有的签到记录，返回的是一个十进制的数字</span><br>    <span class="hljs-comment">// BITFIELD bm1 GET u2 0</span><br>    List&lt;Long&gt; results = stringRedisTemplate.opsForValue().bitField(<br>            key, BitFieldSubCommands.create()<br>                    .get(BitFieldSubCommands.BitFieldType.unsigned(dayOfMonth))<br>                    .valueAt(<span class="hljs-number">0</span>)<br>    );<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == results || results.isEmpty()) &#123;<br>        <span class="hljs-comment">// 没有任何签到结果</span><br>        <span class="hljs-keyword">return</span> Result.ok(<span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-type">Long</span> <span class="hljs-variable">num</span> <span class="hljs-operator">=</span> results.get(<span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == num || <span class="hljs-number">0</span> == num) &#123;<br>        <span class="hljs-keyword">return</span> Result.ok(<span class="hljs-number">0</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// 6.循环遍历</span><br>    <span class="hljs-comment">// 计数器</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">calCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>        <span class="hljs-comment">// 7.让这个数字与1做与运算，得到数字的最后一个bit位</span><br>        <span class="hljs-keyword">if</span> ((num &amp; <span class="hljs-number">1</span>) == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-comment">// 判断这个bit位是否为0，如果为0说明未签到，结束</span><br>            <span class="hljs-keyword">break</span>;<br><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// 如果不为0，说明已签到，计数器 + 1</span><br>            calCount++;<br>        &#125;<br><br><br>        <span class="hljs-comment">// 把数字(无符号)右移一位，抛弃最后一个bit位，继续下一个bit位</span><br>        num = (num &gt;&gt;&gt; <span class="hljs-number">1</span>);<br><br>    &#125;<br><br><br>    <span class="hljs-keyword">return</span> Result.ok(calCount);<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="3-UV统计"><a href="#3-UV统计" class="headerlink" title="3 UV统计"></a>3 UV统计</h1><h2 id="3-1-UV统计的基本思路"><a href="#3-1-UV统计的基本思路" class="headerlink" title="3.1 UV统计的基本思路"></a>3.1 UV统计的基本思路</h2><ul><li>UV：全称Unique Visitor，也叫独立访客量，是指通过互联网访问、浏览这个网页的自然人。1天内同一个用户多次访问该网站，只记录1次。</li><li>PV：全称Page View，也叫页面访问量或点击量，用户每访问网站的一个页面，记录1次PV，用户多次打开页面，则记录多次PV。往往用来衡量网站的流量。</li></ul><p>UV统计在服务端做会比较麻烦，因为要判断该用户是否已经统计过了，需要将统计过的用户信息保存。但是如果每个访问的用户都保存到Redis中，数据量会非常恐怖，那怎么处理呢？</p><p>Hyperloglog(HLL)是从Loglog算法派生的概率算法，用于确定非常大的集合的基数，而不需要存储其所有值。相关算法原理大家可以参考：<a href="https://juejin.cn/post/6844903785744056333#heading-0">Hyperloglog算法</a></p><p>Redis中的HLL是基于string结构实现的，单个HLL的内存永远小于16kb，内存占用低的令人发指！作为代价，其测量结果是概率性的，有小于0.81％的误差。不过对于UV统计来说，这完全可以忽略。</p><h2 id="3-2-HypeLogLog实现统计"><a href="#3-2-HypeLogLog实现统计" class="headerlink" title="3.2 HypeLogLog实现统计"></a>3.2 HypeLogLog实现统计</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testHyperLog</span><span class="hljs-params">()</span> &#123;<br>    String[] values = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[<span class="hljs-number">1000</span>];<br>    <span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000000</span>; i++) &#123;<br>        j = i % <span class="hljs-number">1000</span>;<br>        values[j] = <span class="hljs-string">&quot;user_&quot;</span> + i;<br>        <span class="hljs-keyword">if</span> (j == <span class="hljs-number">999</span>) &#123;<br>            <span class="hljs-comment">// 发送到Redis</span><br>            stringRedisTemplate.opsForHyperLogLog().add(<span class="hljs-string">&quot;hl&quot;</span>, values);<br><br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// 统计数量</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForHyperLogLog().size(<span class="hljs-string">&quot;hl&quot;</span>);<br>    System.out.println(<span class="hljs-string">&quot;统计的总数是：&quot;</span> + count);<br><br>&#125;<br><br></code></pre></td></tr></table></figure><ul><li>计算出来统计的总数是997593</li></ul>]]></content>
    
    
    <categories>
      
      <category>redis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>redis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>redis-探店&amp;关注</title>
    <link href="/redis-%E6%8E%A2%E5%BA%97-%E5%85%B3%E6%B3%A8/47cab89a5a24/"/>
    <url>/redis-%E6%8E%A2%E5%BA%97-%E5%85%B3%E6%B3%A8/47cab89a5a24/</url>
    
    <content type="html"><![CDATA[<h1 id="1-达人探店"><a href="#1-达人探店" class="headerlink" title="1 达人探店"></a>1 达人探店</h1><h2 id="1-1-分享探店图文"><a href="#1-1-分享探店图文" class="headerlink" title="1.1 分享探店图文"></a>1.1 分享探店图文</h2><h3 id="1-1-1-发布探店笔记"><a href="#1-1-1-发布探店笔记" class="headerlink" title="1.1.1 发布探店笔记"></a>1.1.1 发布探店笔记</h3><p>涉及两个数据库表：</p><ul><li>tb_blog：探店笔记表，包含笔记中的标题、文字、图片等</li><li>tb_blog_comments：其他用户对探店笔记的评价</li></ul><p>发布流程：</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/b5533c1860f44bf3956b673ff727a4be.png" alt="在这里插入图片描述"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;upload&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UploadController</span> &#123;<br><br>    <span class="hljs-meta">@PostMapping(&quot;blog&quot;)</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">uploadImage</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;file&quot;)</span> MultipartFile image)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 获取原始文件名称</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">originalFilename</span> <span class="hljs-operator">=</span> image.getOriginalFilename();<br>            <span class="hljs-comment">// 生成新文件名</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">fileName</span> <span class="hljs-operator">=</span> createNewFileName(originalFilename);<br>            <span class="hljs-comment">// 保存文件</span><br>            image.transferTo(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(SystemConstants.IMAGE_UPLOAD_DIR, fileName));<br>            <span class="hljs-comment">// 返回结果</span><br>            log.debug(<span class="hljs-string">&quot;文件上传成功，&#123;&#125;&quot;</span>, fileName);<br>            <span class="hljs-keyword">return</span> Result.ok(fileName);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;文件上传失败&quot;</span>, e);<br>        &#125;<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">IMAGE_UPLOAD_DIR</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;xxxx&quot;</span>;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/blog&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BlogController</span> &#123;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> IBlogService blogService;<br><br>    <span class="hljs-meta">@PostMapping</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">saveBlog</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> Blog blog)</span> &#123;<br>        <span class="hljs-comment">//获取登录用户</span><br>        <span class="hljs-type">UserDTO</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> UserHolder.getUser();<br>        blog.setUpdateTime(user.getId());<br>        <span class="hljs-comment">//保存探店博文</span><br>        blogService.saveBlog(blog);<br>        <span class="hljs-comment">//返回id</span><br>        <span class="hljs-keyword">return</span> Result.ok(blog.getId());<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="1-1-2-查看探店笔记"><a href="#1-1-2-查看探店笔记" class="headerlink" title="1.1.2 查看探店笔记"></a>1.1.2 查看探店笔记</h3><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/6112d227a59c43dd85cf76245c024656.png" alt="在这里插入图片描述"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/hot&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">queryHotBlog</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(value = &quot;current&quot;, defaultValue = &quot;1&quot;)</span> Integer current)</span> &#123;<br>    <span class="hljs-keyword">return</span> blogService.queryHotBlog(current);<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> com.hmdp.dto.Result</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> //查看笔记详情页面</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">queryBlogById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;<br>    <span class="hljs-keyword">return</span> blogService.queryBlogById(id);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BlogServiceImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ServiceImpl</span>&lt;BlogMapper, Blog&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IBlogService</span> &#123;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> IUserService userService;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">queryHotBlog</span><span class="hljs-params">(Integer current)</span> &#123;<br>        <span class="hljs-comment">// 根据用户查询</span><br>        Page&lt;Blog&gt; page = query()<br>                .orderByDesc(<span class="hljs-string">&quot;liked&quot;</span>)<br>                .page(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>&lt;&gt;(current, SystemConstants.MAX_PAGE_SIZE));<br>        <span class="hljs-comment">// 获取当前页数据</span><br>        List&lt;Blog&gt; records = page.getRecords();<br>        <span class="hljs-comment">// 查询用户</span><br>        records.forEach(<span class="hljs-built_in">this</span>::queryBlogUser);<br>        <span class="hljs-keyword">return</span> Result.ok(records);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> com.hmdp.dto.Result</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@description</span> //查看笔记详情页面</span><br><span class="hljs-comment">     **/</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">queryBlogById</span><span class="hljs-params">(Long id)</span> &#123;<br>        <span class="hljs-comment">// 1.查询blog</span><br>        <span class="hljs-type">Blog</span> <span class="hljs-variable">blog</span> <span class="hljs-operator">=</span> getById(id);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == blog) &#123;<br>            <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;笔记不存在!&quot;</span>);<br>        &#125;<br>        <span class="hljs-comment">// 2.查询blog相关的用户</span><br>        queryBlogUser(blog);<br>        <span class="hljs-keyword">return</span> Result.ok(blog);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">queryBlogUser</span><span class="hljs-params">(Blog blog)</span> &#123;<br>        <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> blog.getUserId();<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userService.getById(userId);<br>        blog.setName(user.getNickName());<br>        blog.setIcon(user.getIcon());<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="1-2-点赞功能"><a href="#1-2-点赞功能" class="headerlink" title="1.2 点赞功能"></a>1.2 点赞功能</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/likes/&#123;id&#125;&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">queryBlogLikes</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;<br>    <span class="hljs-comment">//修改点赞数量</span><br>    blogService.update().setSql(<span class="hljs-string">&quot;liked = liked +1 &quot;</span>).eq(<span class="hljs-string">&quot;id&quot;</span>,id).update();<br>    <span class="hljs-keyword">return</span> Result.ok();<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>这样会有一个问题，一个用户可以多次的点赞</p></blockquote><h3 id="1-2-1-修改"><a href="#1-2-1-修改" class="headerlink" title="1.2.1 修改"></a>1.2.1 修改</h3><ol><li><p>给Blog类中添加一个isLike字段，标示是否被当前用户点赞</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@TableField(exist = false)</span><br><span class="hljs-keyword">private</span> Boolean isLike;<br></code></pre></td></tr></table></figure></li><li><p>修改点赞功能，利用Redis的set集合判断是否点赞过，未点赞过则点赞数+1，已点赞过则点赞数-1</p></li><li><p>修改根据id查询Blog的业务，判断当前登录用户是否点赞过，赋值给isLike字段</p></li><li><p>修改分页查询Blog业务，判断当前登录用户是否点赞过，赋值给isLike字段</p></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@PutMapping(&quot;/like/&#123;id&#125;&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">likeBlog</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;<br>    <span class="hljs-comment">// 修改点赞数量 update tb_blog set liked = liked where id = ?</span><br>    <span class="hljs-comment">//blogService.update().setSql(&quot;liked = liked + 1&quot;).eq(&quot;id&quot;, id).update();</span><br>    <span class="hljs-keyword">return</span> blogService.likeBlog(id);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BlogServiceImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ServiceImpl</span>&lt;BlogMapper, Blog&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IBlogService</span> &#123;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> IUserService userService;<br><br>    <span class="hljs-meta">@Resource</span><br>    StringRedisTemplate stringRedisTemplate;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">queryHotBlog</span><span class="hljs-params">(Integer current)</span> &#123;<br>        <span class="hljs-comment">// 根据用户查询</span><br>        Page&lt;Blog&gt; page = query()<br>                .orderByDesc(<span class="hljs-string">&quot;liked&quot;</span>)<br>                .page(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>&lt;&gt;(current, SystemConstants.MAX_PAGE_SIZE));<br>        <span class="hljs-comment">// 获取当前页数据</span><br>        List&lt;Blog&gt; records = page.getRecords();<br>        <span class="hljs-comment">// 查询用户</span><br>        records.forEach(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Consumer</span>&lt;Blog&gt;() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">accept</span><span class="hljs-params">(Blog blog)</span> &#123;<br>                queryBlogUser(blog);<br>                isBlogLiked(blog);<br>            &#125;<br>        &#125;);<br>        <span class="hljs-comment">//records.forEach(this::queryBlogUser);</span><br>        <span class="hljs-keyword">return</span> Result.ok(records);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> com.hmdp.dto.Result</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@description</span> //查看笔记详情页面</span><br><span class="hljs-comment">     **/</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">queryBlogById</span><span class="hljs-params">(Long id)</span> &#123;<br>        <span class="hljs-comment">// 1.查询blog</span><br>        <span class="hljs-type">Blog</span> <span class="hljs-variable">blog</span> <span class="hljs-operator">=</span> getById(id);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == blog) &#123;<br>            <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;笔记不存在!&quot;</span>);<br>        &#125;<br>        <span class="hljs-comment">// 2.查询blog相关的用户</span><br>        queryBlogUser(blog);<br>        <span class="hljs-comment">// 3.查询blog是否被点赞</span><br>        isBlogLiked(blog);<br>        <span class="hljs-keyword">return</span> Result.ok(blog);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> void</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@description</span> //当前笔记是否被当前用户点赞</span><br><span class="hljs-comment">     **/</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">isBlogLiked</span><span class="hljs-params">(Blog blog)</span> &#123;<br>        <span class="hljs-type">Long</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> blog.getId();<br>        <span class="hljs-comment">// 1.获取当前登录用户</span><br>        <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br>        <span class="hljs-comment">// 2.判断当前登录用户是否点赞 key  &quot;blog:liked:&quot; + id</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> RedisConstants.BLOG_LIKED_KEY + id;<br>        <span class="hljs-type">Boolean</span> <span class="hljs-variable">isMember</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForSet().isMember(key, userId.toString());<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> BooleanUtil.isTrue(isMember);<br>        blog.setIsLike(flag);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> com.hmdp.dto.Result</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@description</span> // 点赞</span><br><span class="hljs-comment">     **/</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">likeBlog</span><span class="hljs-params">(Long id)</span> &#123;<br>        <span class="hljs-comment">// 1.获取当前登录用户</span><br>        <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br>        <span class="hljs-comment">// 2.判断当前登录用户是否点赞 key  &quot;blog:liked:&quot; + id</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> RedisConstants.BLOG_LIKED_KEY + id;<br>        <span class="hljs-type">Boolean</span> <span class="hljs-variable">isMember</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForSet().isMember(key, userId.toString());<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> BooleanUtil.isTrue(isMember);<br><br>        <span class="hljs-keyword">if</span> (!flag) &#123;<br>            <span class="hljs-comment">// 3.如果未点赞，可以点赞</span><br>            <span class="hljs-comment">// 3.1数据库点赞数+1</span><br>            <span class="hljs-comment">// 修改点赞数量 update tb_blog set liked = liked where id = ?</span><br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">isSuccess</span> <span class="hljs-operator">=</span> update().setSql(<span class="hljs-string">&quot;liked = liked + 1&quot;</span>).eq(<span class="hljs-string">&quot;id&quot;</span>, id).update();<br>            <span class="hljs-keyword">if</span> (isSuccess) &#123;<br>                <span class="hljs-comment">// 3.2保存用户到Redis的set集合</span><br>                stringRedisTemplate.opsForSet().add(key, userId.toString());<br>            &#125;<br><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// 4.如果已经点赞，取消点赞</span><br>            <span class="hljs-comment">// 4.1数据库点赞数 -1</span><br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">isSuccess</span> <span class="hljs-operator">=</span> update().setSql(<span class="hljs-string">&quot;liked = liked - 1&quot;</span>).eq(<span class="hljs-string">&quot;id&quot;</span>, id).update();<br><br>            <span class="hljs-keyword">if</span> (isSuccess) &#123;<br>                <span class="hljs-comment">// 4.2把用户从Redis的set集合移除</span><br>                stringRedisTemplate.opsForSet().remove(key, userId.toString());<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">queryBlogUser</span><span class="hljs-params">(Blog blog)</span> &#123;<br>        <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> blog.getUserId();<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userService.getById(userId);<br>        blog.setName(user.getNickName());<br>        blog.setIcon(user.getIcon());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="1-3-基于List实现点赞用户列表"><a href="#1-3-基于List实现点赞用户列表" class="headerlink" title="1.3 基于List实现点赞用户列表"></a>1.3 基于List实现点赞用户列表</h2><p>在探店笔记的详情页面，应该把给该笔记点赞的人显示出来，比如最早点赞的TOP5，形成点赞排行榜：</p><p>之前的点赞是放到set集合，但是set集合是不能排序的，所以这个时候，咱们可以采用一个可以排序的set集合，就是咱们的sortedSet</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/4e5a3c274c654725b6ad8477171a5c13.png" alt="在这里插入图片描述"></p><h3 id="1-3-1-List-Set-SortedSet对比"><a href="#1-3-1-List-Set-SortedSet对比" class="headerlink" title="1.3.1 List&#x2F;Set&#x2F;SortedSet对比"></a>1.3.1 List&#x2F;Set&#x2F;SortedSet对比</h3><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/d592308328fc46d5a4b4dfe0159cf0e2.png" alt="在这里插入图片描述"></p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/c584590a6d3145d4a122928ceb96e99d.png" alt="在这里插入图片描述"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BlogServiceImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ServiceImpl</span>&lt;BlogMapper, Blog&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IBlogService</span> &#123;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> IUserService userService;<br><br>    <span class="hljs-meta">@Resource</span><br>    StringRedisTemplate stringRedisTemplate;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">queryHotBlog</span><span class="hljs-params">(Integer current)</span> &#123;<br>        <span class="hljs-comment">// 根据用户查询</span><br>        Page&lt;Blog&gt; page = query()<br>                .orderByDesc(<span class="hljs-string">&quot;liked&quot;</span>)<br>                .page(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>&lt;&gt;(current, SystemConstants.MAX_PAGE_SIZE));<br>        <span class="hljs-comment">// 获取当前页数据</span><br>        List&lt;Blog&gt; records = page.getRecords();<br>        <span class="hljs-comment">// 查询用户</span><br>        records.forEach(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Consumer</span>&lt;Blog&gt;() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">accept</span><span class="hljs-params">(Blog blog)</span> &#123;<br>                queryBlogUser(blog);<br>                isBlogLiked(blog);<br>            &#125;<br>        &#125;);<br>        <span class="hljs-comment">//records.forEach(this::queryBlogUser);</span><br>        <span class="hljs-keyword">return</span> Result.ok(records);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> com.hmdp.dto.Result</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@description</span> //查看笔记详情页面</span><br><span class="hljs-comment">     **/</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">queryBlogById</span><span class="hljs-params">(Long id)</span> &#123;<br>        <span class="hljs-comment">// 1.查询blog</span><br>        <span class="hljs-type">Blog</span> <span class="hljs-variable">blog</span> <span class="hljs-operator">=</span> getById(id);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == blog) &#123;<br>            <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;笔记不存在!&quot;</span>);<br>        &#125;<br>        <span class="hljs-comment">// 2.查询blog相关的用户</span><br>        queryBlogUser(blog);<br>        <span class="hljs-comment">// 3.查询blog是否被点赞</span><br>        isBlogLiked(blog);<br>        <span class="hljs-keyword">return</span> Result.ok(blog);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> void</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@description</span> //当前笔记是否被当前用户点赞(Set)</span><br><span class="hljs-comment">     **/</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">isBlogLikedSet</span><span class="hljs-params">(Blog blog)</span> &#123;<br>        <span class="hljs-type">Long</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> blog.getId();<br>        <span class="hljs-comment">// 1.获取当前登录用户</span><br>        <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br>        <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == userId) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-comment">// 2.判断当前登录用户是否点赞 key  &quot;blog:liked:&quot; + id</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> RedisConstants.BLOG_LIKED_KEY + id;<br>        <span class="hljs-type">Boolean</span> <span class="hljs-variable">isMember</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForSet().isMember(key, userId.toString());<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> BooleanUtil.isTrue(isMember);<br>        blog.setIsLike(flag);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> void</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@description</span> //当前笔记是否被当前用户点赞(SortedSet)</span><br><span class="hljs-comment">     **/</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">isBlogLiked</span><span class="hljs-params">(Blog blog)</span> &#123;<br>        <span class="hljs-type">Long</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> blog.getId();<br>        <span class="hljs-comment">// 1.获取当前登录用户</span><br>        <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br>        <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == userId) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-comment">// 2.判断当前登录用户是否点赞 key  &quot;blog:liked:&quot; + id</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> RedisConstants.BLOG_LIKED_KEY + id;<br>        <span class="hljs-type">Double</span> <span class="hljs-variable">score</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForZSet().score(key, userId.toString());<br>        blog.setIsLike(<span class="hljs-literal">null</span> != score);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> com.hmdp.dto.Result</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@description</span> // 点赞(Set集合)</span><br><span class="hljs-comment">     **/</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">likeBlogSet</span><span class="hljs-params">(Long id)</span> &#123;<br>        <span class="hljs-comment">// 1.获取当前登录用户</span><br>        <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br>        <span class="hljs-comment">// 2.判断当前登录用户是否点赞 key  &quot;blog:liked:&quot; + id</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> RedisConstants.BLOG_LIKED_KEY + id;<br>        <span class="hljs-type">Boolean</span> <span class="hljs-variable">isMember</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForSet().isMember(key, userId.toString());<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> BooleanUtil.isTrue(isMember);<br><br>        <span class="hljs-keyword">if</span> (!flag) &#123;<br>            <span class="hljs-comment">// 3.如果未点赞，可以点赞</span><br>            <span class="hljs-comment">// 3.1数据库点赞数+1</span><br>            <span class="hljs-comment">// 修改点赞数量 update tb_blog set liked = liked where id = ?</span><br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">isSuccess</span> <span class="hljs-operator">=</span> update().setSql(<span class="hljs-string">&quot;liked = liked + 1&quot;</span>).eq(<span class="hljs-string">&quot;id&quot;</span>, id).update();<br>            <span class="hljs-keyword">if</span> (isSuccess) &#123;<br>                <span class="hljs-comment">// 3.2保存用户到Redis的set集合</span><br>                stringRedisTemplate.opsForSet().add(key, userId.toString());<br>            &#125;<br><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// 4.如果已经点赞，取消点赞</span><br>            <span class="hljs-comment">// 4.1数据库点赞数 -1</span><br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">isSuccess</span> <span class="hljs-operator">=</span> update().setSql(<span class="hljs-string">&quot;liked = liked - 1&quot;</span>).eq(<span class="hljs-string">&quot;id&quot;</span>, id).update();<br><br>            <span class="hljs-keyword">if</span> (isSuccess) &#123;<br>                <span class="hljs-comment">// 4.2把用户从Redis的set集合移除</span><br>                stringRedisTemplate.opsForSet().remove(key, userId.toString());<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> com.hmdp.dto.Result</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@description</span> // 点赞(SortedSet集合)</span><br><span class="hljs-comment">     **/</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">likeBlog</span><span class="hljs-params">(Long id)</span> &#123;<br>        <span class="hljs-comment">// 1.获取当前登录用户</span><br>        <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br>        <span class="hljs-comment">// 2.判断当前登录用户是否点赞 key  &quot;blog:liked:&quot; + id</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> RedisConstants.BLOG_LIKED_KEY + id;<br>        <span class="hljs-type">Double</span> <span class="hljs-variable">score</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForZSet().score(key, userId.toString());<br><br>        <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == score) &#123;<br>            <span class="hljs-comment">// 3.如果未点赞，可以点赞</span><br>            <span class="hljs-comment">// 3.1数据库点赞数+1</span><br>            <span class="hljs-comment">// 修改点赞数量 update tb_blog set liked = liked where id = ?</span><br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">isSuccess</span> <span class="hljs-operator">=</span> update().setSql(<span class="hljs-string">&quot;liked = liked + 1&quot;</span>).eq(<span class="hljs-string">&quot;id&quot;</span>, id).update();<br>            <span class="hljs-keyword">if</span> (isSuccess) &#123;<br>                <span class="hljs-comment">// 3.2保存用户到Redis的sortedset集合 zadd key score member</span><br>                stringRedisTemplate.opsForZSet().add(key, userId.toString(), System.currentTimeMillis());<br>            &#125;<br><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// 4.如果已经点赞，取消点赞</span><br>            <span class="hljs-comment">// 4.1数据库点赞数 -1</span><br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">isSuccess</span> <span class="hljs-operator">=</span> update().setSql(<span class="hljs-string">&quot;liked = liked - 1&quot;</span>).eq(<span class="hljs-string">&quot;id&quot;</span>, id).update();<br><br>            <span class="hljs-keyword">if</span> (isSuccess) &#123;<br>                <span class="hljs-comment">// 4.2把用户从Redis的set集合移除</span><br>                stringRedisTemplate.opsForZSet().remove(key, userId.toString());<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">queryBlogUser</span><span class="hljs-params">(Blog blog)</span> &#123;<br>        <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> blog.getUserId();<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userService.getById(userId);<br>        blog.setName(user.getNickName());<br>        blog.setIcon(user.getIcon());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>BlogController.java</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-variable">@GetMapping</span>(<span class="hljs-string">&quot;/likes/&#123;id&#125;&quot;</span>)<br>public Result <span class="hljs-built_in">queryBlogLikes</span>(<span class="hljs-variable">@PathVariable</span>(<span class="hljs-string">&quot;id&quot;</span>) Long id) &#123;<br>    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">blogService</span><span class="hljs-selector-class">.queryBlogLikes</span>(id);<br>&#125;<br><br></code></pre></td></tr></table></figure><p>BlogServiceImpl.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> com.hmdp.dto.Result</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> //查询点赞列表</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">queryBlogLikes</span><span class="hljs-params">(Long id)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> RedisConstants.BLOG_LIKED_KEY + id;<br>    <span class="hljs-comment">// 1.查询top5的点赞用户 zrange key 0 4</span><br>    Set&lt;String&gt; top5 = stringRedisTemplate.opsForZSet().range(key, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == top5 || top5.isEmpty()) &#123;<br>        <span class="hljs-keyword">return</span> Result.ok(Collections.emptyList());<br>    &#125;<br><br>    <span class="hljs-comment">// 2.解析出其中的用户id</span><br>    List&lt;Long&gt; ids = top5.stream().map(Long::valueOf).collect(Collectors.toList());<br><br>    <span class="hljs-comment">// 3.根据用户id查询用户</span><br>    List&lt;UserDTO&gt; userDTOS = userService.listByIds(ids).stream().map(user -&gt; BeanUtil.copyProperties(user, UserDTO.class)).collect(Collectors.toList());<br><br>    <span class="hljs-comment">// 4.返回</span><br>    <span class="hljs-keyword">return</span> Result.ok(userDTOS);<br>&#125;<br><br></code></pre></td></tr></table></figure><blockquote><p>此时会发现点赞的顺序是反的，问题就出现在了SQL上<br><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/5eac4ff438384024bbf09f1ea6663725.png" alt="在这里插入图片描述"></p><p>那么此时修改SQL即可解决</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> tb_user <span class="hljs-keyword">WHERE</span> id <span class="hljs-keyword">IN</span> (<span class="hljs-string">&#x27;5&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>) <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> FIELD(id,<span class="hljs-number">5</span>,<span class="hljs-number">1</span>);<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 3.根据用户id查询用户</span><br><span class="hljs-comment">//List&lt;UserDTO&gt; userDTOS = userService.listByIds(ids).stream().map(user -&gt; BeanUtil.copyProperties(user, UserDTO.class)).collect(Collectors.toList());</span><br>List&lt;UserDTO&gt; userDTOS = userService.query()<br>        <span class="hljs-comment">// SELECT * FROM tb_user WHERE id IN (&#x27;5&#x27;,&#x27;1&#x27;) ORDER BY FIELD(id,5,1);</span><br>        .in(<span class="hljs-string">&quot;id&quot;</span>, ids)<br>        .last(<span class="hljs-string">&quot;order by field (id,&quot;</span> + idsStr + <span class="hljs-string">&quot;) &quot;</span>).list()<br>        .stream().map(user -&gt; BeanUtil.copyProperties(user, UserDTO.class))<br>        .collect(Collectors.toList());<br><br></code></pre></td></tr></table></figure></blockquote><h1 id="2-关注列表"><a href="#2-关注列表" class="headerlink" title="2 关注列表"></a>2 关注列表</h1><h2 id="2-1-添加关注"><a href="#2-1-添加关注" class="headerlink" title="2.1 添加关注"></a>2.1 添加关注</h2><p>针对用户的操作：可以对用户进行关注和取消关注功能。</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/ebe0a18a3d604e0a815444f0a591ac1a.png" alt="在这里插入图片描述"></p><p>涉及到数据库表tb_follow：<br><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/d1e397e897934c87818c67b44b717cea.png" alt="在这里插入图片描述"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/follow&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FollowController</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> IFollowService iFollowService;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> com.hmdp.dto.Result</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@description</span> //关注博主</span><br><span class="hljs-comment">     **/</span><br>    <span class="hljs-meta">@PutMapping(&quot;/&#123;id&#125;/&#123;isFollow&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">follow</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long followUserId, <span class="hljs-meta">@PathVariable(&quot;isFollow&quot;)</span> <span class="hljs-type">boolean</span> isFollow)</span> &#123;<br>        <span class="hljs-keyword">return</span> iFollowService.follow(followUserId, isFollow);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> com.hmdp.dto.Result</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@description</span> //判断是否关注</span><br><span class="hljs-comment">     **/</span><br>    <span class="hljs-meta">@GetMapping(&quot;/or/not/&#123;id&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">isFollow</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long followUserId)</span> &#123;<br>        <span class="hljs-keyword">return</span> iFollowService.isFollow(followUserId);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FollowServiceImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ServiceImpl</span>&lt;FollowMapper, Follow&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IFollowService</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> com.hmdp.dto.Result</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@description</span> //关注</span><br><span class="hljs-comment">     **/</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">follow</span><span class="hljs-params">(Long followUserId, <span class="hljs-type">boolean</span> isFollow)</span> &#123;<br>        <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br>        <span class="hljs-comment">// 1.判断是关注还是取关</span><br>        <span class="hljs-keyword">if</span> (isFollow) &#123;<br>            <span class="hljs-comment">// 2.关注，新增数据</span><br>            <span class="hljs-type">Follow</span> <span class="hljs-variable">follow</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Follow</span>();<br>            follow.setFollowUserId(followUserId);<br>            follow.setUserId(userId);<br>            <span class="hljs-comment">// insert into tb_follow values()</span><br>            save(follow);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// 3.取关，删除</span><br>            <span class="hljs-comment">// delete from follow where user_id = ? and follow_user_id = ?</span><br>            LambdaQueryWrapper&lt;Follow&gt; wrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;&gt;();<br>            remove(wrapper.eq(Follow::getUserId, userId).eq(Follow::getFollowUserId, followUserId));<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> Result.ok();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> com.hmdp.dto.Result</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@description</span> //判断是否关注</span><br><span class="hljs-comment">     **/</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">isFollow</span><span class="hljs-params">(Long followUserId)</span> &#123;<br>        <span class="hljs-comment">// 1.获取用户id</span><br>        <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br>        <span class="hljs-comment">// 2.查询是否关注 select * from tb_follow where  user_id = ? and follow_user_id = ?</span><br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> query().eq(<span class="hljs-string">&quot;user_id&quot;</span>, userId).eq(<span class="hljs-string">&quot;follow_user_id&quot;</span>, followUserId).count();<br>        <span class="hljs-keyword">return</span> Result.ok(count &gt; <span class="hljs-number">0</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-2-共同关注列表"><a href="#2-2-共同关注列表" class="headerlink" title="2.2 共同关注列表"></a>2.2 共同关注列表</h2><p>想要去看共同关注的好友，需要首先进入到这个页面，这个页面会发起两个请求</p><p>1、去查询用户的详情</p><p>2、去查询用户的笔记</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/630737bdbb184d1dac25b2db1d30b4df.png" alt="在这里插入图片描述"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// UserController 根据id查询用户</span><br><span class="hljs-meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">queryUserById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long userId)</span>&#123;<br><span class="hljs-comment">// 查询详情</span><br><span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userService.getById(userId);<br><span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">return</span> Result.ok();<br>&#125;<br><span class="hljs-type">UserDTO</span> <span class="hljs-variable">userDTO</span> <span class="hljs-operator">=</span> BeanUtil.copyProperties(user, UserDTO.class);<br><span class="hljs-comment">// 返回</span><br><span class="hljs-keyword">return</span> Result.ok(userDTO);<br>&#125;<br><br><span class="hljs-comment">// BlogController  根据id查询博主的探店笔记</span><br><span class="hljs-meta">@GetMapping(&quot;/of/user&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">queryBlogByUserId</span><span class="hljs-params">(</span><br><span class="hljs-params"><span class="hljs-meta">@RequestParam(value = &quot;current&quot;, defaultValue = &quot;1&quot;)</span> Integer current,</span><br><span class="hljs-params"><span class="hljs-meta">@RequestParam(&quot;id&quot;)</span> Long id)</span> &#123;<br><span class="hljs-comment">// 根据用户查询</span><br>Page&lt;Blog&gt; page = blogService.query()<br>.eq(<span class="hljs-string">&quot;user_id&quot;</span>, id).page(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>&lt;&gt;(current, SystemConstants.MAX_PAGE_SIZE));<br><span class="hljs-comment">// 获取当前页数据</span><br>List&lt;Blog&gt; records = page.getRecords();<br><span class="hljs-keyword">return</span> Result.ok(records);<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/d0cb2e5f62ab4f9c842e40615ec4a283.png" alt="在这里插入图片描述"></p><p>但是此时点击了之后发现共同关注报错，如何去解决共同关注的问题。模拟场景：A关注了B、C，而D关注了C、E，那么对于A和D来说他们的共同关注就是C，在Redis中可以使用set求交集</p><h3 id="2-2-1-修改"><a href="#2-2-1-修改" class="headerlink" title="2.2.1 修改"></a>2.2.1 修改</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> com.hmdp.dto.Result</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> //关注</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">follow</span><span class="hljs-params">(Long followUserId, <span class="hljs-type">boolean</span> isFollow)</span> &#123;<br>    <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> RedisConstants.FOLLOW_USER_LIST + userId;<br>    <span class="hljs-comment">// 1.判断是关注还是取关</span><br>    <span class="hljs-keyword">if</span> (isFollow) &#123;<br>        <span class="hljs-comment">// 2.关注，新增数据</span><br>        <span class="hljs-type">Follow</span> <span class="hljs-variable">follow</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Follow</span>();<br>        follow.setFollowUserId(followUserId);<br>        follow.setUserId(userId);<br>        <span class="hljs-comment">// insert into tb_follow values()</span><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">isSuccess</span> <span class="hljs-operator">=</span> save(follow);<br><br>        <span class="hljs-comment">// 加入Redis,实现共同关注</span><br>        <span class="hljs-keyword">if</span> (isSuccess) &#123;<br>            <span class="hljs-comment">// 把关注用户的id，加入redis的set集合  sadd userId followUserId</span><br>            stringRedisTemplate.opsForSet().add(key, followUserId.toString());<br>        &#125;<br><br><br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// 3.取关，删除</span><br>        <span class="hljs-comment">// delete from follow where user_id = ? and follow_user_id = ?</span><br>        LambdaQueryWrapper&lt;Follow&gt; wrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;&gt;();<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">isSuccess</span> <span class="hljs-operator">=</span> remove(wrapper.eq(Follow::getUserId, userId).eq(Follow::getFollowUserId, followUserId));<br>        <span class="hljs-keyword">if</span> (isSuccess) &#123;<br>            <span class="hljs-comment">// 从Redis中移除,实现取关</span><br>            <span class="hljs-comment">// 把关注用户的id，从redis的set集合中移除  srem userId followUserId</span><br>            stringRedisTemplate.opsForSet().remove(key, followUserId.toString());<br>        &#125;<br><br>    &#125;<br><br>    <span class="hljs-keyword">return</span> Result.ok();<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-2-2-共同关注"><a href="#2-2-2-共同关注" class="headerlink" title="2.2.2 共同关注"></a>2.2.2 共同关注</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> com.hmdp.dto.Result</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> //查询共同关注</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-meta">@GetMapping(&quot;/common/&#123;id&#125;&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">followCommons</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;<br>    <span class="hljs-keyword">return</span> iFollowService.followCommons(id);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> com.hmdp.dto.Result</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> //共同关注</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">followCommons</span><span class="hljs-params">(Long id)</span> &#123;<br>    <span class="hljs-comment">// 1.获取当前用户</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> RedisConstants.FOLLOW_USER_LIST + userId;<br><br>    <span class="hljs-comment">// 目标用户</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">keyFollow</span> <span class="hljs-operator">=</span> RedisConstants.FOLLOW_USER_LIST + id;<br><br>    <span class="hljs-comment">// 2.求交集</span><br>    Set&lt;String&gt; intersect = stringRedisTemplate.opsForSet().intersect(key, keyFollow);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == intersect || intersect.isEmpty()) &#123;<br>        <span class="hljs-keyword">return</span> Result.ok(Collections.emptyList());<br>    &#125;<br><br>    <span class="hljs-comment">// 3.解析id集合</span><br>    List&lt;Long&gt; ids = intersect.stream().map(Long::valueOf).collect(Collectors.toList());<br>    List&lt;UserDTO&gt; userDTOS = userService.listByIds(ids)<br>            .stream().map(user -&gt; BeanUtil.copyProperties(user, UserDTO.class)).collect(Collectors.toList());<br><br>    <span class="hljs-comment">// 查询用户</span><br>    <span class="hljs-keyword">return</span> Result.ok(userDTOS);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-3-关注用户发布消息-Feed流"><a href="#2-3-关注用户发布消息-Feed流" class="headerlink" title="2.3 关注用户发布消息-Feed流"></a>2.3 关注用户发布消息-Feed流</h2><p>当我们关注了用户后，这个用户发了动态，那么我们应该把这些数据推送给用户，这个需求，其实我们又把他叫做Feed流，关注推送也叫做Feed流，直译为投喂。为用户持续的提供“沉浸式”的体验，通过无限下拉刷新获取新的信息。</p><p>对于传统的模式的内容解锁：我们是需要用户去通过搜索引擎或者是其他的方式去解锁想要看的内容</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/d458c8be7fc34397abc1d78e0179521e.png" alt="在这里插入图片描述"></p><p>对于新型的Feed流的的效果：不需要我们用户再去推送信息，而是系统分析用户到底想要什么，然后直接把内容推送给用户，从而使用户能够更加的节约时间，不用主动去寻找。</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/f68b671793f44d3f93c8ecec5e386ba7.png" alt="在这里插入图片描述"></p><p>Feed流产品有两种常见模式：<br>Timeline：不做内容筛选，简单的按照内容发布时间排序，常用于好友或关注。例如朋友圈</p><p>优点：信息全面，不会有缺失。并且实现也相对简单<br>缺点：信息噪音较多，用户不一定感兴趣，内容获取效率低<br>智能排序：利用智能算法屏蔽掉违规的、用户不感兴趣的内容。推送用户感兴趣信息来吸引用户</p><p>优点：投喂用户感兴趣信息，用户粘度很高，容易沉迷<br>缺点：如果算法不精准，可能起到反作用<br>本例中的个人页面，是基于关注的好友来做Feed流，因此采用Timeline的模式。该模式的实现方案有三种：</p><ul><li>拉模式</li><li>推模式</li><li>推拉结合</li></ul><h3 id="2-3-1-拉模式-读扩散"><a href="#2-3-1-拉模式-读扩散" class="headerlink" title="2.3.1 拉模式-读扩散"></a>2.3.1 拉模式-读扩散</h3><p>该模式的核心含义就是：当张三和李四和王五发了消息后，都会保存在自己的邮箱中，假设赵六要读取信息，那么他会从读取他自己的收件箱，此时系统会从他关注的人群中，把他关注人的信息全部都进行拉取，然后在进行排序</p><p>优点：比较节约空间，因为赵六在读信息时，并没有重复读取，而且读取完之后可以把他的收件箱进行清楚。</p><p>缺点：比较延迟，当用户读取数据时才去关注的人里边去读取数据，假设用户关注了大量的用户，那么此时就会拉取海量的内容，对服务器压力巨大。</p><h3 id="2-3-2-推模式-写扩散"><a href="#2-3-2-推模式-写扩散" class="headerlink" title="2.3.2 推模式-写扩散"></a>2.3.2 推模式-写扩散</h3><p>推模式是没有写邮箱的，当张三写了一个内容，此时会主动的把张三写的内容发送到他的粉丝收件箱中去，假设此时李四再来读取，就不用再去临时拉取了</p><p>优点：时效快，不用临时拉取</p><p>缺点：内存压力大，假设一个大V写信息，很多人关注他， 就会写很多分数据到粉丝那边去</p><h3 id="2-3-3-推拉结合-读写混合"><a href="#2-3-3-推拉结合-读写混合" class="headerlink" title="2.3.3 推拉结合-读写混合"></a>2.3.3 推拉结合-读写混合</h3><p>推拉模式是一个折中的方案，站在发件人这一段，如果是个普通的人，那么我们采用写扩散的方式，直接把数据写入到他的粉丝中去，因为普通的人他的粉丝关注量比较小，所以这样做没有压力，如果是大V，那么他是直接将数据先写入到一份到发件箱里边去，然后再直接写一份到活跃粉丝收件箱里边去，现在站在收件人这端来看，如果是活跃粉丝，那么大V和普通的人发的都会直接写入到自己收件箱里边来，而如果是普通的粉丝，由于他们上线不是很频繁，所以等他们上线时，再从发件箱里边去拉信息。</p><h2 id="2-4-探店推送"><a href="#2-4-探店推送" class="headerlink" title="2.4 探店推送"></a>2.4 探店推送</h2><p>需要实现当关注用户增加一个新的笔记后，能推送到分析收件箱</p><h3 id="2-4-1-分析"><a href="#2-4-1-分析" class="headerlink" title="2.4.1 分析"></a>2.4.1 分析</h3><p>Feed流中的数据会不断更新，所以数据的角标也在变化，因此不能采用传统的分页模式。</p><p>传统的分页在feed流是不适用的，因为我们的数据会随时发生变化。</p><p>假设在t1 时刻，我们去读取第一页，此时page &#x3D; 1 ，size &#x3D; 5 ，那么我们拿到的就是10 ~ 6 这几条记录，假设现在t2时候又发布了一条记录，此时t3 时刻，我们来读取第二页，读取第二页传入的参数是page&#x3D;2 ，size&#x3D;5 ，那么此时读取到的第二页实际上是从6 开始，然后是6~2 ，那么我们就读取到了重复的数据，所以feed流的分页，不能采用原始方案来做。</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/5c2f4b732747435e9d69f031efa7aaa3.png" alt="在这里插入图片描述"></p><h3 id="2-4-2-Feed流滚动分页"><a href="#2-4-2-Feed流滚动分页" class="headerlink" title="2.4.2 Feed流滚动分页"></a>2.4.2 Feed流滚动分页</h3><p>我们需要记录每次操作的最后一条，然后从这个位置开始去读取数据</p><p>举个例子：我们从t1时刻开始，拿第一页数据，拿到了10~6，然后记录下当前最后一次拿取的记录，就是6，t2时刻发布了新的记录，此时这个11放到最顶上，但是不会影响我们之前记录的6，此时t3时刻来拿第二页，第二页这个时候拿数据，还是从6后一点的5去拿，就拿到了5-1的记录。我们这个地方可以采用sortedSet来做，可以进行范围查询，并且还可以记录当前获取数据时间戳最小值，就可以实现滚动分页了</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/d4bbb4ac74004ec786f746ada0dbbb68.png" alt="在这里插入图片描述"></p><blockquote><p>即：在保存完探店笔记后，获得到当前笔记的粉丝，然后把数据推送到粉丝的redis中去。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@PostMapping</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">saveBlog</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> Blog blog)</span> &#123;<br>    <span class="hljs-keyword">return</span> blogService.saveBlog(blog);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> com.hmdp.dto.Result</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> //使用push模式</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">saveBlog</span><span class="hljs-params">(Blog blog)</span> &#123;<br>    <span class="hljs-comment">// 1.获取登录用户</span><br>    <span class="hljs-type">UserDTO</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> UserHolder.getUser();<br><br>    blog.setUserId(user.getId());<br>    <span class="hljs-comment">// 2.保存探店博文</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">isSuccess</span> <span class="hljs-operator">=</span> save(blog);<br>    <span class="hljs-keyword">if</span> (!isSuccess) &#123;<br>        <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;新增笔记失败,请重新发布!&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">// 3.查询笔记作者的所有粉丝</span><br>    <span class="hljs-comment">// select user_id from tb_follow where follow_user_id = ?</span><br>    LambdaQueryWrapper&lt;Follow&gt; wrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;&gt;();<br>    wrapper.eq(Follow::getFollowUserId, user.getId());<br>    List&lt;Follow&gt; follows = followService.list(wrapper);<br>    <span class="hljs-comment">// 4.推送笔记id给所有粉丝</span><br>    <span class="hljs-keyword">for</span> (Follow follow : follows) &#123;<br>        <span class="hljs-comment">// 4.1获取粉丝id</span><br>        <span class="hljs-type">Long</span> <span class="hljs-variable">fansId</span> <span class="hljs-operator">=</span> follow.getUserId();<br>        <span class="hljs-comment">// 4.2推送给粉丝</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> RedisConstants.FEED_KEY + fansId;<br>        stringRedisTemplate.opsForZSet().add(key, blog.getId().toString(), System.currentTimeMillis());<br>    &#125;<br><br><br>    <span class="hljs-comment">// 5.返回id</span><br>    <span class="hljs-keyword">return</span> Result.ok(blog.getId());<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-5-好有关注页分页查询"><a href="#2-5-好有关注页分页查询" class="headerlink" title="2.5 好有关注页分页查询"></a>2.5 好有关注页分页查询</h2><p>在个人主页的“关注”卡片中，查询并展示推送的Blog信息：</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/f5e417eb93be4b7a931c527cf484dbfa.png" alt="在这里插入图片描述"></p><p>正序：</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/b1c97a920dc74be3b5c527ce4c1c8030.png" alt="在这里插入图片描述"></p><p>倒序：</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/ad6cd28c982b496fb4c91c80a876458f.png" alt="在这里插入图片描述"></p><p>带分数：</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/31c0aa410a2d48b4b3ae54d9da5e971d.png" alt="在这里插入图片描述"></p><p>滚动分页规律：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-comment">-- 第一次</span><br>ZREVRANGEBYSCORE key 设定一个最大值 <span class="hljs-number">0</span> WITHSCORES <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">0</span> 每页展示几条<br><span class="hljs-comment">-- 之后</span><br>ZREVRANGEBYSCORE key 第一条最小的角标 <span class="hljs-number">0</span> WITHSCORES <span class="hljs-keyword">LIMIT</span> 第一页中与最小值相等的元素的个数 每页展示几条<br></code></pre></td></tr></table></figure><h3 id="2-5-1-新增实体类"><a href="#2-5-1-新增实体类" class="headerlink" title="2.5.1 新增实体类"></a>2.5.1 新增实体类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ScrollResult</span> &#123;<br>    <span class="hljs-keyword">private</span> List&lt;?&gt; list;<br>    <span class="hljs-keyword">private</span> Long minTime;<br>    <span class="hljs-keyword">private</span> Integer offset;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/of/follow&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">queryBlogOfFollow</span><span class="hljs-params">(</span><br><span class="hljs-params">    <span class="hljs-meta">@RequestParam(&quot;lastId&quot;)</span> Long max, <span class="hljs-meta">@RequestParam(value = &quot;offset&quot;, defaultValue = &quot;0&quot;)</span> Integer offset)</span>&#123;<br>    <span class="hljs-keyword">return</span> blogService.queryBlogOfFollow(max, offset);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> com.hmdp.dto.Result</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> //滚动分页查询关注列表</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">queryBlogOfFollow</span><span class="hljs-params">(Long max, Integer offset)</span> &#123;<br>    <span class="hljs-comment">// 1.查询当前用户</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br>    <span class="hljs-comment">// 2.找到收件箱</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> RedisConstants.FEED_KEY + userId;<br><br>    <span class="hljs-comment">// 滚动分页查询(第一次查询)</span><br>    <span class="hljs-comment">//ZREVRANGEBYSCORE z1 1000 0 WITHSCORES LIMIT 0 5</span><br>    Set&lt;ZSetOperations.TypedTuple&lt;String&gt;&gt; set = stringRedisTemplate<br>            .opsForZSet()<br>            .reverseRangeByScoreWithScores(key, <span class="hljs-number">0</span>, max, offset, <span class="hljs-number">2L</span>);<br><br>    <span class="hljs-comment">// 3.非空判断</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == set || set.isEmpty()) &#123;<br>        <span class="hljs-keyword">return</span> Result.ok();<br>    &#125;<br><br>    <span class="hljs-comment">// 4.解析收件箱的数据:blogId,minTime(时间戳),offset</span><br>    ArrayList&lt;Long&gt; ids = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(set.size());<br>    <span class="hljs-type">long</span> <span class="hljs-variable">minTime</span> <span class="hljs-operator">=</span> Long.MAX_VALUE;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">off</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">for</span> (ZSetOperations.TypedTuple&lt;String&gt; tuple : set) &#123;<br>        <span class="hljs-comment">// 4.1获取id</span><br>        ids.add(Long.valueOf(tuple.getValue()));<br>        <span class="hljs-comment">// 4.2 获取分数(时间戳)</span><br>        <span class="hljs-type">long</span> <span class="hljs-variable">time</span> <span class="hljs-operator">=</span> tuple.getScore().longValue();<br>        <span class="hljs-keyword">if</span> (time == minTime) &#123;<br>            off++;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            minTime = minTime &lt; tuple.getScore().longValue() ? minTime : time;<br>            off = <span class="hljs-number">1</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">//List&lt;Blog&gt; blogs = listByIds(ids);</span><br>    <span class="hljs-comment">// select * from tb_blog where id in () order by field(id,max,min)</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">joinStr</span> <span class="hljs-operator">=</span> StrUtil.join(<span class="hljs-string">&quot;,&quot;</span>, ids);<br>    <span class="hljs-comment">// 5.根据blogId查询blog</span><br>    List&lt;Blog&gt; blogs = query().in(<span class="hljs-string">&quot;id&quot;</span>, ids).last(<span class="hljs-string">&quot;order by field(id,&quot;</span> + joinStr + <span class="hljs-string">&quot;)&quot;</span>).list();<br>    <span class="hljs-keyword">for</span> (Blog blog : blogs) &#123;<br>        <span class="hljs-comment">// 2.查询blog相关的用户</span><br>        queryBlogUser(blog);<br>        <span class="hljs-comment">// 3.查询blog是否被点赞</span><br>        isBlogLiked(blog);<br>    &#125;<br><br>    <span class="hljs-comment">// 6.封装并返回</span><br>    <span class="hljs-type">ScrollResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ScrollResult</span>();<br>    result.setList(blogs);<br>    result.setOffset(off);<br>    result.setMinTime(minTime);<br><br>    <span class="hljs-keyword">return</span> Result.ok(result);<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>redis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>redis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>redis-秒杀优化</title>
    <link href="/redis-%E7%A7%92%E6%9D%80%E4%BC%98%E5%8C%96/fb2025be556d/"/>
    <url>/redis-%E7%A7%92%E6%9D%80%E4%BC%98%E5%8C%96/fb2025be556d/</url>
    
    <content type="html"><![CDATA[<h1 id="1-Redis实现秒杀优化"><a href="#1-Redis实现秒杀优化" class="headerlink" title="1 Redis实现秒杀优化"></a>1 Redis实现秒杀优化</h1><h2 id="1-1-秒杀流程"><a href="#1-1-秒杀流程" class="headerlink" title="1.1 秒杀流程"></a>1.1 秒杀流程</h2><p>1、查询优惠卷</p><p>2、判断秒杀库存是否足够</p><p>3、查询订单</p><p>4、校验是否是一人一单</p><p>5、扣减库存</p><p>6、创建订单</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/1e4c5e6f63884971b9bc1d26dfe20803.png" alt="在这里插入图片描述"></p><p>在流程上，这是同步操作，即：会按照顺序进行执行，但是这样一个一个执行会有一个很大的缺陷：效率很低。那么是否可以提高效率呢？</p><p>可以：使用异步进行优化。</p><p>将耗时比较短的逻辑判断放入到redis中，比如是否库存足够，比如是否一人一单，这样的操作，只要这种逻辑可以完成，就意味着我们是一定可以下单完成的，我们只需要进行快速的逻辑判断，根本就不用等下单逻辑走完，我们直接给用户返回成功， 再在后台开一个线程，后台线程慢慢的去执行queue里边的消息，这样程序不就超级快了吗？而且也不用担心线程池消耗殆尽的问题，因为这里我们的程序中并没有手动使用任何线程池。</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/7d7263c57bee48f2adbb64fdfd85f57f.png" alt="在这里插入图片描述"></p><p>但是此时会有两个问题：</p><ol><li>怎么在redis中去快速校验一人一单，还有库存判断。</li><li>由于我们校验和tomct下单是两个线程，那么我们如何知道到底哪个单他最后是否成功，或者是下单完成，为了完成这件事我们在redis操作完之后，我们会将一些信息返回给前端，同时也会把这些信息丢到异步queue中去，后续操作中，可以通过这个id来查询我们tomcat中的下单逻辑是否完成了。</li></ol><p>针对问题1：</p><p>当用户下单之后，判断库存是否充足只需要导redis中去根据key找对应的value是否大于0即可，如果不充足，则直接结束，如果充足，继续在redis中判断用户是否可以下单，如果set集合中没有这条数据，说明他可以下单，如果set集合中没有这条记录，则将userId和优惠卷存入到redis中，并且返回0，整个过程需要保证是原子性的，我们可以使用lua来操作。</p><p>针对问题2：</p><p>当以上判断逻辑走完之后，我们可以判断当前redis中返回的结果是否是0 ，如果是0，则表示可以下单，则将之前说的信息存入到到queue中去，然后返回，然后再来个线程异步的下单，前端可以通过返回的订单id来判断是否下单成功。</p><h2 id="1-2-流程优化"><a href="#1-2-流程优化" class="headerlink" title="1.2 流程优化"></a>1.2 流程优化</h2><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/6327c7cc9c8e430f8914819371d115aa.png" alt="在这里插入图片描述"></p><h3 id="1-2-1-优惠券添加至Redis"><a href="#1-2-1-优惠券添加至Redis" class="headerlink" title="1.2.1 优惠券添加至Redis"></a>1.2.1 优惠券添加至Redis</h3><blockquote><p>在添加秒杀优惠券的时候，将优惠券id和个数添加至redis中</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VoucherServiceImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ServiceImpl</span>&lt;VoucherMapper, Voucher&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IVoucherService</span> &#123;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> ISeckillVoucherService seckillVoucherService;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> StringRedisTemplate stringRedisTemplate;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">queryVoucherOfShop</span><span class="hljs-params">(Long shopId)</span> &#123;<br>        <span class="hljs-comment">// 查询优惠券信息</span><br>        List&lt;Voucher&gt; vouchers = getBaseMapper().queryVoucherOfShop(shopId);<br>        <span class="hljs-comment">// 返回结果</span><br>        <span class="hljs-keyword">return</span> Result.ok(vouchers);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-meta">@Transactional(rollbackFor = &#123;&#125;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addSeckillVoucher</span><span class="hljs-params">(Voucher voucher)</span> &#123;<br>        <span class="hljs-comment">// 保存优惠券</span><br>        save(voucher);<br>        <span class="hljs-comment">// 保存秒杀信息</span><br>        <span class="hljs-type">SeckillVoucher</span> <span class="hljs-variable">seckillVoucher</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SeckillVoucher</span>();<br>        seckillVoucher.setVoucherId(voucher.getId());<br>        seckillVoucher.setStock(voucher.getStock());<br>        seckillVoucher.setBeginTime(voucher.getBeginTime());<br>        seckillVoucher.setEndTime(voucher.getEndTime());<br>        seckillVoucherService.save(seckillVoucher);<br><br>        <span class="hljs-comment">// 保存秒杀库存到Redis中(永久保存即可)</span><br>        <span class="hljs-comment">// key   seckill:stock: + voucherId</span><br>        <span class="hljs-comment">// value 库存</span><br>        stringRedisTemplate.opsForValue().set(RedisConstants.SECKILL_STOCK_KEY + voucher.getId(), seckillVoucher.getStock().toString());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="1-2-2-Lua脚本"><a href="#1-2-2-Lua脚本" class="headerlink" title="1.2.2 Lua脚本"></a>1.2.2 Lua脚本</h3><p>Lua脚本用来保证下单的时候不会超卖和一人一单，原子化操作放在同一个脚本中。</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- 1.参数列表</span><br><span class="hljs-comment">-- 1.1优惠券id</span><br><span class="hljs-keyword">local</span> voucherId = ARGV[<span class="hljs-number">1</span>]<br><span class="hljs-comment">-- 1.2用户id</span><br><span class="hljs-keyword">local</span> userId = ARGV[<span class="hljs-number">2</span>]<br><br><span class="hljs-comment">-- 2.数据key</span><br><span class="hljs-comment">-- 2.1 库存key</span><br><span class="hljs-keyword">local</span> stockKey = <span class="hljs-string">&#x27;seckill:stock:&#x27;</span> .. voucherId<br><span class="hljs-comment">-- 2.2 订单key</span><br><span class="hljs-keyword">local</span> orderKey = <span class="hljs-string">&#x27;seckill:order:&#x27;</span> .. voucherId<br><br><span class="hljs-comment">-- 3.脚本业务</span><br><span class="hljs-comment">-- 3.1 判断库存是否充足 get stockKet</span><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">tonumber</span>(redis.call(<span class="hljs-string">&#x27;get&#x27;</span>, stockKey)) &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">then</span><br>    <span class="hljs-comment">-- 库存不足返回1</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span><br><span class="hljs-keyword">end</span><br><span class="hljs-comment">-- 3.2 判断用户是否下单 SISMEMBER orderKey userId</span><br><span class="hljs-keyword">if</span> (redis.call(<span class="hljs-string">&#x27;sismember&#x27;</span>, orderKey, userId) == <span class="hljs-number">1</span>) <span class="hljs-keyword">then</span><br>    <span class="hljs-comment">-- 3.3 存在，说明重复下单</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">2</span><br><span class="hljs-keyword">end</span><br><span class="hljs-comment">-- 3.4 扣库存 incrby stockKey -1</span><br>redis.call(<span class="hljs-string">&#x27;incrby&#x27;</span>, stockKey, <span class="hljs-number">-1</span>)<br><span class="hljs-comment">-- 3.5 下单 (保存用户) sadd orderKey userId</span><br>redis.call(<span class="hljs-string">&#x27;sadd&#x27;</span>, orderKey, userId)<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><h3 id="1-2-3-添加异步阻塞队列"><a href="#1-2-3-添加异步阻塞队列" class="headerlink" title="1.2.3 添加异步阻塞队列"></a>1.2.3 添加异步阻塞队列</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VoucherOrderServiceImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ServiceImpl</span>&lt;VoucherOrderMapper, VoucherOrder&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IVoucherOrderService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ISeckillVoucherService iSeckillVoucherService;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisWorker redisWorker;<br><br>    <span class="hljs-meta">@Resource</span><br>    StringRedisTemplate stringRedisTemplate;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> RedissonClient redissonClient;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> DefaultRedisScript&lt;Long&gt; SECKILL_SCRIPT;<br><br>    <span class="hljs-keyword">static</span> &#123;<br>        SECKILL_SCRIPT = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultRedisScript</span>&lt;&gt;();<br>        SECKILL_SCRIPT.setLocation(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathResource</span>(<span class="hljs-string">&quot;seckill.lua&quot;</span>));<br>        SECKILL_SCRIPT.setResultType(Long.class);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 阻塞队列</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> BlockingQueue&lt;VoucherOrder&gt; blockingQueue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>);<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 线程池</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">fixedThreadPool</span> <span class="hljs-operator">=</span> CacheClient.newFixedThreadPool(<span class="hljs-number">1</span>);<br><br>    <span class="hljs-keyword">private</span> IVoucherOrderService proxy;<br><br>    <span class="hljs-comment">// 保证一加载就执行该方法</span><br>    <span class="hljs-meta">@PostConstruct</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> &#123;<br>        fixedThreadPool.submit(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>                <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        <span class="hljs-comment">// 1.获取队列中的订单信息 take是阻塞方法，获取队列头部，如果需要则等待直到元素可用</span><br>                        <span class="hljs-type">VoucherOrder</span> <span class="hljs-variable">voucherOrder</span> <span class="hljs-operator">=</span> blockingQueue.take();<br>                        <span class="hljs-comment">// 2.创建订单</span><br>                        handleVoucherOrder(voucherOrder);<br><br>                    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                        log.error(<span class="hljs-string">&quot;处理订单异常:&quot;</span> + e.getMessage());<br>                    &#125;<br><br><br>                &#125;<br>            &#125;<br><br>            <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleVoucherOrder</span><span class="hljs-params">(VoucherOrder voucherOrder)</span> &#123;<br>                <span class="hljs-comment">// 1.创建锁对象</span><br>                <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> voucherOrder.getUserId();<br>                <span class="hljs-comment">// 2.创建锁对象</span><br>                <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redissonClient.getLock(RedisConstants.LOCK_VOUVHER_ORDER_KEY + userId);<br>                <span class="hljs-comment">// 3.获取锁</span><br>                <span class="hljs-type">boolean</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> lock.tryLock();<br>                <span class="hljs-comment">// 4.判断锁是否获取成功</span><br>                <span class="hljs-keyword">if</span> (!flag) &#123;<br>                    <span class="hljs-comment">// 4.1 获取锁失败</span><br>                    log.error(<span class="hljs-string">&quot;不允许重复下单！&quot;</span>);<br>                    <span class="hljs-keyword">return</span>;<br>                &#125;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    proxy.createVoucherOrderThread(voucherOrder);<br>                &#125; <span class="hljs-keyword">finally</span> &#123;<br>                    lock.unlock();<br>                &#125;<br>            &#125;<br>        &#125;);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">seckillVoucher</span><span class="hljs-params">(Long voucherId)</span> &#123;<br>        <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br>        <span class="hljs-comment">// 1. 执行Lua脚本</span><br>        <span class="hljs-type">Long</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> stringRedisTemplate.execute(<br>                SECKILL_SCRIPT,<br>                Collections.emptyList(),<br>                voucherId.toString(),<br>                userId.toString()<br>        );<br><br>        <span class="hljs-comment">// 2.判断结果是否为0</span><br>        <span class="hljs-keyword">if</span> (result.intValue() != <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-comment">// 2.1 不为0 说明没有购买资格</span><br>            <span class="hljs-keyword">return</span> Result.fail(result == <span class="hljs-number">1</span> ? <span class="hljs-string">&quot;优惠券已售罄，感谢参与！&quot;</span> : <span class="hljs-string">&quot;您已经购买过该优惠券，优惠券限制每人仅购买一次！&quot;</span>);<br>        &#125;<br>        <span class="hljs-comment">// 2.2 为0 说明 存在购买资格，把下单信息保存到阻塞队列中</span><br>        <span class="hljs-comment">// 订单ID</span><br>        <span class="hljs-type">long</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> redisWorker.nextID(RedisConstants.VOUVHER_ORDER_KEY);<br>        <span class="hljs-comment">// 2.3 保存到阻塞队列 优惠券ID 用户ID 订单ID</span><br>        <span class="hljs-type">VoucherOrder</span> <span class="hljs-variable">voucherOrder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">VoucherOrder</span>();<br>        voucherOrder.setVoucherId(voucherId);<br>        voucherOrder.setUserId(userId);<br>        voucherOrder.setId(orderId);<br><br>        <span class="hljs-comment">// 2.4获取代理对象(事务)</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> AopContext.currentProxy();<br>        <span class="hljs-type">IVoucherOrderService</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> (IVoucherOrderService) o;<br><br>        <span class="hljs-comment">// 2.5 放入阻塞队列</span><br>        blockingQueue.add(voucherOrder);<br><br><br>        <span class="hljs-comment">// 3.返回订单信息</span><br>        <span class="hljs-keyword">return</span> Result.ok(orderId);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-meta">@Transactional(rollbackFor = &#123;&#125;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createVoucherOrderThread</span><span class="hljs-params">(VoucherOrder voucherOrder)</span> &#123;<br>        <span class="hljs-type">Long</span> <span class="hljs-variable">userID</span> <span class="hljs-operator">=</span> voucherOrder.getId();<br><br><br>        <span class="hljs-comment">// 5.实现1人1单加入逻辑：根据优惠券id和用户id查询订单</span><br>        <span class="hljs-comment">// 5.1查询订单,并不用查询出具体的值，而是查询出数量即可</span><br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> query().eq(<span class="hljs-string">&quot;user_id&quot;</span>, userID).eq(<span class="hljs-string">&quot;voucher_id&quot;</span>, voucherOrder.getVoucherId()).count();<br>        <span class="hljs-comment">// 5.2判断订单是否存在</span><br>        <span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-comment">// 5.2.1 存在就返回异常结果</span><br>            log.error(<span class="hljs-string">&quot;秒杀优惠券每人限购1张,感谢配合,本优惠券最终解释权归ty公司所有!&quot;</span>);<br>            <span class="hljs-comment">//return Result.fail(&quot;秒杀优惠券每人限购1张,感谢配合,本优惠券最终解释权归ty公司所有!&quot;);</span><br>        &#125;<br><br>        <span class="hljs-comment">// 5.2.2 不存在再减少库存</span><br><br>        <span class="hljs-comment">// 6.1扣减库存(会出现超卖问题)</span><br>        <span class="hljs-comment">// update tb_seckill_voucher set stock = stock -1 where voucher_id = ?</span><br>        <span class="hljs-comment">/*boolean result = iSeckillVoucherService.update()</span><br><span class="hljs-comment">                .setSql(&quot;stock = stock -1&quot;)</span><br><span class="hljs-comment">                .eq(&quot;voucher_id&quot;, voucherId).update();*/</span><br><br>        <span class="hljs-comment">// 6.2扣减库存(针对超卖问题用乐观锁CAS解决)</span><br>        <span class="hljs-comment">// update tb_seckill_voucher set stock = stock -1 where voucher_id = ? and stock = ?</span><br>        <span class="hljs-comment">/*boolean result = iSeckillVoucherService.update()</span><br><span class="hljs-comment">                .setSql(&quot;stock = stock - 1&quot;)</span><br><span class="hljs-comment">                .eq(&quot;voucher_id&quot;, voucherId)</span><br><span class="hljs-comment">                .eq(&quot;stock&quot;, stock)</span><br><span class="hljs-comment">                .update();*/</span><br><br>        <span class="hljs-comment">// 6.3扣减库存(针对使用乐观锁CAS，没卖完解决)</span><br>        <span class="hljs-comment">// update tb_seckill_voucher set stock = stock -1 where voucher_id = ? and stock &gt; 0</span><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> iSeckillVoucherService.update()<br>                .setSql(<span class="hljs-string">&quot;stock = stock - 1&quot;</span>)<br>                .eq(<span class="hljs-string">&quot;voucher_id&quot;</span>, voucherOrder.getVoucherId())<br>                .gt(<span class="hljs-string">&quot;stock&quot;</span>, <span class="hljs-number">0</span>)<br>                .update();<br><br>        <span class="hljs-keyword">if</span> (!result) &#123;<br>            log.error(<span class="hljs-string">&quot;商品已经售罄!&quot;</span>);<br>            <span class="hljs-comment">//return Result.fail(&quot;商品已经售罄!&quot;);</span><br>        &#125;<br><br>        <span class="hljs-comment">// 7.创建订单</span><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 获取订单id</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-type">long</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> redisWorker.nextID(RedisConstants.VOUVHER_ORDER_KEY);<br><br>        <span class="hljs-comment">// 将订单信息保存到数据库</span><br>        <span class="hljs-comment">// insert into tb_voucher_order values ()</span><br>        save(voucherOrder);<br><br>        <span class="hljs-comment">//8.返回订单id</span><br>        <span class="hljs-comment">//return Result.ok(orderId);</span><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="1-3-基于阻塞队列存在的问题"><a href="#1-3-基于阻塞队列存在的问题" class="headerlink" title="1.3 基于阻塞队列存在的问题"></a>1.3 基于阻塞队列存在的问题</h2><ol><li>内存限制问题</li><li>数据安全问题</li></ol><h1 id="2-秒杀的异步优化"><a href="#2-秒杀的异步优化" class="headerlink" title="2 秒杀的异步优化"></a>2 秒杀的异步优化</h1><h2 id="2-1-Redis的消息队列"><a href="#2-1-Redis的消息队列" class="headerlink" title="2.1 Redis的消息队列"></a>2.1 Redis的消息队列</h2><p>什么是消息队列：字面意思就是存放消息的队列。最简单的消息队列模型包括3个角色：</p><ul><li>消息队列：存储和管理消息，也被称为消息代理（Message Broker）</li><li>生产者：发送消息到消息队列</li><li>消费者：从消息队列获取消息并处理消息</li></ul><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/2c0469d2897240ca9f1cad49aa492c14.png" alt="在这里插入图片描述"></p><h3 id="2-1-1-基于List结构的消息队列"><a href="#2-1-1-基于List结构的消息队列" class="headerlink" title="2.1.1 基于List结构的消息队列"></a>2.1.1 基于List结构的消息队列</h3><p>队列是入口和出口不在一边，因此我们可以利用：LPUSH 结合 RPOP、或者 RPUSH 结合 LPOP来实现。<br>不过要注意的是，当队列中没有消息时RPOP或LPOP操作会返回null，并不像JVM的阻塞队列那样会阻塞并等待消息。因此这里应该使用BRPOP或者BLPOP来实现阻塞效果。</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/08a71cbcf388440c96c7c62c4b8cd6ea.png" alt="在这里插入图片描述"></p><p>优点：</p><ul><li>利用Redis存储，<strong>不受限</strong>于JVM<strong>内存</strong>上限</li><li>基于Redis的<strong>持久化</strong>机制，数据安全性有保证</li><li>可以满足消息有序性</li></ul><p>缺点：</p><ul><li><strong>无法避免消息丢失</strong></li><li>只支持<strong>单消费者</strong></li></ul><h3 id="2-1-2-基于PubSub的消息队列"><a href="#2-1-2-基于PubSub的消息队列" class="headerlink" title="2.1.2 基于PubSub的消息队列"></a>2.1.2 基于PubSub的消息队列</h3><p>PubSub（发布publish订阅subscribe）是Redis2.0版本引入的消息传递模型。顾名思义，消费者可以订阅一个或多个channel，生产者向对应channel发送消息后，所有订阅者都能收到相关消息。</p><p>SUBSCRIBE channel [channel] ：订阅一个或多个频道<br>PUBLISH channel msg ：向一个频道发送消息<br>PSUBSCRIBE pattern[pattern] ：订阅与pattern格式匹配的所有频道</p><blockquote><p>[注]pattern:通配符</p><p>? 一个字符<br>*0个或者多个<br>[ab]a或者b</p></blockquote><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/5dd860483d1c485a9496b15bbf13c8f7.png" alt="在这里插入图片描述"></p><p>优点：</p><ul><li>采用发布订阅模型，支持多生产、多消费</li></ul><p>缺点：</p><ul><li>不支持数据持久化</li><li>无法避免消息丢失</li><li>消息堆积有上限，<strong>超出时数据丢失</strong></li></ul><h3 id="2-1-3-基于stream的消息队列"><a href="#2-1-3-基于stream的消息队列" class="headerlink" title="2.1.3 基于stream的消息队列"></a>2.1.3 基于stream的消息队列</h3><p>Stream 是 Redis 5.0 引入的一种新数据类型，可以实现一个功能非常完善的消息队列。</p><h4 id="2-1-3-1-发送消息"><a href="#2-1-3-1-发送消息" class="headerlink" title="2.1.3.1 发送消息"></a>2.1.3.1 发送消息</h4><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/bccca7480df045bfb8c3a6e49eb86b4a.png" alt="在这里插入图片描述"></p><blockquote><p>XADD<br>key – 键值<br>NOMKSTREAM – 如果队列不存在，是否开启创建队列，默认是创建队列<br>MAXLEN – 最大消息数量<br>ID – 消息的唯一id，如果设置*代表Redis自动生成,格式是”时间戳-递增数字”<br>field – 消息体<br>value – 消息值</p></blockquote><h4 id="2-1-3-2-读取消息"><a href="#2-1-3-2-读取消息" class="headerlink" title="2.1.3.2 读取消息"></a>2.1.3.2 读取消息</h4><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/749c22c23c814806af8191a13733f24a.png" alt="在这里插入图片描述"></p><blockquote><p>XREAD<br>count – 每次读取消息的最大数量<br>block – 当前没有消息时，是否阻塞，阻塞时长，0是永久等待<br>streams keys – 要从哪个队列中读取消息，key是队列名<br>ID – 起始id，只返回大于该ID的消息，其中0代表第一条纤细，$代表最新的消息。</p></blockquote><p>阻塞读取</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/93509c89537647759e84b5a9fcac807c.png" alt="在这里插入图片描述"></p><p>STREAM类型消息队列的XREAD命令特点：</p><ul><li>消息可回溯</li><li>一个消息可以被多个消费者读取</li><li>可以阻塞读取</li><li>有消息漏读的风险</li></ul><h4 id="2-1-3-3-stream消费者组模式"><a href="#2-1-3-3-stream消费者组模式" class="headerlink" title="2.1.3.3 stream消费者组模式"></a>2.1.3.3 stream消费者组模式</h4><p>消费者组（Consumer Group）：将多个消费者划分到一个组中，监听同一个队列。</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/853f7f45bfd54e8ea3d06f256436439d.png" alt="在这里插入图片描述"></p><h5 id="2-1-3-3-1-创建消费者组"><a href="#2-1-3-3-1-创建消费者组" class="headerlink" title="2.1.3.3.1 创建消费者组"></a>2.1.3.3.1 创建消费者组</h5><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/84267bf83cf848adbcb85af1350bb7df.png" alt="在这里插入图片描述"></p><blockquote><p>key：队列名称。<br>groupName：消费者组名称。<br>ID：起始ID标示，$代表队列中最后一个消息，0则代表队列中第一个消息。<br>MKSTREAM：队列不存在时自动创建队列。</p></blockquote><h5 id="2-1-3-3-2-消费者组读取消息"><a href="#2-1-3-3-2-消费者组读取消息" class="headerlink" title="2.1.3.3.2 消费者组读取消息"></a>2.1.3.3.2 消费者组读取消息</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">XREADGROUP GROUP group consumer [COUNT count] [BLOCK milliseconds] [NOACK] STREAMS key [key ...] ID [ID ...] &gt;<br></code></pre></td></tr></table></figure><blockquote><p>group：消费组名称<br>consumer：消费者名称，如果消费者不存在，会自动创建一个消费者<br>count：本次查询的最大数量<br>BLOCK milliseconds：当没有消息时最长等待时间<br>NOACK：无需手动ACK，获取到消息后自动确认<br>STREAMS key：指定队列名称<br>ID：获取消息的起始ID：<br>“&gt;”：从下一个未消费的消息开始<br>其它：根据指定id从pending-list中获取已消费但未确认的消息，例如0，是从pending-list中的第1个消息开始。</p></blockquote><p>STREAM类型消息队列的XREADGROUP命令特点：</p><ul><li>消息可回溯</li><li>可以多消费者争抢消息，加快消费速度</li><li>可以阻塞读取</li><li>没有消息漏读的风险</li><li>有消息确认机制，保证消息至少被消费一次</li></ul><h3 id="2-1-4-对比"><a href="#2-1-4-对比" class="headerlink" title="2.1.4 对比"></a>2.1.4 对比</h3><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/09c07cdce23144ef9565a8a72937a048.png" alt="在这里插入图片描述"></p><h2 id="2-2-使用Stream消息队列优化异步秒杀"><a href="#2-2-使用Stream消息队列优化异步秒杀" class="headerlink" title="2.2 使用Stream消息队列优化异步秒杀"></a>2.2 使用Stream消息队列优化异步秒杀</h2><h3 id="2-2-1-创建消息队列"><a href="#2-2-1-创建消息队列" class="headerlink" title="2.2.1 创建消息队列"></a>2.2.1 创建消息队列</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">XGROUP CREATE stream.orders g1 0 MKSTREAM<br></code></pre></td></tr></table></figure><h3 id="2-2-2-修改lua脚本"><a href="#2-2-2-修改lua脚本" class="headerlink" title="2.2.2 修改lua脚本"></a>2.2.2 修改lua脚本</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java">-- <span class="hljs-number">1.</span>参数列表<br>-- <span class="hljs-number">1.1</span>优惠券id<br><span class="hljs-type">local</span> <span class="hljs-variable">voucherId</span> <span class="hljs-operator">=</span> ARGV[<span class="hljs-number">1</span>]<br>-- <span class="hljs-number">1.2</span>用户id<br><span class="hljs-type">local</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> ARGV[<span class="hljs-number">2</span>]<br>-- <span class="hljs-number">1.3</span>订单id<br><span class="hljs-type">local</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> ARGV[<span class="hljs-number">3</span>]<br><br>-- <span class="hljs-number">2.</span>数据key<br>-- <span class="hljs-number">2.1</span> 库存key<br><span class="hljs-type">local</span> <span class="hljs-variable">stockKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;seckill:stock:&#x27;</span> .. voucherId<br>-- <span class="hljs-number">2.2</span> 订单key<br><span class="hljs-type">local</span> <span class="hljs-variable">orderKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;seckill:order:&#x27;</span> .. voucherId<br><br>-- <span class="hljs-number">3.</span>脚本业务<br>-- <span class="hljs-number">3.1</span> 判断库存是否充足 get stockKet<br><span class="hljs-title function_">if</span> <span class="hljs-params">(tonumber(redis.call(<span class="hljs-string">&#x27;get&#x27;</span>, stockKey)</span>) &lt;= <span class="hljs-number">0</span>) then<br>    -- 库存不足返回<span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span><br>end<br>-- <span class="hljs-number">3.2</span> 判断用户是否下单 SISMEMBER orderKey userId<br><span class="hljs-title function_">if</span> <span class="hljs-params">(redis.call(<span class="hljs-string">&#x27;sismember&#x27;</span>, orderKey, userId)</span> == <span class="hljs-number">1</span>) then<br>    -- <span class="hljs-number">3.3</span> 存在，说明重复下单<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">2</span><br>end<br>-- <span class="hljs-number">3.4</span> 扣库存 incrby stockKey -<span class="hljs-number">1</span><br>redis.call(<span class="hljs-string">&#x27;incrby&#x27;</span>, stockKey, -<span class="hljs-number">1</span>)<br>-- <span class="hljs-number">3.5</span> 下单 (保存用户) sadd orderKey userId<br>redis.call(<span class="hljs-string">&#x27;sadd&#x27;</span>, orderKey, userId)<br>-- <span class="hljs-number">3.6</span> 发送到消息队列中 VoucherOrder实体类中主键就叫id，所以这里也是id,不要叫orderId<br>redis.call(<span class="hljs-string">&#x27;xadd&#x27;</span>, <span class="hljs-string">&#x27;stream.orders&#x27;</span>, <span class="hljs-string">&#x27;*&#x27;</span>, <span class="hljs-string">&#x27;userId&#x27;</span>, userId, <span class="hljs-string">&#x27;id&#x27;</span>, orderId, <span class="hljs-string">&#x27;voucherId&#x27;</span>, voucherId)<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><p>即：每次下单保存了用户之后，还需要将消息发送至消息队列中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@SuppressWarnings(&#123;&quot;all&quot;&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VoucherOrderServiceImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ServiceImpl</span>&lt;VoucherOrderMapper, VoucherOrder&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IVoucherOrderService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ISeckillVoucherService iSeckillVoucherService;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisWorker redisWorker;<br><br>    <span class="hljs-meta">@Resource</span><br>    StringRedisTemplate stringRedisTemplate;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> RedissonClient redissonClient;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> DefaultRedisScript&lt;Long&gt; SECKILL_SCRIPT;<br><br>    <span class="hljs-keyword">static</span> &#123;<br>        SECKILL_SCRIPT = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultRedisScript</span>&lt;&gt;();<br>        SECKILL_SCRIPT.setLocation(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathResource</span>(<span class="hljs-string">&quot;seckill.lua&quot;</span>));<br>        SECKILL_SCRIPT.setResultType(Long.class);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 阻塞队列</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> BlockingQueue&lt;VoucherOrder&gt; blockingQueue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>);<br><br><br>    <span class="hljs-keyword">private</span> IVoucherOrderService proxy;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 线程池</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executorService</span> <span class="hljs-operator">=</span> CacheClient.newFixedThreadPool(<span class="hljs-number">1</span>);<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@PostConstruct</span> 保证一加载就执行该方法</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@PostConstruct</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">//异步处理线程池</span><br>        executorService.submit(<span class="hljs-keyword">new</span> <span class="hljs-title class_">VoucherOrderHandler</span>());<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@author</span> wty</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@description</span> // 成员内部类</span><br><span class="hljs-comment">     **/</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VoucherOrderHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">queueName</span> <span class="hljs-operator">=</span> RedisConstants.STREAM_QUEUE_NAME;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-comment">// 1.获取队列中的订单信息 XREADGROUP GROUP g1 c1 COUNT 1 BLOCK 2000 STREAMS stream.order &gt;</span><br>                    List&lt;MapRecord&lt;String, Object, Object&gt;&gt; list = stringRedisTemplate.opsForStream().read(<br>                            Consumer.from(<span class="hljs-string">&quot;g1&quot;</span>, <span class="hljs-string">&quot;c1&quot;</span>),<br>                            StreamReadOptions.empty().count(<span class="hljs-number">1</span>).block(Duration.ofSeconds(<span class="hljs-number">2L</span>)),<br>                            StreamOffset.create(queueName, ReadOffset.lastConsumed())<br>                    );<br><br>                    <span class="hljs-comment">// 2.判断消息获取是否成功</span><br>                    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == list || list.isEmpty()) &#123;<br>                        <span class="hljs-comment">// 2.1如果获取失败，说明没有消息，继续下一次循环</span><br>                        <span class="hljs-keyword">continue</span>;<br>                    &#125;<br>                    <span class="hljs-comment">// 3.解析list</span><br>                    MapRecord&lt;String, Object, Object&gt; record = list.get(<span class="hljs-number">0</span>);<br>                    Map&lt;Object, Object&gt; map = record.getValue();<br>                    <span class="hljs-type">VoucherOrder</span> <span class="hljs-variable">voucherOrder</span> <span class="hljs-operator">=</span> BeanUtil.fillBeanWithMap(map, <span class="hljs-keyword">new</span> <span class="hljs-title class_">VoucherOrder</span>(), <span class="hljs-literal">true</span>);<br><br>                    <span class="hljs-comment">// 4.如果获取成功，可以下单创建订单</span><br>                    handleVoucherOrder(voucherOrder);<br>                    <span class="hljs-comment">// 5.ACK确认 队列名 组名 消息ID SACK stream.order g1 消息id</span><br>                    stringRedisTemplate.opsForStream().acknowledge(queueName, <span class="hljs-string">&quot;g1&quot;</span>, record.getId());<br><br>                &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                    log.error(<span class="hljs-string">&quot;处理订单异常:&quot;</span> + e);<br>                    handlePendingList();<br>                &#125;<br><br><br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> void</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@description</span> //处理PendingList中的消息</span><br><span class="hljs-comment">     **/</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handlePendingList</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">queueName</span> <span class="hljs-operator">=</span> RedisConstants.STREAM_QUEUE_NAME;<br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">// 1.获取队列中的订单信息 XREADGROUP GROUP g1 c1 COUNT 1 STREAMS stream.order 0</span><br>                List&lt;MapRecord&lt;String, Object, Object&gt;&gt; list = stringRedisTemplate.opsForStream().read(<br>                        Consumer.from(<span class="hljs-string">&quot;g1&quot;</span>, <span class="hljs-string">&quot;c1&quot;</span>),<br>                        StreamReadOptions.empty().count(<span class="hljs-number">1</span>),<br>                        StreamOffset.create(queueName, ReadOffset.from(<span class="hljs-string">&quot;0&quot;</span>))<br>                );<br><br>                <span class="hljs-comment">// 2.判断消息获取是否成功</span><br>                <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == list || list.isEmpty()) &#123;<br>                    <span class="hljs-comment">// 2.1如果获取失败，说明没有消息，结束循环</span><br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>                <span class="hljs-comment">// 3.解析list</span><br>                MapRecord&lt;String, Object, Object&gt; record = list.get(<span class="hljs-number">0</span>);<br>                Map&lt;Object, Object&gt; map = record.getValue();<br>                <span class="hljs-type">VoucherOrder</span> <span class="hljs-variable">voucherOrder</span> <span class="hljs-operator">=</span> BeanUtil.fillBeanWithMap(map, <span class="hljs-keyword">new</span> <span class="hljs-title class_">VoucherOrder</span>(), <span class="hljs-literal">true</span>);<br><br>                <span class="hljs-comment">// 4.如果获取成功，可以下单创建订单</span><br>                handleVoucherOrder(voucherOrder);<br>                <span class="hljs-comment">// 5.ACK确认 队列名 组名 消息ID SACK stream.order g1 消息id</span><br>                stringRedisTemplate.opsForStream().acknowledge(queueName, <span class="hljs-string">&quot;g1&quot;</span>, record.getId());<br><br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                log.error(<span class="hljs-string">&quot;处理PendingList订单异常:&quot;</span> + e);<br>                <span class="hljs-keyword">try</span> &#123;<br>                    Thread.sleep(<span class="hljs-number">20</span>);<br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException ex) &#123;<br>                    ex.printStackTrace();<br>                &#125;<br>            &#125;<br><br><br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> void</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@description</span> //处理订单</span><br><span class="hljs-comment">     **/</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleVoucherOrder</span><span class="hljs-params">(VoucherOrder voucherOrder)</span> &#123;<br>        <span class="hljs-comment">// 1.创建锁对象</span><br>        <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> voucherOrder.getUserId();<br>        <span class="hljs-comment">// 2.创建锁对象</span><br>        <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redissonClient.getLock(RedisConstants.LOCK_VOUVHER_ORDER_KEY + userId);<br>        <span class="hljs-comment">// 3.获取锁</span><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> lock.tryLock();<br>        <span class="hljs-comment">// 4.判断锁是否获取成功</span><br>        <span class="hljs-keyword">if</span> (!flag) &#123;<br>            <span class="hljs-comment">// 4.1 获取锁失败</span><br>            log.error(<span class="hljs-string">&quot;不允许重复下单！&quot;</span>);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-keyword">try</span> &#123;<br>            proxy.createVoucherOrderThread(voucherOrder);<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            lock.unlock();<br>        &#125;<br>    &#125;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> com.hmdp.dto.Result</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@description</span> // 秒杀优惠券(消息队列+优化Lua脚本)</span><br><span class="hljs-comment">     **/</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">seckillVoucher</span><span class="hljs-params">(Long voucherId)</span> &#123;<br>        <span class="hljs-comment">// 用户ID</span><br>        <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br>        <span class="hljs-comment">// 订单ID</span><br>        <span class="hljs-type">long</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> redisWorker.nextID(RedisConstants.VOUVHER_ORDER_KEY);<br>        <span class="hljs-comment">// 1. 执行Lua脚本</span><br>        <span class="hljs-type">Long</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> stringRedisTemplate.execute(<br>                SECKILL_SCRIPT,<br>                Collections.emptyList(),<br>                voucherId.toString(),<br>                userId.toString(),<br>                String.valueOf(orderId)<br>        );<br><br>        <span class="hljs-comment">// 2.判断结果是否为0</span><br>        <span class="hljs-keyword">if</span> (result.intValue() != <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-comment">// 2.1 不为0 说明没有购买资格</span><br>            <span class="hljs-keyword">return</span> Result.fail(result == <span class="hljs-number">1</span> ? <span class="hljs-string">&quot;优惠券已售罄，感谢参与！&quot;</span> : <span class="hljs-string">&quot;您已经购买过该优惠券，优惠券限制每人仅购买一次！&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">// 3.获取代理对象(事务)</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> AopContext.currentProxy();<br>        proxy = (IVoucherOrderService) o;<br><br><br>        <span class="hljs-comment">// 4.返回订单信息</span><br>        <span class="hljs-keyword">return</span> Result.ok(orderId);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> com.hmdp.dto.Result</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@description</span> //根据优惠券id和用户id查询订单 减少库存生成订单(方法废弃)</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span>: voucherId</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@date</span> 2023/2/15 22:12</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@author</span> wty</span><br><span class="hljs-comment">     **/</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-meta">@Transactional</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">createVoucherOrder</span><span class="hljs-params">(Long voucherId)</span> &#123;<br>        <span class="hljs-type">Long</span> <span class="hljs-variable">userID</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br><br>        <span class="hljs-comment">// 5.实现1人1单加入逻辑：根据优惠券id和用户id查询订单</span><br>        <span class="hljs-comment">// 5.1查询订单,并不用查询出具体的值，而是查询出数量即可</span><br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> query().eq(<span class="hljs-string">&quot;user_id&quot;</span>, userID).eq(<span class="hljs-string">&quot;voucher_id&quot;</span>, voucherId).count();<br>        <span class="hljs-comment">// 5.2判断订单是否存在</span><br>        <span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-comment">// 5.2.1 存在就返回异常结果</span><br>            <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;秒杀优惠券每人限购1张,感谢配合,本优惠券最终解释权归ty公司所有!&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">// 5.2.2 不存在再减少库存</span><br><br>        <span class="hljs-comment">// 6.1扣减库存(会出现超卖问题)</span><br>        <span class="hljs-comment">// update tb_seckill_voucher set stock = stock -1 where voucher_id = ?</span><br>        <span class="hljs-comment">/*boolean result = iSeckillVoucherService.update()</span><br><span class="hljs-comment">                .setSql(&quot;stock = stock -1&quot;)</span><br><span class="hljs-comment">                .eq(&quot;voucher_id&quot;, voucherId).update();*/</span><br><br>        <span class="hljs-comment">// 6.2扣减库存(针对超卖问题用乐观锁CAS解决)</span><br>        <span class="hljs-comment">// update tb_seckill_voucher set stock = stock -1 where voucher_id = ? and stock = ?</span><br>        <span class="hljs-comment">/*boolean result = iSeckillVoucherService.update()</span><br><span class="hljs-comment">                .setSql(&quot;stock = stock - 1&quot;)</span><br><span class="hljs-comment">                .eq(&quot;voucher_id&quot;, voucherId)</span><br><span class="hljs-comment">                .eq(&quot;stock&quot;, stock)</span><br><span class="hljs-comment">                .update();*/</span><br><br>        <span class="hljs-comment">// 6.3扣减库存(针对使用乐观锁CAS，没卖完解决)</span><br>        <span class="hljs-comment">// update tb_seckill_voucher set stock = stock -1 where voucher_id = ? and stock &gt; 0</span><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> iSeckillVoucherService.update()<br>                .setSql(<span class="hljs-string">&quot;stock = stock - 1&quot;</span>)<br>                .eq(<span class="hljs-string">&quot;voucher_id&quot;</span>, voucherId)<br>                .gt(<span class="hljs-string">&quot;stock&quot;</span>, <span class="hljs-number">0</span>)<br>                .update();<br><br>        <span class="hljs-keyword">if</span> (!result) &#123;<br>            <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;商品已经售罄!&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">// 7.创建订单</span><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 获取订单id</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-type">long</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> redisWorker.nextID(RedisConstants.VOUVHER_ORDER_KEY);<br><br>        <span class="hljs-type">VoucherOrder</span> <span class="hljs-variable">voucherOrder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">VoucherOrder</span>();<br>        voucherOrder.setId(orderId);<br>        voucherOrder.setVoucherId(voucherId);<br>        voucherOrder.setUserId(userID);<br><br>        <span class="hljs-comment">// 将订单信息保存到数据库</span><br>        <span class="hljs-comment">// insert into tb_voucher_order values ()</span><br>        save(voucherOrder);<br><br>        <span class="hljs-comment">//8.返回订单id</span><br>        <span class="hljs-keyword">return</span> Result.ok(orderId);<br>    &#125;  <br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>redis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>redis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>reids-分布式锁</title>
    <link href="/reids-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/62a2e5871819/"/>
    <url>/reids-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/62a2e5871819/</url>
    
    <content type="html"><![CDATA[<h1 id="1-分布式锁"><a href="#1-分布式锁" class="headerlink" title="1 分布式锁"></a>1 分布式锁</h1><p>在之前分析过，集群模式下的一人一单存在问题，其根源就在锁监视器上。因此需要一个分布式锁，满足<strong>分布式系统</strong>或<strong>集群</strong>模式下多进程可见并且<strong>互斥</strong>的锁。</p><p>核心思想：让大家都使用同一把锁，只要大家使用的是同一把锁，那么我们就能锁住线程，不让线程进行，让程序串行执行。</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/cc2afb0cee29412091e3544bb74229ee.png" alt="在这里插入图片描述"></p><h2 id="1-1-分布式要求"><a href="#1-1-分布式要求" class="headerlink" title="1.1 分布式要求"></a>1.1 分布式要求</h2><ul><li><p>可见性：多个线程都能看到相同的结果，注意：这个地方说的可见性并不是并发编程中指的内存可见性，只是说多个进程之间都能感知到变化的意思</p></li><li><p>互斥：互斥是分布式锁的最基本的条件，使得程序串行执行</p></li><li><p>高可用：程序不易崩溃，时时刻刻都保证较高的可用性</p></li><li><p>高性能：由于加锁本身就让性能降低，所有对于分布式锁本身需要他就较高的加锁性能和释放锁性能</p></li><li><p>安全性：安全也是程序中必不可少的一环</p></li></ul><h2 id="1-2-常见的分布式锁"><a href="#1-2-常见的分布式锁" class="headerlink" title="1.2 常见的分布式锁"></a>1.2 常见的分布式锁</h2><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/49ff52e8ebed4ec685048ca0b6661eb9.png" alt="在这里插入图片描述"></p><h2 id="1-3-redis实现分布式锁"><a href="#1-3-redis实现分布式锁" class="headerlink" title="1.3 redis实现分布式锁"></a>1.3 redis实现分布式锁</h2><ol><li>获取锁：要求确保当前只能有一个线程获取到锁。（set key value ex ttl nx ）利用set nx的特性保证只能有一个获取线程</li><li>释放锁：要求可以手动释放，也要有超时释放做兜底。（del key）</li></ol><h2 id="1-4-加锁"><a href="#1-4-加锁" class="headerlink" title="1.4 加锁"></a>1.4 加锁</h2><p>增加一个接口：ILock.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.hmdp.lock;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ILock</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> boolean true获取锁成功，false获取锁失败</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@description</span> //获取尝试锁</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span>: expireTime 锁持有的超时时间，过期后自动释放</span><br><span class="hljs-comment">     **/</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">(<span class="hljs-type">long</span> expireTime)</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> void</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@description</span> //释放锁</span><br><span class="hljs-comment">     **/</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">unLock</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleRedisLock</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ILock</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 锁前缀</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">KEY_PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;lock:&quot;</span>;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 定义锁的名称</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String lockName;<br><br>    StringRedisTemplate stringRedisTemplate;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SimpleRedisLock</span><span class="hljs-params">(String lockName, StringRedisTemplate stringRedisTemplate)</span> &#123;<br>        <span class="hljs-built_in">this</span>.lockName = lockName;<br>        <span class="hljs-built_in">this</span>.stringRedisTemplate = stringRedisTemplate;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">(<span class="hljs-type">long</span> expireTime)</span> &#123;<br>        <span class="hljs-comment">// 获取当前线程的标识</span><br>        <span class="hljs-type">long</span> <span class="hljs-variable">threadId</span> <span class="hljs-operator">=</span> Thread.currentThread().getId();<br>        <span class="hljs-comment">// set key &quot;1&quot; ex expireTime nx</span><br>        <span class="hljs-type">Boolean</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue()<br>                .setIfAbsent(KEY_PREFIX + lockName, threadId + <span class="hljs-string">&quot;&quot;</span>, expireTime, TimeUnit.SECONDS);<br>        <span class="hljs-keyword">return</span> BooleanUtil.isTrue(flag);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unLock</span><span class="hljs-params">()</span> &#123;<br>        stringRedisTemplate.delete(KEY_PREFIX + lockName);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>修改VoucherOrderServiceImpl.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VoucherOrderServiceImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ServiceImpl</span>&lt;VoucherOrderMapper, VoucherOrder&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IVoucherOrderService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ISeckillVoucherService iSeckillVoucherService;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisWorker redisWorker;<br><br>    <span class="hljs-meta">@Resource</span><br>    StringRedisTemplate stringRedisTemplate;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> com.hmdp.dto.Result</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@description</span> //秒杀优惠券</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span>: voucherId</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@date</span> 2023/2/15 22:09</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@author</span> wty</span><br><span class="hljs-comment">     **/</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">seckillVoucher</span><span class="hljs-params">(Long voucherId)</span> &#123;<br>        <span class="hljs-comment">// 1.查询秒杀优惠券信息</span><br>        <span class="hljs-comment">// select * from tb_seckill_voucher where voucher_id = ?</span><br>        <span class="hljs-type">SeckillVoucher</span> <span class="hljs-variable">seckillVoucher</span> <span class="hljs-operator">=</span> iSeckillVoucherService.getById(voucherId);<br><br>        <span class="hljs-comment">// 2.判断秒杀是否开始</span><br>        <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">beginTime</span> <span class="hljs-operator">=</span> seckillVoucher.getBeginTime();<br>        <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">endTime</span> <span class="hljs-operator">=</span> seckillVoucher.getEndTime();<br>        <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> LocalDateTime.now();<br><br>        <span class="hljs-keyword">if</span> (now.isBefore(beginTime)) &#123;<br>            <span class="hljs-comment">// 当前时间早于秒杀开始时间，说明秒杀没有开始</span><br>            <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;秒杀尚未开始,请耐心等待！秒杀开始时间:&quot;</span> + beginTime.format(DateTimeFormatter.ofPattern(<span class="hljs-string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>)));<br>        &#125;<br>        <span class="hljs-comment">// 3.判断秒杀是否已经结束</span><br>        <span class="hljs-keyword">if</span> (now.isAfter(endTime)) &#123;<br>            <span class="hljs-comment">// 当前时间晚于秒杀结束时间，说明秒杀结束了</span><br>            <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;秒杀已经结束,感谢支持!&quot;</span>);<br>        &#125;<br><br><br>        <span class="hljs-comment">// 4.判断库存是否充足</span><br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">stock</span> <span class="hljs-operator">=</span> seckillVoucher.getStock();<br>        <span class="hljs-keyword">if</span> (stock &lt;= <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;商品已经售罄!&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">// 实现一人一单，获取user对象锁</span><br>        <span class="hljs-type">Long</span> <span class="hljs-variable">userID</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br>        <span class="hljs-comment">/*// 使用JDK提供的锁监视器synchronized来实现</span><br><span class="hljs-comment">        synchronized (userID.toString().intern()) &#123;</span><br><span class="hljs-comment">            // 调用本类方法的时候，Spring事务是失效的，解决方案二：调用AopContext API</span><br><span class="hljs-comment">            Object o = AopContext.currentProxy();</span><br><span class="hljs-comment">            IVoucherOrderService proxy = (IVoucherOrderService) o;</span><br><span class="hljs-comment">            return proxy.createVoucherOrder(voucherId);</span><br><span class="hljs-comment">        &#125;*/</span><br>        <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span>修改的地方 尝试自定义锁监视器</span><br>        <span class="hljs-type">SimpleRedisLock</span> <span class="hljs-variable">simpleRedisLock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleRedisLock</span>(<span class="hljs-string">&quot;order:&quot;</span> + userID.toString().intern(), stringRedisTemplate);<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> simpleRedisLock.tryLock(RedisConstants.LOCK_VOUVHER_ORDER_TTL);<br>      <br>        <span class="hljs-keyword">if</span> (!flag) &#123;<br>            <span class="hljs-comment">// 获取锁失败,就直接返回错误信息即可</span><br>            <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;[秒杀优惠券]不允许重复下单!本秒杀业务一切解释器归ty公司所有&quot;</span>);<br>        &#125;<br><br>        Result result;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> AopContext.currentProxy();<br>            <span class="hljs-type">IVoucherOrderService</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> (IVoucherOrderService) o;<br>            <span class="hljs-keyword">return</span> proxy.createVoucherOrder(voucherId);<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            simpleRedisLock.unLock();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> com.hmdp.dto.Result</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@description</span> //根据优惠券id和用户id查询订单 减少库存生成订单</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span>: voucherId</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@date</span> 2023/2/15 22:12</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@author</span> wty</span><br><span class="hljs-comment">     **/</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-meta">@Transactional</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">createVoucherOrder</span><span class="hljs-params">(Long voucherId)</span> &#123;<br>        <span class="hljs-type">Long</span> <span class="hljs-variable">userID</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br><br>        <span class="hljs-comment">// 5.实现1人1单加入逻辑：根据优惠券id和用户id查询订单</span><br>        <span class="hljs-comment">// 5.1查询订单,并不用查询出具体的值，而是查询出数量即可</span><br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> query().eq(<span class="hljs-string">&quot;user_id&quot;</span>, userID).eq(<span class="hljs-string">&quot;voucher_id&quot;</span>, voucherId).count();<br>        <span class="hljs-comment">// 5.2判断订单是否存在</span><br>        <span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-comment">// 5.2.1 存在就返回异常结果</span><br>            <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;秒杀优惠券每人限购1张,感谢配合,本优惠券最终解释权归ty公司所有!&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">// 5.2.2 不存在再减少库存</span><br><br>        <span class="hljs-comment">// 6.1扣减库存(会出现超卖问题)</span><br>        <span class="hljs-comment">// update tb_seckill_voucher set stock = stock -1 where voucher_id = ?</span><br>        <span class="hljs-comment">/*boolean result = iSeckillVoucherService.update()</span><br><span class="hljs-comment">                .setSql(&quot;stock = stock -1&quot;)</span><br><span class="hljs-comment">                .eq(&quot;voucher_id&quot;, voucherId).update();*/</span><br><br>        <span class="hljs-comment">// 6.2扣减库存(针对超卖问题用乐观锁CAS解决)</span><br>        <span class="hljs-comment">// update tb_seckill_voucher set stock = stock -1 where voucher_id = ? and stock = ?</span><br>        <span class="hljs-comment">/*boolean result = iSeckillVoucherService.update()</span><br><span class="hljs-comment">                .setSql(&quot;stock = stock - 1&quot;)</span><br><span class="hljs-comment">                .eq(&quot;voucher_id&quot;, voucherId)</span><br><span class="hljs-comment">                .eq(&quot;stock&quot;, stock)</span><br><span class="hljs-comment">                .update();*/</span><br><br>        <span class="hljs-comment">// 6.3扣减库存(针对使用乐观锁CAS，没卖完解决)</span><br>        <span class="hljs-comment">// update tb_seckill_voucher set stock = stock -1 where voucher_id = ? and stock &gt; 0</span><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> iSeckillVoucherService.update()<br>                .setSql(<span class="hljs-string">&quot;stock = stock - 1&quot;</span>)<br>                .eq(<span class="hljs-string">&quot;voucher_id&quot;</span>, voucherId)<br>                .gt(<span class="hljs-string">&quot;stock&quot;</span>, <span class="hljs-number">0</span>)<br>                .update();<br><br>        <span class="hljs-keyword">if</span> (!result) &#123;<br>            <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;商品已经售罄!&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">// 7.创建订单</span><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 获取订单id</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-type">long</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> redisWorker.nextID(<span class="hljs-string">&quot;order&quot;</span>);<br><br>        <span class="hljs-type">VoucherOrder</span> <span class="hljs-variable">voucherOrder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">VoucherOrder</span>();<br>        voucherOrder.setId(orderId);<br>        voucherOrder.setVoucherId(voucherId);<br>        voucherOrder.setUserId(userID);<br><br>        <span class="hljs-comment">// 将订单信息保存到数据库</span><br>        <span class="hljs-comment">// insert into tb_voucher_order values ()</span><br>        save(voucherOrder);<br><br>        <span class="hljs-comment">//8.返回订单id</span><br>        <span class="hljs-keyword">return</span> Result.ok(orderId);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="1-6-锁误删问题"><a href="#1-6-锁误删问题" class="headerlink" title="1.6 锁误删问题"></a>1.6 锁误删问题</h2><h3 id="1-6-1-介绍"><a href="#1-6-1-介绍" class="headerlink" title="1.6.1 介绍"></a>1.6.1 介绍</h3><p>持有锁的线程在锁的内部出现了阻塞，导致他的锁自动释放。</p><p>这时其他线程，线程2来尝试获得锁，就拿到了这把锁，然后线程2在持有锁执行过程中，线程1反应过来，继续执行，而线程1执行过程中，走到了删除锁逻辑，此时就会把本应该属于线程2的锁进行删除。</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/f7653066583248bfa31dc22d0d0d28ad.png" alt="img"></p><h3 id="1-6-2-解决方案"><a href="#1-6-2-解决方案" class="headerlink" title="1.6.2 解决方案"></a>1.6.2 解决方案</h3><p>在获取锁之前，增加一个标识，每次删除锁的时候，判断当前的锁是否属于自己，属于自己就删除，不属于自己就不删除。</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/4faba0a102f848dda0e705cb7db88dda.png" alt="在这里插入图片描述"></p><p>步骤：</p><ol><li>在获取锁时存入线程标示（可以用UUID表示）</li><li>在释放锁时先获取锁中的线程标示，判断是否与当前线程标示一致</li></ol><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/7775969edfce41b382998626f005e5b1.png" alt="在这里插入图片描述"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleRedisLock</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ILock</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 锁前缀</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">KEY_PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;lock:&quot;</span>;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 线程ID前缀</span><br><span class="hljs-comment">     * true是可以把UUID中的横线去掉</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">THREAD_ID_PREFIX</span> <span class="hljs-operator">=</span> UUID.randomUUID().toString(<span class="hljs-literal">true</span>) + <span class="hljs-string">&quot;-&quot;</span>;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 定义锁的名称</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String lockName;<br><br>    StringRedisTemplate stringRedisTemplate;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SimpleRedisLock</span><span class="hljs-params">(String lockName, StringRedisTemplate stringRedisTemplate)</span> &#123;<br>        <span class="hljs-built_in">this</span>.lockName = lockName;<br>        <span class="hljs-built_in">this</span>.stringRedisTemplate = stringRedisTemplate;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> boolean</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@description</span> // 获取锁</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span>: expireTime</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@date</span> 2023/2/16 12:24</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@author</span> wty</span><br><span class="hljs-comment">     **/</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">(<span class="hljs-type">long</span> expireTime)</span> &#123;<br>        <span class="hljs-comment">// 获取当前线程的标识</span><br>        <span class="hljs-comment">//long threadId = Thread.currentThread().getId();</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">threadId</span> <span class="hljs-operator">=</span> THREAD_ID_PREFIX + Thread.currentThread().getId();<br>        <span class="hljs-comment">// set key &quot;1&quot; ex expireTime nx</span><br>        <span class="hljs-type">Boolean</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue()<br>                .setIfAbsent(KEY_PREFIX + lockName, threadId + <span class="hljs-string">&quot;&quot;</span>, expireTime, TimeUnit.SECONDS);<br>        <span class="hljs-keyword">return</span> BooleanUtil.isTrue(flag);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> void</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@description</span> //释放锁</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@date</span> 2023/2/16 12:24</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@author</span> wty</span><br><span class="hljs-comment">     **/</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unLock</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 获取当前线程的ID</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">threadId</span> <span class="hljs-operator">=</span> THREAD_ID_PREFIX + Thread.currentThread().getId();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">threadId_Redis</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().get(KEY_PREFIX + lockName);<br>        <span class="hljs-comment">// 只有redis中的线程和当前的线程是同一个才允许释放锁</span><br>        <span class="hljs-keyword">if</span> (String.valueOf(threadId).equals(threadId_Redis)) &#123;<br>            stringRedisTemplate.delete(KEY_PREFIX + lockName);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="1-7-分布式锁原子性操作问题"><a href="#1-7-分布式锁原子性操作问题" class="headerlink" title="1.7 分布式锁原子性操作问题"></a>1.7 分布式锁原子性操作问题</h2><h3 id="1-7-1-介绍"><a href="#1-7-1-介绍" class="headerlink" title="1.7.1 介绍"></a>1.7.1 介绍</h3><p>在上述部分绝大部分情况都能满足业务生产使用，但是在最后判断和删除的时候还是有可能出现阻塞，例如：判断完属于自己的锁，正准备删除的时候，此时应用出现full gc，这个时候就出现了阻塞，同理，其他线程此时由于线程1的阻塞导致的释放锁而拿到了锁，线程1等阻塞完成之后还是会删除锁</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/9b1f9f9a5e1e4bf0a62a74283f41cf7a.png" alt="在这里插入图片描述"></p><h3 id="1-7-2-解决方案"><a href="#1-7-2-解决方案" class="headerlink" title="1.7.2 解决方案"></a>1.7.2 解决方案</h3><p>Redis提供了Lua脚本功能，在一个脚本中编写多条Redis命令，确保多条命令执行时的原子性。Lua是一种编程语言，它的基本语法大家可以参考网站：<a href="https://www.runoob.com/lua/lua-tutorial.html">菜鸟教程</a>。</p><h4 id="1-7-2-1-更改释放锁逻辑"><a href="#1-7-2-1-更改释放锁逻辑" class="headerlink" title="1.7.2.1 更改释放锁逻辑"></a>1.7.2.1 更改释放锁逻辑</h4><p>原逻辑：</p><ol><li>获取锁中的线程标示</li><li>判断是否与指定的标示（当前线程标示）一致</li><li>如果一致则释放锁（删除）</li><li>如果不一致则什么都不做</li></ol><p>使用Lua脚本更改</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- 锁的key</span><br><span class="hljs-keyword">local</span> key = KEYS[<span class="hljs-number">1</span>]<br><br><span class="hljs-comment">-- 当前线程的标识</span><br><span class="hljs-keyword">local</span> threadID = ARGV[<span class="hljs-number">1</span>]<br><br><span class="hljs-comment">-- 获取锁中的线程标识</span><br><span class="hljs-keyword">local</span> threadID_Redis = redis.call(<span class="hljs-string">&#x27;get&#x27;</span>,KEYS[<span class="hljs-number">1</span>])<br><br><span class="hljs-comment">-- 比较线程的标识与锁中的标识是否一致</span><br><span class="hljs-keyword">if</span>(ARGV[<span class="hljs-number">1</span>] == threadID_Redis) <span class="hljs-keyword">then</span><br><span class="hljs-comment">-- 一致就释放锁</span><br>redis.call(<span class="hljs-string">&#x27;del&#x27;</span>,KEYS[<span class="hljs-number">1</span>])<br><span class="hljs-keyword">end</span><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><p>java代码调用Lua脚本，更改分布式锁</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleRedisLock</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ILock</span> &#123;<br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 锁前缀</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">KEY_PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;lock:&quot;</span>;<br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 线程ID前缀</span><br><span class="hljs-comment">   * true是可以把UUID中的横线去掉</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">THREAD_ID_PREFIX</span> <span class="hljs-operator">=</span> UUID.randomUUID().toString(<span class="hljs-literal">true</span>) + <span class="hljs-string">&quot;-&quot;</span>;<br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 定义锁的名称</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">private</span> String lockName;<br><br>  StringRedisTemplate stringRedisTemplate;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> DefaultRedisScript&lt;Long&gt; UNLOCK_SCRIPT;<br><br>  <span class="hljs-comment">// 在类第一次启动的时候就进行加载</span><br>  <span class="hljs-keyword">static</span> &#123;<br>      UNLOCK_SCRIPT = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultRedisScript</span>&lt;&gt;();<br>      UNLOCK_SCRIPT.setLocation(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathResource</span>(<span class="hljs-string">&quot;unlock.lua&quot;</span>));<br>      UNLOCK_SCRIPT.setResultType(Long.class);<br>  &#125;<br><br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">SimpleRedisLock</span><span class="hljs-params">(String lockName, StringRedisTemplate stringRedisTemplate)</span> &#123;<br>      <span class="hljs-built_in">this</span>.lockName = lockName;<br>      <span class="hljs-built_in">this</span>.stringRedisTemplate = stringRedisTemplate;<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span></span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> void</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@description</span> //释放锁(基于Lua脚本)</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@date</span> 2023/2/16 15:37</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@author</span> wty</span><br><span class="hljs-comment">   **/</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unLock</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-comment">// 调用Lua脚本</span><br>      stringRedisTemplate.execute(<br>              UNLOCK_SCRIPT,<br>              Collections.singletonList(KEY_PREFIX + lockName),<br>              THREAD_ID_PREFIX + Thread.currentThread().getId()<br>      );<br><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="1-8-Redisssion分布式锁"><a href="#1-8-Redisssion分布式锁" class="headerlink" title="1.8 Redisssion分布式锁"></a>1.8 Redisssion分布式锁</h2><p>使用setnx实现分布式锁存在以下问题：</p><ol><li>重入问题：重入问题是指 获得锁的线程可以再次进入到相同的锁的代码块中，可重入锁的意义在于防止死锁，比如HashTable这样的代码中，他的方法都是使用synchronized修饰的，假如他在一个方法内，调用另一个方法，那么此时如果是不可重入的，不就死锁了吗？所以可重入锁他的主要意义是防止死锁，我们的synchronized和Lock锁都是可重入的。</li><li>不可重试：是指目前的分布式只能尝试一次，我们认为合理的情况是：当线程在获得锁失败后，他应该能再次尝试获得锁。</li><li>超时释放：我们在加锁时增加了过期时间，这样的我们可以防止死锁，但是如果卡顿的时间超长，虽然我们采用了lua表达式防止删锁的时候，误删别人的锁，但是毕竟没有锁住，有安全隐患。</li><li>主从一致性： 如果Redis提供了主从集群，当我们向集群写数据时，主机需要异步的将数据同步给从机，而万一在同步过去之前，主机宕机了，就会出现死锁问题。</li></ol><h3 id="1-8-1-关于Redission"><a href="#1-8-1-关于Redission" class="headerlink" title="1.8.1 关于Redission"></a>1.8.1 关于Redission</h3><p>Redisson是一个在Redis的基础上实现的Java驻内存数据网格（In-Memory Data Grid）。它不仅提供了一系列的分布式的Java常用对象，还提供了许多分布式服务，其中就包含了各种分布式锁的实现。</p><p>官网：<a href="https://redisson.org/">Redisson官网</a></p><h3 id="1-8-2-引入pom依赖"><a href="#1-8-2-引入pom依赖" class="headerlink" title="1.8.2 引入pom依赖"></a>1.8.2 引入pom依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.redisson<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>redisson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.13.6<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="1-8-3-增加配置"><a href="#1-8-3-增加配置" class="headerlink" title="1.8.3 增加配置"></a>1.8.3 增加配置</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedissonConfig</span> &#123;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> RedissonClient <span class="hljs-title function_">redissonClient</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-comment">// 配置类</span><br>        <span class="hljs-type">Config</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Config</span>();<br>        <span class="hljs-comment">// 添加redis地址，这里添加了单点的地址(虚拟机地址)，也可以使用config.useClusterServers()添加集群地址</span><br>        config.useSingleServer().setAddress(<span class="hljs-string">&quot;redis://192.168.150.101:6379&quot;</span>)<br>            .setPassword(<span class="hljs-string">&quot;123321&quot;</span>);<br>        <span class="hljs-comment">// 创建RedissonClient对象</span><br>        <span class="hljs-keyword">return</span> Redisson.create(config);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="1-8-4-使用Redission解决一人一单"><a href="#1-8-4-使用Redission解决一人一单" class="headerlink" title="1.8.4 使用Redission解决一人一单"></a>1.8.4 使用Redission解决一人一单</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VoucherOrderServiceImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ServiceImpl</span>&lt;VoucherOrderMapper, VoucherOrder&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IVoucherOrderService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ISeckillVoucherService iSeckillVoucherService;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisWorker redisWorker;<br><br>    <span class="hljs-meta">@Resource</span><br>    StringRedisTemplate stringRedisTemplate;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> RedissonClient redissonClient;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">seckillVoucher</span><span class="hljs-params">(Long voucherId)</span> &#123;<br>        <span class="hljs-comment">// 1.查询秒杀优惠券信息</span><br>        <span class="hljs-comment">// select * from tb_seckill_voucher where voucher_id = ?</span><br>        <span class="hljs-type">SeckillVoucher</span> <span class="hljs-variable">seckillVoucher</span> <span class="hljs-operator">=</span> iSeckillVoucherService.getById(voucherId);<br><br>        <span class="hljs-comment">// 2.判断秒杀是否开始</span><br>        <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">beginTime</span> <span class="hljs-operator">=</span> seckillVoucher.getBeginTime();<br>        <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">endTime</span> <span class="hljs-operator">=</span> seckillVoucher.getEndTime();<br>        <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> LocalDateTime.now();<br><br>        <span class="hljs-keyword">if</span> (now.isBefore(beginTime)) &#123;<br>            <span class="hljs-comment">// 当前时间早于秒杀开始时间，说明秒杀没有开始</span><br>            <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;秒杀尚未开始,请耐心等待！秒杀开始时间:&quot;</span> + beginTime.format(DateTimeFormatter.ofPattern(<span class="hljs-string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>)));<br>        &#125;<br>        <span class="hljs-comment">// 3.判断秒杀是否已经结束</span><br>        <span class="hljs-keyword">if</span> (now.isAfter(endTime)) &#123;<br>            <span class="hljs-comment">// 当前时间晚于秒杀结束时间，说明秒杀结束了</span><br>            <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;秒杀已经结束,感谢支持!&quot;</span>);<br>        &#125;<br><br><br>        <span class="hljs-comment">// 4.判断库存是否充足</span><br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">stock</span> <span class="hljs-operator">=</span> seckillVoucher.getStock();<br>        <span class="hljs-keyword">if</span> (stock &lt;= <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;商品已经售罄!&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">// 实现一人一单，获取user对象锁</span><br>        <span class="hljs-type">Long</span> <span class="hljs-variable">userID</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br><br>        <span class="hljs-comment">//<span class="hljs-doctag">TODO:</span> 用Redisson提供的可重入锁</span><br>        <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redissonClient.getLock(<span class="hljs-string">&quot;lock:order:&quot;</span> + userID.toString().intern());<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> lock.tryLock();<br><br>        <span class="hljs-keyword">if</span> (!flag) &#123;<br>            <span class="hljs-comment">// 获取锁失败,就直接返回错误信息即可</span><br>            <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;[秒杀优惠券]不允许重复下单!本秒杀业务一切解释器归ty公司所有&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> AopContext.currentProxy();<br>            <span class="hljs-type">IVoucherOrderService</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> (IVoucherOrderService) o;<br>            <span class="hljs-keyword">return</span> proxy.createVoucherOrder(voucherId);<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            lock.unlock();<br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="1-8-5-Redission的可重入锁原理"><a href="#1-8-5-Redission的可重入锁原理" class="headerlink" title="1.8.5 Redission的可重入锁原理"></a>1.8.5 Redission的可重入锁原理</h3><p>在JDK中，lock锁和synchronized锁都是可重入锁，可重入锁就是当前一个线程在调就是一个线程不用释放，可以重复的获取一个锁n次，只是在释放的时候，也需要相应的释放n次。</p><p>那么猜想Redisssion可以实现可重入就一定有一个记录获取锁次数的变量。</p><h4 id="1-8-5-1-Redis无法实现可重入锁"><a href="#1-8-5-1-Redis无法实现可重入锁" class="headerlink" title="1.8.5.1 Redis无法实现可重入锁"></a>1.8.5.1 Redis无法实现可重入锁</h4><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/d60b998ce29541f4ac08ae0826f664e9.png" alt="img"></p><p>可以看到没有一个变量用来计数锁获取次数</p><h4 id="1-8-5-2-Redisssion可实现可重入锁"><a href="#1-8-5-2-Redisssion可实现可重入锁" class="headerlink" title="1.8.5.2 Redisssion可实现可重入锁"></a>1.8.5.2 Redisssion可实现可重入锁</h4><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/d3a7a25fca934160bb031920d883a9c0.png" alt="img"></p><h4 id="1-8-5-3-Lua脚本实现获取锁（可重入）"><a href="#1-8-5-3-Lua脚本实现获取锁（可重入）" class="headerlink" title="1.8.5.3 Lua脚本实现获取锁（可重入）"></a>1.8.5.3 Lua脚本实现获取锁（可重入）</h4><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/8d8ec511048c40368a6421e563122019.png" alt="img"></p><h4 id="1-8-5-4-Lua脚本实现释放锁（可重入）"><a href="#1-8-5-4-Lua脚本实现释放锁（可重入）" class="headerlink" title="1.8.5.4 Lua脚本实现释放锁（可重入）"></a>1.8.5.4 Lua脚本实现释放锁（可重入）</h4><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/8829602506d245c4860e65bba88333cb.png" alt="img"></p><h4 id="1-8-5-5-测试代码"><a href="#1-8-5-5-测试代码" class="headerlink" title="1.8.5.5 测试代码"></a>1.8.5.5 测试代码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedissonTest</span> &#123;<br> <br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedissonClient redissonClient;<br> <br>    <span class="hljs-keyword">private</span> RLock lock;<br> <br>    <span class="hljs-meta">@BeforeEach</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">setup</span><span class="hljs-params">()</span>&#123;<br>        lock=redissonClient.getLock(<span class="hljs-string">&quot;order&quot;</span>);<br>    &#125;<br> <br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">method1</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">isLock</span> <span class="hljs-operator">=</span> lock.tryLock();<br>        <span class="hljs-keyword">if</span>(!isLock)&#123;<br>            log.error(<span class="hljs-string">&quot;获取锁失败……1&quot;</span>);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-keyword">try</span>&#123;<br>            log.info(<span class="hljs-string">&quot;获取锁成功……1&quot;</span>);<br>            method2();<br>            log.info(<span class="hljs-string">&quot;开始执行业务……1&quot;</span>);<br>        &#125;<span class="hljs-keyword">finally</span>&#123;<br>            log.warn(<span class="hljs-string">&quot;准备释放锁……1&quot;</span>);<br>            lock.unlock();<br>        &#125;<br>    &#125;<br> <br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">method2</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">isLock</span> <span class="hljs-operator">=</span> lock.tryLock();<br>        <span class="hljs-keyword">if</span>(!isLock)&#123;<br>            log.error(<span class="hljs-string">&quot;获取锁失败……2&quot;</span>);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-keyword">try</span>&#123;<br>            log.info(<span class="hljs-string">&quot;获取锁成功……2&quot;</span>);<br>            log.info(<span class="hljs-string">&quot;开始执行业务……2&quot;</span>);<br>        &#125;<span class="hljs-keyword">finally</span>&#123;<br>            log.warn(<span class="hljs-string">&quot;准备释放锁……2&quot;</span>);<br>            lock.unlock();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/071adc4a6e234f9d9a8f76c530c48dbe.png" alt="img"></p><h4 id="1-8-5-6-源码"><a href="#1-8-5-6-源码" class="headerlink" title="1.8.5.6 源码"></a>1.8.5.6 源码</h4><p>tryLock():</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/635c000583ed40a8a788767ca9bfb6aa.png" alt="img"></p><p>unLock():</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/6ea4be4c364b4c1ca518b57d92126d3e.png" alt="img"></p><blockquote><p>注：在最后删除锁之后，还进行了一个发布动作</p></blockquote><h3 id="1-8-6-Redission的锁重试和看门狗机制"><a href="#1-8-6-Redission的锁重试和看门狗机制" class="headerlink" title="1.8.6 Redission的锁重试和看门狗机制"></a>1.8.6 Redission的锁重试和看门狗机制</h3><h4 id="1-8-6-1-获取锁重试"><a href="#1-8-6-1-获取锁重试" class="headerlink" title="1.8.6.1 获取锁重试"></a>1.8.6.1 获取锁重试</h4><p>redis获取锁只尝试一次就返回false，没有更多的尝试机制。</p><p>整体流程：<br><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/47d24705269d4683b5dec4f3bb553a51.png" alt="img"></p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/image-20240225204126277.png" alt="image-20240225204126277"></p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/image-20240225204221016.png" alt="image-20240225204221016"></p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/image-20240225204321817.png" alt="image-20240225204321817"></p><p>同时计算获取锁耗时，再使用等待时间-获取锁耗时时间</p> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">(<span class="hljs-type">long</span> waitTime, <span class="hljs-type">long</span> leaseTime, TimeUnit unit)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>    <span class="hljs-comment">//将最大获取锁等待时间转化为毫秒</span><br>    <span class="hljs-type">long</span> <span class="hljs-variable">time</span> <span class="hljs-operator">=</span> unit.toMillis(waitTime);<br>    <span class="hljs-comment">//获取当前时间的毫秒值</span><br>    <span class="hljs-type">long</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>    <span class="hljs-comment">//获取线程标识</span><br>    <span class="hljs-type">long</span> <span class="hljs-variable">threadId</span> <span class="hljs-operator">=</span> Thread.currentThread().getId();<br>    <span class="hljs-comment">//尝试获取锁,如果获取锁失败ttl应该是一个具体值，而不是null</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">ttl</span> <span class="hljs-operator">=</span> tryAcquire(waitTime, leaseTime, unit, threadId);<br>    <span class="hljs-comment">// lock acquired</span><br>    <span class="hljs-keyword">if</span> (ttl == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">//获取到锁，直接返回true</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br> <br>    <span class="hljs-comment">//计算最大等待时间减去第一次尝试获取锁的时间，得到剩余等待时间 </span><br>    time -= System.currentTimeMillis() - current;<br>    <span class="hljs-keyword">if</span> (time &lt;= <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-comment">//如果不存在剩余时间</span><br>        acquireFailed(waitTime, unit, threadId);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <br>    <span class="hljs-comment">//如果还存在剩余时间，接着获取当前时间</span><br>    current = System.currentTimeMillis();<br>    <span class="hljs-comment">//订阅释放锁的信号（就是开头说的释放锁时会发布的那条信息），这里也是异步执行，因此返回类型为Future</span><br>    CompletableFuture&lt;RedissonLockEntry&gt; subscribeFuture = subscribe(threadId);<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">//获取等待结果，如果超过了剩余最大等待时间会抛出异常，执行TimeOutException中的catch代码</span><br>        subscribeFuture.get(time, TimeUnit.MILLISECONDS);<br>    &#125; <span class="hljs-keyword">catch</span> (TimeoutException e) &#123;<br>        <span class="hljs-keyword">if</span> (!subscribeFuture.completeExceptionally(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisTimeoutException</span>(<br>                <span class="hljs-string">&quot;Unable to acquire subscription lock after &quot;</span> + time + <span class="hljs-string">&quot;ms. &quot;</span> +<br>                        <span class="hljs-string">&quot;Try to increase &#x27;subscriptionsPerConnection&#x27; and/or &#x27;subscriptionConnectionPoolSize&#x27; parameters.&quot;</span>))) &#123;<br>            subscribeFuture.whenComplete((res, ex) -&gt; &#123;<br>                <span class="hljs-keyword">if</span> (ex == <span class="hljs-literal">null</span>) &#123;<br>                    unsubscribe(res, threadId);<br>                &#125;<br>            &#125;);<br>        &#125;<br>        acquireFailed(waitTime, unit, threadId);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125; <span class="hljs-keyword">catch</span> (ExecutionException e) &#123;<br>        acquireFailed(waitTime, unit, threadId);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>  <br>    <span class="hljs-comment">//走到这一步说明还存在剩余时间并获取到了锁释放信息</span><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">//更新剩余时间</span><br>        time -= System.currentTimeMillis() - current;<br>        <span class="hljs-keyword">if</span> (time &lt;= <span class="hljs-number">0</span>) &#123;<br>            acquireFailed(waitTime, unit, threadId);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br> <br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>            <span class="hljs-type">long</span> <span class="hljs-variable">currentTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>            <span class="hljs-comment">//再次尝试获取锁，如果失败获取到ttl存活时间</span><br>            ttl = tryAcquire(waitTime, leaseTime, unit, threadId);<br>            <span class="hljs-comment">// lock acquired</span><br>            <span class="hljs-keyword">if</span> (ttl == <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;<br>            <span class="hljs-comment">//执行到这说明又没有获取到锁，更新剩余时间</span><br>            time -= System.currentTimeMillis() - currentTime;<br>            <span class="hljs-keyword">if</span> (time &lt;= <span class="hljs-number">0</span>) &#123;<br>                acquireFailed(waitTime, unit, threadId);<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            &#125;<br> <br>            <span class="hljs-comment">// waiting for message</span><br>            currentTime = System.currentTimeMillis();<br>            <span class="hljs-keyword">if</span> (ttl &gt;= <span class="hljs-number">0</span> &amp;&amp; ttl &lt; time) &#123;<br>                <span class="hljs-comment">//如果锁剩余时间小于当前线程剩余等待时间，再次获取锁，最大等待时间为锁的释放时间</span><br>                commandExecutor.getNow(subscribeFuture).getLatch().tryAcquire(ttl, TimeUnit.MILLISECONDS);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">//如果锁的剩余时间大于当前线程剩余等待时间，再次获取锁，最大等待时间为当前线程的剩余时间</span><br>                commandExecutor.getNow(subscribeFuture).getLatch().tryAcquire(time, TimeUnit.MILLISECONDS);<br>            &#125;<br>            <span class="hljs-comment">//如果还没有获取到锁，while循环执行上述代码</span><br>            time -= System.currentTimeMillis() - currentTime;<br>            <span class="hljs-keyword">if</span> (time &lt;= <span class="hljs-number">0</span>) &#123;<br>                acquireFailed(waitTime, unit, threadId);<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            &#125;<br>        &#125;<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>        unsubscribe(commandExecutor.getNow(subscribeFuture), threadId);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="1-8-6-2-看门狗机制（刷新有效期）"><a href="#1-8-6-2-看门狗机制（刷新有效期）" class="headerlink" title="1.8.6.2 看门狗机制（刷新有效期）"></a>1.8.6.2 看门狗机制（刷新有效期）</h4><h5 id="1-8-6-2-1-获取锁"><a href="#1-8-6-2-1-获取锁" class="headerlink" title="1.8.6.2.1 获取锁"></a>1.8.6.2.1 获取锁</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> &lt;T&gt; RFuture&lt;Long&gt; <span class="hljs-title function_">tryAcquireAsync</span><span class="hljs-params">(<span class="hljs-type">long</span> waitTime, <span class="hljs-type">long</span> leaseTime, TimeUnit unit, <span class="hljs-type">long</span> threadId)</span> &#123;<br>    <span class="hljs-comment">//返回的值赋值给该变量，该变量是一个Future，因为是异步执行lua脚本，因此无法立刻拿到返回值</span><br>    RFuture&lt;Long&gt; ttlRemainingFuture;<br>    <span class="hljs-keyword">if</span> (leaseTime &gt; <span class="hljs-number">0</span>) &#123;<br>        ttlRemainingFuture = tryLockInnerAsync(waitTime, leaseTime, unit, threadId, RedisCommands.EVAL_LONG);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        ttlRemainingFuture = tryLockInnerAsync(waitTime, internalLockLeaseTime,<br>                TimeUnit.MILLISECONDS, threadId, RedisCommands.EVAL_LONG);<br>    &#125;<br>  <br>  <span class="hljs-comment">// 刷新有效期</span><br>    <span class="hljs-comment">//回调函数，当拿到返回值ttlRemaining</span><br>    CompletionStage&lt;Long&gt; f = ttlRemainingFuture.thenApply(ttlRemaining -&gt; &#123;<br>        <span class="hljs-comment">// lock acquired</span><br>        <span class="hljs-comment">//说明获取锁成功</span><br>        <span class="hljs-keyword">if</span> (ttlRemaining == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">//如果我们配置了锁的过期时间，那么将其转化为毫秒后覆盖掉默认的锁释放时间（同时也会取消看门狗机制）</span><br>            <span class="hljs-keyword">if</span> (leaseTime &gt; <span class="hljs-number">0</span>) &#123;<br>                internalLockLeaseTime = unit.toMillis(leaseTime);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">//如果没有指定锁的过期施放时间，那么定时将锁的有效时间进行更新</span><br>                scheduleExpirationRenewal(threadId);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> ttlRemaining;<br>    &#125;);<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CompletableFutureWrapper</span>&lt;&gt;(f);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">scheduleExpirationRenewal</span><span class="hljs-params">(<span class="hljs-type">long</span> threadId)</span> &#123;<br><span class="hljs-comment">//该对象主要存储了两个属性，线程标识，Timeout对象（一个定时任务），我们可以理解为一个锁对象</span><br>    <span class="hljs-type">ExpirationEntry</span> <span class="hljs-variable">entry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExpirationEntry</span>();<br><span class="hljs-comment">//MAP对象存储的是不同业务中的不同锁对象。getEntryName()实际上获取到的是getLock(name)方法中的name</span><br><span class="hljs-comment">//如果第一次获取，返回值为null，如果map中已经存在该业务类型的锁那么返回的是entry对象</span><br>    <span class="hljs-type">ExpirationEntry</span> <span class="hljs-variable">oldEntry</span> <span class="hljs-operator">=</span> EXPIRATION_RENEWAL_MAP.putIfAbsent(getEntryName(), entry);<br>    <span class="hljs-keyword">if</span> (oldEntry != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">//说明map中以及存在该业务类型的锁了，更新该业务锁的线程标识id</span><br>        oldEntry.addThreadId(threadId);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">//第一次向map中存放该业务类型的锁，更新该业务锁的线程标识id</span><br>        entry.addThreadId(threadId);<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//续约方法</span><br>            renewExpiration();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">if</span> (Thread.currentThread().isInterrupted()) &#123;<br>                cancelExpirationRenewal(threadId);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">renewExpiration</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">//获取业务锁对象</span><br>    <span class="hljs-type">ExpirationEntry</span> <span class="hljs-variable">ee</span> <span class="hljs-operator">=</span> EXPIRATION_RENEWAL_MAP.get(getEntryName());<br>    <span class="hljs-keyword">if</span> (ee == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-comment">//这里有三个参数，第一个是定时任务需要执行的逻辑代码，第二个是延时执行时间，第三个延时执行时间单位</span><br>    <span class="hljs-comment">//延时执行时间是锁的过期释放时间的三分之一</span><br>    <span class="hljs-type">Timeout</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> commandExecutor.getConnectionManager().newTimeout(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TimerTask</span>() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">(Timeout timeout)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>            <span class="hljs-comment">//获取锁对象</span><br>            <span class="hljs-type">ExpirationEntry</span> <span class="hljs-variable">ent</span> <span class="hljs-operator">=</span> EXPIRATION_RENEWAL_MAP.get(getEntryName());<br>            <span class="hljs-keyword">if</span> (ent == <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>            <span class="hljs-comment">//获取锁对象中的线程标识</span><br>            <span class="hljs-type">Long</span> <span class="hljs-variable">threadId</span> <span class="hljs-operator">=</span> ent.getFirstThreadId();<br>            <span class="hljs-keyword">if</span> (threadId == <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>            <span class="hljs-comment">//刷新锁的有效时间</span><br>            CompletionStage&lt;Boolean&gt; future = renewExpirationAsync(threadId);<br>            <span class="hljs-comment">//刷新锁的有效时间结束后，调用下面方法</span><br>            future.whenComplete((res, e) -&gt; &#123;<br>                <span class="hljs-comment">//如果刷新锁的有效时间抛出异常，抛出日志并将锁对象从map中移除</span><br>                <span class="hljs-keyword">if</span> (e != <span class="hljs-literal">null</span>) &#123;<br>                    log.error(<span class="hljs-string">&quot;Can&#x27;t update lock &#123;&#125; expiration&quot;</span>, getRawName(), e);<br>                    EXPIRATION_RENEWAL_MAP.remove(getEntryName());<br>                    <span class="hljs-keyword">return</span>;<br>                &#125;<br>                <span class="hljs-comment">//如果刷新成功</span><br>                <span class="hljs-keyword">if</span> (res) &#123;<br>                    <span class="hljs-comment">// 递归调用本方法</span><br>                    renewExpiration();<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-comment">//如果返回值为null，那么就取消定时任务</span><br>                    cancelExpirationRenewal(<span class="hljs-literal">null</span>);<br>                &#125;<br>            &#125;);<br>        &#125;<br>    &#125;, internalLockLeaseTime / <span class="hljs-number">3</span>, TimeUnit.MILLISECONDS);<br>    <br>    ee.setTimeout(task);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> CompletionStage&lt;Boolean&gt; <span class="hljs-title function_">renewExpirationAsync</span><span class="hljs-params">(<span class="hljs-type">long</span> threadId)</span> &#123;<br>    <span class="hljs-keyword">return</span> evalWriteAsync(getRawName(), LongCodec.INSTANCE, RedisCommands.EVAL_BOOLEAN,<br>            <span class="hljs-string">&quot;if (redis.call(&#x27;hexists&#x27;, KEYS[1], ARGV[2]) == 1) then &quot;</span> +<br>                    <span class="hljs-string">&quot;redis.call(&#x27;pexpire&#x27;, KEYS[1], ARGV[1]); &quot;</span> +<br>                    <span class="hljs-string">&quot;return 1; &quot;</span> +<br>                    <span class="hljs-string">&quot;end; &quot;</span> +<br>                    <span class="hljs-string">&quot;return 0;&quot;</span>,<br>            Collections.singletonList(getRawName()),<br>            internalLockLeaseTime, getLockName(threadId));<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="1-8-6-2-2-释放锁"><a href="#1-8-6-2-2-释放锁" class="headerlink" title="1.8.6.2.2 释放锁"></a>1.8.6.2.2 释放锁</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> RFuture&lt;Void&gt; <span class="hljs-title function_">unlockAsync</span><span class="hljs-params">(<span class="hljs-type">long</span> threadId)</span> &#123;<br>    RFuture&lt;Boolean&gt; future = unlockInnerAsync(threadId);<br><span class="hljs-comment">//当取消锁成功时，执行该回调方法</span><br>    CompletionStage&lt;Void&gt; f = future.handle((opStatus, e) -&gt; &#123;<br>        <span class="hljs-comment">//取消续约定时任务</span><br>        cancelExpirationRenewal(threadId);<br> <br>        <span class="hljs-keyword">if</span> (e != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CompletionException</span>(e);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (opStatus == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">IllegalMonitorStateException</span> <span class="hljs-variable">cause</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalMonitorStateException</span>(<span class="hljs-string">&quot;attempt to unlock lock, not locked by current thread by node id: &quot;</span><br>                    + id + <span class="hljs-string">&quot; thread-id: &quot;</span> + threadId);<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CompletionException</span>(cause);<br>        &#125;<br> <br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;);<br> <br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CompletableFutureWrapper</span>&lt;&gt;(f);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cancelExpirationRenewal</span><span class="hljs-params">(Long threadId)</span> &#123;<br><span class="hljs-comment">//根据key获取到锁对象</span><br>    <span class="hljs-type">ExpirationEntry</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> EXPIRATION_RENEWAL_MAP.get(getEntryName());<br><span class="hljs-comment">//如果不存在锁，那么直接返回</span><br>    <span class="hljs-keyword">if</span> (task == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <br>    <span class="hljs-keyword">if</span> (threadId != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">//移除锁对象中的线程标识</span><br>        task.removeThreadId(threadId);<br>    &#125;<br> <br>    <span class="hljs-keyword">if</span> (threadId == <span class="hljs-literal">null</span> || task.hasNoThreads()) &#123;<br>        <span class="hljs-type">Timeout</span> <span class="hljs-variable">timeout</span> <span class="hljs-operator">=</span> task.getTimeout();<br>        <span class="hljs-keyword">if</span> (timeout != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">//如果锁对象中的定时任务不为空，那么就取消</span><br>            timeout.cancel();<br>        &#125;<br>        <span class="hljs-comment">//移除map中的锁对象</span><br>        EXPIRATION_RENEWAL_MAP.remove(getEntryName());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="1-8-7-Redission的multiLock问题"><a href="#1-8-7-Redission的multiLock问题" class="headerlink" title="1.8.7 Redission的multiLock问题"></a>1.8.7 Redission的multiLock问题</h3><h4 id="1-8-7-1-背景"><a href="#1-8-7-1-背景" class="headerlink" title="1.8.7.1 背景"></a>1.8.7.1 背景</h4><p>Redisson分布式锁主从一致性问题<br>为了提高redis的可用性，我们会搭建集群或者主从，现在以主从为例<br>此时我们去写命令，写在主机上， 主机会将数据同步给从机，但是假设在主机还没有来得及把数据写入到从机去的时候，此时主机宕机，哨兵会发现主机宕机，并且选举一个slave变成master，而此时新的master中实际上并没有锁信息，此时锁信息就已经丢掉了。</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/52f67dbfbe044fb899ca21af38ea1d9d.png" alt="在这里插入图片描述"></p><h4 id="1-8-7-2-解决"><a href="#1-8-7-2-解决" class="headerlink" title="1.8.7.2 解决"></a>1.8.7.2 解决</h4><p>redission提出来了MutiLock锁，使用这把锁咱们就不使用主从了，每个节点的地位都是一样的， 这把锁加锁的逻辑需要写入到每一个主丛节点上，只有所有的服务器都写入成功，此时才是加锁成功，假设现在某个节点挂了，那么他去获得锁的时候，只要有一个节点拿不到，都不能算是加锁成功，就保证了加锁的可靠性。</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/a6cc34e028ac4edf93d14e55119051ef.png" alt="在这里插入图片描述"></p><h4 id="1-8-7-3-使用示例"><a href="#1-8-7-3-使用示例" class="headerlink" title="1.8.7.3 使用示例"></a>1.8.7.3 使用示例</h4><p>修改配置</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedissonConfig</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> RedissonClient <span class="hljs-title function_">redissonClient</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 配置类</span><br>        <span class="hljs-type">Config</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Config</span>();<br>        <span class="hljs-comment">// 添加redis地址，这里添加了单点的地址，也可以使用config.useClusterServers()添加集群地址</span><br>        config.useSingleServer().setAddress(<span class="hljs-string">&quot;redis://192.168.183.145:6379&quot;</span>)<br>                .setPassword(<span class="hljs-string">&quot;112453&quot;</span>);<br>        <span class="hljs-comment">// 创建RedissonClient对象</span><br>        <span class="hljs-keyword">return</span> Redisson.create(config);<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> RedissonClient <span class="hljs-title function_">redissonClient2</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 配置类</span><br>        <span class="hljs-type">Config</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Config</span>();<br>        <span class="hljs-comment">// 添加redis地址，这里添加了单点的地址，也可以使用config.useClusterServers()添加集群地址</span><br>        config.useSingleServer().setAddress(<span class="hljs-string">&quot;redis://192.168.193.175:6380&quot;</span>)<br>                .setPassword(<span class="hljs-string">&quot;557724&quot;</span>);<br>        <span class="hljs-comment">// 创建RedissonClient对象</span><br>        <span class="hljs-keyword">return</span> Redisson.create(config);<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> RedissonClient <span class="hljs-title function_">redissonClient3</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 配置类</span><br>        <span class="hljs-type">Config</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Config</span>();<br>        <span class="hljs-comment">// 添加redis地址，这里添加了单点的地址，也可以使用config.useClusterServers()添加集群地址</span><br>        config.useSingleServer().setAddress(<span class="hljs-string">&quot;redis://192.168.177.145:6381&quot;</span>)<br>                .setPassword(<span class="hljs-string">&quot;5896&quot;</span>);<br>        <span class="hljs-comment">// 创建RedissonClient对象</span><br>        <span class="hljs-keyword">return</span> Redisson.create(config);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedissonTest</span> &#123;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> RedissonClient redissonClient;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> RedissonClient redissonClient2;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> RedissonClient redissonClient3;<br><br>    RLock lock;<br><br>    <span class="hljs-meta">@BeforeEach</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUp</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">RLock</span> <span class="hljs-variable">lock1</span> <span class="hljs-operator">=</span> redissonClient.getLock(<span class="hljs-string">&quot;lock&quot;</span>);<br>        <span class="hljs-type">RLock</span> <span class="hljs-variable">lock2</span> <span class="hljs-operator">=</span> redissonClient.getLock(<span class="hljs-string">&quot;lock&quot;</span>);<br>        <span class="hljs-type">RLock</span> <span class="hljs-variable">lock3</span> <span class="hljs-operator">=</span> redissonClient.getLock(<span class="hljs-string">&quot;lock&quot;</span>);<br><br>        <span class="hljs-comment">// 创建连锁</span><br>        lock = redissonClient.getMultiLock(lock1, lock2, lock3);<br>    &#125;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">method1</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">isLock</span> <span class="hljs-operator">=</span> lock.tryLock();<br>        <span class="hljs-keyword">if</span> (!isLock) &#123;<br>            log.error(<span class="hljs-string">&quot;获取锁失败1&quot;</span>);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-keyword">try</span> &#123;<br>            log.info(<span class="hljs-string">&quot;获取锁成功,1&quot;</span>);<br>            method2();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            log.info(<span class="hljs-string">&quot;释放锁,1&quot;</span>);<br>            lock.unlock();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">method2</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">isLock</span> <span class="hljs-operator">=</span> lock.tryLock();<br>        <span class="hljs-keyword">if</span> (!isLock) &#123;<br>            log.error(<span class="hljs-string">&quot;获取锁失败2&quot;</span>);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-keyword">try</span> &#123;<br>            log.info(<span class="hljs-string">&quot;获取锁成功,2&quot;</span>);<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            log.info(<span class="hljs-string">&quot;释放锁,2&quot;</span>);<br>            lock.unlock();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="1-8-7-4-源码"><a href="#1-8-7-4-源码" class="headerlink" title="1.8.7.4 源码"></a>1.8.7.4 源码</h4><p>getMultiLock()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 这里相对简单，就是创建了一个RLock集合，为了后续分别去获取锁</span><br><span class="hljs-keyword">final</span> List&lt;RLock&gt; locks = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> RLock <span class="hljs-title function_">getMultiLock</span><span class="hljs-params">(RLock... locks)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedissonMultiLock</span>(locks);<br>&#125;<br><span class="hljs-keyword">public</span> <span class="hljs-title function_">RedissonMultiLock</span><span class="hljs-params">(RLock... locks)</span> &#123;<br>    <span class="hljs-keyword">if</span> (locks.length == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;Lock objects are not defined&quot;</span>);<br>    &#125;<br>    <span class="hljs-built_in">this</span>.locks.addAll(Arrays.asList(locks));<br>&#125;<br></code></pre></td></tr></table></figure><p>加锁：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 假设传入的waitTime=2s leaseTime=2s</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">(<span class="hljs-type">long</span> waitTime, <span class="hljs-type">long</span> leaseTime, TimeUnit unit)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br><span class="hljs-comment">// 定义了一个新的释放时间newLeaseTime=-1</span><br>        <span class="hljs-type">long</span> <span class="hljs-variable">newLeaseTime</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;<br>    <span class="hljs-comment">// 如果传入了时间的tryLock，leaseTime就不等于-1，不传默认值为-1</span><br>        <span class="hljs-keyword">if</span> (leaseTime != -<span class="hljs-number">1</span>) &#123;<br>            <span class="hljs-comment">// 将新的锁释放时间设置为waitTime的2倍，重试耗时时间较久，预防重试没完就释放了</span><br>            newLeaseTime = unit.toMillis(waitTime)*<span class="hljs-number">2</span>;<br>        &#125;<br>        <span class="hljs-comment">// 获取当前时间（毫秒）</span><br>        <span class="hljs-type">long</span> <span class="hljs-variable">time</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>    <span class="hljs-comment">// remain==保持，先翻译为保持时间，定义为-1</span><br>        <span class="hljs-type">long</span> <span class="hljs-variable">remainTime</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">if</span> (waitTime != -<span class="hljs-number">1</span>) &#123;<br>            <span class="hljs-comment">// 保持时间设置为waitTime，2000ms</span><br>            remainTime = unit.toMillis(waitTime);<br>        &#125;<br>    <span class="hljs-comment">// calcLockWaitTime(remainTime);--&gt;return Math.max(remainTime / locks.size(), 1);</span><br>    <span class="hljs-comment">// 300ms=lockWaitTime</span><br>        <span class="hljs-type">long</span> <span class="hljs-variable">lockWaitTime</span> <span class="hljs-operator">=</span> calcLockWaitTime(remainTime);<br>        <span class="hljs-comment">// failedLocksLimit -&gt; 0</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">failedLocksLimit</span> <span class="hljs-operator">=</span> failedLocksLimit();<br>        List&lt;RLock&gt; acquiredLocks = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(locks.size());<br>    <span class="hljs-comment">// 循环获取锁</span><br>        <span class="hljs-keyword">for</span> (ListIterator&lt;RLock&gt; iterator = locks.listIterator(); iterator.hasNext();) &#123;<br>            <span class="hljs-comment">// 获取到的redisson实例生成的锁</span><br>            <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> iterator.next();<br>            <span class="hljs-comment">// 锁获取标识</span><br>            <span class="hljs-type">boolean</span> lockAcquired;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">if</span> (waitTime == -<span class="hljs-number">1</span> &amp;&amp; leaseTime == -<span class="hljs-number">1</span>) &#123;<br>                    lockAcquired = lock.tryLock();<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-type">long</span> <span class="hljs-variable">awaitTime</span> <span class="hljs-operator">=</span> Math.min(lockWaitTime, remainTime);<br>                    <span class="hljs-comment">// 直接去获取锁，返回true or false</span><br>                    lockAcquired = lock.tryLock(awaitTime, newLeaseTime, TimeUnit.MILLISECONDS);<br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span> (RedisResponseTimeoutException e) &#123;<br>                <span class="hljs-comment">// 如果发生了RedisResponseTimeoutException，会先解锁。因为这个时候不确定是否加锁成功了，所以解锁设置标识为失败。</span><br>                unlockInner(Arrays.asList(lock));<br>                lockAcquired = <span class="hljs-literal">false</span>;<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                <span class="hljs-comment">// 其他异常设置标识为false</span><br>                lockAcquired = <span class="hljs-literal">false</span>;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (lockAcquired) &#123;<br>                <span class="hljs-comment">// 如果加锁成功 放入集合中</span><br>                acquiredLocks.add(lock);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">// 获取锁数量等于锁总数量</span><br>                <span class="hljs-keyword">if</span> (locks.size() - acquiredLocks.size() == failedLocksLimit()) &#123;<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>              <br>                <span class="hljs-keyword">if</span> (failedLocksLimit == <span class="hljs-number">0</span>) &#123;<br>                    <span class="hljs-comment">// 会把获取到锁的一次性解锁</span><br>                    unlockInner(acquiredLocks);<br>                    <span class="hljs-keyword">if</span> (waitTime == -<span class="hljs-number">1</span> &amp;&amp; leaseTime == -<span class="hljs-number">1</span>) &#123;<br>                        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>                    &#125;<br>                    <span class="hljs-comment">// 重置failedLocksLimit=0</span><br>                    failedLocksLimit = failedLocksLimit();<br>                    <span class="hljs-comment">// 清空获取到锁的集合</span><br>                    acquiredLocks.clear();<br>                    <span class="hljs-comment">// 重置迭代器的指针</span><br>                    <span class="hljs-keyword">while</span> (iterator.hasPrevious()) &#123;<br>                        iterator.previous();<br>                    &#125;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-comment">// RedissonRedLock才会进入这个逻辑</span><br>                    failedLocksLimit--;<br>                &#125;<br>            &#125;<br><span class="hljs-comment">// 如果remainTime不为-1</span><br>            <span class="hljs-comment">// remainTime=2000ms</span><br>            <span class="hljs-keyword">if</span> (remainTime != -<span class="hljs-number">1</span>) &#123;<br>                <span class="hljs-comment">// 查看remainTime的剩余时间</span><br>                remainTime -= System.currentTimeMillis() - time;<br>                <span class="hljs-comment">// 重置time</span><br>                time = System.currentTimeMillis();<br>                <span class="hljs-comment">// 如果保持时间也就是之前的waitTime小于0，也就是说超过了尝试获取锁时最长的等待时间，释放所有已获得的锁，并返回false，加锁失败</span><br>                <span class="hljs-keyword">if</span> (remainTime &lt;= <span class="hljs-number">0</span>) &#123;<br>                    unlockInner(acquiredLocks);<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>                &#125;<br>            &#125;<br>        &#125;<br>  <br><span class="hljs-comment">// 如果自己手动传入了锁释放时间，释放时间为-1的时候触发看门狗机制</span><br>        <span class="hljs-keyword">if</span> (leaseTime != -<span class="hljs-number">1</span>) &#123;<br>            <span class="hljs-comment">// 创建了一个RFuture集合</span><br>            List&lt;RFuture&lt;Boolean&gt;&gt; futures = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(acquiredLocks.size());<br>           <span class="hljs-comment">// 由于每个锁获取到手的时间不同，等所有锁都拿到手之后，重新给所有锁重新设置有效期</span><br>            <span class="hljs-keyword">for</span> (RLock rLock : acquiredLocks) &#123;<br>                <span class="hljs-comment">//为每个锁设置过期时间，是一个异步的操作</span><br>                RFuture&lt;Boolean&gt; future = ((RedissonLock) rLock).expireAsync(unit.toMillis(leaseTime), TimeUnit.MILLISECONDS);<br>                futures.add(future);<br>            &#125;<br>            <br>            <span class="hljs-keyword">for</span> (RFuture&lt;Boolean&gt; rFuture : futures) &#123;<br>                <span class="hljs-comment">// 阻塞当前线程，同步等待每个异步操作的结果</span><br>                rFuture.syncUninterruptibly();<br>            &#125;<br>        &#125;<br>        <br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>redis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>redis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>reids-优惠券秒杀</title>
    <link href="/reids-%E4%BC%98%E6%83%A0%E5%88%B8%E7%A7%92%E6%9D%80/92ed990d85c4/"/>
    <url>/reids-%E4%BC%98%E6%83%A0%E5%88%B8%E7%A7%92%E6%9D%80/92ed990d85c4/</url>
    
    <content type="html"><![CDATA[<h1 id="0-目录"><a href="#0-目录" class="headerlink" title="0 目录"></a>0 目录</h1><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/image-20240225111852122.png" alt="image-20240225111852122"></p><h1 id="1-全局ID生成器"><a href="#1-全局ID生成器" class="headerlink" title="1 全局ID生成器"></a>1 全局ID生成器</h1><h2 id="1-1-背景"><a href="#1-1-背景" class="headerlink" title="1.1 背景"></a>1.1 背景</h2><p>使用数据库自增ID会存在两个问题：</p><ul><li>id的规律性太明显（如果我们的id具有太明显的规则，用户或者说商业对手很容易猜测出来我们的一些敏感信息，比如商城在一天时间内，卖出了多少单，这明显不合适）</li><li>受单表数据量的限制（随着我们商城规模越来越大，mysql的单表的容量不宜超过500W，数据量过大之后，我们要进行拆库拆表，但拆分表了之后，他们从逻辑上讲他们是同一张表，所以他们的id是不能一样的， 于是乎我们需要保证id的唯一性。）</li></ul><p>因此就需要就一个<strong>全局ID生成器</strong>，是一种在分布式系统下用来生成全局唯一ID的工具，一般要满足下列特性：</p><ul><li>唯一性：想到了关键字incrby</li><li>高可用：集群方案、主从方案、哨兵方案</li><li>高性能：内存存储性能好</li><li>递增：采用递增</li><li>安全性：自增然后再拼接一些其它信息，让规律不要那么明显</li></ul><h2 id="1-2-组成"><a href="#1-2-组成" class="headerlink" title="1.2 组成"></a>1.2 组成</h2><p>数据库的id选择数值类型（占用空间更小），对应Java的Long（8字节，64比特位）</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/d3650cb15c06465fb160f86d7d0d7f17.png" alt="在这里插入图片描述"></p><ul><li>符号位：1bit，永远为0</li><li>时间戳：31bit，以秒为单位，可以使用69年</li><li>序列号：32bit，秒内的计数器，支持每秒产生232个不同ID</li></ul><h2 id="1-3-代码"><a href="#1-3-代码" class="headerlink" title="1.3 代码"></a>1.3 代码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisWorker</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 把距离当前时间的偏移量作为时间戳</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">BEGIN_TIMESTAMP</span> <span class="hljs-operator">=</span> 计算出当前的时间戳;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 序列号的长度(位数)</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">COUNT_BITS</span> <span class="hljs-operator">=</span> <span class="hljs-number">32</span>;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> StringRedisTemplate stringRedisTemplate;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">nextID</span><span class="hljs-params">(String keyPrefix)</span> &#123;<br>        <span class="hljs-comment">// 1.生成时间戳</span><br>        <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> LocalDateTime.now();<br>        <span class="hljs-type">long</span> <span class="hljs-variable">nowSecond</span> <span class="hljs-operator">=</span> now.toEpochSecond(ZoneOffset.UTC);<br>        <span class="hljs-type">long</span> <span class="hljs-variable">timestamp</span> <span class="hljs-operator">=</span> nowSecond - BEGIN_TIMESTAMP;<br><br>        <span class="hljs-comment">// 2.生成序列号</span><br>        <span class="hljs-comment">// 2.1 获取当前日期，精确到天,保证一天生成一个key</span><br>        <span class="hljs-comment">// 2.2 自增长</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">date</span> <span class="hljs-operator">=</span> now.format(DateTimeFormatter.ofPattern(<span class="hljs-string">&quot;yyyyMMdd&quot;</span>));<br>        <span class="hljs-type">Long</span> <span class="hljs-variable">sequence</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().increment(<span class="hljs-string">&quot;icr:&quot;</span> + keyPrefix + <span class="hljs-string">&quot;:&quot;</span> + date);<br><br>        <span class="hljs-comment">//3.拼接返回</span><br>        <span class="hljs-type">long</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> (timestamp &lt;&lt; COUNT_BITS) | sequence;<br>        <span class="hljs-keyword">return</span> id;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="1-4-多线程测试"><a href="#1-4-多线程测试" class="headerlink" title="1.4 多线程测试"></a>1.4 多线程测试</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>    <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">pools</span> <span class="hljs-operator">=</span> CacheClient.newFixedThreadPool(<span class="hljs-number">500</span>);<br>    <span class="hljs-comment">// 程序计数器 设置的数量和循环数量一致</span><br>    <span class="hljs-type">CountDownLatch</span> <span class="hljs-variable">latch</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(<span class="hljs-number">300</span>);<br><br>    <span class="hljs-type">Runnable</span> <span class="hljs-variable">runnable</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) &#123;<br>                <span class="hljs-type">long</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> redisWorker.nextID(<span class="hljs-string">&quot;order&quot;</span>);<br>                System.out.println(<span class="hljs-string">&quot;id:&quot;</span> + id);<br>            &#125;<br>            <span class="hljs-comment">// 每一个线程跑完，就剪掉一次计数(倒计时)</span><br>            latch.countDown();<br>        &#125;<br>    &#125;;<br>  <br>    runnable.run();<br>  <br>    <span class="hljs-type">long</span> <span class="hljs-variable">begin</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">300</span>; i++) &#123;<br>        pools.submit(runnable);<br>    &#125;<br>    latch.await(); <span class="hljs-comment">//等待所有的执行完毕</span><br>  <br>    <span class="hljs-type">long</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>    System.out.println(<span class="hljs-string">&quot;总时间是:&quot;</span> + (end - begin));<br>&#125;<br><br></code></pre></td></tr></table></figure><h1 id="2-优惠券秒杀下单"><a href="#2-优惠券秒杀下单" class="headerlink" title="2 优惠券秒杀下单"></a>2 优惠券秒杀下单</h1><h2 id="2-1-接口"><a href="#2-1-接口" class="headerlink" title="2.1 接口"></a>2.1 接口</h2><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/02af1e94c857425d831a773723f43e39.png" alt="在这里插入图片描述"></p><blockquote><p>考虑的点：</p><ol><li>秒杀是否开始或结束，如果尚未开始或已经结束则无法下单</li><li>库存是否充足，不足则无法下单</li></ol></blockquote><h2 id="2-2-分析及代码实现"><a href="#2-2-分析及代码实现" class="headerlink" title="2.2 分析及代码实现"></a>2.2 分析及代码实现</h2><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/82ccfe860b3b4c64b2e50f4fbe35dbeb.png" alt="在这里插入图片描述"></p><p>controller</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/voucher-order&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VoucherOrderController</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> VoucherOrderServiceImpl voucherOrderService;<br><br>    <span class="hljs-meta">@PostMapping(&quot;seckill/&#123;id&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">seckillVoucher</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long voucherId)</span> &#123;<br>        <span class="hljs-keyword">return</span> voucherOrderService.seckillVoucher(voucherId);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VoucherOrderServiceImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ServiceImpl</span>&lt;VoucherOrderMapper, VoucherOrder&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IVoucherOrderService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ISeckillVoucherService iSeckillVoucherService;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisWorker redisWorker;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-meta">@Transactional</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">seckillVoucher</span><span class="hljs-params">(Long voucherId)</span> &#123;<br>        <span class="hljs-comment">// 1.查询秒杀优惠券信息</span><br>        <span class="hljs-comment">// select * from tb_seckill_voucher where voucher_id = ?</span><br>        <span class="hljs-type">SeckillVoucher</span> <span class="hljs-variable">seckillVoucher</span> <span class="hljs-operator">=</span> iSeckillVoucherService.getById(voucherId);<br><br>        <span class="hljs-comment">// 2.判断秒杀是否开始</span><br>        <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">beginTime</span> <span class="hljs-operator">=</span> seckillVoucher.getBeginTime();<br>        <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">endTime</span> <span class="hljs-operator">=</span> seckillVoucher.getEndTime();<br>        <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> LocalDateTime.now();<br><br>        <span class="hljs-keyword">if</span> (now.isBefore(beginTime)) &#123;<br>            <span class="hljs-comment">// 当前时间早于秒杀开始时间，说明秒杀没有开始</span><br>            <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;秒杀尚未开始,请耐心等待！秒杀开始时间:&quot;</span> + beginTime.format(DateTimeFormatter.ofPattern(<span class="hljs-string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>)));<br>        &#125;<br>        <span class="hljs-comment">// 3.判断秒杀是否已经结束</span><br>        <span class="hljs-keyword">if</span> (now.isAfter(endTime)) &#123;<br>            <span class="hljs-comment">// 当前时间晚于秒杀结束时间，说明秒杀结束了</span><br>            <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;秒杀已经结束,感谢支持!&quot;</span>);<br>        &#125;<br><br><br>        <span class="hljs-comment">// 4.判断库存是否充足</span><br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">stock</span> <span class="hljs-operator">=</span> seckillVoucher.getStock();<br>        <span class="hljs-keyword">if</span> (stock &lt;= <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;商品已经售罄!&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">// 5.扣减库存</span><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> iSeckillVoucherService.update()<br>                .setSql(<span class="hljs-string">&quot;stock = stock -1&quot;</span>)<br>                .eq(<span class="hljs-string">&quot;voucher_id&quot;</span>, voucherId).update();<br><br>        <span class="hljs-keyword">if</span> (!result) &#123;<br>            <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;商品已经售罄!&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">// 6.创建订单</span><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 获取订单id</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-type">long</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> redisWorker.nextID(<span class="hljs-string">&quot;order&quot;</span>);<br><br>        <span class="hljs-type">VoucherOrder</span> <span class="hljs-variable">voucherOrder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">VoucherOrder</span>();<br>        voucherOrder.setId(orderId);<br>        voucherOrder.setVoucherId(voucherId);<br>        voucherOrder.setUserId(UserHolder.getUser().getId());<br><br>        <span class="hljs-comment">// 将订单信息保存到数据库</span><br>        <span class="hljs-comment">// insert into tb_voucher_order values ()</span><br>        save(voucherOrder);<br><br>        <span class="hljs-comment">// 7.返回订单id</span><br>        <span class="hljs-keyword">return</span> Result.ok(orderId);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="3-超卖问题"><a href="#3-超卖问题" class="headerlink" title="3 超卖问题"></a>3 超卖问题</h1><h2 id="3-1-背景"><a href="#3-1-背景" class="headerlink" title="3.1 背景"></a>3.1 背景</h2><p>如果只有同一时间只有一个用户下单没有任何的问题，但是此时如果统一时间有多个用户下单，QPS较高的情况此时就会出现并发的问题</p><h2 id="3-2-超卖模拟"><a href="#3-2-超卖模拟" class="headerlink" title="3.2 超卖模拟"></a>3.2 超卖模拟</h2><p>将库存恢复（tb_seckill_voucher），清空订单数据（tb_voucher_order），使用Jemeter</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/35415018536b4fa395eab6b764c0d44a.png" alt="在这里插入图片描述"></p><ul><li>post请求设置</li></ul><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/de596be2297d4bb7819d001e08a1101d.png" alt="在这里插入图片描述"></p><ul><li>配置头</li></ul><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/be0fcbaf17fc449eac9499cefd72c359.png" alt="在这里插入图片描述"></p><ul><li>设置断言</li></ul><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/084556d444fe45e5b8e8189779f03bed-20240225124652133.png"></p><ul><li>启动</li></ul><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/a5644e9f12f846519f1e63f55b856156.png" alt="在这里插入图片描述"></p><ul><li>结果</li></ul><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/c7e8f8b8eb7449a7b83d56c878691f17.png" alt="在这里插入图片描述"></p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/76187badbe3e429a82c3d0d7b22e7dd1.png" alt="在这里插入图片描述"></p><h2 id="3-3-原因分析"><a href="#3-3-原因分析" class="headerlink" title="3.3 原因分析"></a>3.3 原因分析</h2><p>当库存还有1的时候，线程1查询库存的时候，得到库存为大于0，正准备扣减库存，此时正好线程2过来也进行查询，库存也是大于0，线程2同样准备扣减库存，当两个线程结束的时候，库存被-2了。</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/795fd813c2944d5db9e20ad25ca59130.png" alt="在这里插入图片描述"></p><h2 id="3-4-锁"><a href="#3-4-锁" class="headerlink" title="3.4 锁"></a>3.4 锁</h2><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/60f90535f95c4569b419a36f2260b5e4.png" alt="在这里插入图片描述"></p><h3 id="3-4-1-悲观锁"><a href="#3-4-1-悲观锁" class="headerlink" title="3.4.1 悲观锁"></a>3.4.1 悲观锁</h3><p>悲观锁可以实现对于数据的串行化执行，比如syn，和lock都是悲观锁的代表，同时，悲观锁中又可以再细分为公平锁，非公平锁，可重入锁，等等。</p><h3 id="3-4-2-乐观锁"><a href="#3-4-2-乐观锁" class="headerlink" title="3.4.2 乐观锁"></a>3.4.2 乐观锁</h3><p>乐观锁：增加一个版本号，每次操作数据会对版本号+1，再提交回数据时，会去校验是否比之前的版本大1 ，如果大1 ，则进行操作成功。</p><p>这套机制的核心逻辑在于，如果在操作过程中，版本号只比原来大1 ，那么就意味着操作过程中没有人对他进行过修改，他的操作就是安全的，如果不大1，则数据被修改过。</p><p>当然乐观锁还有一些变种的处理方式比如cas：compare and set</p><h2 id="3-5-解决"><a href="#3-5-解决" class="headerlink" title="3.5 解决"></a>3.5 解决</h2><h3 id="3-5-1-方案一"><a href="#3-5-1-方案一" class="headerlink" title="3.5.1 方案一"></a>3.5.1 方案一</h3><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/1ce17bb7620e4c1697112fbf340dbd5e.png" alt="在这里插入图片描述"></p><p>根据乐观锁分析，只需要比对和上次的version相同即可，如果版本相同那么证明是没有被修改过，此时扣减库存，同时version++，如果不同，那么证明已经被修改了。</p><p>但是发现库存和版本号同样也可以做到这个功能，因此无需多增加版本信息。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 5.2扣减库存(针对超卖问题用乐观锁CAS解决)</span><br><span class="hljs-comment">// update tb_seckill_voucher set stock = stock -1 where voucher_id = ? and stock = ?</span><br><span class="hljs-type">boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> iSeckillVoucherService.update()<br>        .setSql(<span class="hljs-string">&quot;stock = stock - 1&quot;</span>)<br>        .eq(<span class="hljs-string">&quot;voucher_id&quot;</span>, voucherId)<br>        .eq(<span class="hljs-string">&quot;stock&quot;</span>, stock)<br>        .update();<br><br></code></pre></td></tr></table></figure><p>即：比对库存是否相同即可。</p><p>问题：有很多失败的，售卖出去的很少，没有实现超卖</p><p>原因：这样修改只保证了同一时间查询出来的库存相同的时候，多个线程只有一个会成功，其他的都会失败。</p><h3 id="3-5-2-方案二"><a href="#3-5-2-方案二" class="headerlink" title="3.5.2 方案二"></a>3.5.2 方案二</h3><p>针对方案1的问题，只需要将库存设置为大于0即可，不需要严格的按照cas去做</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 5.3扣减库存(针对使用乐观锁CAS，没卖完解决)</span><br><span class="hljs-comment">// update tb_seckill_voucher set stock = stock -1 where voucher_id = ? and stock &gt; 0</span><br><span class="hljs-type">boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> iSeckillVoucherService.update()<br>        .setSql(<span class="hljs-string">&quot;stock = stock - 1&quot;</span>)<br>        .eq(<span class="hljs-string">&quot;voucher_id&quot;</span>, voucherId)<br>        .gt(<span class="hljs-string">&quot;stock&quot;</span>, <span class="hljs-number">0</span>)<br>        .update();<br></code></pre></td></tr></table></figure><h1 id="4-一人一单"><a href="#4-一人一单" class="headerlink" title="4 一人一单"></a>4 一人一单</h1><h2 id="4-1-背景"><a href="#4-1-背景" class="headerlink" title="4.1 背景"></a>4.1 背景</h2><p>在优惠券不超卖的情况下需要考虑一个问题：每个用户只能领取一个优惠券，不能多次重复的领取</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/d6d485a3accd4231bfc8bc1a972bce28.png" alt="在这里插入图片描述"></p><h2 id="4-2-修改"><a href="#4-2-修改" class="headerlink" title="4.2 修改"></a>4.2 修改</h2><p>增加对优惠券id和用户id进行判断</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/f32d9de8c5744798928847432ed32c33.png" alt="在这里插入图片描述"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Long</span> <span class="hljs-variable">userID</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br><span class="hljs-comment">// 5.实现1人1单加入逻辑：根据优惠券id和用户id查询订单</span><br><span class="hljs-comment">// 5.1查询订单,并不用查询出具体的值，而是查询出数量即可</span><br><span class="hljs-type">Integer</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> query().eq(<span class="hljs-string">&quot;user_id&quot;</span>, userID).eq(<span class="hljs-string">&quot;voucher_id&quot;</span>, voucherId).count();<br><span class="hljs-comment">// 5.2判断订单是否存在</span><br><span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-comment">// 5.2.1 存在就返回异常结果</span><br>    <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;秒杀优惠券每人限购1张,感谢配合,本优惠券最终解释权归ty公司所有!&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>Jemeter测试：</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/2e1d73c74891476da6e0923622412049.png" alt="在这里插入图片描述"></p><h2 id="4-3-分析"><a href="#4-3-分析" class="headerlink" title="4.3 分析"></a>4.3 分析</h2><p>此时问题出现在了查询至修改库存的地方，多线程过来之后，查询到都不存在订单，因此某几个线程还是会一起去创建订单</p><h2 id="4-4-解决"><a href="#4-4-解决" class="headerlink" title="4.4 解决"></a>4.4 解决</h2><p>使用悲观锁进行解决</p><p>对代码的分析，此时只需要对创建订单这个方法进行抽取，使用sychronized加锁</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Transactional</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> Result <span class="hljs-title function_">createVoucherOrder</span><span class="hljs-params">(Long voucherId)</span> &#123;<br>    <span class="hljs-type">Long</span> <span class="hljs-variable">userID</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br>    <span class="hljs-comment">// 5.实现1人1单加入逻辑：根据优惠券id和用户id查询订单</span><br>    <span class="hljs-comment">// 5.1查询订单,并不用查询出具体的值，而是查询出数量即可</span><br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> query().eq(<span class="hljs-string">&quot;user_id&quot;</span>, userID).eq(<span class="hljs-string">&quot;voucher_id&quot;</span>, voucherId).count();<br>    <span class="hljs-comment">// 5.2判断订单是否存在</span><br>    <span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-comment">// 5.2.1 存在就返回异常结果</span><br>        <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;秒杀优惠券每人限购1张,感谢配合,本优惠券最终解释权归ty公司所有!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// 5.2.2 不存在再减少库存</span><br><br>    <span class="hljs-comment">// 6.1扣减库存(会出现超卖问题)</span><br>    <span class="hljs-comment">// update tb_seckill_voucher set stock = stock -1 where voucher_id = ?</span><br>    <span class="hljs-comment">/*boolean result = iSeckillVoucherService.update()</span><br><span class="hljs-comment">            .setSql(&quot;stock = stock -1&quot;)</span><br><span class="hljs-comment">            .eq(&quot;voucher_id&quot;, voucherId).update();*/</span><br><br>    <span class="hljs-comment">// 6.2扣减库存(针对超卖问题用乐观锁CAS解决)</span><br>    <span class="hljs-comment">// update tb_seckill_voucher set stock = stock -1 where voucher_id = ? and stock = ?</span><br>    <span class="hljs-comment">/*boolean result = iSeckillVoucherService.update()</span><br><span class="hljs-comment">            .setSql(&quot;stock = stock - 1&quot;)</span><br><span class="hljs-comment">            .eq(&quot;voucher_id&quot;, voucherId)</span><br><span class="hljs-comment">            .eq(&quot;stock&quot;, stock)</span><br><span class="hljs-comment">            .update();*/</span><br><br>    <span class="hljs-comment">// 6.3扣减库存(针对使用乐观锁CAS，没卖完解决)</span><br>    <span class="hljs-comment">// update tb_seckill_voucher set stock = stock -1 where voucher_id = ? and stock &gt; 0</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> iSeckillVoucherService.update()<br>            .setSql(<span class="hljs-string">&quot;stock = stock - 1&quot;</span>)<br>            .eq(<span class="hljs-string">&quot;voucher_id&quot;</span>, voucherId)<br>            .gt(<span class="hljs-string">&quot;stock&quot;</span>, <span class="hljs-number">0</span>)<br>            .update();<br><br>    <span class="hljs-keyword">if</span> (!result) &#123;<br>        <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;商品已经售罄!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// 7.创建订单</span><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取订单id</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-type">long</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> redisWorker.nextID(<span class="hljs-string">&quot;order&quot;</span>);<br><br>    <span class="hljs-type">VoucherOrder</span> <span class="hljs-variable">voucherOrder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">VoucherOrder</span>();<br>    voucherOrder.setId(orderId);<br>    voucherOrder.setVoucherId(voucherId);<br>    voucherOrder.setUserId(userID);<br><br>    <span class="hljs-comment">// 将订单信息保存到数据库</span><br>    <span class="hljs-comment">// insert into tb_voucher_order values ()</span><br>    save(voucherOrder);<br><br>    <span class="hljs-comment">//8.返回订单id</span><br>    <span class="hljs-keyword">return</span> Result.ok(orderId);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="4-4-1-问题一"><a href="#4-4-1-问题一" class="headerlink" title="4.4.1 问题一"></a>4.4.1 问题一</h3><p>此时sychronized加锁的话，锁粒度很粗，直接锁住的是整个方法，导致性能较差，因此考虑缩小锁的范围</p><blockquote><p>此时使用用户ID作为锁</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Transactional</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">createVoucherOrder</span><span class="hljs-params">(Long voucherId)</span> &#123;<br>    <span class="hljs-type">Long</span> <span class="hljs-variable">userID</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br><br>    <span class="hljs-comment">// 通过悲观锁，锁住用户，实现一人一单</span><br>    <span class="hljs-keyword">synchronized</span> (userID.toString().intern()) &#123; <span class="hljs-comment">//如果不加Intern的话，那么在toString底层每次都是New一个新的对象，那么锁就失效了</span><br>        <span class="hljs-comment">// 5.实现1人1单加入逻辑：根据优惠券id和用户id查询订单</span><br>        <span class="hljs-comment">// 5.1查询订单,并不用查询出具体的值，而是查询出数量即可</span><br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> query().eq(<span class="hljs-string">&quot;user_id&quot;</span>, userID).eq(<span class="hljs-string">&quot;voucher_id&quot;</span>, voucherId).count();<br>        <span class="hljs-comment">// 5.2判断订单是否存在</span><br>        <span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-comment">// 5.2.1 存在就返回异常结果</span><br>            <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;秒杀优惠券每人限购1张,感谢配合,本优惠券最终解释权归ty公司所有!&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">// 5.2.2 不存在再减少库存</span><br><br>        <span class="hljs-comment">// 6.1扣减库存(会出现超卖问题)</span><br>        <span class="hljs-comment">// update tb_seckill_voucher set stock = stock -1 where voucher_id = ?</span><br>    <span class="hljs-comment">/*boolean result = iSeckillVoucherService.update()</span><br><span class="hljs-comment">            .setSql(&quot;stock = stock -1&quot;)</span><br><span class="hljs-comment">            .eq(&quot;voucher_id&quot;, voucherId).update();*/</span><br><br>        <span class="hljs-comment">// 6.2扣减库存(针对超卖问题用乐观锁CAS解决)</span><br>        <span class="hljs-comment">// update tb_seckill_voucher set stock = stock -1 where voucher_id = ? and stock = ?</span><br>    <span class="hljs-comment">/*boolean result = iSeckillVoucherService.update()</span><br><span class="hljs-comment">            .setSql(&quot;stock = stock - 1&quot;)</span><br><span class="hljs-comment">            .eq(&quot;voucher_id&quot;, voucherId)</span><br><span class="hljs-comment">            .eq(&quot;stock&quot;, stock)</span><br><span class="hljs-comment">            .update();*/</span><br><br>        <span class="hljs-comment">// 6.3扣减库存(针对使用乐观锁CAS，没卖完解决)</span><br>        <span class="hljs-comment">// update tb_seckill_voucher set stock = stock -1 where voucher_id = ? and stock &gt; 0</span><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> iSeckillVoucherService.update()<br>                .setSql(<span class="hljs-string">&quot;stock = stock - 1&quot;</span>)<br>                .eq(<span class="hljs-string">&quot;voucher_id&quot;</span>, voucherId)<br>                .gt(<span class="hljs-string">&quot;stock&quot;</span>, <span class="hljs-number">0</span>)<br>                .update();<br><br>        <span class="hljs-keyword">if</span> (!result) &#123;<br>            <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;商品已经售罄!&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">// 7.创建订单</span><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 获取订单id</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-type">long</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> redisWorker.nextID(<span class="hljs-string">&quot;order&quot;</span>);<br><br>        <span class="hljs-type">VoucherOrder</span> <span class="hljs-variable">voucherOrder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">VoucherOrder</span>();<br>        voucherOrder.setId(orderId);<br>        voucherOrder.setVoucherId(voucherId);<br>        voucherOrder.setUserId(userID);<br><br>        <span class="hljs-comment">// 将订单信息保存到数据库</span><br>        <span class="hljs-comment">// insert into tb_voucher_order values ()</span><br>        save(voucherOrder);<br><br>        <span class="hljs-comment">//8.返回订单id</span><br>        <span class="hljs-keyword">return</span> Result.ok(orderId);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="4-4-2-问题二"><a href="#4-4-2-问题二" class="headerlink" title="4.4.2 问题二"></a>4.4.2 问题二</h3><p>当前方法加了<code>@Transactional</code>进行事务控制，在方法内部加锁，可能会导致当前方法事务还没有提交，但是锁已经释放也会导致问题，因此需要将方法整体包起来，确保事务不会出现问题</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/5c92409485eb439f8fda941ba9ed4b19.png" alt="在这里插入图片描述"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 实现一人一单，锁住对象</span><br><span class="hljs-type">Long</span> <span class="hljs-variable">userID</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br><span class="hljs-keyword">synchronized</span> (userID.toString().intern()) &#123;<br>    <span class="hljs-keyword">return</span> createVoucherOrder(voucherId);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="4-4-3-问题三"><a href="#4-4-3-问题三" class="headerlink" title="4.4.3 问题三"></a>4.4.3 问题三</h3><p>此时事务的标志是在createVocherOrder方法上，并没有在seckillVoucher方法上，在调用createVocherOrder的时候使用的this方式里调用的，因此是VoucherOrderServiceImpl而不是VoucherOrderService的代理对象。因此我们需要获得原始的事务对象， 来操作事务。</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/c664f5bd083042349de129575b8337a3.png" alt="在这里插入图片描述"></p><p>VoucherOrderServiceImpl.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 实现一人一单，获取user对象锁</span><br><span class="hljs-type">Long</span> <span class="hljs-variable">userID</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br><span class="hljs-keyword">synchronized</span> (userID.toString().intern()) &#123;<br>    <span class="hljs-comment">// 调用本类方法的时候，Spring事务是失效的，解决方案二：调用AopContext API</span><br>    <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> AopContext.currentProxy();<br>    <span class="hljs-type">IVoucherOrderService</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> (IVoucherOrderService) o;<br>    <span class="hljs-keyword">return</span> proxy.createVoucherOrder(voucherId);<br>&#125;<br></code></pre></td></tr></table></figure><p>IVoucherOrderService.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IVoucherOrderService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IService</span>&lt;VoucherOrder&gt; &#123;<br><br>    Result <span class="hljs-title function_">seckillVoucher</span><span class="hljs-params">(Long voucherId)</span>;<br><br>    Result <span class="hljs-title function_">createVoucherOrder</span><span class="hljs-params">(Long voucherId)</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>pom依赖</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;!-- Spring事务失效，采用AopContext API来处理 --&gt;<br>&lt;dependency&gt;<br>    &lt;groupId&gt;org.aspectj&lt;/groupId&gt;<br>    &lt;artifactId&gt;aspectjweaver&lt;/artifactId&gt;<br>&lt;/dependency&gt;<br><br></code></pre></td></tr></table></figure><p>HmDianPingApplication.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@EnableAspectJAutoProxy(exposeProxy = true)</span> <span class="hljs-comment">//暴露代理对象，默认不暴露</span><br></code></pre></td></tr></table></figure><h1 id="5-集群模式下的一人一单"><a href="#5-集群模式下的一人一单" class="headerlink" title="5 集群模式下的一人一单"></a>5 集群模式下的一人一单</h1><p>通过加锁可以解决在单机情况下的一人一单安全问题，但是在集群模式下就不行了。</p><ol><li><p>我们将服务启动两份，端口分别为8081和8082：</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/7249a1b7643c443d8598279efc3e7ac9.png" alt="在这里插入图片描述"></p></li><li><p>重新指定新服务端口</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/aabca2e47e0d4c06a20cc9324787432b-20240225134656691.png"></p></li><li><p>debug启动</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/3bb5bade6df74a959fa8e0ac7344e875.png" alt="在这里插入图片描述"></p></li><li><p>nginx修改</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/c3ef5952ae2f413f8169a2760d5c5d71.png" alt="在这里插入图片描述"></p></li><li><p>重启nginx</p></li><li><p>访问接口（<a href="http://localhost:8080/api/voucher/list/1%EF%BC%89%EF%BC%8C%E7%9B%B4%E8%87%B3%E4%B8%A4%E4%B8%AA%E6%9C%8D%E5%8A%A1%E9%83%BD%E6%9C%89sql%E8%AF%AD%E5%8F%A5%E8%BE%93%E5%87%BA%EF%BC%8C%E8%BF%99%E6%A0%B7%E6%A8%A1%E6%8B%9F%E9%9B%86%E7%BE%A4%E5%B0%B1%E7%94%9F%E6%95%88%E4%BA%86">http://localhost:8080/api/voucher/list/1），直至两个服务都有sql语句输出，这样模拟集群就生效了</a></p></li><li><p>使用postman配置2个http请求</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/410013ae88514d299a1838742bff18c3.png" alt="在这里插入图片描述"></p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/0d58e777b7a847e29a4033cd52071a6a.png" alt="在这里插入图片描述"></p></li></ol><h2 id="5-1-问题"><a href="#5-1-问题" class="headerlink" title="5.1 问题"></a>5.1 问题</h2><p>此时使用Postman发送完成后</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/1b0874003c3f4a6b8c230899bfd8bc4b.png" alt="在这里插入图片描述"></p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/cbc5e4aa165245b3916a857c9e54f62c.png" alt="在这里插入图片描述"></p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/34a650a4e30f4540a31aadc45c124c55.png" alt="在这里插入图片描述"></p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/8535a1623be546aaa5578b43bee31bfc.png" alt="在这里插入图片描述"></p><p>此时发现2个请求在查询的时候count都是0，那么说明都是可以下单的，此时说明这个是有问题的。</p><h2 id="5-2-分析"><a href="#5-2-分析" class="headerlink" title="5.2 分析"></a>5.2 分析</h2><p>此时启动的另外一个服务，相当于是新一个JVM。如果在同一个应用下，JVM只有一个，此时锁监视器也只有一个，因此是锁可以实现互斥的，但是现在存在两个JVM，锁监视器在每个JVM中存在一个，因此无法实现互斥</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/7bf47a4fa09246eab959c3f1aea0702a.png" alt="在这里插入图片描述"></p>]]></content>
    
    
    <categories>
      
      <category>redis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>redis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>mybatis-缓存&amp;逆向工程&amp;分页插件</title>
    <link href="/mybatis-%E7%BC%93%E5%AD%98-%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B-%E5%88%86%E9%A1%B5%E6%8F%92%E4%BB%B6/2990250b4e00/"/>
    <url>/mybatis-%E7%BC%93%E5%AD%98-%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B-%E5%88%86%E9%A1%B5%E6%8F%92%E4%BB%B6/2990250b4e00/</url>
    
    <content type="html"><![CDATA[<h1 id="1-缓存"><a href="#1-缓存" class="headerlink" title="1 缓存"></a>1 缓存</h1><h2 id="1-1-一级缓存"><a href="#1-1-一级缓存" class="headerlink" title="1.1 一级缓存"></a>1.1 一级缓存</h2><ol><li>是默认开启的</li><li>是SqlSession级别的，通过同一个SqlSession查询的数据会被缓存，下次查询相同的数据，就会从缓存中直接获取，不会从数据库重新访问。</li></ol><h3 id="1-1-1-一级缓存失效"><a href="#1-1-1-一级缓存失效" class="headerlink" title="1.1.1 一级缓存失效"></a>1.1.1 一级缓存失效</h3><ol><li>不同的SqlSession对应不同的一级缓存</li><li>同一个SqlSession但是查询条件不同</li><li>同一个SqlSession两次查询期间执行了任何一次增删改操作</li><li>同一个SqlSession两次查询期间手动清空了缓存 （sqlsession.clearCache()）</li></ol><h2 id="1-2-二级缓存"><a href="#1-2-二级缓存" class="headerlink" title="1.2 二级缓存"></a>1.2 二级缓存</h2><ol><li>是SqlSessionFactory级别，通过同一个SqlSessionFactory创建的SqlSession查询的结果会被缓存；此后若再次执行相同的查询语句，结果就会从缓存中获取</li></ol><p>开启条件：</p><ol><li>在核心配置文件中，设置全局配置属性cacheEnabled&#x3D;“true”，默认为true，不需要设置</li><li>在映射文件中设置标签&lt; cache &#x2F;&gt;</li><li>二级缓存必须在SqlSession关闭或提交之后有效</li><li>查询的数据所转换的实体类类型必须实现序列化的接口</li></ol><h3 id="1-2-1-二级缓存失效"><a href="#1-2-1-二级缓存失效" class="headerlink" title="1.2.1 二级缓存失效"></a>1.2.1 二级缓存失效</h3><p>两次查询之间执行了任意的增删改，会使一级和二级缓存同时失效</p><h2 id="1-3-二级缓存配置"><a href="#1-3-二级缓存配置" class="headerlink" title="1.3 二级缓存配置"></a>1.3 二级缓存配置</h2><p>在mapper配置文件中添加的cache标签可以设置一些属性：</p><p>eviction属性：缓存回收策略 默认的是 LRU。<br>LRU（Least Recently Used） – 最近最少使用的：移除最长时间不被使用的对象。<br>FIFO（First in First out） – 先进先出：按对象进入缓存的顺序来移除它们。<br>SOFT – 软引用：移除基于垃圾回收器状态和软引用规则的对象。<br>WEAK – 弱引用：更积极地移除基于垃圾收集器状态和弱引用规则的对象。</p><p>flushInterval属性：刷新间隔，单位毫秒 默认情况是不设置，也就是没有刷新间隔，缓存仅仅调用语句时刷新</p><p>size属性：引用数目，正整数 代表缓存最多可以存储多少个对象，太大容易导致内存溢出</p><p>readOnly属性：只读，true&#x2F;false<br>true：只读缓存；会给所有调用者返回缓存对象的相同实例。因此这些对象不能被修改。这提供了很重要的性能优势。<br>false：读写缓存；会返回缓存对象的拷贝（通过序列化）。这会慢一些，但是安全，因此默认是 false。</p><h2 id="1-4-缓存查询的顺序"><a href="#1-4-缓存查询的顺序" class="headerlink" title="1.4 缓存查询的顺序"></a>1.4 缓存查询的顺序</h2><ul><li>先查询二级缓存，因为二级缓存中可能会有其他程序已经查出来的数据，可以拿来直接使用。</li><li>如果二级缓存没有命中，再查询一级缓存</li><li>如果一级缓存也没有命中，则查询数据库</li><li>SqlSession关闭之后，一级缓存中的数据会写入二级缓存</li></ul><h1 id="2-逆向工程"><a href="#2-逆向工程" class="headerlink" title="2 逆向工程"></a>2 逆向工程</h1><ul><li><p>正向工程：先创建Java实体类，由框架负责根据实体类生成数据库表。Hibernate是支持正向工程 的。</p></li><li><p>逆向工程：先创建数据库表，由框架负责根据数据库表，反向生成如下资源：</p><ul><li>Java实体类</li><li>Mapper接口</li><li>Mapper映射文件</li></ul></li></ul><h2 id="2-1-添加依赖和插件"><a href="#2-1-添加依赖和插件" class="headerlink" title="2.1 添加依赖和插件"></a>2.1 添加依赖和插件</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 依赖MyBatis核心包 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.7<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br><span class="hljs-comment">&lt;!-- 控制Maven在构建过程中相关配置 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- 构建过程中用到的插件 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 具体插件，逆向工程的操作是以构建过程中插件形式出现的 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis.generator<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-generator-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.3.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-comment">&lt;!-- 插件的依赖 --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>                <span class="hljs-comment">&lt;!-- 逆向工程的核心依赖 --&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis.generator<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-generator-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.3.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-comment">&lt;!-- 数据库连接池 --&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.mchange<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>c3p0<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.9.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-comment">&lt;!-- MySQL驱动 --&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.0.23<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="2-2-创建Mybatis的核心配置文件"><a href="#2-2-创建Mybatis的核心配置文件" class="headerlink" title="2.2 创建Mybatis的核心配置文件"></a>2.2 创建Mybatis的核心配置文件</h2><h2 id="2-3-创建逆向工程配置文件"><a href="#2-3-创建逆向工程配置文件" class="headerlink" title="2.3 创建逆向工程配置文件"></a>2.3 创建逆向工程配置文件</h2><p>文件名必须是：generatorConfig.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span> <span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">generatorConfiguration</span></span><br><span class="hljs-meta">        <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">&quot;-//mybatis.org//DTD MyBatis Generator Configuration 1.0//EN&quot;</span></span><br><span class="hljs-meta">        <span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-generator-config_1_0.dtd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">generatorConfiguration</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--targetRuntime: 执行生成的逆向工程的版本</span><br><span class="hljs-comment">    MyBatis3Simple: 生成基本的CRUD（清新简洁版）</span><br><span class="hljs-comment">    MyBatis3: 生成带条件的CRUD（奢华尊享版） --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">context</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;DB2Tables&quot;</span> <span class="hljs-attr">targetRuntime</span>=<span class="hljs-string">&quot;MyBatis3Simple&quot;</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 数据库的连接信息 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">jdbcConnection</span> <span class="hljs-attr">driverClass</span>=<span class="hljs-string">&quot;com.mysql.jdbc.Driver&quot;</span></span><br><span class="hljs-tag">                        <span class="hljs-attr">connectionURL</span>=<span class="hljs-string">&quot;jdbc:mysql://localhost:3306/mybatis&quot;</span></span><br><span class="hljs-tag">                        <span class="hljs-attr">userId</span>=<span class="hljs-string">&quot;root&quot;</span></span><br><span class="hljs-tag">                        <span class="hljs-attr">password</span>=<span class="hljs-string">&quot;123456&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">jdbcConnection</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- javaBean的生成策略--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">javaModelGenerator</span> <span class="hljs-attr">targetPackage</span>=<span class="hljs-string">&quot;com.atguigu.mybatis.pojo&quot;</span> <span class="hljs-attr">targetProject</span>=<span class="hljs-string">&quot;.\src\main\java&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;enableSubPackages&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span> /&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;trimStrings&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span> /&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">javaModelGenerator</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- SQL映射文件的生成策略 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">sqlMapGenerator</span> <span class="hljs-attr">targetPackage</span>=<span class="hljs-string">&quot;com.atguigu.mybatis.mapper&quot;</span></span><br><span class="hljs-tag">                         <span class="hljs-attr">targetProject</span>=<span class="hljs-string">&quot;.\src\main\resources&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;enableSubPackages&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span> /&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">sqlMapGenerator</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- Mapper接口的生成策略 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">javaClientGenerator</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;XMLMAPPER&quot;</span> <span class="hljs-attr">targetPackage</span>=<span class="hljs-string">&quot;com.atguigu.mybatis.mapper&quot;</span></span><br><span class="hljs-tag">                             <span class="hljs-attr">targetProject</span>=<span class="hljs-string">&quot;.\src\main\java&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;enableSubPackages&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span> /&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">javaClientGenerator</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 逆向分析的表 --&gt;</span><br>        <span class="hljs-comment">&lt;!-- tableName设置为*号，可以对应所有表，此时不写domainObjectName --&gt;</span><br>        <span class="hljs-comment">&lt;!-- domainObjectName属性指定生成出来的实体类的类名 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">table</span> <span class="hljs-attr">tableName</span>=<span class="hljs-string">&quot;t_emp&quot;</span> <span class="hljs-attr">domainObjectName</span>=<span class="hljs-string">&quot;Emp&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">table</span> <span class="hljs-attr">tableName</span>=<span class="hljs-string">&quot;t_dept&quot;</span> <span class="hljs-attr">domainObjectName</span>=<span class="hljs-string">&quot;Dept&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">context</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">generatorConfiguration</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="2-4-点击执行gerneate目标"><a href="#2-4-点击执行gerneate目标" class="headerlink" title="2.4 点击执行gerneate目标"></a>2.4 点击执行gerneate目标</h2><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Mybatis/aa6401a00d554b178e0f04cae6b1a015.png" alt="在这里插入图片描述"></p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Mybatis/7cd04e6ca0e745e09cbaee40849c1ef6.png" alt="在这里插入图片描述"></p><h1 id="3-分页插件"><a href="#3-分页插件" class="headerlink" title="3 分页插件"></a>3 分页插件</h1><h2 id="3-1-依赖"><a href="#3-1-依赖" class="headerlink" title="3.1 依赖"></a>3.1 依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/com.github.pagehelper/pagehelper --&gt;</span> <br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span> <br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.pagehelper<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span> <br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>pagehelper<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.2.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span> <br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="3-2-配置分页插件"><a href="#3-2-配置分页插件" class="headerlink" title="3.2 配置分页插件"></a>3.2 配置分页插件</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span>    <br><span class="hljs-comment">&lt;!--设置分页插件--&gt;</span>    <br><span class="hljs-tag">&lt;<span class="hljs-name">plugin</span> <span class="hljs-attr">interceptor</span>=<span class="hljs-string">&quot;com.github.pagehelper.PageInterceptor&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span> <br><span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="3-3-使用"><a href="#3-3-使用" class="headerlink" title="3.3 使用"></a>3.3 使用</h2><ol><li><p>在查询功能之前使用PageHelper.startPage(int pageNum, int pageSize)开启分页功能<br>pageNum：当前页的页码<br>pageSize：每页显示的条数</p></li><li><p>在查询获取list集合之后，使用PageInfo pageInfo &#x3D; new PageInfo&lt;&gt;(List list, int navigatePages)获取分页相关数据<br>list：分页之后的数据<br>navigatePages：导航分页的页码数</p></li><li><p>分页相关数据<br>PageInfo{<br>pageNum&#x3D;8, pageSize&#x3D;4, size&#x3D;2, startRow&#x3D;29, endRow&#x3D;30, total&#x3D;30, pages&#x3D;8,<br>list&#x3D;Page{count&#x3D;true, pageNum&#x3D;8, pageSize&#x3D;4, startRow&#x3D;28, endRow&#x3D;32, total&#x3D;30, pages&#x3D;8, reasonable&#x3D;false, pageSizeZero&#x3D;false},<br>prePage&#x3D;7, nextPage&#x3D;0, isFirstPage&#x3D;false, isLastPage&#x3D;true, hasPreviousPage&#x3D;true, hasNextPage&#x3D;false, navigatePages&#x3D;5, navigateFirstPage4, navigateLastPage8, navigatepageNums&#x3D;[4, 5, 6, 7, 8] }</p></li></ol><p>常用数据：<br>pageNum：当前页的页码<br>pageSize：每页显示的条数<br>size：当前页显示的真实条数<br>total：总记录数<br>pages：总页数<br>prePage：上一页的页码<br>nextPage：下一页的页码<br>isFirstPage&#x2F;isLastPage：是否为第一页&#x2F;最后一页<br>hasPreviousPage&#x2F;hasNextPage：是否存在上一页&#x2F;下一页<br>navigatePages：导航分页的页码数<br>navigatepageNums：导航分页的页码，[1,2,3,4,5]</p>]]></content>
    
    
    <categories>
      
      <category>mybatis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mybatis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>mybatis-动态SQL</title>
    <link href="/mybatis-%E5%8A%A8%E6%80%81SQL/127465e25950/"/>
    <url>/mybatis-%E5%8A%A8%E6%80%81SQL/127465e25950/</url>
    
    <content type="html"><![CDATA[<blockquote><p>Mybatis框架的动态SQL技术是一种根据特定条件动态拼装SQL语句的功能，它存在的意义是为了解决 拼接SQL语句字符串时的痛点问题。</p></blockquote><h1 id="1-if"><a href="#1-if" class="headerlink" title="1 if"></a>1 if</h1><p>if标签可通过test属性的表达式进行判断，若表达式的结果为true，则标签中的内容会执行；反之标签中 的内容不会执行</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--List&lt;Emp&gt; getEmpListByMoreTJ(Emp emp);--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;getEmpListByMoreTJ&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;Emp&quot;</span>&gt;</span><br>    select * from t_emp where 1=1<br>    <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;ename != &#x27;&#x27; and ename != null&quot;</span>&gt;</span><br>        and ename = #&#123;ename&#125;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;age != &#x27;&#x27; and age != null&quot;</span>&gt;</span><br>        and age = #&#123;age&#125;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;sex != &#x27;&#x27; and sex != null&quot;</span>&gt;</span><br>        and sex = #&#123;sex&#125;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br></code></pre></td></tr></table></figure><h1 id="2-where"><a href="#2-where" class="headerlink" title="2 where"></a>2 where</h1><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;getEmpListByMoreTJ2&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;Emp&quot;</span>&gt;</span><br>    select * from t_emp<br>    <span class="hljs-tag">&lt;<span class="hljs-name">where</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;ename != &#x27;&#x27; and ename != null&quot;</span>&gt;</span><br>            ename = #&#123;ename&#125;<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;age != &#x27;&#x27; and age != null&quot;</span>&gt;</span><br>            and age = #&#123;age&#125;<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;sex != &#x27;&#x27; and sex != null&quot;</span>&gt;</span><br>            and sex = #&#123;sex&#125;<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">where</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br></code></pre></td></tr></table></figure><blockquote><p>where和if一般结合使用： </p><ol><li>若where标签中的if条件都不满足，则where标签没有任何功能，即不会添加where关键字</li><li>若where标签中的if条件满足，则where标签会自动添加where关键字，并将条件最前方多余的 and去掉 注意：where标签不能去掉条件最后多余的and</li></ol></blockquote><h1 id="3-trim"><a href="#3-trim" class="headerlink" title="3 trim"></a>3 trim</h1><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;getEmpListByMoreTJ&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;Emp&quot;</span>&gt;</span><br>  select * from t_emp<br>  <span class="hljs-tag">&lt;<span class="hljs-name">trim</span> <span class="hljs-attr">prefix</span>=<span class="hljs-string">&quot;where&quot;</span> <span class="hljs-attr">suffixOverrides</span>=<span class="hljs-string">&quot;and&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;ename != &#x27;&#x27; and ename != null&quot;</span>&gt;</span><br>          ename = #&#123;ename&#125; and<br>      <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;age != &#x27;&#x27; and age != null&quot;</span>&gt;</span><br>          age = #&#123;age&#125; and<br>      <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;sex != &#x27;&#x27; and sex != null&quot;</span>&gt;</span><br>          sex = #&#123;sex&#125;<br>      <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">trim</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br></code></pre></td></tr></table></figure><blockquote><p>trim用于去掉或添加标签中的内容<br>常用属性：<br>prefix：在trim标签中的内容的前面添加某些内容<br>prefixOverrides：在trim标签中的内容的前面去掉某些内容<br>suffix：在trim标签中的内容的后面添加某些内容<br>suffixOverrides：在trim标签中的内容的后面去掉某些内容</p></blockquote><h1 id="4-choose-when-otherwise"><a href="#4-choose-when-otherwise" class="headerlink" title="4 choose&#x2F;when&#x2F;otherwise"></a>4 choose&#x2F;when&#x2F;otherwise</h1><p>这个语句就像java中的if..else if..else</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--List&lt;Emp&gt; getEmpListByChoose(Emp emp);--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;getEmpListByChoose&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;Emp&quot;</span>&gt;</span><br>    select * from t_emp<br>    <span class="hljs-tag">&lt;<span class="hljs-name">where</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">choose</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">when</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;ename != &#x27;&#x27; and ename != null&quot;</span>&gt;</span><br>                ename = #&#123;ename&#125;<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">when</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">when</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;age != &#x27;&#x27; and age != null&quot;</span>&gt;</span><br>                age = #&#123;age&#125;<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">when</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">when</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;sex != &#x27;&#x27; and sex != null&quot;</span>&gt;</span><br>                sex = #&#123;sex&#125;<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">when</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">when</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;email != &#x27;&#x27; and email != null&quot;</span>&gt;</span><br>                email = #&#123;email&#125;<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">when</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">choose</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">where</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br></code></pre></td></tr></table></figure><h1 id="5-foreach"><a href="#5-foreach" class="headerlink" title="5 foreach"></a>5 foreach</h1><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--int insertMoreEmp(List&lt;Emp&gt; emps);--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">insert</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;insertMoreEmp&quot;</span>&gt;</span><br>    insert into t_emp values<br>    <span class="hljs-tag">&lt;<span class="hljs-name">foreach</span> <span class="hljs-attr">collection</span>=<span class="hljs-string">&quot;emps&quot;</span> <span class="hljs-attr">item</span>=<span class="hljs-string">&quot;emp&quot;</span> <span class="hljs-attr">separator</span>=<span class="hljs-string">&quot;,&quot;</span>&gt;</span><br>        (null,#&#123;emp.ename&#125;,#&#123;emp.age&#125;,#&#123;emp.sex&#125;,#&#123;emp.email&#125;,null)<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">foreach</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">insert</span>&gt;</span><br><br><span class="hljs-comment">&lt;!--int deleteMoreByArray(int[] eids);--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">delete</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;deleteMoreByArray&quot;</span>&gt;</span><br>    delete from t_emp where<br>    <span class="hljs-tag">&lt;<span class="hljs-name">foreach</span> <span class="hljs-attr">collection</span>=<span class="hljs-string">&quot;eids&quot;</span> <span class="hljs-attr">item</span>=<span class="hljs-string">&quot;eid&quot;</span> <span class="hljs-attr">separator</span>=<span class="hljs-string">&quot;or&quot;</span>&gt;</span><br>        eid = #&#123;eid&#125;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">foreach</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">delete</span>&gt;</span> <br><br><span class="hljs-comment">&lt;!--int deleteMoreByArray(int[] eids);--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">delete</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;deleteMoreByArray&quot;</span>&gt;</span><br>    delete from t_emp where eid in<br>    <span class="hljs-tag">&lt;<span class="hljs-name">foreach</span> <span class="hljs-attr">collection</span>=<span class="hljs-string">&quot;eids&quot;</span> <span class="hljs-attr">item</span>=<span class="hljs-string">&quot;eid&quot;</span> <span class="hljs-attr">separator</span>=<span class="hljs-string">&quot;,&quot;</span> <span class="hljs-attr">open</span>=<span class="hljs-string">&quot;(&quot;</span> <span class="hljs-attr">close</span>=<span class="hljs-string">&quot;)&quot;</span>&gt;</span><br>        #&#123;eid&#125;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">foreach</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">delete</span>&gt;</span><br><br></code></pre></td></tr></table></figure><blockquote><p>属性：<br>collection：设置要循环的数组或集合<br>item：表示集合或数组中的每一个数据</p><p>separator：设置循环体之间的分隔符</p><p>open：设置foreach标签中的内容的开始符<br>close：设置foreach标签中的内容的结束符</p></blockquote><h1 id="6-SQL片段"><a href="#6-SQL片段" class="headerlink" title="6 SQL片段"></a>6 SQL片段</h1><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">sql</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;empColumns&quot;</span>&gt;</span><br>    eid,ename,age,sex,did<br><span class="hljs-tag">&lt;/<span class="hljs-name">sql</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;xxx&quot;</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">&quot;deptEmpMap&quot;</span>&gt;</span><br>    select <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">refid</span>=<span class="hljs-string">&quot;empColumns&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span> from t_emp<br><span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>mybatis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mybatis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>mybatis-特殊SQL执行&amp;自定义resultMap</title>
    <link href="/mybatis-%E7%89%B9%E6%AE%8ASQL%E6%89%A7%E8%A1%8C-%E8%87%AA%E5%AE%9A%E4%B9%89resultMap/7c02110b378d/"/>
    <url>/mybatis-%E7%89%B9%E6%AE%8ASQL%E6%89%A7%E8%A1%8C-%E8%87%AA%E5%AE%9A%E4%B9%89resultMap/7c02110b378d/</url>
    
    <content type="html"><![CDATA[<h1 id="1-特殊SQL"><a href="#1-特殊SQL" class="headerlink" title="1 特殊SQL"></a>1 特殊SQL</h1><h2 id="1-1-模糊查询"><a href="#1-1-模糊查询" class="headerlink" title="1.1 模糊查询"></a>1.1 模糊查询</h2><p>在SQL语句中，使用like关键字进行查询</p><p>推荐使用</p><ol><li><p>${}</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Mybatis/6e685fc26d974b5a9d340111f393dcc0.png" alt="在这里插入图片描述"></p></li><li><p>concat</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Mybatis/2bc95a35d7d44506a8cb4be2153d8dce.png" alt="在这里插入图片描述"></p></li><li><p>“%”#{}”%”</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Mybatis/ae8a42b7f5c947419b633f132b43a8af.png" alt="在这里插入图片描述"></p></li></ol><h2 id="1-2-批量删除"><a href="#1-2-批量删除" class="headerlink" title="1.2 批量删除"></a>1.2 批量删除</h2><p>由于#{}会自动添加””，因此在批量删除的时候使用${}</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Mybatis/42e01bec768b4bf4b23f5857f5283256.png" alt="在这里插入图片描述"></p><h2 id="1-3-动态设置表名"><a href="#1-3-动态设置表名" class="headerlink" title="1.3 动态设置表名"></a>1.3 动态设置表名</h2><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Mybatis/4c963feff23a484fa913defc18ab6397.png" alt="在这里插入图片描述"></p><h2 id="1-4-获取自增主键"><a href="#1-4-获取自增主键" class="headerlink" title="1.4 获取自增主键"></a>1.4 获取自增主键</h2><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Mybatis/61f21275105545cc97db452d09409943.png" alt="在这里插入图片描述"></p><p>注：</p><p>在标签中，</p><ol><li>使用userGeneratedKeys表示当前添加功能使用自增的主键</li><li>使用keyProperty表示将添加的数据自增主键赋值给实体类型对应的属性</li></ol><h1 id="2-自定义映射resultMap"><a href="#2-自定义映射resultMap" class="headerlink" title="2 自定义映射resultMap"></a>2 自定义映射resultMap</h1><p>若字段名和实体类中的属性名不一致，但是字段名符合数据库字段命名规则，实体类中的属性 名符合Java的规则（使用驼峰）<br>此时也可通过以下两种方式处理字段名和实体类中的属性的映射关系<br>a&gt;可以通过为字段起别名的方式，保证和实体类中的属性名保持一致<br>b&gt;可以在MyBatis的核心配置文件中设置一个全局配置信息mapUnderscoreToCamelCase，可以在查询表中数据时，自动将_类型的字段名转换为驼峰<br>例如：字段名user_name，设置了mapUnderscoreToCamelCase，此时字段名就会转换为 userName</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Mybatis/6c7aa53ab23a44e0a743e1826ae652a0.png" alt="在这里插入图片描述"></p><h2 id="2-1-别名"><a href="#2-1-别名" class="headerlink" title="2.1 别名"></a>2.1 别名</h2><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Mybatis/51290bcc5b5c4099b1cef322bd27e49b.png" alt="在这里插入图片描述"></p><h2 id="2-2-全局配置"><a href="#2-2-全局配置" class="headerlink" title="2.2 全局配置"></a>2.2 全局配置</h2><p>将配置文件中设置settings标签，里面将mapUnderscoreToCamelCase设置为true</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Mybatis/b90ca69407314c4689749999148f24cb.png" alt="在这里插入图片描述"></p><h2 id="2-3-resultMap"><a href="#2-3-resultMap" class="headerlink" title="2.3 resultMap"></a>2.3 resultMap</h2><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Mybatis/0e5181ced6fd40d1b4bc25f24c8d22e6.png" alt="在这里插入图片描述"></p><h2 id="2-4-多对一映射"><a href="#2-4-多对一映射" class="headerlink" title="2.4 多对一映射"></a>2.4 多对一映射</h2><p>例如：多个员工对应一个部门</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Mybatis/8218abd41733406da7c462db903775d5.png" alt="在这里插入图片描述"></p><h3 id="2-4-1-使用级联方式处理"><a href="#2-4-1-使用级联方式处理" class="headerlink" title="2.4.1 使用级联方式处理"></a>2.4.1 使用级联方式处理</h3><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Mybatis/eeb6abf91bdd4019bd6d614bbee31e36.png" alt="在这里插入图片描述"></p><h3 id="2-4-2-使用association处理"><a href="#2-4-2-使用association处理" class="headerlink" title="2.4.2 使用association处理"></a>2.4.2 使用association处理</h3><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Mybatis/4e54b839d19c404cb9dea6c9b11752ae.png" alt="在这里插入图片描述"></p><p>association就是用来处理多对一的映射关系</p><p>property表示需要处理多对一的属性名</p><p>javaType表示该属性的类型</p><h3 id="2-4-3-分步查询"><a href="#2-4-3-分步查询" class="headerlink" title="2.4.3 分步查询"></a>2.4.3 分步查询</h3><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Mybatis/4d89accf87144df098bf871f9bcd1734.png" alt="在这里插入图片描述"></p><ol><li>根据多的一方的条件先进行查询，同样使用association处理多对一的关系<ol><li>property 设置实体类中dept对象的映射关系             </li><li>select 设置分布查询中dept对象的属性从另外哪个sql获取,这里取值是mapper接口中方法的全类名             </li><li>column 多表查询中外键字段的字段名</li></ol></li><li>根据一的一方进行查询</li></ol><blockquote><p>分步查询的优点：</p><ol><li>可以实现延迟加载，</li><li>必须在核心配置文件中设置全局配置信息：<ol><li>lazyLoadingEnabled：延迟加载的全局开关。当开启时，所有关联对象都会延迟加载。</li><li>aggressiveLazyLoading：当开启时，任何方法的调用都会加载该对象的所有属性。 否则，每个属性会按需加载此时就可以实现按需加载，获取的数据是什么，就只会执行相应的sql。</li><li>此时可通过association和 collection中的fetchType属性设置当前的分步查询是否使用延迟加载，fetchType&#x3D;“lazy(延迟加 载)|eager(立即加载)”</li></ol></li></ol></blockquote><h4 id="2-4-3-1-延迟加载"><a href="#2-4-3-1-延迟加载" class="headerlink" title="2.4.3.1 延迟加载"></a>2.4.3.1 延迟加载</h4><p>如果当前只查询员工信息，而不需要部门信息，那么就不会查询部门信息，即：不会进行第二步的查询，可以减少内存的消耗。<br>如果要开启延迟加载，需要开启配置信息</p><h5 id="2-4-3-1-1-lazyLoadingEnabled"><a href="#2-4-3-1-1-lazyLoadingEnabled" class="headerlink" title="2.4.3.1.1 lazyLoadingEnabled"></a>2.4.3.1.1 lazyLoadingEnabled</h5><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Mybatis/e5c712c9f588470495809dc661f54a09.png" alt="在这里插入图片描述"></p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Mybatis/f1656e9d54754fa2b24416407a4ccc5b.png" alt="在这里插入图片描述"></p><h5 id="2-4-3-1-2-aggressiveLazyLoading"><a href="#2-4-3-1-2-aggressiveLazyLoading" class="headerlink" title="2.4.3.1.2 aggressiveLazyLoading"></a>2.4.3.1.2 aggressiveLazyLoading</h5><p>当开启时，任何方法的调用都会加载该对象的所有属性。 否则，每个属性会按需加载</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Mybatis/1d718b34bcd1474ea53d061a05f2d605.png" alt="在这里插入图片描述"></p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Mybatis/b92f3e1ca7064d6d850124db2578331b.png" alt="在这里插入图片描述"></p><blockquote><p>此时就可以实现按需加载，获取的数据是什么，就只会执行相应的sql。</p><p>此时可通过association和 collection中的fetchType属性设置当前的分步查询是否使用延迟加载，fetchType&#x3D;”lazy(延迟加 载)|eager(立即加载)”</p></blockquote><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Mybatis/a10c2dc09a7a402aa1b1225e8b53b61b.png" alt="在这里插入图片描述"></p><h2 id="2-5-一对多映射"><a href="#2-5-一对多映射" class="headerlink" title="2.5 一对多映射"></a>2.5 一对多映射</h2><p>例如：查询一个部门下的所有员工</p><h3 id="2-5-1-使用collection处理"><a href="#2-5-1-使用collection处理" class="headerlink" title="2.5.1 使用collection处理"></a>2.5.1 使用collection处理</h3><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Mybatis/e8dfaa899a2e432eb926ab26e98bbb40.png" alt="在这里插入图片描述"></p><p>collection就是用来处理一对多的映射关系</p><p>property表示需要处理一对多的属性名</p><p>ofType表示该属性的类型</p><h3 id="2-5-2-分步查询"><a href="#2-5-2-分步查询" class="headerlink" title="2.5.2 分步查询"></a>2.5.2 分步查询</h3><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Mybatis/5e42024bd7734684bb6ae7943f2ada88.png" alt="在这里插入图片描述"></p>]]></content>
    
    
    <categories>
      
      <category>mybatis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mybatis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>mybatis-参数获取&amp;查询</title>
    <link href="/mybatis-%E5%8F%82%E6%95%B0%E8%8E%B7%E5%8F%96-%E6%9F%A5%E8%AF%A2/ce8dcd6d1259/"/>
    <url>/mybatis-%E5%8F%82%E6%95%B0%E8%8E%B7%E5%8F%96-%E6%9F%A5%E8%AF%A2/ce8dcd6d1259/</url>
    
    <content type="html"><![CDATA[<h1 id="0-目录"><a href="#0-目录" class="headerlink" title="0 目录"></a>0 目录</h1><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Mybatis/image-20240219215146983.png" alt="image-20240219215146983"></p><h1 id="1-参数获取"><a href="#1-参数获取" class="headerlink" title="1 参数获取"></a>1 参数获取</h1><p>MyBatis获取参数值的两种方式：${}和#{}</p><p>${}的本质就是字符串拼接，**#{}的本质就是占位符赋值**</p><p>${}使用字符串拼接的方式拼接sql，<strong>若为字符串类型或日期类型的字段进行赋值时，需要手动加单引号</strong>；</p><p>但是#{}使用占位符赋值的方式拼接sql，此时为字符串类型或日期类型的字段进行赋值时，可以自动添加单引号。</p><h2 id="1-1-单个字面量"><a href="#1-1-单个字面量" class="headerlink" title="1.1 单个字面量"></a>1.1 单个字面量</h2><p>若mapper接口中的方法参数为单个的字面量类型 此时可以使用$ { }和 # { }以任意的名称获取参数的值。</p><p>注意${}需要手动加单引号</p><h2 id="1-2-多个字面量"><a href="#1-2-多个字面量" class="headerlink" title="1.2 多个字面量"></a>1.2 多个字面量</h2><p>若mapper接口中的方法参数为多个时，此时MyBatis会自动将这些参数放在一个map集合中，以arg0,arg1…为键，以参数为值；以 param1,param2…为键，以参数为值；因此只需要通过${}和#{}访问map集合的键就可以获取相对应的值。</p><p>注意 $ { }需要手动加单引号</p><h2 id="1-3-map集合类型"><a href="#1-3-map集合类型" class="headerlink" title="1.3 map集合类型"></a>1.3 map集合类型</h2><p>若mapper接口中的方法需要的参数为多个时，此时可以手动创建map集合，将这些数据放在map中 只需要通过 $ {}和#{}访问map集合的键就可以获取相对应的值。</p><p>注意${}需要手动加单引号</p><h2 id="1-4-实体类型"><a href="#1-4-实体类型" class="headerlink" title="1.4 实体类型"></a>1.4 实体类型</h2><p>若mapper接口中的方法参数为实体类对象时<br>此时可以使用$ {}和#{}，通过访问实体类对象中的属性名获取属性值。只跟get&#x2F;set方法有关</p><p>注意${}需要手动加单引号</p><h2 id="1-5-Param"><a href="#1-5-Param" class="headerlink" title="1.5 @Param"></a>1.5 @Param</h2><p>命名参数<br>可以通过@Param注解标识mapper接口中的方法参数<br>此时，会将这些参数放在map集合中，以@Param注解的value属性值为键，以参数为值；以 param1,param2…为键，以参数为值；只需要通过${}和#{}访问map集合的键就可以获取相对应的值。</p><p> 注意 ${}需要手动加单引号</p><h1 id="2-查询"><a href="#2-查询" class="headerlink" title="2 查询"></a>2 查询</h1><h2 id="2-1-查询一个实体类对象"><a href="#2-1-查询一个实体类对象" class="headerlink" title="2.1 查询一个实体类对象"></a>2.1 查询一个实体类对象</h2><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Mybatis/7cabf542e63c4797b0eb92212f7181d8.png" alt="在这里插入图片描述"></p><h2 id="2-2-查询一个list集合"><a href="#2-2-查询一个list集合" class="headerlink" title="2.2 查询一个list集合"></a>2.2 查询一个list集合</h2><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Mybatis/b0bc187ef3ab45b8966d03a2ac9b94b8.png" alt="在这里插入图片描述"></p><h2 id="2-3-查询单个数据"><a href="#2-3-查询单个数据" class="headerlink" title="2.3 查询单个数据"></a>2.3 查询单个数据</h2><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Mybatis/b0405dadafee447cb3e3eb9bf469774c.png" alt="在这里插入图片描述"></p><h2 id="2-4-查询一条数据为map的集合"><a href="#2-4-查询一条数据为map的集合" class="headerlink" title="2.4 查询一条数据为map的集合"></a>2.4 查询一条数据为map的集合</h2><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Mybatis/4ae0054addb741278f9de439acd89fc2.png" alt="在这里插入图片描述"></p><h2 id="2-5-查询多条数据为map集合"><a href="#2-5-查询多条数据为map集合" class="headerlink" title="2.5 查询多条数据为map集合"></a>2.5 查询多条数据为map集合</h2><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Mybatis/6d9cf111808d472bb82db8aaf63093d6.png" alt="在这里插入图片描述"></p>]]></content>
    
    
    <categories>
      
      <category>mybatis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mybatis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>mybatis-环境搭建</title>
    <link href="/mybatis-%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/64bafa7e8456/"/>
    <url>/mybatis-%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/64bafa7e8456/</url>
    
    <content type="html"><![CDATA[<h1 id="0-目录"><a href="#0-目录" class="headerlink" title="0 目录"></a>0 目录</h1><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Mybatis/image-20240219205704269.png" alt="image-20240219205704269"></p><h1 id="1-Maven工程"><a href="#1-Maven工程" class="headerlink" title="1 Maven工程"></a>1 Maven工程</h1><ol><li><p>设置打包方式</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.xxxx.xxx<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>MyBatis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">packaging</span>&gt;</span>jar<span class="hljs-tag">&lt;/<span class="hljs-name">packaging</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>引入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>  <span class="hljs-comment">&lt;!-- Mybatis核心 --&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.7<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-comment">&lt;!-- junit测试 --&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.12<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-comment">&lt;!-- MySQL驱动 --&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.0.23<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure></li></ol><h1 id="2-数据库准备"><a href="#2-数据库准备" class="headerlink" title="2 数据库准备"></a>2 数据库准备</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `t_user` (<br>  `id` <span class="hljs-type">int</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,<br>  `username` <span class="hljs-type">varchar</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">COLLATE</span> utf8mb4_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  `password` <span class="hljs-type">varchar</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">COLLATE</span> utf8mb4_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  `age` <span class="hljs-type">int</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  `gender` <span class="hljs-type">char</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">COLLATE</span> utf8mb4_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  `email` <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">COLLATE</span> utf8mb4_general_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 <span class="hljs-keyword">COLLATE</span><span class="hljs-operator">=</span>utf8mb4_general_ci;<br><br></code></pre></td></tr></table></figure><h1 id="3-创建Mybatis核心文件"><a href="#3-创建Mybatis核心文件" class="headerlink" title="3 创建Mybatis核心文件"></a>3 创建Mybatis核心文件</h1><p>核心文件取名：mybatis-config.xml，存放位置src&#x2F;main&#x2F;resources</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span> ?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">configuration</span></span><br><span class="hljs-meta">        <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span></span><br><span class="hljs-meta">        <span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--设置连接数据库的环境--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">environments</span> <span class="hljs-attr">default</span>=<span class="hljs-string">&quot;development&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">environment</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;development&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">transactionManager</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;JDBC&quot;</span>/&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dataSource</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;POOLED&quot;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;driver&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>/&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;url&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;jdbc:mysql://localhost:3306/ssm?serverTimezone=UTC&quot;</span>/&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;username&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;root&quot;</span>/&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;password&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;root&quot;</span>/&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dataSource</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">environment</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">environments</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--引入mybatis映射文件--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">mappers</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">resource</span>=<span class="hljs-string">&quot;mappers/UserMapper.xml&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">mappers</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br></code></pre></td></tr></table></figure><h1 id="4-实体类、mapper接口"><a href="#4-实体类、mapper接口" class="headerlink" title="4 实体类、mapper接口"></a>4 实体类、mapper接口</h1><ol><li><p>实体类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> &#123;<br><br>  <span class="hljs-keyword">private</span> Integer id;<br><br>  <span class="hljs-keyword">private</span> String username;<br><br>  <span class="hljs-keyword">private</span> String password;<br><br>  <span class="hljs-keyword">private</span> Integer age;<br><br>  <span class="hljs-keyword">private</span> String gender;<br><br>  <span class="hljs-keyword">private</span> String email;<br>&#125;<br><br></code></pre></td></tr></table></figure></li><li><p>mapper接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserMapper</span> &#123;<br>    <span class="hljs-comment">//添加用户信息</span><br>    <span class="hljs-type">int</span> <span class="hljs-title function_">insertUser</span><span class="hljs-params">()</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure></li></ol><h1 id="5-映射文件"><a href="#5-映射文件" class="headerlink" title="5 映射文件"></a>5 映射文件</h1><blockquote><ol><li>mapper接口的全类名和映射文件的命名空间（namespace）保持一致，在resource下使用&#x2F;代替.</li><li>mapper接口中方法的方法名和映射文件中编写SQL的标签的id属性保持一致</li></ol></blockquote><p>UserMapper.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span> ?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">mapper</span></span><br><span class="hljs-meta">        <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span><br><span class="hljs-meta">        <span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">&quot;com.xxxx.xxx.mapper.UserMapper&quot;</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!--</span><br><span class="hljs-comment">        mapper接口和映射文件要保证两个一致：</span><br><span class="hljs-comment">        1.mapper接口的全类名和映射文件的namespace一致</span><br><span class="hljs-comment">        2.mapper接口中的方法的方法名要和映射文件中的sql语句的id保持一致</span><br><span class="hljs-comment">    --&gt;</span><br><br>    <span class="hljs-comment">&lt;!--添加--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">insert</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;insertUser&quot;</span>&gt;</span><br>        insert into t_user values(null,&#x27;张三&#x27;,&#x27;123&#x27;,23,&#x27;男&#x27;,&quot;123@163.com&quot;)<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">insert</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span><br><br></code></pre></td></tr></table></figure><h1 id="6-测试"><a href="#6-测试" class="headerlink" title="6 测试"></a>6 测试</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyBatisTest</span> &#123;<br>  <span class="hljs-meta">@Test</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testInsertUser</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>      <span class="hljs-comment">//获取核心配置文件的输入流</span><br>      <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> Resources.getResourceAsStream(<span class="hljs-string">&quot;mybatis-config.xml&quot;</span>);<br>      <span class="hljs-comment">//获取SqlSessionFactoryBuilder对象</span><br>      <span class="hljs-type">SqlSessionFactoryBuilder</span> <span class="hljs-variable">sqlSessionFactoryBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSessionFactoryBuilder</span>();<br>      <span class="hljs-comment">//获取SqlSessionFactory对象</span><br>      <span class="hljs-type">SqlSessionFactory</span> <span class="hljs-variable">sqlSessionFactory</span> <span class="hljs-operator">=</span> sqlSessionFactoryBuilder.build(inputStream);<br>      <span class="hljs-comment">//获取sql的会话对象SqlSession(不会自动提交事务)，是MyBatis提供的操作数据库的对象</span><br>      <span class="hljs-type">SqlSession</span> <span class="hljs-variable">sqlSession</span> <span class="hljs-operator">=</span> sqlSessionFactory.openSession();<br>      <span class="hljs-comment">//获取sql的会话对象SqlSession(会自动提交事务)，是MyBatis提供的操作数据库的对象</span><br>      <span class="hljs-comment">//SqlSession sqlSession = sqlSessionFactory.openSession(true);</span><br>      <span class="hljs-comment">//获取UserMapper的代理实现对象getMapper(Class&lt;T&gt; var1)</span><br>      <span class="hljs-type">UserMapper</span> <span class="hljs-variable">userMapper</span> <span class="hljs-operator">=</span> sqlSession.getMapper(UserMapper.class);<br>      <span class="hljs-comment">//调用mapper接口中的方法，实现添加用户信息的功能</span><br>      <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> userMapper.insertUser();<br>      <span class="hljs-comment">//通过sql语句的唯一标识找到sql并执行，唯一标识是namespace.sqlId</span><br>      <span class="hljs-comment">//int result = sqlSession.insert(&quot;com.xxxx.lln.mapper.UserMapper.insertUser&quot;);</span><br>      System.out.println(<span class="hljs-string">&quot;返回结果：&quot;</span>+result);<br>      <span class="hljs-comment">//提交事务</span><br>      sqlSession.commit();<br>      <span class="hljs-comment">//关闭会话</span><br>      sqlSession.close();<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h1 id="7-日志"><a href="#7-日志" class="headerlink" title="7 日志"></a>7 日志</h1><ol><li><p>引入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- log4j日志 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>log4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>log4j<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.17<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br></code></pre></td></tr></table></figure></li><li><p>log4j.xml，位置src&#x2F;main&#x2F;resources</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span> ?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">log4j</span>:configuration <span class="hljs-keyword">SYSTEM</span> <span class="hljs-string">&quot;log4j.dtd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">log4j:configuration</span> <span class="hljs-attr">xmlns:log4j</span>=<span class="hljs-string">&quot;http://jakarta.apache.org/log4j/&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">appender</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;STDOUT&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.apache.log4j.ConsoleAppender&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">param</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;Encoding&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;UTF-8&quot;</span> /&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">layout</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.apache.log4j.PatternLayout&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">param</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;ConversionPattern&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;%-5p %d&#123;MM-dd HH:mm:ss,SSS&#125;</span></span><br><span class="hljs-string"><span class="hljs-tag">%m (%F:%L) \n&quot;</span> /&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">layout</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">appender</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">logger</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;java.sql&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">level</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;debug&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">logger</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">logger</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;org.apache.ibatis&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">level</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;info&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">logger</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">root</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">level</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;debug&quot;</span> /&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">appender-ref</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;STDOUT&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">root</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">log4j:configuration</span>&gt;</span><br><br></code></pre></td></tr></table></figure></li></ol><h1 id="8-工具类"><a href="#8-工具类" class="headerlink" title="8 工具类"></a>8 工具类</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SqlSessionUtil</span> &#123;<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SqlSession <span class="hljs-title function_">getSqlSession</span><span class="hljs-params">()</span>&#123;<br>      <span class="hljs-comment">//创建sql的会话对象SqlSession</span><br>      <span class="hljs-type">SqlSession</span> <span class="hljs-variable">sqlSession</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>      <span class="hljs-keyword">try</span> &#123;<br>          <span class="hljs-comment">//获取核心配置文件的输入流</span><br>          <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> Resources.getResourceAsStream(<span class="hljs-string">&quot;mybatis-config.xml&quot;</span>);<br>          <span class="hljs-comment">//获取SqlSessionFactoryBuilder对象</span><br>          <span class="hljs-type">SqlSessionFactoryBuilder</span> <span class="hljs-variable">sqlSessionFactoryBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSessionFactoryBuilder</span>();<br>          <span class="hljs-comment">//获取SqlSessionFactory对象</span><br>          <span class="hljs-type">SqlSessionFactory</span> <span class="hljs-variable">sqlSessionFactory</span> <span class="hljs-operator">=</span> sqlSessionFactoryBuilder.build(inputStream);<br>          <span class="hljs-comment">//配置sql的会话对象SqlSession(会自动提交事务)，是MyBatis提供的操作数据库的对象</span><br>          sqlSession = sqlSessionFactory.openSession(<span class="hljs-literal">true</span>);<br>      &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>          e.printStackTrace();<br>      &#125;<br>      <span class="hljs-keyword">return</span> sqlSession;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="9-增删改查"><a href="#9-增删改查" class="headerlink" title="9 增删改查"></a>9 增删改查</h1><ol><li><p>mapper接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserMapper</span> &#123;<br><br>  <span class="hljs-comment">//添加用户信息</span><br>  <span class="hljs-type">int</span> <span class="hljs-title function_">insertUser</span><span class="hljs-params">()</span>;<br><br>  <span class="hljs-comment">//删除用户信息</span><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteUser</span><span class="hljs-params">()</span>;<br><br>  <span class="hljs-comment">//修改用户信息</span><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateUser</span><span class="hljs-params">()</span>;<br><br>  <span class="hljs-comment">//通过id查询一个实体类对象</span><br>  User <span class="hljs-title function_">getUserById</span><span class="hljs-params">()</span>;<br><br>  <span class="hljs-comment">//查询实体类集合</span><br>  List&lt;User&gt; <span class="hljs-title function_">getUserList</span><span class="hljs-params">()</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>xml文件</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span> ?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">mapper</span></span><br><span class="hljs-meta">        <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span><br><span class="hljs-meta">        <span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">&quot;com.xxxx.xxx.mapper.UserMapper&quot;</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!--</span><br><span class="hljs-comment">        mapper接口和映射文件要保证两个一致：</span><br><span class="hljs-comment">        1.mapper接口的全类名和映射文件的namespace一致</span><br><span class="hljs-comment">        2.mapper接口中的方法的方法名要和映射文件中的sql语句的id保持一致</span><br><span class="hljs-comment">    --&gt;</span><br><br>    <span class="hljs-comment">&lt;!--添加用户信息--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">insert</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;insertUser&quot;</span>&gt;</span><br>        insert into t_user values(null,&#x27;张三&#x27;,&#x27;123&#x27;,23,&#x27;男&#x27;,&quot;123@163.com&quot;)<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">insert</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!--删除用户信息--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">delete</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;deleteUser&quot;</span>&gt;</span><br>        delete from t_user where id = 2<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">delete</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!--修改用户信息--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;updateUser&quot;</span>&gt;</span><br>        update t_user set username=&#x27;ybc&#x27;,password=&#x27;123&#x27; where id = 3<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!--</span><br><span class="hljs-comment">        resultType：自动映射，用于属性名和表中字段名一致的情况</span><br><span class="hljs-comment">        resultMap：自定义映射，用于一对多或多对一或字段名和属性名不一致的情况</span><br><span class="hljs-comment">    --&gt;</span><br><br>    <span class="hljs-comment">&lt;!--通过id查询一个实体类对象--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;getUserById&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;com.xxxx.lln.pojo.User&quot;</span>&gt;</span><br>        select * from t_user where id = 3<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!--查询实体类集合--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;getUserList&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;com.xxxx.lln.pojo.User&quot;</span>&gt;</span><br>        select * from t_user<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>代码测试</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyBatisTest</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 测试添加用户信息</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IOException</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testInsertUser</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-comment">//获取核心配置文件的输入流</span><br>        <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> Resources.getResourceAsStream(<span class="hljs-string">&quot;mybatis-config.xml&quot;</span>);<br>        <span class="hljs-comment">//获取SqlSessionFactoryBuilder对象</span><br>        <span class="hljs-type">SqlSessionFactoryBuilder</span> <span class="hljs-variable">sqlSessionFactoryBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSessionFactoryBuilder</span>();<br>        <span class="hljs-comment">//获取SqlSessionFactory对象</span><br>        <span class="hljs-type">SqlSessionFactory</span> <span class="hljs-variable">sqlSessionFactory</span> <span class="hljs-operator">=</span> sqlSessionFactoryBuilder.build(inputStream);<br>        <span class="hljs-comment">//获取sql的会话对象SqlSession(不会自动提交事务)，是MyBatis提供的操作数据库的对象</span><br>        <span class="hljs-type">SqlSession</span> <span class="hljs-variable">sqlSession</span> <span class="hljs-operator">=</span> sqlSessionFactory.openSession();<br>        <span class="hljs-comment">//获取sql的会话对象SqlSession(会自动提交事务)，是MyBatis提供的操作数据库的对象</span><br>        <span class="hljs-comment">//SqlSession sqlSession = sqlSessionFactory.openSession(true);</span><br>        <span class="hljs-comment">//获取UserMapper的代理实现对象getMapper(Class&lt;T&gt; var1)</span><br>        <span class="hljs-type">UserMapper</span> <span class="hljs-variable">userMapper</span> <span class="hljs-operator">=</span> sqlSession.getMapper(UserMapper.class);<br>        <span class="hljs-comment">//调用mapper接口中的方法，实现添加用户信息的功能</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> userMapper.insertUser();<br>        <span class="hljs-comment">//通过sql语句的唯一标识找到sql并执行，唯一标识是namespace.sqlId</span><br>        <span class="hljs-comment">//int result = sqlSession.insert(&quot;com.xxxx.lln.mapper.UserMapper.insertUser&quot;);</span><br>        System.out.println(<span class="hljs-string">&quot;返回结果：&quot;</span>+result);<br>        <span class="hljs-comment">//提交事务</span><br>        sqlSession.commit();<br>        <span class="hljs-comment">//关闭会话</span><br>        sqlSession.close();<br>    &#125;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 测试删除用户信息</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testDeleteUser</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">SqlSession</span> <span class="hljs-variable">sqlSession</span> <span class="hljs-operator">=</span> SqlSessionUtil.getSqlSession();<br>        <span class="hljs-type">UserMapper</span> <span class="hljs-variable">userMapper</span> <span class="hljs-operator">=</span> sqlSession.getMapper(UserMapper.class);<br>        userMapper.deleteUser();<br>        sqlSession.close();<br>    &#125;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 测试修改用户信息</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testUpdateUser</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">SqlSession</span> <span class="hljs-variable">sqlSession</span> <span class="hljs-operator">=</span> SqlSessionUtil.getSqlSession();<br>        <span class="hljs-type">UserMapper</span> <span class="hljs-variable">userMapper</span> <span class="hljs-operator">=</span> sqlSession.getMapper(UserMapper.class);<br>        userMapper.updateUser();<br>        sqlSession.close();<br>    &#125;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 通过id查询一个实体类对象</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testGetUserById</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">SqlSession</span> <span class="hljs-variable">sqlSession</span> <span class="hljs-operator">=</span> SqlSessionUtil.getSqlSession();<br>        <span class="hljs-type">UserMapper</span> <span class="hljs-variable">userMapper</span> <span class="hljs-operator">=</span> sqlSession.getMapper(UserMapper.class);<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userMapper.getUserById();<br>        System.out.println(user);<br>        sqlSession.close();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 查询实体类对象集合</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testGetUserList</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">SqlSession</span> <span class="hljs-variable">sqlSession</span> <span class="hljs-operator">=</span> SqlSessionUtil.getSqlSession();<br>        <span class="hljs-type">UserMapper</span> <span class="hljs-variable">userMapper</span> <span class="hljs-operator">=</span> sqlSession.getMapper(UserMapper.class);<br>        List&lt;User&gt; userList = userMapper.getUserList();<br>userList.forEach(System.out::println);<br>        sqlSession.close();<br>    &#125;<br><br><br>&#125;<br></code></pre></td></tr></table></figure></li></ol><blockquote><ol><li><p>查询的标签select必须设置属性resultType或resultMap，用于设置实体类和数据库表的映射关系</p><ol><li>resultType：自动映射，用于属性名和表中字段名一致的情况</li><li>resultMap：自定义映射，用于一对多或多对一或字段名和属性名不一致的情况</li></ol></li><li><p>当查询的数据为多条时，不能使用实体类作为返回值，只能使用集合，否则会抛出异常</p><p>TooManyResultsException；但是若查询的数据只有一条，可以使用实体类或集合作为返回值</p></li></ol></blockquote><h1 id="10-核心文件详解"><a href="#10-核心文件详解" class="headerlink" title="10 核心文件详解"></a>10 核心文件详解</h1><p>顺序：</p><p>properties?,settings?,typeAliases?,typeHandlers?,objectFactory?,objectWrapperFactory?,</p><p>reflectorFactory?,plugins?,environments?,databaseIdProvider?,mappers?</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span> ?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">configuration</span></span><br><span class="hljs-meta">        <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span></span><br><span class="hljs-meta">        <span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br><br><br>    <span class="hljs-comment">&lt;!--引入properties文件，此时就可以$&#123;属性名&#125;的方式访问属性值--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span> <span class="hljs-attr">resource</span>=<span class="hljs-string">&quot;jdbc.properties&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">settings</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--将表中字段的下划线自动转换为驼峰--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">setting</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;mapUnderscoreToCamelCase&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span>/&gt;</span><br>        <span class="hljs-comment">&lt;!--开启延迟加载--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">setting</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;lazyLoadingEnabled&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">settings</span>&gt;</span><br><br><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">typeAliases</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--</span><br><span class="hljs-comment">            typeAlias：设置某个具体的类型的别名</span><br><span class="hljs-comment">            属性： type：需要设置别名的类型的全类名</span><br><span class="hljs-comment">            alias：设置此类型的别名，若不设置此属性，该类型拥有默认的别名，即类名且不区分大小写</span><br><span class="hljs-comment">            若设置此属性，此时该类型的别名只能使用alias所设置的值</span><br><span class="hljs-comment">        --&gt;</span><br>        <span class="hljs-comment">&lt;!--&lt;typeAlias type=&quot;com.atguigu.mybatis.bean.User&quot;&gt;&lt;/typeAlias&gt;--&gt;</span><br>        <span class="hljs-comment">&lt;!--&lt;typeAlias type=&quot;com.atguigu.mybatis.bean.User&quot; alias=&quot;abc&quot;&gt; &lt;/typeAlias&gt;--&gt;</span><br>        <span class="hljs-comment">&lt;!--以包为单位，设置改包下所有的类型都拥有默认的别名，即类名且不区分大小写--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">package</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;com.atguigu.mybatis.bean&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">typeAliases</span>&gt;</span><br><br><br>    <span class="hljs-comment">&lt;!--environments：设置多个连接数据库的环境 属性： default：设置默认使用的环境的id --&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">environments</span> <span class="hljs-attr">default</span>=<span class="hljs-string">&quot;mysql_test&quot;</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--</span><br><span class="hljs-comment">            environment：设置具体的连接数据库的环境信息</span><br><span class="hljs-comment">            属性： id：设置环境的唯一标识，可通过environments标签中的default设置某一个环境的id， 表示默认使用的环境</span><br><span class="hljs-comment">        --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">environment</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;mysql_test&quot;</span>&gt;</span><br>            <span class="hljs-comment">&lt;!--</span><br><span class="hljs-comment">                transactionManager：设置事务管理方式 属性：</span><br><span class="hljs-comment">                type：设置事务管理方式，type=&quot;JDBC|MANAGED&quot; type=&quot;JDBC&quot;：设置当前环境的事务管理都必须手动处理</span><br><span class="hljs-comment">                type=&quot;MANAGED&quot;：设置事务被管理，例如spring中的AOP</span><br><span class="hljs-comment">            --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">transactionManager</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;JDBC&quot;</span>/&gt;</span><br><br><br>            <span class="hljs-comment">&lt;!--</span><br><span class="hljs-comment">                dataSource：设置数据源</span><br><span class="hljs-comment">                属性：type：设置数据源的类型，type=&quot;POOLED|UNPOOLED|JNDI&quot;</span><br><span class="hljs-comment">                type=&quot;POOLED&quot;：使用数据库连接池，即会将创建的连接进行缓存，下次使用可以从缓存中直接获取，不需要重新创建</span><br><span class="hljs-comment">                type=&quot;UNPOOLED&quot;：不使用数据库连接池，即每次使用连接都需要重新创建</span><br><span class="hljs-comment">                type=&quot;JNDI&quot;：调用上下文中的数据源</span><br><span class="hljs-comment">            --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dataSource</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;POOLED&quot;</span>&gt;</span><br>                <span class="hljs-comment">&lt;!--设置驱动类的全类名--&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;driver&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;$&#123;jdbc.driver&#125;&quot;</span>/&gt;</span><br>                <span class="hljs-comment">&lt;!--设置连接数据库的连接地址--&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;url&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;$&#123;jdbc.url&#125;&quot;</span>/&gt;</span><br>                <span class="hljs-comment">&lt;!--设置连接数据库的用户名--&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;username&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;$&#123;jdbc.username&#125;&quot;</span>/&gt;</span><br>                <span class="hljs-comment">&lt;!--设置连接数据库的密码--&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;password&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;$&#123;jdbc.password&#125;&quot;</span>/&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dataSource</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">environment</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">environments</span>&gt;</span><br><br><br><br>    <span class="hljs-comment">&lt;!--引入映射文件--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">mappers</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">resource</span>=<span class="hljs-string">&quot;UserMapper.xml&quot;</span>/&gt;</span><br>        <span class="hljs-comment">&lt;!--</span><br><span class="hljs-comment">            以包为单位，将包下所有的映射文件引入核心配置文件</span><br><span class="hljs-comment">            注意：此方式必须保证mapper接口和mapper映射文件必须在相同的包下</span><br><span class="hljs-comment">            接口名和映射文件名字一致</span><br><span class="hljs-comment">            创建包的时候以斜线为分隔符</span><br><span class="hljs-comment">        --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">package</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;com.atguigu.mybatis.mapper&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">mappers</span>&gt;</span><br><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>mybatis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mybatis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>redis-缓存</title>
    <link href="/redis-%E7%BC%93%E5%AD%98/22e726666a0f/"/>
    <url>/redis-%E7%BC%93%E5%AD%98/22e726666a0f/</url>
    
    <content type="html"><![CDATA[<h1 id="0-目录"><a href="#0-目录" class="headerlink" title="0 目录"></a>0 目录</h1><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/image-20240217144633116.png" alt="image-20240217144633116"></p><h1 id="1-什么是缓存"><a href="#1-什么是缓存" class="headerlink" title="1 什么是缓存"></a>1 什么是缓存</h1><p>缓存就是数据交换的缓冲区（称作Cache），是存储数据的临时地方，一般读写性能较高</p><h2 id="1-1-作用"><a href="#1-1-作用" class="headerlink" title="1.1 作用"></a>1.1 作用</h2><ul><li>降低后端负载</li><li>提高读写效率，降低响应时间</li></ul><h2 id="1-2-成本"><a href="#1-2-成本" class="headerlink" title="1.2 成本"></a>1.2 成本</h2><ul><li>数据一致性成本</li><li>代码维护成本</li><li>运维成本</li></ul><h1 id="2-添加Redis缓存"><a href="#2-添加Redis缓存" class="headerlink" title="2 添加Redis缓存"></a>2 添加Redis缓存</h1><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/f5fab07a6b6c428686526e0703545046.png" alt="img"></p><ul><li>即：在客户端和数据库之间加一层redis，这样就可以减轻数据库的压力。</li></ul><h1 id="3-缓存更新策略"><a href="#3-缓存更新策略" class="headerlink" title="3 缓存更新策略"></a>3 缓存更新策略</h1><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/fab53328769e46539e642d34dad23b6b.png" alt="img"></p><h2 id="3-1-具体业务场景"><a href="#3-1-具体业务场景" class="headerlink" title="3.1 具体业务场景"></a>3.1 具体业务场景</h2><ul><li><p>低一致性需求：使用内存淘汰机制。例如店铺类型的查询缓存</p></li><li><p>高一致性需求：主动更新，并以超时剔除作为兜底方案。例如店铺详情查询的缓存</p></li></ul><h2 id="3-2-主动更新策略"><a href="#3-2-主动更新策略" class="headerlink" title="3.2 主动更新策略"></a>3.2 主动更新策略</h2><p>即：由缓存调用者在更新数据库的同时更新缓存。</p><h3 id="3-2-1-注意点"><a href="#3-2-1-注意点" class="headerlink" title="3.2.1 注意点"></a>3.2.1 注意点</h3><ul><li>删除还是更新缓存？<ul><li>更新缓存：每次更新都更新缓存，无效写操作较多</li><li>删除缓存：更新数据库时让缓存失效，查询时再更新缓存（胜出）</li></ul></li><li>如何保证缓存和数据库的操作的同时成功或失败？<ul><li>更新缓存：每次更新都更新缓存，无效写操作较多</li><li>删除缓存：更新数据库时让缓存失效，查询时再更新缓存（胜出）</li></ul></li><li>先操作缓存还是先操作数据库？<ul><li>先操作数据库再删缓存，因为出现数据不一致的前提：1.  刚好缓存失效；2. 另一个线程写入时间在前一个线程查询数据库到写入缓存的几短时间内进行了更新操作</li></ul></li></ul><blockquote><ul><li>读操作：<ul><li>缓存命中就返回</li><li>缓存没有命中查数据库，写入缓存同时设定超时时间</li></ul></li><li>写操作：<ul><li>先写数据库再删缓存</li><li>确保数据库和缓存操作的原子性</li></ul></li></ul></blockquote><h2 id="3-3-实现缓存和数据库的双写一致"><a href="#3-3-实现缓存和数据库的双写一致" class="headerlink" title="3.3 实现缓存和数据库的双写一致"></a>3.3 实现缓存和数据库的双写一致</h2><p>在单体系统中，更新方法使用<code>@Transactional</code>对方法进行标记</p><h1 id="4-缓存穿透"><a href="#4-缓存穿透" class="headerlink" title="4 缓存穿透"></a>4 缓存穿透</h1><p>缓存穿透是指客户端请求的数据在缓存中和数据库中都不存在，这样缓存永远不会生效，这些请求都会打到数据库</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/ae54cd7944a94a66b442ccccf97e56d3.png" alt="img"></p><h2 id="4-1-解决"><a href="#4-1-解决" class="headerlink" title="4.1 解决"></a>4.1 解决</h2><ol><li><p>缓存null值</p></li><li><p>布隆过滤</p></li><li><p>增强id的复杂度，避免被猜测id规律</p></li><li><p>做好数据的基础格式校验</p></li><li><p>加强用户权限校验</p></li><li><p>做好热点参数的限流</p></li></ol><h3 id="4-1-1-空值解决"><a href="#4-1-1-空值解决" class="headerlink" title="4.1.1 空值解决"></a>4.1.1 空值解决</h3><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/477d7458be374f6da2c101233ee80aac.png" alt="img"></p><p>步骤</p><ol><li>当缓存没有命中的时候，查询数据库</li><li>判断数据库的数据是否存在<ol><li>存在：将数据写入缓存同时返回</li><li>不存在：写入空值到缓存</li></ol></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">queryById</span><span class="hljs-params">(Long id)</span> &#123;<br>    String key=CACHE_SHOP_KEY+id;<br>    <span class="hljs-comment">//1.从redis查询商铺缓存</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">shopJson</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().get(key);<br>    <span class="hljs-comment">//2.判断是否存在</span><br>    <span class="hljs-keyword">if</span>(StrUtil.isNotBlank(shopJson)) &#123;<br>        <span class="hljs-comment">//3.存在，直接返回</span><br>        <span class="hljs-type">Shop</span> <span class="hljs-variable">shop</span> <span class="hljs-operator">=</span> JSONUtil.toBean(shopJson, Shop.class);<br>        <span class="hljs-keyword">return</span> Result.ok(shop);<br>    &#125;<br>    <span class="hljs-comment">//命中的是否为空值</span><br>    <span class="hljs-keyword">if</span>(<span class="hljs-string">&#x27;&#x27;</span>.equals(shopJson))&#123;<br>        <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;店铺信息不存在！&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">//4.不存在，根据id查询数据库</span><br>    <span class="hljs-type">Shop</span> <span class="hljs-variable">shop</span> <span class="hljs-operator">=</span> getById(id);<br>    <span class="hljs-comment">//5.不存在，返回错误</span><br>    <span class="hljs-keyword">if</span>(shop==<span class="hljs-literal">null</span>)&#123;<br>        <span class="hljs-comment">//将空值写入redis</span><br>        stringRedisTemplate.opsForValue().set(key,<span class="hljs-string">&quot;&quot;</span>,CACHE_NULL_TTL,TimeUnit.MINUTES);<br>        <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;店铺信息不存在！&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">//6.存在，写入redis</span><br>    stringRedisTemplate.opsForValue().set(key,JSONUtil.toJsonStr(shop),CACHE_SHOP_TTL, TimeUnit.MINUTES);<br>    <span class="hljs-comment">//7.返回</span><br>    <span class="hljs-keyword">return</span> Result.ok(shop);<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="5-缓存雪崩"><a href="#5-缓存雪崩" class="headerlink" title="5 缓存雪崩"></a>5 缓存雪崩</h1><p>缓存雪崩是指同一时刻大量的缓存key同时失效或者redis服务宕机，导致大量请求到达数据库，带来巨大压力</p><h2 id="5-1-解决"><a href="#5-1-解决" class="headerlink" title="5.1 解决"></a>5.1 解决</h2><p>给不同的Key的TTL添加随机值</p><p>利用Redis集群提高服务的可用性</p><p>给缓存业务添加降级限流策略</p><p>给业务添加多级缓存</p><h1 id="6-缓存击穿"><a href="#6-缓存击穿" class="headerlink" title="6 缓存击穿"></a>6 缓存击穿</h1><p>缓存击穿问题也叫热点Key问题，就是一个被高并发访问并且缓存重建业务较复杂的key突然失效了，无数的请求访问会在瞬间给数据库带来巨大的冲击。</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/c21f331b1b9e45cfb8bc40d960a1c21e.png" alt="img"></p><h2 id="6-1-解决"><a href="#6-1-解决" class="headerlink" title="6.1 解决"></a>6.1 解决</h2><blockquote><p>前言：涉及到互斥锁，使用redis的一个命令：setnx</p></blockquote><h3 id="6-1-1-互斥锁解决"><a href="#6-1-1-互斥锁解决" class="headerlink" title="6.1.1 互斥锁解决"></a>6.1.1 互斥锁解决</h3><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/image-20240218202535260.png" alt="image-20240218202535260"></p><p>即：当第一个线程查询缓存的时候，没有实现命中，此时第一个线程开始获取互斥锁，当锁获取成功之后，开始查询数据库进行缓存的重建，查询完成之后写入缓存，最后释放锁</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/f30a477e296542b888949cfcb0d2f356.png" alt="img"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Shop <span class="hljs-title function_">queryWithMutex</span><span class="hljs-params">(Long id)</span>&#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> CACHE_SHOP_KEY+id;<br>    <span class="hljs-comment">//从redis查询商铺缓存</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">shopJson</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().get(key);<br>    <span class="hljs-comment">//判断缓存是否命中</span><br>    <span class="hljs-keyword">if</span>(StrUtil.isNotBlank(shopJson))&#123;<br>        <span class="hljs-comment">//命中则直接返回数据</span><br>        <span class="hljs-keyword">return</span> JSONUtil.toBean(shopJson, Shop.class);<br>    &#125;<br>    <span class="hljs-comment">//判断是否是缓存穿透</span><br>    <span class="hljs-keyword">if</span>(<span class="hljs-string">&#x27;&#x27;</span>.equals(shopJson))&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-comment">//实现缓存重建</span><br>    <span class="hljs-comment">//1.获取互斥锁</span><br>    String lockKey=LOCK_SHOP_KEY+id;<br>   <span class="hljs-keyword">try</span>&#123;<br>       <span class="hljs-type">boolean</span> <span class="hljs-variable">isLock</span> <span class="hljs-operator">=</span> tryLock(lockKey);<br>       <span class="hljs-comment">//2.判断是否获取成功</span><br>       <span class="hljs-keyword">if</span>(!isLock) &#123;<br>           <span class="hljs-comment">//3.失败，则休眠并重试</span><br>           Thread.sleep(<span class="hljs-number">50</span>);<br>           queryWithMutex(id);<br>       &#125;<br>      <span class="hljs-comment">//<span class="hljs-doctag">TODO:</span> 此时锁获取成功之后，应该再查询一下缓存，实现双重检查</span><br>       <span class="hljs-comment">//4.成功，根据id查询数据库</span><br>       <span class="hljs-type">Shop</span> <span class="hljs-variable">shop</span> <span class="hljs-operator">=</span> getById(id);<br>       <span class="hljs-comment">//5.不存在，返回错误</span><br>       <span class="hljs-keyword">if</span>(shop==<span class="hljs-literal">null</span>)&#123;<br>           stringRedisTemplate.opsForValue().set(key,<span class="hljs-string">&quot;&quot;</span>,CACHE_NULL_TTL,TimeUnit.MINUTES);<br>           <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>       &#125;<br>       <span class="hljs-comment">//6.存在，写入redis</span><br>       stringRedisTemplate.opsForValue().set(key,JSONUtil.toJsonStr(shop),CACHE_SHOP_TTL,TimeUnit.MINUTES);<br>       <span class="hljs-keyword">return</span> shop;<br>   &#125;<span class="hljs-keyword">catch</span>(InterruptedException e)&#123;<br>       <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>   &#125;<span class="hljs-keyword">finally</span>&#123;<br>       unlock(lockKey);<br>   &#125;<br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">(String key)</span>&#123;<br>    <span class="hljs-type">Boolean</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().setIfAbsent(key, <span class="hljs-string">&quot;1&quot;</span>, LOCK_SHOP_TTL, TimeUnit.MINUTES);<br>    <span class="hljs-keyword">return</span> BooleanUtil.isTrue(flag); <span class="hljs-comment">//为防止程序在拆箱的时候出现空指针，要手动拆箱</span><br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">(String key)</span>&#123;<br>    stringRedisTemplate.delete(key);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="6-1-2-逻辑过期解决"><a href="#6-1-2-逻辑过期解决" class="headerlink" title="6.1.2 逻辑过期解决"></a>6.1.2 逻辑过期解决</h3><ul><li>热点key需要先进行预热，将相关数据先放入缓存中，设定的过期时间不是redis的TTL，而是一个逻辑上认定会过期的时间</li></ul><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/image-20240218202644763.png" alt="image-20240218202644763"></p><p>即：当缓存命中的时候，判断设定的缓存逻辑时间是否过期，如果没有，那么就直接返回数据信息；如果过期了，先尝试获取互斥锁，当获取到锁，如果获取锁失败了，将旧数据返回即可；如果获取锁成功，那么开启一个独立的线程进行查询数据库，写入缓存，以及设定逻辑过期时间，最后释放互斥锁。</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/a44029589bb94df680da373e291c346f.png" alt="img"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ExecutorService CACHE_REBUILD_EXECUTOR= Executors.newFixedThreadPool(<span class="hljs-number">10</span>);<br><br><span class="hljs-keyword">public</span> Shop <span class="hljs-title function_">queryWithLogicalExpire</span><span class="hljs-params">(Long id)</span>&#123;<br>    String key=CACHE_SHOP_KEY+id;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">shopJson</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().get(key);<br>    <span class="hljs-comment">//缓存未命中</span><br>    <span class="hljs-keyword">if</span>(StrUtil.isBlank(shopJson))&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-comment">//命中，需要先把json反序列化为对象</span><br>    <span class="hljs-type">RedisData</span> <span class="hljs-variable">redisData</span> <span class="hljs-operator">=</span> JSONUtil.toBean(shopJson, RedisData.class);<br>    <span class="hljs-type">Shop</span> <span class="hljs-variable">shop</span> <span class="hljs-operator">=</span> JSONUtil.toBean((JSONObject) redisData.getData(), Shop.class);<br>    <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">expireTime</span> <span class="hljs-operator">=</span> redisData.getExpireTime();<br>    <span class="hljs-comment">//判断是否过期</span><br>    <span class="hljs-keyword">if</span>(expireTime.isAfter(LocalDateTime.now())) &#123;<br>        <span class="hljs-comment">//未过期,直接返回店铺信息</span><br>        <span class="hljs-keyword">return</span> shop;<br>    &#125;<br>    <span class="hljs-comment">//已过期，需要缓存重建</span><br>    String lockKey=LOCK_SHOP_KEY+id;<br>    <span class="hljs-comment">//获取互斥锁</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">isLock</span> <span class="hljs-operator">=</span> tryLock(lockKey);<br>    <span class="hljs-comment">//判断是否获取锁成功</span><br>    <span class="hljs-keyword">if</span>(isLock) &#123;<br>        <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> 获取锁成功之后，再尝试获取一下缓存数据，没有就开启独立线程实现缓存重建</span><br>        <span class="hljs-comment">//成功，开启独立线程，实现缓存重建</span><br>        CACHE_REBUILD_EXECUTOR.submit(()-&gt;&#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                saveShop2Redis(id, CACHE_SHOP_TTL);<br>            &#125;<span class="hljs-keyword">catch</span>(Exception e)&#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>            &#125;<span class="hljs-keyword">finally</span>&#123;<br>                unlock(lockKey);<br>            &#125;<br>        &#125;);<br>    &#125;<br>    <span class="hljs-comment">//返过期的商铺信息</span><br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">(String key)</span>&#123;<br>    <span class="hljs-type">Boolean</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().setIfAbsent(key, <span class="hljs-string">&quot;1&quot;</span>, LOCK_SHOP_TTL, TimeUnit.MINUTES);<br>    <span class="hljs-keyword">return</span> BooleanUtil.isTrue(flag); <span class="hljs-comment">//为防止程序在拆箱的时候出现空指针，要手动拆箱</span><br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">(String key)</span>&#123;<br>    stringRedisTemplate.delete(key);<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveShop2Redis</span><span class="hljs-params">(Long id,Long expireSeconds)</span>&#123;<br>    <span class="hljs-comment">//1.查询店铺数据</span><br>    <span class="hljs-type">Shop</span> <span class="hljs-variable">shop</span> <span class="hljs-operator">=</span> getById(id);<br>    <span class="hljs-comment">//2.封装逻辑过期时间</span><br>    <span class="hljs-type">RedisData</span> <span class="hljs-variable">redisData</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisData</span>();<br>    redisData.setData(shop);<br>    redisData.setExpireTime(LocalDateTime.now().plusSeconds(expireSeconds));<br>    <span class="hljs-comment">//3.写入Redis</span><br>    stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY+id,JSONUtil.toJsonStr(redisData));<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="7-缓存工具类"><a href="#7-缓存工具类" class="headerlink" title="7 缓存工具类"></a>7 缓存工具类</h1><p>需要满足以下4个要求：</p><ol><li>任意Java对象序列化为json并存储在string类型的key中，并且可以设置TTL过期时间</li><li>将任意Java对象序列化为json并存储在string类型的key中，并且可以设置逻辑过期时间，用于处理缓存击穿问题</li><li>根据指定的key查询缓存，并反序列化为指定类型，利用缓存空值的方式解决缓存穿透问题</li><li>根据指定的key查询缓存，并反序列化为指定类型，需要利用逻辑过期解决缓存击穿问题</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheClient</span> &#123;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> StringRedisTemplate stringRedisTemplate;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">CacheClient</span><span class="hljs-params">(StringRedisTemplate stringRedisTemplate)</span>&#123;<br>      <span class="hljs-built_in">this</span>.stringRedisTemplate=stringRedisTemplate;<br>  &#125;<br><br>  <span class="hljs-comment">// 任意Java对象序列化为json并存储在string类型的key中，并且可以设置TTL过期时间</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(String key, Object value, Long time, TimeUnit unit)</span>&#123;<br>      stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(value),time,unit);<br>  &#125;<br>  <br><br>  <span class="hljs-comment">// 将任意Java对象序列化为json并存储在string类型的key中，并且可以设置逻辑过期时间，用于处理缓存击穿问题</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setWithLogicalExpire</span><span class="hljs-params">(String key, Object value, Long time, TimeUnit unit)</span>&#123;<br>      <span class="hljs-comment">//设置逻辑过期</span><br>      <span class="hljs-type">RedisData</span> <span class="hljs-variable">redisData</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisData</span>();<br>      redisData.setData(value);<br>      redisData.setExpireTime(LocalDateTime.now().plusSeconds(unit.toSeconds(time)));<br>      stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(redisData));<br>  &#125;<br><br>  <span class="hljs-comment">// 根据指定的key查询缓存，并反序列化为指定类型，利用缓存空值的方式解决缓存穿透问题</span><br>  <span class="hljs-keyword">public</span> &lt;R,ID&gt; R <span class="hljs-title function_">queryWithPassThrough</span><span class="hljs-params">(String keyPrefix, ID id, Class&lt;R&gt; type, Function&lt;ID,R&gt;dbFallback,Long time,TimeUnit unit)</span>&#123;<br>      String key=keyPrefix+id;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().get(key);<br>      <span class="hljs-keyword">if</span>(StrUtil.isNotBlank(json))&#123;<br>          <span class="hljs-keyword">return</span> JSONUtil.toBean(json,type);<br>      &#125;<br>      <span class="hljs-comment">//判断命中的是否为空值</span><br>      <span class="hljs-keyword">if</span>(json!=<span class="hljs-literal">null</span>)&#123;<br>          <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>      &#125;<br>      <span class="hljs-type">R</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> dbFallback.apply(id);<br>      <span class="hljs-keyword">if</span>(r==<span class="hljs-literal">null</span>)&#123;<br>          stringRedisTemplate.opsForValue().set(key,<span class="hljs-string">&quot;&quot;</span>,time,unit);<br>          <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>      &#125;<br>      <span class="hljs-built_in">this</span>.set(key,r,time,unit);<br>      <span class="hljs-keyword">return</span> r;<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ExecutorService CACHE_REBUILD_EXECUTOR= Executors.newFixedThreadPool(<span class="hljs-number">10</span>);<br><br>  <span class="hljs-comment">// 根据指定的key查询缓存，并反序列化为指定类型，需要利用逻辑过期解决缓存击穿问题</span><br>  <span class="hljs-keyword">public</span> &lt;R,ID&gt; R <span class="hljs-title function_">queryWithLogicalExpire</span><span class="hljs-params">(String keyPrefix,ID id,Class&lt;R&gt; type,Function&lt;ID,R&gt;dbFallback,Long time,TimeUnit unit)</span>&#123;<br>      String key=keyPrefix+id;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().get(key);<br>      <span class="hljs-keyword">if</span>(StrUtil.isBlank(json))&#123;<br>          <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>      &#125;<br>      <span class="hljs-type">RedisData</span> <span class="hljs-variable">redisData</span> <span class="hljs-operator">=</span> JSONUtil.toBean(json, RedisData.class);<br>      <span class="hljs-type">R</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> JSONUtil.toBean((JSONObject) redisData.getData(), type);<br>      <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">expireTime</span> <span class="hljs-operator">=</span> redisData.getExpireTime();<br>      <span class="hljs-comment">//判断是否过期</span><br>      <span class="hljs-keyword">if</span>(expireTime.isAfter(LocalDateTime.now()))&#123;<br>          <span class="hljs-comment">//未过期，直接返回店铺信息</span><br>          <span class="hljs-keyword">return</span> r;<br>      &#125;<br>      <span class="hljs-comment">//已过期，需要缓存重建</span><br>      String lockKey=LOCK_SHOP_KEY+id;<br>      <span class="hljs-type">boolean</span> <span class="hljs-variable">isLock</span> <span class="hljs-operator">=</span> tryLock(lockKey);<br>      <span class="hljs-keyword">if</span>(isLock)&#123;<br>          CACHE_REBUILD_EXECUTOR.submit(()-&gt;&#123;<br>              <span class="hljs-keyword">try</span>&#123;<br>                  <span class="hljs-comment">//重建缓存</span><br>                  <span class="hljs-comment">//1.查询数据库</span><br>                  <span class="hljs-type">R</span> <span class="hljs-variable">apply</span> <span class="hljs-operator">=</span> dbFallback.apply(id);<br>                  <span class="hljs-comment">//2.存入redis</span><br>                  <span class="hljs-built_in">this</span>.setWithLogicalExpire(key,apply,time,unit);<br>              &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>                  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>              &#125;<span class="hljs-keyword">finally</span>&#123;<br>                  unlock(key);<br>              &#125;<br>          &#125;);<br>      &#125;<br>      <span class="hljs-keyword">return</span> r;<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">(String key)</span>&#123;<br>      Boolean flag=stringRedisTemplate.opsForValue().setIfAbsent(key,<span class="hljs-string">&quot;1&quot;</span>,<span class="hljs-number">10</span>,TimeUnit.SECONDS);<br>      <span class="hljs-keyword">return</span> BooleanUtil.isTrue(flag);<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">(String key)</span>&#123;<br>      stringRedisTemplate.delete(key);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>redis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>redis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>redis-短信验证登录</title>
    <link href="/redis-%E7%9F%AD%E4%BF%A1%E9%AA%8C%E8%AF%81%E7%99%BB%E5%BD%95/6c096f110ba0/"/>
    <url>/redis-%E7%9F%AD%E4%BF%A1%E9%AA%8C%E8%AF%81%E7%99%BB%E5%BD%95/6c096f110ba0/</url>
    
    <content type="html"><![CDATA[<h1 id="0-目录"><a href="#0-目录" class="headerlink" title="0 目录"></a>0 目录</h1><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/image-20240218210105896.png" alt="image-20240218210105896"></p><h1 id="1-基于session实现登录"><a href="#1-基于session实现登录" class="headerlink" title="1 基于session实现登录"></a>1 基于session实现登录</h1><h2 id="1-1-发送短信验证码"><a href="#1-1-发送短信验证码" class="headerlink" title="1.1 发送短信验证码"></a>1.1 发送短信验证码</h2><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/image-20240218210209795.png" alt="image-20240218210209795"></p><p>即：将生成的验证码保存到session中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">sendCode</span><span class="hljs-params">(String phone, HttpSession session)</span> &#123;<br>    <span class="hljs-comment">//1.校验手机号</span><br>    <span class="hljs-keyword">if</span>(RegexUtils.isPhoneInvalid(phone))&#123;<br>        <span class="hljs-comment">//2.如果不符合，返回错误信息</span><br>        <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;手机号格式错误!&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">//3.符合，生成验证码</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span> RandomUtil.randomNumbers(<span class="hljs-number">6</span>);<br>    <span class="hljs-comment">//4.保存验证码到session</span><br>    session.setAttribute(<span class="hljs-string">&quot;code&quot;</span>,code);<br>    <span class="hljs-comment">//5.模拟发送验证码</span><br>    log.debug(<span class="hljs-string">&quot;发送短信验证码成功，验证码：&#123;&#125;&quot;</span>+code);<br>    <span class="hljs-comment">//返回ok</span><br>    <span class="hljs-keyword">return</span> Result.ok();<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="1-2-短信验证码注册登录"><a href="#1-2-短信验证码注册登录" class="headerlink" title="1.2 短信验证码注册登录"></a>1.2 短信验证码注册登录</h2><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/image-20240218210311253.png" alt="image-20240218210311253"></p><p>即：校验完成验证码之后，根据用户手机号去数据库查询，查询用户如果不存在，那么就创建用户，将创建的心用户保存到数据库中；如果查询到用户存在，那么将用户信息保存到session中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginFormDTO</span> &#123;<br>    <span class="hljs-keyword">private</span> String phone;<br>    <span class="hljs-keyword">private</span> String code;<br>    <span class="hljs-keyword">private</span> String password;<br>&#125;<br><br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">login</span><span class="hljs-params">(LoginFormDTO loginForm, HttpSession session)</span> &#123;<br>    <span class="hljs-comment">//1.校验手机号</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">phone</span> <span class="hljs-operator">=</span> loginForm.getPhone();<br>    <span class="hljs-keyword">if</span>(RegexUtils.isPhoneInvalid(phone))&#123;<br>        <span class="hljs-comment">//如果不符合，返回错误信息</span><br>        <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;手机号格式错误！&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">//2.校验验证码</span><br>    <span class="hljs-type">Object</span> <span class="hljs-variable">cacheCode</span> <span class="hljs-operator">=</span> session.getAttribute(<span class="hljs-string">&quot;code&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span> loginForm.getCode();<br>    <span class="hljs-keyword">if</span>(cacheCode==<span class="hljs-literal">null</span> ||! cacheCode.toString().equals(code))&#123;<br>        <span class="hljs-comment">//3.不一致，报错</span><br>        <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;验证码错误!&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">//4.一致，根据手机号查询用户 select * from tb_user where phone = ?</span><br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> query().eq(<span class="hljs-string">&quot;phone&quot;</span>, phone).one();<br>    <span class="hljs-comment">//5.判断用户是否存在</span><br>    <span class="hljs-keyword">if</span>(user==<span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">//6.不存在，创建新用户并保存</span><br>        user=createUsrWithPhone(phone);<br>    &#125;<br>    <span class="hljs-comment">//7.保存用户信息到session中</span><br>    session.setAttribute(<span class="hljs-string">&quot;user&quot;</span>,user);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;   <br>&#125;<br><br><span class="hljs-keyword">private</span> User <span class="hljs-title function_">createUsrWithPhone</span><span class="hljs-params">(String phone)</span> &#123;<br>    <span class="hljs-comment">//1.创建用户</span><br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br>    user.setPhone(phone);<br>    user.setNickName(USER_NICK_NAME_PREFIX+RandomUtil.randomString(<span class="hljs-number">10</span>));<br>    <span class="hljs-comment">//2.保存用户</span><br>    save(user);<br>    <span class="hljs-keyword">return</span> user;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="1-3-校验登录状态"><a href="#1-3-校验登录状态" class="headerlink" title="1.3 校验登录状态"></a>1.3 校验登录状态</h2><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/image-20240218210437940.png" alt="image-20240218210437940"></p><p>即：从拦截器拦截请求之后，从request中获取到cookie，由cookie获取session进而获取到用户信息，此时判断用户是否存在，如果用户不存在进行拦截，用户存在就将用户数据保存到ThreadLocal中。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserHolder</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;UserDTO&gt; tl = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();<br> <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveUser</span><span class="hljs-params">(UserDTO user)</span>&#123;<br>        tl.set(user);<br>    &#125;<br> <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> UserDTO <span class="hljs-title function_">getUser</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> tl.get();<br>    &#125;<br> <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeUser</span><span class="hljs-params">()</span>&#123;<br>        tl.remove();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="2-登录校验拦截器"><a href="#2-登录校验拦截器" class="headerlink" title="2 登录校验拦截器"></a>2 登录校验拦截器</h1><h2 id="2-1-拦截器"><a href="#2-1-拦截器" class="headerlink" title="2.1 拦截器"></a>2.1 拦截器</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//1.获取session</span><br>        <span class="hljs-type">HttpSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> request.getSession();<br>        <span class="hljs-comment">//2.获取session中的用户</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> session.getAttribute(<span class="hljs-string">&quot;user&quot;</span>);<br>        <span class="hljs-comment">//3.判断用户是否存在</span><br>        <span class="hljs-keyword">if</span>(user==<span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">//4.不存在，拦截,返回401状态码，代表未授权</span><br>            response.setStatus(<span class="hljs-number">401</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        <span class="hljs-comment">//5.存在，保存用户信息到ThreadLocal</span><br>        UserHolder.saveUser((UserDTO) user);<br>        <span class="hljs-comment">//6.放行</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br> <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterCompletion</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        UserHolder.removeUser();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-2-添加拦截器"><a href="#2-2-添加拦截器" class="headerlink" title="2.2 添加拦截器"></a>2.2 添加拦截器</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MvcConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebMvcConfigurer</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addInterceptors</span><span class="hljs-params">(InterceptorRegistry registry)</span> &#123;<br>        registry.addInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LoginInterceptor</span>())<br>                .excludePathPatterns(<span class="hljs-string">&quot;/user/code&quot;</span>,<span class="hljs-string">&quot;/user/login&quot;</span>,<span class="hljs-string">&quot;/blog/hot&quot;</span>,<span class="hljs-string">&quot;/shop/**&quot;</span>,<span class="hljs-string">&quot;/shop-type/**&quot;</span>,<span class="hljs-string">&quot;/voucher/**&quot;</span>,<span class="hljs-string">&quot;/upload/**&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="3-session共享问题"><a href="#3-session共享问题" class="headerlink" title="3 session共享问题"></a>3 session共享问题</h1><p>session共享问题：多台Tomcat并不共享session存储空间，当请求切换到不同tomcat服务时导致数据丢失的问题</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/7d7d1467d2fd4e48a88c912e3dfbfaa8.png" alt="img"></p><h1 id="4-Redis替换session业务"><a href="#4-Redis替换session业务" class="headerlink" title="4 Redis替换session业务"></a>4 Redis替换session业务</h1><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/4d931c795aa64ee8b9cfd3b759d0edbc.png" alt="img"></p><h1 id="5-基于Redis实现短信登录"><a href="#5-基于Redis实现短信登录" class="headerlink" title="5 基于Redis实现短信登录"></a>5 基于Redis实现短信登录</h1><h2 id="5-1-发送验证码"><a href="#5-1-发送验证码" class="headerlink" title="5.1 发送验证码"></a>5.1 发送验证码</h2><p>流程修改：生成验证码后，将验证码放入至redis并且设置过期时间</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">sendCode</span><span class="hljs-params">(String phone, HttpSession session)</span> &#123;<br>    <span class="hljs-comment">//1.校验手机号</span><br>    <span class="hljs-keyword">if</span>(RegexUtils.isPhoneInvalid(phone))&#123;<br>        <span class="hljs-comment">//2.如果不符合，返回错误信息</span><br>        <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;手机号格式错误!&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">//3.符合，生成验证码</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span> RandomUtil.randomNumbers(<span class="hljs-number">6</span>);<br>    <span class="hljs-comment">//4.保存验证码到redis中</span><br>    stringRedisTemplate.opsForValue().set(LOGIN_CODE_KEY+phone,code,LOGIN_CODE_TTL, TimeUnit.MINUTES);<br>    <span class="hljs-comment">//5.发送验证码</span><br>    log.debug(<span class="hljs-string">&quot;发送短信验证码成功，验证码：&#123;&#125;&quot;</span>+code);<br>    <span class="hljs-comment">//返回ok</span><br>    <span class="hljs-keyword">return</span> Result.ok();<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="5-2-验证码登录"><a href="#5-2-验证码登录" class="headerlink" title="5.2 验证码登录"></a>5.2 验证码登录</h2><p>修改：校验的时候，客户端传入的验证码和redis中的验证码进行比对，随后需要将用户信息保存到redis中，此时选择使用Hash结构存储用户信息</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">login</span><span class="hljs-params">(LoginFormDTO loginForm, HttpSession session)</span> &#123;<br>    <span class="hljs-comment">//1.校验手机号</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">phone</span> <span class="hljs-operator">=</span> loginForm.getPhone();<br>    <span class="hljs-keyword">if</span>(RegexUtils.isPhoneInvalid(phone))&#123;<br>        <span class="hljs-comment">//如果不符合，返回错误信息</span><br>        <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;手机号格式错误！&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">//2.校验验证码</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">cacheCode</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().get(LOGIN_CODE_KEY + phone);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span> loginForm.getCode();<br>    <span class="hljs-keyword">if</span>(cacheCode==<span class="hljs-literal">null</span> ||!cacheCode.equals(code))&#123;<br>        <span class="hljs-comment">//3.不一致，报错</span><br>        <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;验证码错误!&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">//4.一致，根据手机号查询用户 select * from tb_user where phone = ?</span><br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> query().eq(<span class="hljs-string">&quot;phone&quot;</span>, phone).one();<br>    <span class="hljs-comment">//5.判断用户是否存在</span><br>    <span class="hljs-keyword">if</span>(user==<span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">//6.不存在，创建新用户并保存</span><br>        user=createUsrWithPhone(phone);<br>    &#125;<br>    <span class="hljs-comment">//保存用户信息到redis中</span><br>    <span class="hljs-comment">//1.随机生成token，作为登录令牌</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> UUID.randomUUID().toString(<span class="hljs-literal">true</span>);  <span class="hljs-comment">//true代表isSimple，即不带中划线</span><br>    <span class="hljs-comment">//2.将User对象转为Hash存储</span><br>    UserDTO userDTO=BeanUtil.copyProperties(user,UserDTO.class);<br>    Map&lt;String, Object&gt; userMap = BeanUtil.beanToMap(userDTO,<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(), CopyOptions.create().setIgnoreNullValue(<span class="hljs-literal">true</span>).setFieldValueEditor((fieldName,fieldValue)-&gt;fieldValue.toString()));<br>    String tokenKey=LOGIN_USER_KEY+token;<br>    <span class="hljs-comment">//7.存储</span><br>    stringRedisTemplate.opsForHash().putAll(tokenKey,userMap);<br>    <span class="hljs-comment">//设置token有效期</span><br>    stringRedisTemplate.expire(tokenKey,LOGIN_USER_TTL,TimeUnit.MINUTES);<br>    <span class="hljs-keyword">return</span> Result.ok();<br>&#125;<br><br><span class="hljs-keyword">private</span> User <span class="hljs-title function_">createUsrWithPhone</span><span class="hljs-params">(String phone)</span> &#123;<br>    <span class="hljs-comment">//1.创建用户</span><br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br>    user.setPhone(phone);<br>    user.setNickName(USER_NICK_NAME_PREFIX+RandomUtil.randomString(<span class="hljs-number">10</span>));<br>    <span class="hljs-comment">//2.保存用户</span><br>    save(user);<br>    <span class="hljs-keyword">return</span> user;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="5-3-拦截器修改"><a href="#5-3-拦截器修改" class="headerlink" title="5.3 拦截器修改"></a>5.3 拦截器修改</h2><p>修改：此时获取的用户信息是从redis中获取而不是从session获取。查询到用户信息之后将Hash数据转为UserDto对象，再存入ThreadLocal中，同时刷新token的有效期</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> &#123;<br> <br>    <span class="hljs-keyword">private</span> StringRedisTemplate stringRedisTemplate;<br> <br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">LoginInterceptor</span><span class="hljs-params">(StringRedisTemplate stringRedisTemplate)</span>&#123;<br>        <span class="hljs-built_in">this</span>.stringRedisTemplate=stringRedisTemplate;<br>    &#125;<br> <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//1.获取请求头中的token</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">&quot;authorization&quot;</span>);<br>        <span class="hljs-comment">//判断token是否为空</span><br>        <span class="hljs-keyword">if</span>(StrUtil.isBlank(token))&#123;<br>            response.setStatus(<span class="hljs-number">401</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        String key=LOGIN_USER_KEY+token;<br>        <span class="hljs-comment">//2.基于token获取redis中的用户</span><br>        Map&lt;Object, Object&gt; userMap = stringRedisTemplate.opsForHash().entries(key);<br>        <span class="hljs-comment">//3.判断用户是否存在</span><br>        <span class="hljs-keyword">if</span>(userMap.isEmpty())&#123;<br>            <span class="hljs-comment">//不存在，拦截，返回401状态码</span><br>            response.setStatus(<span class="hljs-number">401</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        <span class="hljs-comment">//5.存在，将查询到的Hash数据转为UserDTO对象</span><br>        <span class="hljs-type">UserDTO</span> <span class="hljs-variable">userDTO</span> <span class="hljs-operator">=</span> BeanUtil.fillBeanWithMap(userMap, <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserDTO</span>(), <span class="hljs-literal">false</span>);<br>        <span class="hljs-comment">//6.保存用户到ThreadLocal</span><br>        UserHolder.saveUser(userDTO);<br>        <span class="hljs-comment">//7.刷新token有效期</span><br>        stringRedisTemplate.expire(key,LOGIN_USER_TTL, TimeUnit.MINUTES);<br>        <span class="hljs-comment">//8.放行</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br> <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterCompletion</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        UserHolder.removeUser();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="6-登录状态刷新问题"><a href="#6-登录状态刷新问题" class="headerlink" title="6 登录状态刷新问题"></a>6 登录状态刷新问题</h1><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/98f5c29b1b8b4b0fb9108a4bc4f035ee.png" alt="img"></p><p>即：配置两个拦截器</p><p>拦截器1：拦截一切的请求，同时刷新token的有效期</p><p>拦截器2：拦截登录的请求</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RefreshTokenInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> &#123;<br><br>  <span class="hljs-keyword">private</span> StringRedisTemplate stringRedisTemplate;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">RefreshTokenInterceptor</span><span class="hljs-params">(StringRedisTemplate stringRedisTemplate)</span>&#123;<br>      <span class="hljs-built_in">this</span>.stringRedisTemplate=stringRedisTemplate;<br>  &#125;<br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>      <span class="hljs-comment">//1.获取请求头中的token</span><br>      <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">&quot;authorization&quot;</span>);<br>      <span class="hljs-comment">//判断token是否为空</span><br>      <span class="hljs-keyword">if</span>(StrUtil.isBlank(token))&#123;<br>          <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>      &#125;<br>      String key=LOGIN_USER_KEY+token;<br>      <span class="hljs-comment">//2.基于token获取redis中的用户</span><br>      Map&lt;Object, Object&gt; userMap = stringRedisTemplate.opsForHash().entries(key);<br>      <span class="hljs-comment">//3.判断用户是否存在</span><br>      <span class="hljs-keyword">if</span>(userMap.isEmpty())&#123;<br>          <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>      &#125;<br>      <span class="hljs-comment">//5.存在，将查询到的Hash数据转为UserDTO对象</span><br>      <span class="hljs-type">UserDTO</span> <span class="hljs-variable">userDTO</span> <span class="hljs-operator">=</span> BeanUtil.fillBeanWithMap(userMap, <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserDTO</span>(), <span class="hljs-literal">false</span>);<br>      <span class="hljs-comment">//6.保存用户到ThreadLocal</span><br>      UserHolder.saveUser(userDTO);<br>      <span class="hljs-comment">//7.刷新token有效期</span><br>      stringRedisTemplate.expire(key,LOGIN_USER_TTL, TimeUnit.MINUTES);<br>      <span class="hljs-comment">//8.放行</span><br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterCompletion</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>      UserHolder.removeUser();<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> &#123;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>      <span class="hljs-comment">//判断是否需要拦截（ThreadLocal中是否有用户）</span><br>      <span class="hljs-keyword">if</span>(UserHolder.getUser()==<span class="hljs-literal">null</span>)&#123;<br>          <span class="hljs-comment">//没有，需要拦截，设置状态码</span><br>          response.setStatus(<span class="hljs-number">401</span>);<br>          <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>      &#125;<br>      <span class="hljs-comment">//有用户，则放行</span><br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterCompletion</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>      UserHolder.removeUser();<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs haxe"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-title class_"><span class="hljs-keyword">class</span> <span class="hljs-title">MvcConfig</span> <span class="hljs-keyword"><span class="hljs-keyword">implements</span> <span class="hljs-type">WebMvcConfigurer</span></span> </span>&#123;<br><br>  <span class="hljs-meta">@Resource</span><br>  <span class="hljs-keyword">private</span> StringRedisTemplate stringRedisTemplate;<br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> void addInterceptors(InterceptorRegistry registry) &#123;<br>      registry.addInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-type">LoginInterceptor</span>())<br>              .excludePathPatterns(<br>                      <span class="hljs-string">&quot;/user/code&quot;</span>,<br>                      <span class="hljs-string">&quot;/user/login&quot;</span>,<br>                      <span class="hljs-string">&quot;/blog/hot&quot;</span>,<br>                      <span class="hljs-string">&quot;/shop/**&quot;</span>,<br>                      <span class="hljs-string">&quot;/shop-type/**&quot;</span>,<br>                      <span class="hljs-string">&quot;/voucher/**&quot;</span>,<br>                      <span class="hljs-string">&quot;/upload/**&quot;</span>).order(<span class="hljs-number">1</span>);<br>      registry.addInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-type">RefreshTokenInterceptor</span>(stringRedisTemplate)).order(<span class="hljs-number">0</span>);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>拦截器的顺序，order值越小越小执行</strong></p>]]></content>
    
    
    <categories>
      
      <category>redis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>redis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>redis-基础</title>
    <link href="/redis-%E5%9F%BA%E7%A1%80/be1ba4ac3a84/"/>
    <url>/redis-%E5%9F%BA%E7%A1%80/be1ba4ac3a84/</url>
    
    <content type="html"><![CDATA[<h1 id="0-目录"><a href="#0-目录" class="headerlink" title="0 目录"></a>0 目录</h1><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/image-20240218215626001.png" alt="image-20240218215626001"></p><h1 id="1-NoSQL和SQL"><a href="#1-NoSQL和SQL" class="headerlink" title="1 NoSQL和SQL"></a>1 NoSQL和SQL</h1><p>SQL：<strong>传统关系型数据库是结构化数据，每一张表都有严格的约束信息：字段名、字段数据类型、字段约束等等信息，插入的数据必须遵守这些约束</strong></p><p>NoSQL：<strong>NoSql对数据库格式没有严格约束，往往形式松散，自由。可以是key-value,可以是文档，或者图格式</strong></p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/5c1e0a6741c8868bf4ad9996c03e2589.png" alt="image-20221108154744967"></p><h1 id="2-认识Redis"><a href="#2-认识Redis" class="headerlink" title="2 认识Redis"></a>2 认识Redis</h1><p><strong>特征：</strong></p><ul><li><strong>键值（key-value）型，value支持多种不同数据结构，功能丰富</strong></li><li><strong>单线程，每个命令具备原子性</strong></li><li><strong>低延迟，速度快（基于内存、IO多路复用、良好的编码）。</strong></li><li><strong>支持数据持久化(定期将内存搬运到磁盘)</strong></li><li><strong>支持主从集群、分片集群（数据拆分）</strong></li><li><strong>支持多语言客户端</strong></li></ul><h1 id="3-Redis命令"><a href="#3-Redis命令" class="headerlink" title="3 Redis命令"></a>3 Redis命令</h1><ul><li>KEYS：查看符合模板的所有key</li><li>DEL：删除一个指定的KEY</li><li>EXISTS：判断KEY是否存在</li><li>EXPIRE：给一个KEY设置有效期，有效期到期，这个key就会被自动删除（<strong>expire设置存活周期，ttl查看剩余时间，不设置expire的话ttl为-1</strong>）</li></ul><h2 id="3-1-String"><a href="#3-1-String" class="headerlink" title="3.1 String"></a>3.1 String</h2><p>String类型，也就是字符串类型，是Redis中最简单的存储类型。其value是字符串，不过根据字符串的格式不同，又可以分为3类：</p><ol><li>string：普通字符串</li><li>int：整数类型，可以做自增、自减操作</li><li>float：浮点类型，可以做自增、自减操作</li></ol><p>不管是哪种格式，底层都是字节数组形式存储，只不过是编码方式不同。字符串类型的最 大空间不能超过512m </p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/image-20240218220640595.png" alt="image-20240218220640595"></p><h3 id="3-1-1-常见命令"><a href="#3-1-1-常见命令" class="headerlink" title="3.1.1 常见命令"></a>3.1.1 常见命令</h3><ul><li>SET：添加或者修改已经存在的一个String类型的键值对</li><li>GET：根据key获取String类型的value</li><li>MSET：批量添加多个String类型的键值对</li><li>MGET：根据多个key获取多个String类型的value</li><li>INCR：让一个整型的key自增1</li><li>INCRBY:让一个整型的key自增并指定步长，例如： incrby num 2 让num值自增2</li><li>INCRBYFLOAT：让一个浮点类型的数字自增并指定步长</li><li>SETNX：添加一个String类型的键值对，前提是这个key不存在，否则不执行</li><li>SETEX：添加一个String类型的键值对，并且指定有效期</li></ul><h3 id="3-1-2-Key结构"><a href="#3-1-2-Key结构" class="headerlink" title="3.1.2 Key结构"></a>3.1.2 Key结构</h3><p>可以通过给key添加前缀加以区分，前缀规范：Redis的key允许有多个单词形成层级结构，多个单词之间用’:’隔开，格式如下：</p><blockquote><p>项目名：业务名：类型：id</p></blockquote><h2 id="3-2-Hash"><a href="#3-2-Hash" class="headerlink" title="3.2 Hash"></a>3.2 Hash</h2><p>Hash类型，也叫散列，其value是一个无序字典，类似于Java中的HashMap结构。String结构是将对象序列化为JSON字符串后存储，当需要修改对象某个字段时很不方便。</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/image-20240218220722702.png" alt="image-20240218220722702"></p><p>Hash结构可以将对象中的每个字段独立存储，可以针对单个字段做CRUD：</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/image-20240218220620645.png" alt="image-20240218220620645"></p><h3 id="3-2-1-常见命令"><a href="#3-2-1-常见命令" class="headerlink" title="3.2.1 常见命令"></a>3.2.1 常见命令</h3><ul><li>HSET  key  field  value：添加或者修改hash类型key的field的值</li><li>HGET key field：获取一个hash类型key的field的值</li><li>HMSET：批量添加多个hash类型key的field的值</li><li>HMGET：批量获取多个hash类型key的field的值</li><li>HGETALL：获取一个hash类型的key中的所有的field和value</li><li>HKEYS：获取一个hash类型的key中的所有的field</li><li>HVALS：获取一个hash类型的key中的所有的value</li><li>HINCRBY:让一个hash类型key的字段值自增并指定步长</li><li>HSETNX：添加一个hash类型的key的field值，前提是这个field不存在，否则不执行</li></ul><h2 id="3-3-List"><a href="#3-3-List" class="headerlink" title="3.3 List"></a>3.3 List</h2><p>Redis中的List类型与Java中的LinkedList类似，可以看做是一个双向链表结构。既 可以支持正向检索和也可以支持反向检索。</p><p><strong>特征也与LinkedList类似：</strong>有序、元素可以重复、插入和删除快、查询速度一般</p><p>常用来存储一个有序数据，例如：朋友圈点赞列表，评论列表等。</p><h3 id="3-3-1-常见命令"><a href="#3-3-1-常见命令" class="headerlink" title="3.3.1 常见命令"></a>3.3.1 常见命令</h3><ul><li>LPUSH key element  ：向列表左侧插入一个或多个元素</li><li>LPOP key：移除并返回列表左侧的第一个元素，没有则返回nil</li><li>RPUSH key element  ：向列表右侧插入一个或多个元素</li><li>RPOP key：移除并返回列表右侧的第一个元素</li><li>LRANGE key star end：返回一段角标范围内的所有元素</li></ul><p>BLPOP和BRPOP：与LPOP和RPOP类似，只不过在没有元素时等待指定时间，而不是直接返回nil</p><h2 id="3-4-Set"><a href="#3-4-Set" class="headerlink" title="3.4 Set"></a>3.4 Set</h2><p>Redis的Set结构与Java中的HashSet类似，可以看做是一个value为null的 HashMap。因为也是一个hash表，因此具备与HashSet类似的特征： 无序、元素不可重复、查找快、支持交集、并集、差集等功能。</p><h3 id="3-4-1-常见命令"><a href="#3-4-1-常见命令" class="headerlink" title="3.4.1 常见命令"></a>3.4.1 常见命令</h3><ul><li>SADD key member  ：向set中添加一个或多个元素</li><li>SREM key member  : 移除set中的指定元素</li><li>SCARD key： 返回set中元素的个数</li><li>SISMEMBER key member：判断一个元素是否存在于set中</li><li>SMEMBERS：获取set中的所有元素</li><li>SINTER key1 key2  ：求key1与key2的交集</li><li>SDIFF key1 key2  ：求key1与key2的差集</li><li>SUNION key1 key2  ：求key1与key2的并集</li></ul><h2 id="3-5-SortedSet"><a href="#3-5-SortedSet" class="headerlink" title="3.5 SortedSet"></a>3.5 SortedSet</h2><p>Redis的SortedSet是一个可排序的set集合，与Java中的TreeSet有些类似，但底层 数据结构却差别很大。 SortedSet中的每一个元素都带有一个score属性，可以基于score属性对元素排序，底层的实现是一个跳表（SkipList）加  hash表。</p><p>SortedSet具备下列特性：</p><ul><li>可排序</li><li>元素不重复</li><li>查询速度快</li></ul><p>因为SortedSet的可排序特性（从小到大排序 ），经常被用来实现排行榜这样的功能。</p><h3 id="3-5-1-常见命令"><a href="#3-5-1-常见命令" class="headerlink" title="3.5.1 常见命令"></a>3.5.1 常见命令</h3><ul><li>ZADD key score member：添加一个或多个元素到sorted set 如果已经存在则更新其score值</li><li>ZREM key member：删除sorted set中的一个指定元素</li><li>ZSCORE key member  :  获取sorted set中的指定元素的score值</li><li>ZRANK key member：获取sorted set 中的指定元素的排名</li><li>ZCARD key：获取sorted set中的元素个数</li><li>ZCOUNT key min max ：统计score值在给定范围内的所有元素的个数</li><li>ZINCRBY key increment member：让sorted set中的指定元素自增，步长为指定的increment值</li><li>ZRANGE key min max ：按照 score排序后，获取指定排名范围内的元素</li><li>ZRANGEBYSCORE key min max ：按照 score排序后，获取指定score范围内的元 素</li><li>ZDIFF、 ZINTER、 ZUNION：求差集、交集、并集</li></ul><p>注意：所有的排名默认都是升序，如果要降序则在命令的Z后面添加REV即可，例如：</p><p> <strong>升序</strong>获取sorted set 中的指定元素的排名：  ZRANK key member</p><p> <strong>降序</strong>获取sorted set 中的指定元素的排名：  ZREVRANK key memeber</p><h1 id="4-Redis的Java客户端"><a href="#4-Redis的Java客户端" class="headerlink" title="4 Redis的Java客户端"></a>4 Redis的Java客户端</h1><h2 id="4-1-Jedis"><a href="#4-1-Jedis" class="headerlink" title="4.1 Jedis"></a>4.1 Jedis</h2><ol><li><p>导入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>redis.clients<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jedis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.8.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br></code></pre></td></tr></table></figure></li><li><p>建立连接</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JedisTest</span> &#123;<br>    <span class="hljs-keyword">private</span> Jedis jedis;<br><br>    <span class="hljs-meta">@BeforeEach</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUp</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-comment">//1.建立连接</span><br>        jedis = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">&quot;192.168.200.130&quot;</span>,<span class="hljs-number">6379</span>);<br>        <span class="hljs-comment">//2.设置密码</span><br>        jedis.auth(<span class="hljs-string">&quot;1234&quot;</span>);<br>        <span class="hljs-comment">//3.选择库</span><br>        jedis.select(<span class="hljs-number">0</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testString</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> jedis.set(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;小明&quot;</span>);<br>        System.out.println(<span class="hljs-string">&quot;result= &quot;</span> + result);<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> jedis.get(<span class="hljs-string">&quot;name&quot;</span>);<br>        System.out.println(<span class="hljs-string">&quot;name= &quot;</span>+name);<br>    &#125;<br><br>    <span class="hljs-meta">@AfterEach</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">tearDown</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">if</span>(jedis!=<span class="hljs-literal">null</span>)&#123;<br>            jedis.close();<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure></li><li><p>Jedis连接池</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JedisConnectFactory</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> JedisPool jedisPool;<br><br>    <span class="hljs-keyword">static</span>&#123;<br>        <span class="hljs-comment">//配置连接池</span><br>        <span class="hljs-type">JedisPoolConfig</span> <span class="hljs-variable">poolConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JedisPoolConfig</span>();<br>        poolConfig.setMaxTotal(<span class="hljs-number">8</span>);<br>        poolConfig.setMaxIdle(<span class="hljs-number">8</span>);<br>        poolConfig.setMinIdle(<span class="hljs-number">0</span>);<br>        poolConfig.setMaxWait(Duration.ofMillis(<span class="hljs-number">1000</span>));<br>        jedisPool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">JedisPool</span>(poolConfig,<span class="hljs-string">&quot;192.168.200.130&quot;</span>,<span class="hljs-number">6379</span>,<span class="hljs-number">1000</span>,<span class="hljs-string">&quot;1234&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Jedis <span class="hljs-title function_">getJedis</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> jedisPool.getResource();<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure></li><li><p>JedisConnectionFacotry：工厂设计模式是实际开发中非常常用的一种设计模式，我们可以使用工厂，去降低代的耦合，比如Spring中的Bean的创建，就用到了工厂设计模式</p></li><li><p>静态代码块：随着类的加载而加载，确保只能执行一次，我们在加载当前工厂类的时候，就可以执行static的操作完成对 连接池的初始化</p></li><li><p>最后提供返回连接池中连接的方法.</p></li></ol><h2 id="4-2-SpringDataRedis"><a href="#4-2-SpringDataRedis" class="headerlink" title="4.2 SpringDataRedis"></a>4.2 SpringDataRedis</h2><p><strong>SpringData是Spring中数据操作的模块，包含对各种数据库的集成，其中对Redis的集成模块就叫做SpringDataRedis</strong></p><p><strong>SpringDataRedis中提供了RedisTemplate工具类，其中封装了各种对Redis的操作。并且将不同数据类型的操作API封装到了不同的类型中：</strong></p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/Redis/image-20240218221757795.png" alt="image-20240218221757795"></p><ol><li><p>导入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--Redis依赖--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-comment">&lt;!--连接池依赖--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.commons<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-pool2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>   <br></code></pre></td></tr></table></figure></li><li><p>配置文件</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">redis:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.130</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">6379</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-number">1234</span><br>    <span class="hljs-attr">database:</span> <span class="hljs-number">0</span><br>    <span class="hljs-attr">lettuce:</span><br>      <span class="hljs-attr">pool:</span><br>        <span class="hljs-attr">max-active:</span> <span class="hljs-number">8</span> <span class="hljs-comment">#最大连接数</span><br>        <span class="hljs-attr">max-idle:</span> <span class="hljs-number">8</span> <span class="hljs-comment">#最大空闲连接</span><br>        <span class="hljs-attr">min-idle:</span> <span class="hljs-number">0</span> <span class="hljs-comment">#最小空闲连接</span><br>        <span class="hljs-attr">max-wait:</span> <span class="hljs-number">100</span> <span class="hljs-comment">#连接等待时间</span><br><br></code></pre></td></tr></table></figure></li><li><p>Test</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> StringRedisTemplate stringRedisTemplate;<br><br><span class="hljs-comment">//JSON工具类ObjectMapper,或者可以用fastjson:JSON.toJSONString(), JSON.parseObject()</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">mapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();<br><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSaveUser</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> JsonProcessingException &#123;<br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br>    user.setName(<span class="hljs-string">&quot;阿廖莎&quot;</span>);<br>    user.setAge(<span class="hljs-number">21</span>);<br>    <span class="hljs-comment">//手动序列化</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> mapper.writeValueAsString(user);<br><br>    stringRedisTemplate.opsForValue().set(<span class="hljs-string">&quot;user:100&quot;</span>,json);<br>    <span class="hljs-comment">//反序列化</span><br>    <span class="hljs-type">User</span> <span class="hljs-variable">user1</span> <span class="hljs-operator">=</span> mapper.readValue(stringRedisTemplate.opsForValue().get(<span class="hljs-string">&quot;user:100&quot;</span>), User.class);<br>    System.out.println(<span class="hljs-string">&quot;user1 = &quot;</span> + user1);<br>&#125;<br></code></pre></td></tr></table></figure></li></ol>]]></content>
    
    
    <categories>
      
      <category>redis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>redis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Java编程技巧-并发处理-01</title>
    <link href="/Java%E7%BC%96%E7%A8%8B%E6%8A%80%E5%B7%A7-%E5%B9%B6%E5%8F%91%E5%A4%84%E7%90%86-01/156a7266de3c/"/>
    <url>/Java%E7%BC%96%E7%A8%8B%E6%8A%80%E5%B7%A7-%E5%B9%B6%E5%8F%91%E5%A4%84%E7%90%86-01/156a7266de3c/</url>
    
    <content type="html"><![CDATA[<blockquote><p>背景：公司的项目，自己写了一个接口的时候，请求接口的具体service涉及到异步A+同步B的情况，需要等到同步B方法执行完成之后才会释放资源，因此如何控制好并发是一个问题</p></blockquote><h1 id="1-解决思路"><a href="#1-解决思路" class="headerlink" title="1. 解决思路"></a>1. 解决思路</h1><p>使用队列进行控制</p><h1 id="2-思路："><a href="#2-思路：" class="headerlink" title="2. 思路："></a>2. 思路：</h1><ol><li>分析出真正会并发的一块代码</li><li>将真正会并发的那一块代码抽取出来，单独封装一个方法</li><li>将调用并发代码之前的方法A加锁，保证该方法A不会出现并发情况</li><li>在方法A中使用一个队列将需要执行的任务进行管理</li><li>当有第一个请求进入的时候，此时list为空，那么直接执行并发方法，如果当list不为空，那么将任务添加进去即可。</li><li>最后当第一个请求执行完成需要释放资源的时候，此时将执行的任务移除，判断list中是否有内容，如果有，取出list首位，并执行并发的方法。</li></ol><h1 id="3-具体代码"><a href="#3-具体代码" class="headerlink" title="3. 具体代码"></a>3. 具体代码</h1><p>第一步：等待编译回调</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@PostMapping(&quot;/apk/&#123;mode&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">jenkinsCompile</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> RobustReq robustReq, <span class="hljs-meta">@PathVariable(&quot;mode&quot;)</span>Integer mode)</span> &#123;<br>        compileRecordService.saveParamAndStartCompile(robustReq.getLiTaskId(), robustReq, mode, <span class="hljs-keyword">new</span> <span class="hljs-title class_">IJenkinsResultCallback</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onResult</span><span class="hljs-params">(String taskId, <span class="hljs-type">boolean</span> isSuccess)</span> &#123;<br>                <span class="hljs-keyword">if</span> (isSuccess) &#123;<br>                    robustService.savRobustParam(taskId, robustReq);<br>                    robustService.noticeInstall(taskId);<br>                &#125;<br>            &#125;<br>        &#125;, TaskTypeEnum.ROBUST_TEST.getTaskCode());<br><br>        <span class="hljs-keyword">return</span> Result.ok();<br>    &#125;<br></code></pre></td></tr></table></figure><p>第二步：回调完成，安装APK</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">noticeInstall</span><span class="hljs-params">(String taskId)</span> &#123;<br>        <span class="hljs-keyword">if</span> (taskIdList.isEmpty()) &#123;<br>            exeInstall(taskId);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            taskIdList.add(taskId);<br>        &#125;<br>    &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">exeInstall</span><span class="hljs-params">(String taskId)</span> &#123;<br>      List&lt;Map&lt;String, Object&gt;&gt; envInfoList = getAvaInfoList(rowList);<br><br>      <span class="hljs-comment">// 1~5min</span><br>      <span class="hljs-keyword">while</span> (envInfoList.isEmpty()) &#123;<br>          <span class="hljs-type">Random</span> <span class="hljs-variable">random</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>();<br>          <span class="hljs-type">int</span> <span class="hljs-variable">delay</span> <span class="hljs-operator">=</span> random.nextInt(<span class="hljs-number">5</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>) + <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>;<br><br>          <span class="hljs-keyword">try</span> &#123;<br>              Thread.sleep(delay);<br>          &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>              e.printStackTrace();<br>          &#125;<br>          envInfoList = getAvaInfoList(rowList);<br>      &#125;<br><br>      Map&lt;String, Object&gt; envInfo = envInfoList.get(<span class="hljs-number">0</span>);<br>      List&lt;String&gt; devicesList = (List&lt;String&gt;) envInfo.get(<span class="hljs-string">&quot;deviceIds&quot;</span>);<br>      <span class="hljs-type">String</span> <span class="hljs-variable">deviceId</span> <span class="hljs-operator">=</span> devicesList.get(<span class="hljs-number">0</span>);<br><br>      <span class="hljs-type">Integer</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> (Integer) envInfo.get(<span class="hljs-string">&quot;id&quot;</span>);<br><br>      <span class="hljs-type">String</span> <span class="hljs-variable">installUrl</span> <span class="hljs-operator">=</span> Constants.Win.ADDRESS + Constants.Common.COLON + Constants.Win.JAVA_PORT + Constants.Common.SEPARATOR + Constants.Win.INSTALL_APK_HMI;<br>      HttpUtil.createPost(installUrl)<br>              .header(<span class="hljs-string">&quot;Content-Type&quot;</span>, <span class="hljs-string">&quot;application/json&quot;</span>)<br>              .body(JSONUtil.toJsonStr(paramMap))<br>              .execute();<br>  &#125;<br></code></pre></td></tr></table></figure><p>第三步：等待另一台服务的响应：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@PostMapping(&quot;/callback&quot;)</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">installCallback</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> InstallResp resp)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">taskId</span> <span class="hljs-operator">=</span> resp.getTaskId();<br><br>        <span class="hljs-keyword">if</span> (resp.isSuccess()) &#123;<br>            robustService.startRobust(taskId, infoMap -&gt; &#123;<br>            &#125;, emitter);<br>            <span class="hljs-keyword">return</span> Result.ok();<br><br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>第四步：执行任务</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startRobust</span><span class="hljs-params">(String taskId, ILiATCallback callback, ObservableEmitter&lt;Boolean&gt; emitter)</span> &#123;<br>        executeTask(runTime, returnNum, liTaskId, taskId);<br><br>        startIntervalGetRate(liTaskId, taskId, emitter);<br>    &#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">executeTask</span><span class="hljs-params">(Integer runtime, Integer returnNum, Integer liTaskId, String taskId)</span> &#123;<br>        List&lt;Map&lt;String, Object&gt;&gt; envList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br>        Map&lt;String, Object&gt; paramMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br><br><br>        <span class="hljs-type">HttpResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> HttpUtil.createPost(<span class="hljs-string">&quot;xxx&quot;</span>)<br>                .header(<span class="hljs-string">&quot;content-type&quot;</span>, <span class="hljs-string">&quot;application/json&quot;</span>)<br>                .header(<span class="hljs-string">&quot;authorization&quot;</span>, Constants.LiAT.AUTHORIZATION)<br>                .body(JSONUtil.toJsonStr(paramMap))<br>                .execute();<br><br>        taskIdList.remove(taskId);<br>        <span class="hljs-keyword">if</span> (!taskIdList.isEmpty()) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">nextTaskId</span> <span class="hljs-operator">=</span> taskIdList.get(<span class="hljs-number">0</span>);<br>            exeInstall(nextTaskId);<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Java编程技巧</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java编程技巧</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>leetcode-hot100-双指针</title>
    <link href="/leetcode-hot100-%E5%8F%8C%E6%8C%87%E9%92%88/fa7554c1833c/"/>
    <url>/leetcode-hot100-%E5%8F%8C%E6%8C%87%E9%92%88/fa7554c1833c/</url>
    
    <content type="html"><![CDATA[<h1 id="1-移动零"><a href="#1-移动零" class="headerlink" title="1. 移动零"></a>1. 移动零</h1><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/LeetCode/image-20231202172905894.png" alt="image-20231202172905894"></p><h1 id="2-盛最多水的容器"><a href="#2-盛最多水的容器" class="headerlink" title="2. 盛最多水的容器"></a>2. 盛最多水的容器</h1><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/LeetCode/image-20231202174344254.png" alt="image-20231202174344254"></p>]]></content>
    
    
    
    <tags>
      
      <tag>leetcode</tag>
      
      <tag>双指针</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>leetcode-hot100-哈希</title>
    <link href="/leetcode-hot100-%E5%93%88%E5%B8%8C/91774001b143/"/>
    <url>/leetcode-hot100-%E5%93%88%E5%B8%8C/91774001b143/</url>
    
    <content type="html"><![CDATA[<h1 id="1-两数之和"><a href="#1-两数之和" class="headerlink" title="1. 两数之和"></a>1. 两数之和</h1><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/LeetCode/image-20231202170319592.png" alt="image-20231202170319592"></p><h1 id="2-字母异位词分组"><a href="#2-字母异位词分组" class="headerlink" title="2. 字母异位词分组"></a>2. 字母异位词分组</h1><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/LeetCode/image-20231202171402767.png" alt="image-20231202171402767"></p>]]></content>
    
    
    
    <tags>
      
      <tag>leetcode</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Java编程技巧-回调函数</title>
    <link href="/Java%E7%BC%96%E7%A8%8B%E6%8A%80%E5%B7%A7-%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0/12bcfab4b0fb/"/>
    <url>/Java%E7%BC%96%E7%A8%8B%E6%8A%80%E5%B7%A7-%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0/12bcfab4b0fb/</url>
    
    <content type="html"><![CDATA[<blockquote><p>背景：<br>开发公司项目的时候，需要用到Jenkins触发编译，打包APK，随后拿到产物地址再进行下一步，但是APK编译时间不确定，但是检测又必须拿到这个产物地址才能进行。</p></blockquote><h1 id="1-回调"><a href="#1-回调" class="headerlink" title="1. 回调"></a>1. 回调</h1><h2 id="1-1-同步回调"><a href="#1-1-同步回调" class="headerlink" title="1.1. 同步回调"></a>1.1. 同步回调</h2><blockquote><p>比如：你去书店买书，进门问老板有书吗？老板说有，同时给你拿出了书，随后，你付钱离开。这一过程，整个流程：</p><ol><li>询问</li><li>等老板给你拿书</li><li>拿到书付钱离开</li></ol></blockquote><p><code>fun(a)</code>调用<code>fun(b)</code>，<code>fun(a)</code><strong>等待</strong><code>fun(b)</code>执行完后再进行下一步。</p><p>同步调用会引起代码的阻塞。</p><h2 id="1-2-异步回调"><a href="#1-2-异步回调" class="headerlink" title="1.2. 异步回调"></a>1.2. 异步回调</h2><blockquote><p>比如：你还是去买书，询问老板有书吗？老板说我去找一下，你回复说那你先找吧，我先去喝一杯奶茶去，我过一会人再来。过了一个小时，老板已经将书放在柜台，你付钱离开。整个过程：</p><ol><li>询问</li><li>老板去招书</li><li>你去喝奶茶</li><li>得到书，付钱离开</li></ol></blockquote><p><code>fun(a)</code>调用<code>fun(b)</code>, <code>fun(a)</code><strong>不等待</strong><code>fun(b)</code>执行完便进行下一步。<br>常见的有Thread、Task等。</p><h2 id="1-3-回调"><a href="#1-3-回调" class="headerlink" title="1.3. 回调"></a>1.3. 回调</h2><blockquote><p>比如：你接着去买书，询问老板有书吗？老板说目前没有，然后你回答说，那我在这儿等，书来了我才走。后面有书了，你得到了书付钱离开。整个过程：</p><ol><li>询问</li><li>老板备货</li><li>等待</li><li>得到书，付钱离开</li></ol></blockquote><p> 回调的机制是：</p><ol><li>类A的<code>a()</code>方法调用类B的<code>b()</code>方法</li><li>类B的<code>b()</code>方法执行完毕主动调用类A的<code>callback()</code>方法</li></ol><p>所以在回调，重要的就是两个类：</p><p>A：调用B后，需要等到B的结果才能继续向下执行。</p><p>B：执行动作。</p><p>设置回调，由于A是需要等到B的结果再向下，所以在A中，需要实现这个接口，或者在调用B方法的参数中，实例化一个Callback对象，B中持有这个回调对象，当B完成之后，就通过这个回调对象发消息。</p><p>比如买书：</p><p>用户需要等书才走，书店老板要备货，那么用户就是A，书店(老板)就是B，用户需要实现一个回调，并且书店要持有这个回调，当备货完成才能通知用户。</p><p>回调：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">BookAvailableCallback</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">onBookAvailable</span><span class="hljs-params">(String bookTitle)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>用户：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">buyBook</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;去书店买书&quot;</span>);<br>        <span class="hljs-type">BookStore</span> <span class="hljs-variable">bookStore</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BookStore</span>();<br>        bookStore.prepareBook(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BookAvailableCallback</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onBookAvailable</span><span class="hljs-params">(String bookTitle)</span> &#123;<br>                System.out.println(<span class="hljs-string">&quot;买到了书---《&quot;</span> + bookTitle + <span class="hljs-string">&quot;》&quot;</span>);<br>            &#125;<br>        &#125;);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>书店：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BookStore</span> &#123;<br>    <span class="hljs-keyword">private</span> BookAvailableCallback callback;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">prepareBook</span><span class="hljs-params">(BookAvailableCallback callback)</span> &#123;<br>        <span class="hljs-built_in">this</span>.callback = callback;<br>        <span class="hljs-keyword">try</span> &#123;<br>            System.out.println(<span class="hljs-string">&quot;书店正在备货，请稍候...&quot;</span>);<br>            TimeUnit.SECONDS.sleep(<span class="hljs-number">5</span>); <span class="hljs-comment">// 模拟备货过程，等待5秒</span><br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br><br>        haveBook();<br><br><br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">haveBook</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">bookTitle</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Java Programming&quot;</span>; <span class="hljs-comment">// 模拟书店有了书</span><br><br>        <span class="hljs-comment">// 当书店有书时，调用回调通知用户</span><br>        <span class="hljs-keyword">if</span> (callback != <span class="hljs-literal">null</span>) &#123;<br>            callback.onBookAvailable(bookTitle);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>测试：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">BookStore</span> <span class="hljs-variable">bookStore</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BookStore</span>();<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br><br>        user.buyBook();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>其实回调就是一个很好的面向接口编程的实例，在接口中定义好要做什么事，根据接口定义的职责，实例出来的对象就具备这个接口能力，那么只需要在另一边持有对应的引用就可以通过回调定义的能力将最终结果返回。</p>]]></content>
    
    
    <categories>
      
      <category>Java编程技巧</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java编程技巧</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Java多线程-ThreadLocal</title>
    <link href="/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B-ThreadLocal/5c8cef3482ea/"/>
    <url>/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B-ThreadLocal/5c8cef3482ea/</url>
    
    <content type="html"><![CDATA[<h1 id="1、ThreadLocal是什么？"><a href="#1、ThreadLocal是什么？" class="headerlink" title="1、ThreadLocal是什么？"></a>1、ThreadLocal是什么？</h1><ul><li>提供线程内局部变量，不同线程之间不会相互干扰。</li><li>ThreadLocal 实例通常来说都是 <code>private static</code> 修饰的，用于关联线程和线程的上下文。</li><li><code>减少同一个线程内的函数 或 组件之间传递变量的复杂性</code>。</li></ul><p>小结：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 线程并发：在多线程并发的场景<br><span class="hljs-bullet">2.</span> 传递数据：通过ThreadLocal在同一线程不同组件中传递公共变量。<br><span class="hljs-bullet">3.</span> 线程隔离：每个线程的变量都是独立的，不会互相影响<br></code></pre></td></tr></table></figure><h2 id="1-1、举例-线程隔离"><a href="#1-1、举例-线程隔离" class="headerlink" title="1.1、举例-线程隔离"></a>1.1、举例-线程隔离</h2><ul><li><p>不使用ThreadLocal</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo</span> &#123;<br><br>    <span class="hljs-keyword">private</span> String content;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setContent</span><span class="hljs-params">(String content)</span> &#123;<br>        <span class="hljs-built_in">this</span>.content= content;<br>    &#125;<br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getContent</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> content;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Demo</span> <span class="hljs-variable">demo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Demo</span>();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) &#123;<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br>                <span class="hljs-meta">@Override</span><br>                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>                    demo.setContent(Thread.currentThread().getName() + <span class="hljs-string">&quot;的数据&quot;</span>);<br>                    System.out.println(<span class="hljs-string">&quot;------------&quot;</span>);<br>                    System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;----&gt;&quot;</span> + demo.getContent());<br>                &#125;<br>            &#125;, <span class="hljs-string">&quot;线程&quot;</span> + i).start();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/JUC/ThreadLocal/image-20230722155750292.png" alt="image-20230722155750292"></p></li><li><p>使用ThreadLocal</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo</span> &#123;<br>    ThreadLocal&lt;String&gt; threadLocal = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();<br>    <span class="hljs-keyword">private</span> String content;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setContent</span><span class="hljs-params">(String content)</span> &#123;<br>        threadLocal.set(content);<br>    &#125;<br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getContent</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> threadLocal.get();<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Demo</span> <span class="hljs-variable">demo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Demo</span>();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) &#123;<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br>                <span class="hljs-meta">@Override</span><br>                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>                    demo.setContent(Thread.currentThread().getName() + <span class="hljs-string">&quot;的数据&quot;</span>);<br>                    System.out.println(<span class="hljs-string">&quot;------------&quot;</span>);<br>                    System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;----&gt;&quot;</span> + demo.getContent());<br>                &#125;<br>            &#125;, <span class="hljs-string">&quot;线程&quot;</span> + i).start();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/JUC/ThreadLocal/image-20230722155708884.png" alt="image-20230722155708884"></p></li></ul><h2 id="1-2、对比synchronized"><a href="#1-2、对比synchronized" class="headerlink" title="1.2、对比synchronized"></a>1.2、对比synchronized</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">synchronizedDemo</span> &#123;<br>    <span class="hljs-keyword">private</span> String content;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setContent</span><span class="hljs-params">(String content)</span> &#123;<br>        <span class="hljs-built_in">this</span>.content= content;<br>    &#125;<br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getContent</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> content;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">synchronizedDemo</span> <span class="hljs-variable">demo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">synchronizedDemo</span>();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) &#123;<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br>                <span class="hljs-meta">@Override</span><br>                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>                    <span class="hljs-keyword">synchronized</span> (synchronizedDemo.class) &#123;<br>                        demo.setContent(Thread.currentThread().getName() + <span class="hljs-string">&quot;的数据&quot;</span>);<br>                        System.out.println(<span class="hljs-string">&quot;------------&quot;</span>);<br>                        System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;----&gt;&quot;</span> + demo.getContent());<br>                    &#125;<br>                &#125;<br>            &#125;, <span class="hljs-string">&quot;线程&quot;</span> + i).start();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/JUC/ThreadLocal/image-20230722161534672.png" alt="image-20230722161534672"></p><p>虽然 <code>ThreadLocal</code> 和 <code>Synchronized</code> 关键字都是用于处理多线程并发访问变量的问题，不过两者处理问题的角度和思路不同。</p><table><thead><tr><th align="center"></th><th align="center">Synchronized</th><th align="center">ThreadLocal</th></tr></thead><tbody><tr><td align="center">原理</td><td align="center">同步机制采用“以时间换空间”的方式，只提供了一份变量，让不同的线程排队访问。</td><td align="center">采用 “以空间换时间”的方式，为每一个线程都提供了一份变量的副本，从而实现同时访问而不互相干扰。</td></tr><tr><td align="center">侧重点</td><td align="center">多个线程之间访问资源的<strong>同步</strong>。</td><td align="center">并发情况下让每个线程之间数据相互<strong>隔离</strong>。</td></tr></tbody></table><h2 id="1-3、ThreadLocal的好处"><a href="#1-3、ThreadLocal的好处" class="headerlink" title="1.3、ThreadLocal的好处"></a>1.3、ThreadLocal的好处</h2><ol><li>传递数据：保证每个线程保定的数据在需要的地方可以直接使用，这样避免了进行参数传递而带来的代码耦合问题。</li><li>线程隔离：各个线程之间的数据相互隔离但有具备并发性，同事避免了使用synchronized加锁带来的性能损耗问题。</li></ol><h1 id="2、案例"><a href="#2、案例" class="headerlink" title="2、案例"></a>2、案例</h1><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/JUC/ThreadLocal/image.png" alt="img"></p><p>那么可以看到在service到Dao层的时候，都会使用connection，那么此时将connection对象和当前线程进行绑定，这样就能保证数据的一致性，并且避免传参导致的代码耦合问题。</p><h2 id="2-1、Service层"><a href="#2-1、Service层" class="headerlink" title="2.1、Service层"></a>2.1、Service层</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.itheima.transfer.service;<br><br><span class="hljs-keyword">import</span> com.itheima.transfer.dao.AccountDao;<br><span class="hljs-keyword">import</span> com.itheima.transfer.utils.JdbcUtils;<br><span class="hljs-keyword">import</span> java.sql.Connection;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AccountService</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">transfer</span><span class="hljs-params">(String outUser, String inUser, <span class="hljs-type">int</span> money)</span> &#123;<br>        <span class="hljs-type">AccountDao</span> <span class="hljs-variable">ad</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AccountDao</span>();<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> JdbcUtils.getConnection();<br>            <span class="hljs-comment">//开启事务</span><br>            conn.setAutoCommit(<span class="hljs-literal">false</span>);<br>            <span class="hljs-comment">// 转出 ： 这里不需要传参了 ！</span><br>            ad.out(outUser, money);<br>            <span class="hljs-comment">// 模拟转账过程中的异常</span><br><span class="hljs-comment">//            int i = 1 / 0;</span><br>            <span class="hljs-comment">// 转入</span><br>            ad.in(inUser, money);<br>            <span class="hljs-comment">//事务提交</span><br>            JdbcUtils.commitAndClose();<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>            <span class="hljs-comment">//事务回滚</span><br>           JdbcUtils.rollbackAndClose();<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="2-2、Dao层"><a href="#2-2、Dao层" class="headerlink" title="2.2、Dao层"></a>2.2、Dao层</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.itheima.transfer.dao;<br><br><span class="hljs-keyword">import</span> com.itheima.transfer.utils.JdbcUtils;<br><br><span class="hljs-keyword">import</span> java.sql.Connection;<br><span class="hljs-keyword">import</span> java.sql.PreparedStatement;<br><span class="hljs-keyword">import</span> java.sql.SQLException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AccountDao</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">out</span><span class="hljs-params">(String outUser, <span class="hljs-type">int</span> money)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;update account set money = money - ? where name = ?&quot;</span>;<br>        <span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> JdbcUtils.getConnection();<br>        <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">pstm</span> <span class="hljs-operator">=</span> conn.prepareStatement(sql);<br>        pstm.setInt(<span class="hljs-number">1</span>,money);<br>        pstm.setString(<span class="hljs-number">2</span>,outUser);<br>        pstm.executeUpdate();<br>        <span class="hljs-comment">//照常使用</span><br><span class="hljs-comment">//        JdbcUtils.release(pstm,conn);</span><br>        JdbcUtils.release(pstm);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">in</span><span class="hljs-params">(String inUser, <span class="hljs-type">int</span> money)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;update account set money = money + ? where name = ?&quot;</span>;<br>        <span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> JdbcUtils.getConnection();<br>        <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">pstm</span> <span class="hljs-operator">=</span> conn.prepareStatement(sql);<br>        pstm.setInt(<span class="hljs-number">1</span>,money);<br>        pstm.setString(<span class="hljs-number">2</span>,inUser);<br>        pstm.executeUpdate();<br><span class="hljs-comment">//        JdbcUtils.release(pstm,conn);</span><br>        JdbcUtils.release(pstm);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="2-3、Utils方法"><a href="#2-3、Utils方法" class="headerlink" title="2.3、Utils方法"></a>2.3、Utils方法</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.itheima.transfer.utils;<br><br><span class="hljs-keyword">import</span> com.mchange.v2.c3p0.ComboPooledDataSource;<br><span class="hljs-keyword">import</span> java.sql.Connection;<br><span class="hljs-keyword">import</span> java.sql.SQLException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JdbcUtils</span> &#123;<br>    <span class="hljs-comment">//ThreadLocal对象 : 将connection绑定在当前线程中</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;Connection&gt; tl = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>();<br><br>    <span class="hljs-comment">// c3p0 数据库连接池对象属性</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ComboPooledDataSource</span> <span class="hljs-variable">ds</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ComboPooledDataSource</span>();<br><br>    <span class="hljs-comment">// 获取连接</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Connection <span class="hljs-title function_">getConnection</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>        <span class="hljs-comment">//取出当前线程绑定的connection对象</span><br>        <span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> tl.get();<br>        <span class="hljs-keyword">if</span> (conn == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">//如果没有，则从连接池中取出</span><br>            conn = ds.getConnection();<br>            <span class="hljs-comment">//再将connection对象绑定到当前线程中</span><br>            tl.set(conn);<br>        &#125;<br>        <span class="hljs-keyword">return</span> conn;<br>    &#125;<br><br>    <span class="hljs-comment">//释放资源</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">release</span><span class="hljs-params">(AutoCloseable... ios)</span> &#123;<br>        <span class="hljs-keyword">for</span> (AutoCloseable io : ios) &#123;<br>            <span class="hljs-keyword">if</span> (io != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    io.close();<br>                &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">commitAndClose</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> getConnection();<br>            <span class="hljs-comment">//提交事务</span><br>            conn.commit();<br>            <span class="hljs-comment">//解除绑定</span><br>            tl.remove();<br>            <span class="hljs-comment">//释放连接</span><br>            conn.close();<br>        &#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rollbackAndClose</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> getConnection();<br>            <span class="hljs-comment">//回滚事务</span><br>            conn.rollback();<br>            <span class="hljs-comment">//解除绑定</span><br>            tl.remove();<br>            <span class="hljs-comment">//释放连接</span><br>            conn.close();<br>        &#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>可以看到，在Utils方法中，getConnection的时候，此时使用了一个ThreadLocal对象，将当前Connection对象和当前线程进行绑定了；如果是第一次获取connection对象，那么就从连接池中获取，不是的话，那么直接从ThreadLocal中获取。</p><h1 id="3、内部结构探索"><a href="#3、内部结构探索" class="headerlink" title="3、内部结构探索"></a>3、内部结构探索</h1><h2 id="3-1、内部结构"><a href="#3-1、内部结构" class="headerlink" title="3.1、内部结构"></a>3.1、内部结构</h2><p>在JDK8中ThreadLocal的设计：每个<code>Thread</code>维护一个<code>ThreadLocalMap</code>，这个Map的<code>key</code>是<code>ThreadLocal</code>对象本身，而<code>value</code>就是真正需要存储的值。</p><p>具体：</p><blockquote><p>（1） 每个Thread线程内部都有一个Map (ThreadLocalMap)<br>（2） Map里面存储ThreadLocal对象（key）和线程的变量副本（value）<br>（3）Thread内部的Map是由ThreadLocal维护的，由ThreadLocal负责向map获取和设置线程的变量值。<br>（4）对于不同的线程，每次获取副本值时，别的线程并不能获取到当前线程的副本值，形成了副本的隔离，互不干扰。</p></blockquote><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/JUC/ThreadLocal/image-20230722171217698.png" alt="image-20230722171217698"></p><p>由于每个Thread中维护一个ThreadLocalMap，Map的key为ThreadLocal对象本身，value为设置的值，这样的优势：</p><ol><li>每个<code>Map</code>存储的<code>Entry</code>数量就会变少，JDK7中的存储数量由<code>Thread</code>的数量决定，现在是由<code>ThreadLocal</code>的数量决定。（ThreadLocal的数量远远小于Thread数量）</li><li>当<code>Thread</code>销毁之后，对应的<code>ThreadLocalMap</code>也会随之销毁，能减少内存的使用。</li></ol><h2 id="3-2、核心方法"><a href="#3-2、核心方法" class="headerlink" title="3.2、核心方法"></a>3.2、核心方法</h2><h3 id="3-2-1、set"><a href="#3-2-1、set" class="headerlink" title="3.2.1、set"></a>3.2.1、set</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(T value)</span> &#123;<br><span class="hljs-comment">// 1）拿到当前线程</span><br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> Thread.currentThread();<br>        <span class="hljs-comment">// 2）通过线程内部的 threadLocals 变量，拿到对应 ThreadLocalMap 对象。对应着分析1</span><br>        <span class="hljs-type">ThreadLocalMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> getMap(t);<br>        <span class="hljs-comment">// 3）判断如果不为 null ,则直接调用 ThreadLocalMap 中的 set 方法，传入 当前的 ThreadLocal 对象和要指定修改的值 value，对应着分析2</span><br>        <span class="hljs-keyword">if</span> (map != <span class="hljs-literal">null</span>)<br>            map.set(<span class="hljs-built_in">this</span>, value);<br>        <span class="hljs-keyword">else</span><br>        <span class="hljs-comment">// 4）创建 map 为 null，就创建 map, 对应着分析3</span><br>            createMap(t, value);<br>    &#125; <br><br></code></pre></td></tr></table></figure><hr><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java">ThreadLocalMap <span class="hljs-title function_">getMap</span><span class="hljs-params">(Thread t)</span> &#123;<br>    <span class="hljs-keyword">return</span> t.threadLocals;<br>&#125;<br><br><span class="hljs-comment">// Thread类中持有一个ThreadLocalMap类型的对象threadLocals</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Thread</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> &#123;<br>    ThreadLocal.<span class="hljs-type">ThreadLocalMap</span> <span class="hljs-variable">threadLocals</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    ThreadLocal.<span class="hljs-type">ThreadLocalMap</span> <span class="hljs-variable">inheritableThreadLocals</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><hr><p>真正进行赋值：</p><blockquote><p>set方法可以进行修改或者新建的操作。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(ThreadLocal&lt;?&gt; key, Object value)</span> &#123;<br>    <span class="hljs-comment">// 将ThreadLocal对象的存储表table赋值给局部变量tab</span><br>        Entry[] tab = table;<br>    <span class="hljs-comment">// 计算tab的长度</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> tab.length;<br>    <span class="hljs-comment">// 先找到对应Entry的数组下标</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> key.threadLocalHashCode &amp; (len-<span class="hljs-number">1</span>);<br>    <span class="hljs-comment">// 循环查找存储表中能匹配的Entry对象，从索引位置开始一直到链表末尾</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">Entry</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> tab[i];<br>             e != <span class="hljs-literal">null</span>;<br>             e = tab[i = nextIndex(i, len)]) &#123;<br>            <span class="hljs-comment">// 取出当前的ThreadLocal对象</span><br>            ThreadLocal&lt;?&gt; k = e.get();<br>            <span class="hljs-comment">// 判断与Key，即是否是一个ThreadLocal对象，如果是，那么就进行以及修改</span><br>            <span class="hljs-keyword">if</span> (k == key) &#123;<br>                e.value = value;<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>            <span class="hljs-comment">// 当前Entry的ThreadLocal对象为空，说明该Entry无效，可能在之前被GC掉了</span><br>            <span class="hljs-keyword">if</span> (k == <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-comment">// 传入key, value, i创建一个新的Entry，存储在数组tab的位置</span><br>                replaceStaleEntry(key, value, i);<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>        &#125;<br><br>    <span class="hljs-comment">// 循环找都没有匹配ThreadLocal对象</span><br>    <span class="hljs-comment">// 新建一个Entry，</span><br>        tab[i] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Entry</span>(key, value);<br><span class="hljs-comment">// 增加存储表中的Entry数量</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">sz</span> <span class="hljs-operator">=</span> ++size;<br>    <span class="hljs-comment">// 判断是否需要清理一些无效的Entry&amp;&amp;是否需要去扩容</span><br>        <span class="hljs-keyword">if</span> (!cleanSomeSlots(i, sz) &amp;&amp; sz &gt;= threshold)<br>            <span class="hljs-comment">// 进行扩容</span><br>            rehash();<br>    &#125;<br></code></pre></td></tr></table></figure><hr><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">createMap</span><span class="hljs-params">(Thread t, T firstValue)</span> &#123;<br>        t.threadLocals = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocalMap</span>(<span class="hljs-built_in">this</span>, firstValue);<br>    &#125;<br>    <br>ThreadLocalMap(ThreadLocal&lt;?&gt; firstKey, Object firstValue) &#123;<br>        <span class="hljs-comment">// 创建一个默认长度大小为 16 的 Entry 数组</span><br>        table = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Entry</span>[INITIAL_CAPACITY];<br>        <span class="hljs-comment">// 计算对应的数组的下标</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> firstKey.threadLocalHashCode &amp; (INITIAL_CAPACITY - <span class="hljs-number">1</span>);<br>        <span class="hljs-comment">// 插入节点</span><br>        table[i] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Entry</span>(firstKey, firstValue);<br>        size = <span class="hljs-number">1</span>;<br>        <span class="hljs-comment">// 设置扩容阈值</span><br>        setThreshold(INITIAL_CAPACITY);<br>    &#125;<br><br></code></pre></td></tr></table></figure><h3 id="3-2-2、get"><a href="#3-2-2、get" class="headerlink" title="3.2.2、get"></a>3.2.2、get</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> T <span class="hljs-title function_">get</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 获取当前的线程</span><br>    <span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> Thread.currentThread();<br>    <span class="hljs-comment">// 获取当前线程的ThreadLocalMap</span><br>    <span class="hljs-type">ThreadLocalMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> getMap(t);<br>    <span class="hljs-keyword">if</span> (map != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">// 通过 getEntry 找到线程对应着的 Entry 对象, 对应着分析1</span><br>        ThreadLocalMap.<span class="hljs-type">Entry</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> map.getEntry(<span class="hljs-built_in">this</span>);<br>        <span class="hljs-comment">// 如果不为 null 则直接拿到返回</span><br>        <span class="hljs-keyword">if</span> (e != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>            <span class="hljs-type">T</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> (T)e.value;<br>            <span class="hljs-keyword">return</span> result;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// map为空，进行initialValue</span><br>    <span class="hljs-keyword">return</span> setInitialValue();<br>&#125;<br><br></code></pre></td></tr></table></figure><hr><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> Entry <span class="hljs-title function_">getEntry</span><span class="hljs-params">(ThreadLocal&lt;?&gt; key)</span> &#123;<br>    <span class="hljs-comment">// 计算出 index 的值</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> key.threadLocalHashCode &amp; (table.length - <span class="hljs-number">1</span>);<br>    <span class="hljs-comment">// 获取当前tab下表为i的Entry</span><br>    <span class="hljs-type">Entry</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> table[i];<br>    <span class="hljs-comment">// 如果存在, 判断是不是相同的对象，是就直接返回</span><br>    <span class="hljs-keyword">if</span> (e != <span class="hljs-literal">null</span> &amp;&amp; e.get() == key)<br>        <span class="hljs-keyword">return</span> e;<br>    <span class="hljs-keyword">else</span><br>        <span class="hljs-comment">// 清空 key 为 null 的对象</span><br>        <span class="hljs-keyword">return</span> getEntryAfterMiss(key, i, e);<br>&#125;<br></code></pre></td></tr></table></figure><hr><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> T <span class="hljs-title function_">setInitialValue</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 会进行初始化, 如果我们重写了就会调用我们自己重写的，否则就调用默认的。</span><br>    <span class="hljs-comment">// protected T initialValue() &#123;return null;&#125;</span><br>    <span class="hljs-type">T</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> initialValue();<br>    <span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> Thread.currentThread();<br>    <span class="hljs-type">ThreadLocalMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> getMap(t);<br>     <span class="hljs-comment">// 如果 map 不为 null ，就直接添加本地变量，key 为当前线程，值为添加的本地变量值</span><br>    <span class="hljs-keyword">if</span> (map != <span class="hljs-literal">null</span>)<br>        map.set(<span class="hljs-built_in">this</span>, value);<br>    <span class="hljs-keyword">else</span><br>    <span class="hljs-comment">// 如果 map 为 null，说明首次添加，需要首先创建出对应的 map</span><br>        createMap(t, value);<br>    <span class="hljs-keyword">return</span> value;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-2-3、remove"><a href="#3-2-3、remove" class="headerlink" title="3.2.3、remove"></a>3.2.3、remove</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">remove</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 获取当前线程绑定的 threadLocals</span><br>     <span class="hljs-type">ThreadLocalMap</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> getMap(Thread.currentThread());<br>     <span class="hljs-comment">// 如果 map 不为 null，就移除当前线程中指定 ThreadLocal 实例的本地变量</span><br>     <span class="hljs-keyword">if</span> (m != <span class="hljs-literal">null</span>)<br>         m.remove(<span class="hljs-built_in">this</span>);<br> &#125;<br><br></code></pre></td></tr></table></figure><h1 id="4、ThreadLocal内存泄漏"><a href="#4、ThreadLocal内存泄漏" class="headerlink" title="4、ThreadLocal内存泄漏"></a>4、ThreadLocal内存泄漏</h1><h2 id="4-1、内存泄漏是什么？"><a href="#4-1、内存泄漏是什么？" class="headerlink" title="4.1、内存泄漏是什么？"></a>4.1、内存泄漏是什么？</h2><blockquote><p>不再会使用的对象或者变量占用的内存不能被回收，就是内存泄漏。</p></blockquote><h2 id="4-2、四种引用"><a href="#4-2、四种引用" class="headerlink" title="4.2、四种引用"></a>4.2、四种引用</h2><h3 id="4-2-1、强引用"><a href="#4-2-1、强引用" class="headerlink" title="4.2.1、强引用"></a>4.2.1、强引用</h3><p>一般我们 new 关键字创建的对象就是 Reference（强引用），当内存不足时，JVM 开始垃圾回收，对于强引用对象，就算是出现 OOM 也不会对该对象进行回收。</p><h3 id="4-2-2、软引用"><a href="#4-2-2、软引用" class="headerlink" title="4.2.2、软引用"></a>4.2.2、软引用</h3><p>软引用是一种相对相对于强引用弱化了一些的引用，需要用 SoftReference 类实现，对于软引用来说，当系统内存充足时，软引用对象不会被垃圾回收，不充足时，会被回收。软引用通常用在对内存敏感的程序中，比如高速缓存就有用到软引用，内存够用的时候就保留，不够用就回收！</p><h3 id="4-2-3、弱引用"><a href="#4-2-3、弱引用" class="headerlink" title="4.2.3、弱引用"></a>4.2.3、弱引用</h3><p>弱引用需要用 WeakReference 类实现，它比软引用的生存期更短，对于弱引用对象来说，只要垃圾回收器运行，不管 JVM 内存空间是否足够，都会回收该对象占用的内存。</p><h3 id="4-2-4、虚引用"><a href="#4-2-4、虚引用" class="headerlink" title="4.2.4、虚引用"></a>4.2.4、虚引用</h3><p>虚引用需要 PhantomReference 类来实现，如果一个对象持有虚引用，那么它就和没有任何引用一样，在任何时候都可能会垃圾回收器回收，它不能单独使用也不能通过它访问对象，虚引用必须和引用队列（ReferenceQueue）联合使用。</p><h2 id="4-3、Entry"><a href="#4-3、Entry" class="headerlink" title="4.3、Entry"></a>4.3、Entry</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadLocalMap</span> &#123;<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Entry</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WeakReference</span>&lt;ThreadLocal&lt;?&gt;&gt; &#123;<br>        <span class="hljs-comment">/** The value associated with this ThreadLocal. */</span><br>        Object value;<br><br>        Entry(ThreadLocal&lt;?&gt; k, Object v) &#123;<br>            <span class="hljs-built_in">super</span>(k);<br>            value = v;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>从上述代码中可以得知，</p><ul><li>ThreadLocalMap是ThreadLocal的一个内部静态类，用来存储每个线程对应的变量值。Entry类来管理每个线程本地变量的key-value。</li><li><code>Entry</code>是<code>ThreadLocalMap</code>的一个内部静态类，继承自<code>WeakReference&lt;ThreadLocal&lt;?&gt;&gt;</code>。<code>Entry</code>表示一个键值对，用于将<code>ThreadLocal</code>对象与其对应的变量值关联起来。<ul><li>表明：<code>ThreadLocal</code>对象在没有其他强引用对象的时候会被垃圾回收器进行回收，而<code>Entry</code>的声明周期也会随着结束，进而避免了内存泄漏。</li></ul></li></ul><h3 id="4-3-1、为什么是弱引用"><a href="#4-3-1、为什么是弱引用" class="headerlink" title="4.3.1、为什么是弱引用"></a>4.3.1、为什么是弱引用</h3><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/JUC/ThreadLocal/20210219124533810.png" alt="图一"></p><p>代码演示：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">method</span><span class="hljs-params">()</span> &#123;<br>    ThreadLocal&lt;Integer&gt; tl = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();<br>    tl .set(<span class="hljs-number">2021</span>);<br>    tl .get();<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>当调用method的时候，会向栈中插入一条栈帧。</li><li>new关键字创建一个ThreadLocal对象，此时tl是对象的引用<ul><li>new出的对象是一个强引用，通过set方法进行存储值，Key是ThreadLocal对象本身，Value为需要存储的值。</li><li>Entry继承WeakReference，那么Key是弱引用指向了ThreadLocal对象。</li></ul></li><li>当method方法执行完毕之后，栈帧销毁，此时强引用tl就不存在了。<ul><li>但是Thread的ThreadLocalMap中的某一个Entry的key的引用还指向了ThreadLocal对象</li><li>如果这个Key引用是强引用，会导致Key指向的ThreadLocal对象是强引用对象不能被GC，会造成内存泄漏</li><li>如果这个Key引用是弱引用，会大概率减少内存泄漏的问题。使用了弱引用，就可以使ThreadLocal对象在方法执行完毕之后顺利被回收，并且Key的引用会被指向为null。</li></ul></li></ul><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/JUC/ThreadLocal/20210219131444101.png" alt="图二"></p><blockquote><p>总结：</p><ul><li>new一个ThreadLocal对象的时候，就会有一个强引用指向这个对象。</li><li>调用set方法之后，线程中的ThreadLocalMap中的Entry对象中的Key指向ThreadLocal对象。</li><li>如果Key是强引用的话，当方法执行完，栈帧中的强引用销毁了，对象还不能被回收，此时就会造成内存泄漏。</li></ul></blockquote><h3 id="4-3-2、为什么还是会泄漏"><a href="#4-3-2、为什么还是会泄漏" class="headerlink" title="4.3.2、为什么还是会泄漏"></a>4.3.2、为什么还是会泄漏</h3><p>虽然Entry继承了弱引用，保证了Key指向的ThreadLocal对象能被及时回收，但是此时v指向的Value对象需要再ThreadLocalMap调用get、set的时候发现Key为null的时候才能回收整个的entry、Value。</p><blockquote><p>为什么value还持有引用？</p><p>解答：ThreadLocal作为Thread的一个属性，如果当前线程没有手动销毁，那么ThreadLocalMap也还是存在，同理Entry的引用也持有。</p></blockquote><p><code>所以泄露的根本原因就是因为ThreadLocal的生命周期和Thread的生命周期一样，如果线程没有主动销毁，那么entry就不会被销毁。</code><br><img src="https://workspace-1313021454.cos.ap-beijing.myqcloud.com/JUC/ThreadLocal/image-20230725174415384.png" alt="image-20230725174415384"></p><p>所以：弱引用只是帮助我们降低了内存泄漏的概率，并不能完全避免，在使用完成之后，<code>必须手动remove</code>这个对象。</p><p><img src="https://mypc-1313021454.cos.ap-beijing.myqcloud.com/JUC/ThreadLocal/20210219134347416.png" alt="在这里插入图片描述"></p>]]></content>
    
    
    <categories>
      
      <category>Java多线程</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java多线程</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Java多线程-线程交替打印</title>
    <link href="/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B-%E7%BA%BF%E7%A8%8B%E4%BA%A4%E6%9B%BF%E6%89%93%E5%8D%B0/4fde684e52ae/"/>
    <url>/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B-%E7%BA%BF%E7%A8%8B%E4%BA%A4%E6%9B%BF%E6%89%93%E5%8D%B0/4fde684e52ae/</url>
    
    <content type="html"><![CDATA[<p>今日复习来自极海Channel的一个面试</p><blockquote><p>如何实现两个线程实现交替打印，线程A打印A，线程B打印B？</p></blockquote><p>讲真当时看到的时候，脑子里面第一反应就是信号量和synchronized解法，那有synchronized就会有ReentrantLock，那就尝试用这三个解法回答一下吧。</p><p>代码地址：<a href="https://github.com/baijiangLai/LearnOfJUC/tree/master/alternatePrint">线程交替打印</a></p><h2 id="1、synchronized实现"><a href="#1、synchronized实现" class="headerlink" title="1、synchronized实现"></a>1、synchronized实现</h2><p>synchronized的方式实现主要是进行加锁，通过一把对象锁，在代码块内只允许一个线程执行后续操作。</p><p>核心：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 持有的lock锁</span><br><span class="hljs-keyword">synchronized</span> (lock) &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>        <span class="hljs-comment">// 打印顺序就是A--&gt;B--&gt;C</span><br>        <span class="hljs-keyword">while</span> (currentOrder % <span class="hljs-number">3</span> != order) &#123;<br>            lock.wait(); <span class="hljs-comment">// 当前线程等待，直到轮到自己打印</span><br>        &#125;<br>        System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;------&quot;</span> + message);<br>        currentOrder++;<br>        lock.notifyAll(); <span class="hljs-comment">// 唤醒其他等待的线程</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2、ReentrantLock实现"><a href="#2、ReentrantLock实现" class="headerlink" title="2、ReentrantLock实现"></a>2、ReentrantLock实现</h2><p>ReentrantLock实现，同样会传入锁，但是lock和unlock是自己规定，所以当需要判断打印的时候，进行枷锁操作，同时每个线程进去之后判断是否是自己需要打印，如果不是，那么就唤醒下一个线程。</p><p>核心：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>    <span class="hljs-comment">// 某个线程持有锁，只有一个线程进入后续部分</span><br>    lock.lock();<br>    <span class="hljs-comment">// 条件判断，如果不满足，当前线程等待，</span><br>    <span class="hljs-keyword">while</span> (currentOrder % <span class="hljs-number">3</span> != order) &#123;<br>        current.await();<br>    &#125;<br>    System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;------&quot;</span> + message);<br>    currentOrder++;<br>    <span class="hljs-comment">// 使用signal()唤醒下一个线程</span><br>    next.signal();<br>    <span class="hljs-comment">// 锁释放</span><br>    lock.unlock();<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>注意：Condition对象是与锁（<strong>ReentrantLock</strong>）关联的条件对象，用于线程间的等待和通知机制。因此锁的类型不并不是Object</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();<br><br>lock.newContional();    <span class="hljs-comment">//ConditionalA</span><br>lock.newContional();    <span class="hljs-comment">//ConditionalB</span><br>lock.newContional();    <span class="hljs-comment">//ConditionalC</span><br></code></pre></td></tr></table></figure></blockquote><h2 id="3、信号量实现"><a href="#3、信号量实现" class="headerlink" title="3、信号量实现"></a>3、信号量实现</h2><p>在使用信号量实现的时候，需要指定谁最先拥有许可。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Semaphore</span> <span class="hljs-variable">semaphoreA</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Semaphore</span>(<span class="hljs-number">1</span>);   <span class="hljs-comment">//信号量A最先拥有许可，所以从他开始</span><br><span class="hljs-type">Semaphore</span> <span class="hljs-variable">semaphoreB</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Semaphore</span>(<span class="hljs-number">0</span>);<br><span class="hljs-type">Semaphore</span> <span class="hljs-variable">semaphoreC</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Semaphore</span>(<span class="hljs-number">0</span>);<br></code></pre></td></tr></table></figure><p>核心：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 核心：通过获取当前线程的信号量来确定是否轮到自己执行。</span><br><span class="hljs-comment">     * 在执行完打印操作后，释放下一个线程的信号量，从而实现线程的交叉打印。</span><br><span class="hljs-comment">     */</span><br>    current.acquire();      <span class="hljs-comment">// 获取当前线程的信号量</span><br>    System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;------&quot;</span> + message);<br>    currentOrder++;<br>    next.release();         <span class="hljs-comment">//释放下一个线程的信号量</span><br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Java多线程</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java多线程</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
